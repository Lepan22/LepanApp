<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda</title>
  <link rel="stylesheet" href="assets/base.css">
  <link rel="stylesheet" href="assets/menu-styles.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root{
      --brand:#ff7f00;
      --line:#e7e7ea;
      --muted:#6b7280;

      --gap:6px;
      --fontDay:11px;
      --fontEvt:9px;
      --padDay:4px;

      --rowH: 120px;
    }

    body{background:#f6f7f9;margin:0;color:#222}
    .wrap{padding:10px}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin-bottom:var(--gap)}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;justify-content:center;min-height:52px}
    .kpi small{color:var(--muted);font-size:11px;font-weight:600}
    .kpi strong{font-size:16px;margin-top:2px}
    .kpi .sub{font-size:11px;margin-top:2px;color:#7a4c00}
    .kpi.warn{background:#fffaf2;box-shadow:inset 0 0 0 2px #ffd199}

    .topbar{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:var(--gap)}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    #mesAtual{font-weight:700;text-transform:capitalize}

    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
    .dow div{background:#fff;border:1px solid var(--line);border-radius:8px;text-align:center;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;min-height:24px}

    .grid{
      display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
      grid-auto-rows: var(--rowH);
      min-height: calc(var(--rowH) * 6 + 5 * 4px);
    }

    .day{
      background:#fff;border:1px solid var(--line);border-radius:10px;
      padding:var(--padDay);display:flex;flex-direction:column;overflow:hidden;font-size:var(--fontDay);
      position: relative;
    }

    .other-month{background:#f3f5f8;color:#6b7280}

    .is-week{background:#fff5e6 !important;box-shadow: inset 0 0 0 1px #ffd199}
    .other-month.is-week{background:#fff1d6 !important}

    .head-dia{display:flex;align-items:center;justify-content:space-between}
    .n{font-weight:700}
    .count{min-width:18px;height:18px;line-height:18px;border-radius:9px;border:1px solid var(--line);background:#fff;color:#555;font-size:10px;text-align:center;margin-left:6px}

    .lista{margin-top:3px; flex:1 1 auto; overflow:auto; padding-right:2px;}
    .lista::-webkit-scrollbar{width:6px}
    .lista::-webkit-scrollbar-thumb{background:#ddd;border-radius:8px}
    .lista{scrollbar-width:thin; scrollbar-color:#ddd transparent;}

    .is-blocked{background:#fafafa;border-style:dashed}
    .blocked{font-size:9px;color:#d9534f;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}

    .evt{
      margin-top:3px;background:var(--brand);color:#fff;border-radius:6px;padding:1px 5px;
      display:flex;align-items:center;justify-content:space-between;font-size:var(--fontEvt);min-height:18px
    }
    /* título agora cresce e ocupa o que sobrar, garantindo ao menos 5 caracteres visíveis */
    .evt .t{
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      flex:1 1 auto;
      min-width:5ch;
    }

    .evt.confirmado{background: var(--brand);color:#fff;border: 1px solid rgba(255,255,255,.2)}
    .evt.previsto{background:#fff3e0;color:#8a4b00;border:1px dashed #ffcc80}

    /* Ações menores para liberar espaço ao título */
    .acts{display:flex;align-items:center;gap:2px;margin-left:6px;flex:0 0 auto}
    .iconbtn{
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.35);
      color:#fff; border-radius:4px;
      font-size:8px;
      padding:0 3px;
      height:14px; line-height:14px;
      cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none; min-width:14px;
    }
    .evt.previsto .iconbtn{background:#fff;color:#8a4b00;border:1px solid #efc48f}
    .iconbtn:hover{filter:brightness(1.05)}

    .foot{display:flex;align-items:center;justify-content:center;margin-top:6px}

    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 640px){ .kpis{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <div class="wrap card-dashboard" style="border:1px solid #eee;border-radius:10px;background:#fff">
        <section id="kpis" class="kpis">
          <div class="kpi"><small>Vendas Real Mês Anterior</small><strong id="kpiRealAnterior">—</strong></div>
          <div class="kpi"><small>Vendas Real Mês</small><strong id="kpiRealMes">—</strong></div>
          <div class="kpi" id="kpiCardPrevMes">
            <small>Venda Prevista Mês</small>
            <strong id="kpiPrevMes">—</strong>
            <div class="sub" id="kpiPrevMesAConf">à confirmar: —</div>
          </div>
          <div class="kpi"><small>Venda Prevista Próx. Mês</small><strong id="kpiPrevProx">—</strong></div>
        </section>

        <div id="nav" class="topbar">
          <button class="btn" onclick="mudarMes(-1)">&#8592; Mês Anterior</button>
          <span id="mesAtual">Mês Atual</span>
          <button class="btn" onclick="mudarMes(1)">Mês Seguinte &#8594;</button>
        </div>

        <div id="dow" class="dow">
          <div>DOM</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>SAB</div>
        </div>

        <div id="grid" class="grid"></div>

        <div id="foot" class="foot">
          <button class="btn" onclick="duplicarMes()">📅 Duplicar Mês</button>
        </div>
      </div>
    </main>
  </div>

  <script src="assets/menu.js" defer></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let mesRef = new Date();
    let eventos = [];
    let indis = {};

    const pad2 = n => String(n).padStart(2,'0');
    const ym   = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const toISO = d => new Date(d).toISOString().split('T')[0];
    const brl  = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
    const num = v => { if (v==null) return 0; if (typeof v==='number') return v; const s=String(v).replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };

    const VIEW_BASE = 'https://lepan22.github.io/LepanApp/GestaoEvento.html?id=';

    function ajustarAlturaLinhas(){
      const grid = document.getElementById('grid');
      const vb = document.documentElement.clientHeight;
      const rectWrap = grid.parentElement.getBoundingClientRect();

      const kpisH = document.getElementById('kpis').getBoundingClientRect().height;
      const navH  = document.getElementById('nav').getBoundingClientRect().height;
      const dowH  = document.getElementById('dow').getBoundingClientRect().height;
      const footH = document.getElementById('foot').getBoundingClientRect().height;

      const extras = 26;

      const disponivel = vb - (rectWrap.top + kpisH + navH + dowH + footH + extras);
      const rowH = Math.max(84, Math.floor((disponivel - (5*4)) / 6));

      grid.style.setProperty('--rowH', rowH + 'px');
    }
    window.addEventListener('resize', ajustarAlturaLinhas);

    function mudarMes(delta){
      mesRef.setMonth(mesRef.getMonth()+delta);
      carregar();
    }

    async function carregar(){
      const snap = await db.ref('eventos').once('value');
      eventos = [];
      snap.forEach(ch=>{ const v=ch.val(); v.id=ch.key; eventos.push(v); });

      const iSnap = await db.ref('configuracao/diasIndisponiveis').once('value');
      indis = {};
      iSnap.forEach(ch=>{
        const it=ch.val();
        if (it?.tipo==='único' && it?.data) {
          indis[it.data]=it.motivo||'Indisponível';
        } else if (it?.tipo==='período' && it?.inicio && it?.fim){
          const i=new Date(it.inicio), f=new Date(it.fim);
          for(let d=new Date(i); d<=f; d.setDate(d.getDate()+1)){
            indis[toISO(d)] = it.motivo||'Indisponível';
          }
        }
      });

      desenhar();
      atualizarKPIs();
      ajustarAlturaLinhas();
    }

    function desenhar(){
      document.getElementById('mesAtual').textContent =
        mesRef.toLocaleString('pt-BR',{month:'long',year:'numeric'});

      const grid = document.getElementById('grid');
      grid.innerHTML='';

      const ano = mesRef.getFullYear();
      const mes = mesRef.getMonth();

      const first = new Date(ano, mes, 1);
      const inicioGrid = new Date(first);
      inicioGrid.setDate(first.getDate() - first.getDay());

      const semanaAtual = semanaSegADom();

      for (let i=0; i<42; i++){
        const data = new Date(inicioGrid);
        data.setDate(inicioGrid.getDate()+i);
        const iso = toISO(data);

        const el = document.createElement('div');
        el.className='day';
        el.dataset.data=iso;

        const isOther = data.getMonth() !== mes;
        if (isOther) el.classList.add('other-month');
        if (semanaAtual.includes(iso)) el.classList.add('is-week');
        if (indis[iso]) el.classList.add('is-blocked');

        el.addEventListener('dragover', e=>e.preventDefault());
        el.addEventListener('drop', onDropMove);

        const head = document.createElement('div');
        head.className = 'head-dia';
        const nEl = document.createElement('div');
        nEl.className='n'; nEl.textContent=data.getDate();

        const cnt = document.createElement('span');
        cnt.className='count'; cnt.textContent='';
        head.appendChild(nEl); head.appendChild(cnt);
        el.appendChild(head);

        if (indis[iso]){
          const b = document.createElement('div');
          b.className='blocked'; b.textContent=indis[iso];
          el.appendChild(b);
        }

        const lista = document.createElement('div');
        lista.className = 'lista';

        const doDia = eventos.filter(ev=>ev.data===iso);
        doDia.forEach(ev=>{
          const estado = (ev.confirmacao === 'previsto') ? 'previsto' : 'confirmado';

          const evt = document.createElement('div');
          evt.className='evt ' + estado;
          evt.draggable=true;
          evt.dataset.eventoId=ev.id;

          const t = document.createElement('span');
          t.className='t'; t.textContent=ev.nomeEvento || 'Sem nome';

          const acts = document.createElement('div');
          acts.className='acts';

          const ver = document.createElement('a');
          ver.className = 'iconbtn';
          ver.href = VIEW_BASE + encodeURIComponent(ev.id);
          ver.target = '_blank';
          ver.title = 'Visualizar evento';
          ver.textContent = '🔍';

          const tog = document.createElement('button');
          tog.className='iconbtn';
          tog.title = (estado==='previsto') ? 'Marcar como Confirmado' : 'Marcar como Previsto';
          tog.textContent = (estado==='previsto') ? 'C' : 'P';
          tog.onclick = ()=>alternarConfirmacao(ev.id, estado);

          const dup = document.createElement('button');
          dup.className='iconbtn'; dup.title='Duplicar';
          dup.textContent='＋';
          dup.onclick = ()=>duplicarEvento(ev);

          const del = document.createElement('button');
          del.className='iconbtn'; del.title='Excluir';
          del.textContent='🗑';
          del.onclick = ()=>excluirEvento(ev.id);

          acts.appendChild(ver);
          acts.appendChild(tog);
          acts.appendChild(dup);
          acts.appendChild(del);

          evt.appendChild(t);
          evt.appendChild(acts);

          evt.addEventListener('dragstart', e=> e.dataTransfer.setData('eventoId', ev.id));
          lista.appendChild(evt);
        });

        if (doDia.length > 0) cnt.textContent = doDia.length;

        el.appendChild(lista);
        grid.appendChild(el);
      }
    }

    function onDropMove(e){
      const id = e.dataTransfer.getData('eventoId');
      const data = this.dataset.data;
      if (!id || !data) return;
      db.ref(`eventos/${id}`).update({data})
        .then(()=>carregar())
        .catch(err=>alert('Erro ao mover: '+err.message));
    }

    function semanaSegADom(){
      const hoje = new Date();
      const dw = hoje.getDay();
      const inicio = new Date(hoje);
      const delta = (dw===0 ? -6 : 1-dw);
      inicio.setDate(hoje.getDate()+delta);
      const out=[];
      for(let i=0;i<7;i++){const d=new Date(inicio);d.setDate(inicio.getDate()+i);out.push(toISO(d));}
      return out;
    }

    async function alternarConfirmacao(id, atual){
      const novo = (atual==='previsto') ? 'confirmado' : 'previsto';
      try{
        await db.ref(`eventos/${id}/confirmacao`).set(novo);
        carregar();
      }catch(err){
        alert('Erro ao salvar: ' + err.message);
      }
    }

    async function duplicarEvento(ev){
      if(!confirm('Duplicar este evento?')) return;
      const novo={...ev}; delete novo.id;
      await db.ref('eventos').push(novo);
      carregar();
    }

    async function excluirEvento(id){
      if(!confirm('Tem certeza que deseja excluir este evento?')) return;
      try{
        await db.ref('eventos/'+id).remove();
        carregar();
      }catch(err){
        alert('Erro ao excluir: ' + err.message);
      }
    }

    async function duplicarMes(){
      if(!confirm('Duplicar todos os eventos do mês para o próximo?')) return;

      const ano=mesRef.getFullYear(), mes=mesRef.getMonth();
      const doMes = eventos.filter(ev=>{
        const d=new Date(ev.data);
        return d.getMonth()===mes && d.getFullYear()===ano;
      });

      await Promise.all(doMes.map(ev=>{
        const nova = new Date(ev.data); nova.setMonth(nova.getMonth()+1);
        const ultimoNovo = new Date(nova.getFullYear(), nova.getMonth()+1, 0).getDate();
        if (nova.getDate()>ultimoNovo) nova.setDate(ultimoNovo);

        const n={...ev}; delete n.id;
        n.data = toISO(nova); n.status='Aberto';
        delete n.vendaPDV;
        if (n.produtos){ n.produtos = n.produtos.map(p=>{ const {congelado,assado,perda,...r}=p; return r; }); }
        return db.ref('eventos').push(n);
      }));

      carregar();
    }

    function atualizarKPIs(){
      const atualYM = ym(mesRef);
      const dAnt = new Date(mesRef); dAnt.setMonth(dAnt.getMonth()-1);
      const dProx= new Date(mesRef); dProx.setMonth(dProx.getMonth()+1);
      const antYM  = ym(dAnt);
      const proxYM = ym(dProx);

      const dentroYM = (e, ymKey)=>{
        if(!e?.data) return false;
        const d = new Date(e.data);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        return key === ymKey;
      };

      const isFechado = (e)=>{
        const s = String(e.status||'').toLowerCase();
        return s==='fechado' || s==='finalizado';
      };

      const realAtual    = eventos.filter(e=>dentroYM(e, atualYM) && isFechado(e))
                                  .reduce((s,e)=> s + num(e.vendaPDV), 0);
      const realAnterior = eventos.filter(e=>dentroYM(e, antYM) && isFechado(e))
                                  .reduce((s,e)=> s + num(e.vendaPDV), 0);

      const doMesAtual   = eventos.filter(e=>dentroYM(e, atualYM));
      const prevMesTotal = doMesAtual.reduce((s,e)=> s + num(e.estimativaVenda), 0);
      const prevMesAConf = doMesAtual
                            .filter(e => (e.confirmacao || 'confirmado') === 'previsto')
                            .reduce((s,e)=> s + num(e.estimativaVenda), 0);

      const prevProx = eventos.filter(e=>dentroYM(e, proxYM))
                              .reduce((s,e)=> s + num(e.estimativaVenda), 0);

      document.getElementById('kpiRealAnterior').textContent = brl(realAnterior);
      document.getElementById('kpiRealMes').textContent      = brl(realAtual);
      document.getElementById('kpiPrevMes').textContent      = brl(prevMesTotal);
      document.getElementById('kpiPrevProx').textContent     = brl(prevProx);

      const sub = document.getElementById('kpiPrevMesAConf');
      sub.textContent = 'à confirmar: ' + brl(prevMesAConf);

      const card = document.getElementById('kpiCardPrevMes');
      if (prevMesAConf > 0) card.classList.add('warn'); else card.classList.remove('warn');
    }

    document.addEventListener('DOMContentLoaded', carregar);
  </script>
</body>
</html>
