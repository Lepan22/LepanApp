<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda</title>
  <link rel="stylesheet" href="assets/base.css">
  <link rel="stylesheet" href="assets/menu-styles.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    /* ---- Layout geral ---- */
    :root{
      --gap:8px;
      --kpi-h:82px;         /* faixa dos KPIs */
      --header-h:44px;      /* barra com navegaÃ§Ã£o do mÃªs */
      --botao-h:40px;       /* Ã¡rea do "Duplicar MÃªs" */
      --chrome: calc(var(--kpi-h) + var(--header-h) + var(--botao-h) + 40px); /* paddings/margens */
      --day-font: 10px;     /* texto dia/evento */
      --event-font: 8px;
      --accent:#ff7f00;
    }

    .card-dashboard{
      background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 5px rgba(0,0,0,.08);
    }

    /* ---- KPIs ---- */
    .kpi-wrap{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: var(--gap);
      margin-bottom: var(--gap);
      height: var(--kpi-h);
    }
    .kpi{
      display:flex; flex-direction:column; justify-content:center; align-items:flex-start;
      background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px;
    }
    .kpi small{ color:#777; font-weight:600; }
    .kpi strong{ font-size:18px; line-height:1.1; margin-top:4px; }

    /* ---- NavegaÃ§Ã£o do mÃªs ---- */
    .topbar{
      display:flex; align-items:center; justify-content:center; gap:8px;
      height: var(--header-h);
    }
    .btn-navegar{
      background-color: var(--accent);
      color:#fff; padding:6px 10px; border:none; cursor:pointer; border-radius:6px; font-size:12px;
    }
    .btn-navegar:hover{ background:#e96f00; }
    #mesAtual{ font-weight:700; text-transform:capitalize; }

    /* ---- CalendÃ¡rio ---- */
    .calendario{
      /* 7 colunas x 6 linhas fixas, calculando a altura para caber na viewport */
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: calc((100vh - var(--chrome) - 6px - 6px) / 6); /* 6 linhas visÃ­veis sem rolagem */
      gap: 6px;
      margin-top: 6px;
      user-select:none;
    }
    .dia{
      border:1px solid #ddd; border-radius:6px; padding:4px;
      display:flex; flex-direction:column; overflow:hidden;
      font-size: var(--day-font); background:#fff;
    }
    .cabecalho{
      background:#f2f2f2; font-weight:700; display:flex; align-items:center; justify-content:center;
      font-size:11px;
    }
    .dia .numero{
      font-weight:700; color:#444; margin-bottom:2px;
    }
    .semana-atual{ box-shadow: inset 0 0 0 2px #ffe0b2; }
    .dia-indisponivel{ background:#f9f9f9; border:2px dashed #d9534f; }
    .motivo-indisponivel{ font-size:8px; color:#d9534f; margin:2px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .evento-dia{
      margin-top:2px; background: var(--accent); color:#fff; border-radius:4px;
      padding:2px 4px; font-size: var(--event-font); display:flex; align-items:center; justify-content:space-between;
      min-height:16px;
    }
    .evento-dia span.label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .botao-duplicar{ margin-left:6px; font-size:11px; cursor:pointer; }

    /* ---- RodapÃ© botÃ£o ---- */
    .rodape-acoes{ margin-top:8px; text-align:center; height:var(--botao-h); }

    /* ---- Responsivo: em telas menores, empilha KPIs ---- */
    @media (max-width: 980px){
      .kpi-wrap{ grid-template-columns: repeat(2, minmax(0,1fr)); height: calc(var(--kpi-h) * 2 + var(--gap)); }
      :root{ --chrome: calc((var(--kpi-h)*2 + var(--gap)) + var(--header-h) + var(--botao-h) + 40px); }
    }
    @media (max-width: 640px){
      .kpi-wrap{ grid-template-columns: 1fr; height: calc(var(--kpi-h)*4 + var(--gap)*3); }
      :root{ --chrome: calc((var(--kpi-h)*4 + var(--gap)*3) + var(--header-h) + var(--botao-h) + 40px); }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <div class="card-dashboard">

        <!-- KPIs -->
        <section class="kpi-wrap">
          <div class="kpi">
            <small>Vendas Real MÃªs Anterior</small>
            <strong id="kpiRealAnterior">â€”</strong>
          </div>
          <div class="kpi">
            <small>Vendas Real MÃªs</small>
            <strong id="kpiRealAtual">â€”</strong>
          </div>
          <div class="kpi">
            <small>Venda Prevista MÃªs</small>
            <strong id="kpiPrevistaAtual">â€”</strong>
          </div>
          <div class="kpi">
            <small>Venda Prevista PrÃ³x. MÃªs</small>
            <strong id="kpiPrevistaProx">â€”</strong>
          </div>
        </section>

        <!-- NavegaÃ§Ã£o -->
        <div class="topbar">
          <button class="btn-navegar" onclick="mudarMes(-1)">&#8592; MÃªs Anterior</button>
          <span id="mesAtual">MÃªs Atual</span>
          <button class="btn-navegar" onclick="mudarMes(1)">MÃªs Seguinte &#8594;</button>
        </div>

        <!-- CalendÃ¡rio -->
        <div class="calendario" id="calendario"></div>

        <!-- AÃ§Ãµes -->
        <div class="rodape-acoes">
          <button class="btn-navegar" onclick="duplicarMes()">ðŸ“… Duplicar MÃªs</button>
        </div>
      </div>
    </main>
  </div>

  <script src="assets/menu.js" defer></script>
  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Estado =====
    let mesAtual = new Date();
    let eventos = [];
    let mapaIndisponiveis = {};

    // ===== Utils =====
    const pad2 = (n)=> String(n).padStart(2,'0');
    const ym = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

    function mudarMes(delta){
      mesAtual.setMonth(mesAtual.getMonth() + delta);
      carregarDados();
    }

    // ===== Carga =====
    async function carregarDados(){
      // Eventos
      const eventosSnap = await db.ref('eventos').once('value');
      eventos = [];
      eventosSnap.forEach(child=>{
        const ev = child.val(); ev.id = child.key; eventos.push(ev);
      });

      // IndisponÃ­veis
      const indisSnap = await db.ref('configuracao/diasIndisponiveis').once('value');
      mapaIndisponiveis = {};
      indisSnap.forEach(child=>{
        const item = child.val();
        if (item?.tipo === 'Ãºnico' && item?.data){
          mapaIndisponiveis[item.data] = item.motivo || 'IndisponÃ­vel';
        } else if (item?.tipo === 'perÃ­odo' && item?.inicio && item?.fim){
          const ini = new Date(item.inicio), fim = new Date(item.fim);
          for (let d=new Date(ini); d<=fim; d.setDate(d.getDate()+1)){
            const s = d.toISOString().split('T')[0];
            mapaIndisponiveis[s] = item.motivo || 'IndisponÃ­vel';
          }
        }
      });

      atualizarInterface();
      atualizarKPIs();
    }

    function atualizarInterface(){
      // Nome do mÃªs
      document.getElementById('mesAtual').textContent =
        mesAtual.toLocaleString('pt-BR', { month:'long', year:'numeric' });

      renderizarCalendario();
    }

    function renderizarCalendario(){
      const cal = document.getElementById('calendario');
      cal.innerHTML = '';

      // CabeÃ§alho (fixo fora das 6 linhas)
      const cab = ['DOM','S','T','Q','Q','S','SAB'];
      cab.forEach(txt=>{
        const div = document.createElement('div');
        div.className = 'dia cabecalho';
        div.textContent = txt;
        cal.appendChild(div);
      });

      const ano = mesAtual.getFullYear();
      const mes = mesAtual.getMonth();
      const primeiro = new Date(ano, mes, 1);
      const ultimo = new Date(ano, mes+1, 0);
      const offset = primeiro.getDay(); // 0=Dom

      // Preenche dias: always 6 weeks (42 boxes)
      const totalBoxes = 42;
      const prevDays = offset;
      const daysInMonth = ultimo.getDate();

      // Dias anteriores (em branco)
      for (let i=0; i<prevDays; i++) cal.appendChild(document.createElement('div'));

      // Semana atual (segunda a domingo)
      const semanaAtual = getSemanaAtualISO();

      // Dias do mÃªs
      for (let dia=1; dia<=daysInMonth; dia++){
        const data = new Date(ano, mes, dia);
        const dataStr = data.toISOString().split('T')[0];

        const box = document.createElement('div');
        box.classList.add('dia');
        box.dataset.data = dataStr;

        if (semanaAtual.includes(dataStr)) box.classList.add('semana-atual');
        if (mapaIndisponiveis[dataStr]) box.classList.add('dia-indisponivel');

        box.addEventListener('dragover', e=>e.preventDefault());
        box.addEventListener('drop', onDropMoverEvento);

        const numero = document.createElement('div');
        numero.className = 'numero';
        numero.textContent = dia;
        box.appendChild(numero);

        if (mapaIndisponiveis[dataStr]){
          const motivo = document.createElement('div');
          motivo.className = 'motivo-indisponivel';
          motivo.textContent = mapaIndisponiveis[dataStr];
          box.appendChild(motivo);
        }

        // Eventos do dia
        eventos.filter(ev => ev.data === dataStr).forEach(ev=>{
          const eventoDiv = document.createElement('div');
          eventoDiv.className = 'evento-dia';
          eventoDiv.setAttribute('draggable', true);
          eventoDiv.dataset.eventoId = ev.id;

          const label = document.createElement('span');
          label.className = 'label';
          label.textContent = ev.nomeEvento || 'Sem nome';

          const dup = document.createElement('span');
          dup.className = 'botao-duplicar';
          dup.title = 'Duplicar Evento';
          dup.textContent = 'âž•';
          dup.onclick = ()=>duplicarEvento(ev);

          eventoDiv.appendChild(label);
          eventoDiv.appendChild(dup);

          eventoDiv.addEventListener('dragstart', e=>{
            e.dataTransfer.setData('eventoId', ev.id);
          });

          box.appendChild(eventoDiv);
        });

        cal.appendChild(box);
      }

      // Dias posteriores (em branco) para fechar 42
      const used = prevDays + daysInMonth;
      for (let i=used; i<42; i++) cal.appendChild(document.createElement('div'));
    }

    function onDropMoverEvento(e){
      const eventoId = e.dataTransfer.getData('eventoId');
      const novaData = this.dataset.data;
      if (!eventoId || !novaData) return;

      db.ref(`eventos/${eventoId}`).update({ data: novaData })
        .then(()=>{ alert("Evento movido para " + novaData); carregarDados(); })
        .catch(err=> alert("Erro ao mover evento: " + err.message));
    }

    function getSemanaAtualISO(){
      const hoje = new Date();
      const dow = hoje.getDay();      // 0..6 (Dom..SÃ¡b)
      const inicio = new Date(hoje);
      // comeÃ§ar segunda (1); alinhar segunda-domingo
      const delta = (dow === 0 ? -6 : 1 - dow);
      inicio.setDate(hoje.getDate() + delta);
      const out = [];
      for (let i=0; i<7; i++){
        const d = new Date(inicio); d.setDate(inicio.getDate()+i);
        out.push(d.toISOString().split('T')[0]);
      }
      return out;
    }

    async function duplicarEvento(ev){
      if(!confirm("Deseja duplicar este evento?")) return;
      const novo = { ...ev }; delete novo.id;
      await db.ref('eventos').push(novo);
      alert("Evento duplicado com sucesso!");
      carregarDados();
    }

    async function duplicarMes(){
      if (!confirm("Deseja realmente duplicar todos os eventos do mÃªs para o mÃªs seguinte?")) return;

      const ano = mesAtual.getFullYear();
      const mes = mesAtual.getMonth();

      const eventosDoMes = eventos.filter(ev=>{
        const d = new Date(ev.data);
        return d.getMonth() === mes && d.getFullYear() === ano;
      });

      const tasks = eventosDoMes.map(ev=>{
        const nova = new Date(ev.data);
        nova.setMonth(nova.getMonth()+1);
        const ultimoNovo = new Date(nova.getFullYear(), nova.getMonth()+1, 0).getDate();
        if (nova.getDate() > ultimoNovo) nova.setDate(ultimoNovo);

        const novoEvento = { ...ev };
        delete novoEvento.id;
        novoEvento.data = nova.toISOString().split('T')[0];
        novoEvento.status = 'aberto';

        delete novoEvento.vendaPDV;
        if (novoEvento.produtos){
          novoEvento.produtos = novoEvento.produtos.map(p=>{
            const { congelado, assado, perda, ...rest } = p;
            return rest;
          });
        }
        return db.ref('eventos').push(novoEvento);
      });

      await Promise.all(tasks);
      alert("Eventos duplicados com sucesso!");
      carregarDados();
    }

    // ===== KPIs =====
    async function atualizarKPIs(){
      const atualYM = ym(mesAtual);
      const prevDate = new Date(mesAtual); prevDate.setMonth(prevDate.getMonth()-1);
      const nextDate = new Date(mesAtual); nextDate.setMonth(nextDate.getMonth()+1);
      const prevYM = ym(prevDate);
      const nextYM = ym(nextDate);

      // Real mÃªs atual e anterior (somatÃ³rio dos eventos)
      const somaReal = (ymStr)=>{
        let total = 0;
        eventos.forEach(ev=>{
          if (!ev?.data) return;
          const d = new Date(ev.data);
          const str = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
          if (str === ymStr){
            const v = Number(ev.totalVendasEvento ?? ev.totalVendas ?? 0);
            if (!isNaN(v)) total += v;
          }
        });
        return total;
      };

      const realAtual = somaReal(atualYM);
      const realAnterior = somaReal(prevYM);

      // PrevisÃ£o mÃªs atual e prÃ³ximo: /previsao_receita/{AAAA-MM}/total
      const lerPrev = async (ymKey)=>{
        const snap = await db.ref(`previsao_receita/${ymKey}/total`).once('value');
        const v = Number(snap.val() ?? 0);
        return isNaN(v) ? 0 : v;
      };
      const [prevAtual, prevProx] = await Promise.all([ lerPrev(atualYM), lerPrev(nextYM) ]);

      // Atualiza tela
      const brl = (n)=> n.toLocaleString('pt-BR', { style:'currency', currency:'BRL', maximumFractionDigits:0 });
      document.getElementById('kpiRealAnterior').textContent = brl(realAnterior);
      document.getElementById('kpiRealAtual').textContent    = brl(realAtual);
      document.getElementById('kpiPrevistaAtual').textContent= brl(prevAtual);
      document.getElementById('kpiPrevistaProx').textContent = brl(prevProx);
    }

    document.addEventListener('DOMContentLoaded', carregarDados);
  </script>
</body>
</html>
