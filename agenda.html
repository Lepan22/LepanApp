<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agend a</title>
  <link rel="stylesheet" href="assets/base.css">
  <link rel="stylesheet" href="assets/menu-styles.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root{
      --brand:#ff7f00;
      --line:#e7e7ea;
      --muted:#6b7280;

      --gap:6px;
      --fontDay:11px;
      --fontEvt:10px;
      --padDay:4px;

      /* serÃ¡ definida via JS p/ caber na viewport */
      --rowH: 120px;
    }

    body{background:#f6f7f9;margin:0;color:#222}

    .wrap{padding:10px}

    /* KPIs compactos */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin-bottom:var(--gap)}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;justify-content:center;min-height:52px}
    .kpi small{color:var(--muted);font-size:11px;font-weight:600}
    .kpi strong{font-size:16px;margin-top:2px}

    /* NavegaÃ§Ã£o */
    .topbar{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:var(--gap)}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    #mesAtual{font-weight:700;text-transform:capitalize}

    /* CabeÃ§alho DOM..SAB */
    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px}
    .dow div{background:#fff;border:1px solid var(--line);border-radius:8px;text-align:center;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;min-height:24px}

    /* Grade do mÃªs â€“ 6 semanas ajustadas por JS */
    .grid{
      display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
      grid-auto-rows: var(--rowH);
      min-height: calc(var(--rowH) * 6 + 5 * 4px); /* 6 linhas + gaps */
    }

    .day{
      background:#fff;border:1px solid var(--line);border-radius:10px;
      padding:var(--padDay);display:flex;flex-direction:column;overflow:hidden;font-size:var(--fontDay)
    }
    .n{font-weight:700;margin-bottom:2px}
    .is-week{box-shadow: inset 0 0 0 2px #ffe0b2}
    .is-blocked{background:#fafafa;border-style:dashed}
    .blocked{font-size:9px;color:#d9534f;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .evt{
      margin-top:3px;background:var(--brand);color:#fff;border-radius:6px;padding:1px 5px;
      display:flex;align-items:center;justify-content:space-between;font-size:var(--fontEvt);min-height:18px
    }
    .evt .t{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dup{margin-left:6px;cursor:pointer;font-weight:700}

    .foot{display:flex;align-items:center;justify-content:center;margin-top:6px}

    /* Responsivo: se apertar, empilha KPIs */
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 640px){ .kpis{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <div class="wrap card-dashboard" style="border:1px solid #eee;border-radius:10px;background:#fff">
        <!-- KPIs -->
        <section id="kpis" class="kpis">
          <div class="kpi"><small>Vendas Real MÃªs Anterior</small><strong id="kpiRealAnterior">â€”</strong></div>
          <div class="kpi"><small>Vendas Real MÃªs</small><strong id="kpiRealMes">â€”</strong></div>
          <div class="kpi"><small>Venda Prevista MÃªs</small><strong id="kpiPrevMes">â€”</strong></div>
          <div class="kpi"><small>Venda Prevista PrÃ³x. MÃªs</small><strong id="kpiPrevProx">â€”</strong></div>
        </section>

        <!-- NavegaÃ§Ã£o -->
        <div id="nav" class="topbar">
          <button class="btn" onclick="mudarMes(-1)">&#8592; MÃªs Anterior</button>
          <span id="mesAtual">MÃªs Atual</span>
          <button class="btn" onclick="mudarMes(1)">MÃªs Seguinte &#8594;</button>
        </div>

        <!-- CabeÃ§alho dos dias -->
        <div id="dow" class="dow">
          <div>DOM</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>SAB</div>
        </div>

        <!-- CalendÃ¡rio -->
        <div id="grid" class="grid"></div>

        <!-- RodapÃ© -->
        <div id="foot" class="foot">
          <button class="btn" onclick="duplicarMes()">ðŸ“… Duplicar MÃªs</button>
        </div>
      </div>
    </main>
  </div>

  <script src="assets/menu.js" defer></script>
  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Estado =====
    let mesRef = new Date();
    let eventos = [];
    let indis = {};

    // ===== Utils =====
    const pad2 = n => String(n).padStart(2,'0');
    const ym   = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const toISO = d => new Date(d).toISOString().split('T')[0];
    const brl  = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
    const num = v => { if (v==null) return 0; if (typeof v==='number') return v; const s=String(v).replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };

    // ===== Fit-to-viewport (sem scroll) =====
    function ajustarAlturaLinhas(){
      const grid = document.getElementById('grid');
      const vb = document.documentElement.clientHeight;   // altura viewport
      const rectWrap = grid.parentElement.getBoundingClientRect();

      const kpisH = document.getElementById('kpis').getBoundingClientRect().height;
      const navH  = document.getElementById('nav').getBoundingClientRect().height;
      const dowH  = document.getElementById('dow').getBoundingClientRect().height;
      const footH = document.getElementById('foot').getBoundingClientRect().height;

      // margem/padding do container + seguranÃ§a
      const extras = 26; // leve folga

      const disponivel = vb - (rectWrap.top + kpisH + navH + dowH + footH + extras);
      const rowH = Math.max(76, Math.floor((disponivel - (5*4)) / 6)); // 5 gaps de 4px

      grid.style.setProperty('--rowH', rowH + 'px');
    }
    window.addEventListener('resize', ajustarAlturaLinhas);

    // ===== Navegar mÃªs =====
    function mudarMes(delta){
      mesRef.setMonth(mesRef.getMonth()+delta);
      carregar();
    }

    // ===== Carga =====
    async function carregar(){
      // eventos
      const snap = await db.ref('eventos').once('value');
      eventos = [];
      snap.forEach(ch=>{ const v=ch.val(); v.id=ch.key; eventos.push(v); });

      // indisponÃ­veis
      const iSnap = await db.ref('configuracao/diasIndisponiveis').once('value');
      indis = {};
      iSnap.forEach(ch=>{
        const it=ch.val();
        if (it?.tipo==='Ãºnico' && it?.data) {
          indis[it.data]=it.motivo||'IndisponÃ­vel';
        } else if (it?.tipo==='perÃ­odo' && it?.inicio && it?.fim){
          const i=new Date(it.inicio), f=new Date(it.fim);
          for(let d=new Date(i); d<=f; d.setDate(d.getDate()+1)){
            indis[toISO(d)] = it.motivo||'IndisponÃ­vel';
          }
        }
      });

      desenhar();
      atualizarKPIs();
      ajustarAlturaLinhas(); // chama apÃ³s render
    }

    // ===== CalendÃ¡rio =====
    function desenhar(){
      document.getElementById('mesAtual').textContent =
        mesRef.toLocaleString('pt-BR',{month:'long',year:'numeric'});

      const grid = document.getElementById('grid');
      grid.innerHTML='';

      const ano = mesRef.getFullYear();
      const mes = mesRef.getMonth();
      const first = new Date(ano, mes, 1);
      const last  = new Date(ano, mes+1, 0);
      const offset = first.getDay(); // 0..6 (Dom..SÃ¡b)
      const daysInMonth = last.getDate();

      // espaÃ§os iniciais antes do dia 1
      for (let i=0;i<offset;i++) grid.appendChild(document.createElement('div'));

      const semanaAtual = semanaSegADom();

      // dias do mÃªs
      for (let d=1; d<=daysInMonth; d++){
        const data = new Date(ano,mes,d);
        const iso = toISO(data);

        const el = document.createElement('div');
        el.className='day';
        el.dataset.data=iso;

        if (semanaAtual.includes(iso)) el.classList.add('is-week');
        if (indis[iso]) el.classList.add('is-blocked');

        el.addEventListener('dragover', e=>e.preventDefault());
        el.addEventListener('drop', onDropMove);

        const nEl = document.createElement('div');
        nEl.className='n'; nEl.textContent=d;
        el.appendChild(nEl);

        if (indis[iso]){
          const b = document.createElement('div');
          b.className='blocked'; b.textContent=indis[iso];
          el.appendChild(b);
        }

        eventos.filter(ev=>ev.data===iso).forEach(ev=>{
          const evt = document.createElement('div');
          evt.className='evt';
          evt.draggable=true;
          evt.dataset.eventoId=ev.id;

          const t = document.createElement('span');
          t.className='t'; t.textContent=ev.nomeEvento || 'Sem nome';

          const dup = document.createElement('span');
          dup.className='dup'; dup.title='Duplicar'; dup.textContent='ï¼‹';
          dup.onclick = ()=>duplicarEvento(ev);

          evt.appendChild(t); evt.appendChild(dup);
          evt.addEventListener('dragstart', e=> e.dataTransfer.setData('eventoId', ev.id));
          el.appendChild(evt);
        });

        grid.appendChild(el);
      }

      // completa atÃ© 42 boxes
      const usados = offset + daysInMonth;
      for (let i=usados;i<42;i++) grid.appendChild(document.createElement('div'));
    }

    function onDropMove(e){
      const id = e.dataTransfer.getData('eventoId');
      const data = this.dataset.data;
      if (!id || !data) return;
      db.ref(`eventos/${id}`).update({data})
        .then(()=>carregar())
        .catch(err=>alert('Erro ao mover: '+err.message));
    }

    function semanaSegADom(){
      const hoje = new Date();
      const dw = hoje.getDay(); // 0..6
      const inicio = new Date(hoje);
      const delta = (dw===0 ? -6 : 1-dw);
      inicio.setDate(hoje.getDate()+delta);
      const out=[];
      for(let i=0;i<7;i++){const d=new Date(inicio);d.setDate(inicio.getDate()+i);out.push(toISO(d));}
      return out;
    }

    async function duplicarEvento(ev){
      if(!confirm('Duplicar este evento?')) return;
      const novo={...ev}; delete novo.id;
      await db.ref('eventos').push(novo);
      carregar();
    }

    async function duplicarMes(){
      if(!confirm('Duplicar todos os eventos do mÃªs para o prÃ³ximo?')) return;

      const ano=mesRef.getFullYear(), mes=mesRef.getMonth();
      const doMes = eventos.filter(ev=>{
        const d=new Date(ev.data);
        return d.getMonth()===mes && d.getFullYear()===ano;
      });

      await Promise.all(doMes.map(ev=>{
        const nova = new Date(ev.data); nova.setMonth(nova.getMonth()+1);
        const ultimoNovo = new Date(nova.getFullYear(), nova.getMonth()+1, 0).getDate();
        if (nova.getDate()>ultimoNovo) nova.setDate(ultimoNovo);

        const n={...ev}; delete n.id;
        n.data = toISO(nova); n.status='Aberto';
        delete n.vendaPDV;
        if (n.produtos){ n.produtos = n.produtos.map(p=>{ const {congelado,assado,perda,...r}=p; return r; }); }
        return db.ref('eventos').push(n);
      }));

      carregar();
    }

    // ===== KPIs =====
    function atualizarKPIs(){
      const atualYM = ym(mesRef);
      const dAnt = new Date(mesRef); dAnt.setMonth(dAnt.getMonth()-1);
      const dProx= new Date(mesRef); dProx.setMonth(dProx.getMonth()+1);
      const antYM  = ym(dAnt);
      const proxYM = ym(dProx);

      const dentroYM = (e, ymKey)=>{
        if(!e?.data) return false;
        const d = new Date(e.data);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        return key === ymKey;
      };

      const isFechado = (e)=>{
        const s = String(e.status||'').toLowerCase();
        return s==='fechado' || s==='finalizado';
      };

      const realAtual    = eventos.filter(e=>dentroYM(e, atualYM) && isFechado(e))
                                  .reduce((s,e)=> s + num(e.vendaPDV), 0);
      const realAnterior = eventos.filter(e=>dentroYM(e, antYM) && isFechado(e))
                                  .reduce((s,e)=> s + num(e.vendaPDV), 0);

      const prevMes  = eventos.filter(e=>dentroYM(e, atualYM))
                              .reduce((s,e)=> s + num(e.estimativaVenda), 0);
      const prevProx = eventos.filter(e=>dentroYM(e, proxYM))
                              .reduce((s,e)=> s + num(e.estimativaVenda), 0);

      document.getElementById('kpiRealAnterior').textContent = brl(realAnterior);
      document.getElementById('kpiRealMes').textContent      = brl(realAtual);
      document.getElementById('kpiPrevMes').textContent      = brl(prevMes);
      document.getElementById('kpiPrevProx').textContent     = brl(prevProx);
    }

    document.addEventListener('DOMContentLoaded', carregar);
  </script>
</body>
</html>
