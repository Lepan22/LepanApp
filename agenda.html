<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda</title>
  <link rel="stylesheet" href="assets/base.css">
  <link rel="stylesheet" href="assets/menu-styles.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    :root{
      --brand:#ff7f00;
      --bg:#f5f6f8;
      --line:#e8e9ed;
      --text:#2a2d34;
      --muted:#6b7280;
      --kpiH:74px;
      --navH:44px;
      --footH:36px;
      --g:8px;
      --dayPad:6px;
      --eventSize:11px;
    }
    html,body{height:100%;}
    body{background:var(--bg); color:var(--text); margin:0;}

    .card {background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 1px 4px rgba(16,24,40,.05)}

    /* KPIs */
    .kpi-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:var(--g);margin-bottom:var(--g);height:var(--kpiH)}
    .kpi{padding:10px 12px;border-radius:10px}
    .kpi small{display:block;color:var(--muted);font-weight:600}
    .kpi strong{display:block;font-size:18px;margin-top:4px}

    /* NavegaÃ§Ã£o */
    .topnav{display:flex;align-items:center;justify-content:center;gap:10px;height:var(--navH);margin-bottom:var(--g)}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 12px;font-size:12px;cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    #mesAtual{font-weight:700;text-transform:capitalize}

    /* CabeÃ§alho dias da semana */
    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:6px 0}
    .dow div{background:#fff;border:1px solid var(--line);border-radius:8px;text-align:center;font-weight:700;padding:8px 0}

    /* Grade do mÃªs (6 semanas fixas, ocupa a viewport sem rolar) */
    .grid{
      display:grid;grid-template-columns:repeat(7,1fr);gap:6px;
      grid-auto-rows: calc( (100vh - (var(--kpiH)+var(--navH)+var(--footH)+100px)) / 6 );
      /* 100px ~ margem/cabecalho/espacamentos do container */
      min-height:calc( (100vh - (var(--kpiH)+var(--navH)+var(--footH)+100px)) );
    }
    .day{
      background:#fff;border:1px solid var(--line);border-radius:10px;
      padding:var(--dayPad);display:flex;flex-direction:column;overflow:hidden
    }
    .day .n{font-weight:700;color:#111;margin-bottom:4px}
    .is-week{box-shadow: inset 0 0 0 2px #ffe0b2}
    .is-blocked{background:#fafafa;border-style:dashed}
    .blocked-msg{font-size:10px;color:#d9534f;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .evt{
      margin-top:4px;background:var(--brand);color:#fff;border-radius:6px;padding:2px 6px;
      display:flex;align-items:center;justify-content:space-between;font-size:var(--eventSize);min-height:20px
    }
    .evt .t{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dup{margin-left:8px;cursor:pointer;font-weight:700}

    .foot{height:var(--footH);display:flex;justify-content:center;align-items:center;margin-top:8px}

    /* Responsivo */
    @media (max-width: 980px){ .kpi-row{grid-template-columns:repeat(2,1fr); height:calc(var(--kpiH)*2 + var(--g)); } }
    @media (max-width: 640px){ .kpi-row{grid-template-columns:1fr; height:calc(var(--kpiH)*4 + var(--g)*3);} }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi card"><small>Vendas Real MÃªs Anterior</small><strong id="kpiRealAnt">â€”</strong></div>
        <div class="kpi card"><small>Vendas Real MÃªs</small><strong id="kpiRealMes">â€”</strong></div>
        <div class="kpi card"><small>Venda Prevista MÃªs</small><strong id="kpiPrevMes">â€”</strong></div>
        <div class="kpi card"><small>Venda Prevista PrÃ³x. MÃªs</small><strong id="kpiPrevProx">â€”</strong></div>
      </div>

      <!-- NavegaÃ§Ã£o -->
      <div class="topnav">
        <button class="btn" onclick="mudarMes(-1)">&#8592; MÃªs Anterior</button>
        <span id="mesAtual">MÃªs Atual</span>
        <button class="btn" onclick="mudarMes(1)">MÃªs Seguinte &#8594;</button>
      </div>

      <!-- CabeÃ§alho dos dias -->
      <div class="dow">
        <div>DOM</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>SAB</div>
      </div>

      <!-- CalendÃ¡rio -->
      <div class="grid" id="grid"></div>

      <div class="foot">
        <button class="btn" onclick="duplicarMes()">ðŸ“… Duplicar MÃªs</button>
      </div>
    </main>
  </div>

  <script src="assets/menu.js" defer></script>
  <script>
    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Estado ===
    let mesRef = new Date();
    let eventos = [];
    let indis = {};

    // === Utils ===
    const pad2 = n => String(n).padStart(2,'0');
    const ym   = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const brl  = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
    const toISO = d => new Date(d).toISOString().split('T')[0];
    const parseNumber = v => {
      if (v==null) return 0;
      if (typeof v==='number') return v;
      const s = String(v).replace(/\./g,'').replace(',','.');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    };
    const vendaDoEvento = ev => {
      // cobre diferentes nomes/casos
      const cands = [
        ev.totalVendasEvento,
        ev.totalVendas,
        ev.vendaReal,
        ev.financeiro && ev.financeiro.totalVendasEvento,
        ev.financeiro && ev.financeiro.totalVendas
      ];
      for (const c of cands) {
        const n = parseNumber(c);
        if (n>0) return n;
      }
      return 0;
    };

    // === NavegaÃ§Ã£o ===
    function mudarMes(delta){
      mesRef.setMonth(mesRef.getMonth()+delta);
      carregar();
    }

    // === Carga principal ===
    async function carregar(){
      // eventos
      const snap = await db.ref('eventos').once('value');
      eventos = [];
      snap.forEach(ch=>{ const v=ch.val(); v.id=ch.key; eventos.push(v); });

      // indisponÃ­veis
      const iSnap = await db.ref('configuracao/diasIndisponiveis').once('value');
      indis={};
      iSnap.forEach(ch=>{
        const it=ch.val();
        if (it?.tipo==='Ãºnico' && it?.data) {
          indis[it.data]=it.motivo||'IndisponÃ­vel';
        } else if (it?.tipo==='perÃ­odo' && it?.inicio && it?.fim){
          const i=new Date(it.inicio), f=new Date(it.fim);
          for(let d=new Date(i); d<=f; d.setDate(d.getDate()+1)){
            indis[toISO(d)] = it.motivo||'IndisponÃ­vel';
          }
        }
      });

      desenhar();
      atualizarKPIs();
    }

    function desenhar(){
      document.getElementById('mesAtual').textContent =
        mesRef.toLocaleString('pt-BR',{month:'long',year:'numeric'});

      const grid = document.getElementById('grid');
      grid.innerHTML='';

      const ano = mesRef.getFullYear();
      const mes = mesRef.getMonth();
      const first = new Date(ano, mes, 1);
      const last  = new Date(ano, mes+1, 0);

      const offset = first.getDay(); // 0..6
      const daysInMonth = last.getDate();

      // espaÃ§os iniciais atÃ© o 1Âº dia
      for (let i=0;i<offset;i++) grid.appendChild(document.createElement('div'));

      const semanaAtual = semanaISO();

      // dias do mÃªs
      for (let d=1; d<=daysInMonth; d++){
        const data = new Date(ano,mes,d);
        const iso = toISO(data);

        const el = document.createElement('div');
        el.className='day card';
        if (semanaAtual.includes(iso)) el.classList.add('is-week');
        if (indis[iso]) el.classList.add('is-blocked');
        el.dataset.data=iso;
        el.addEventListener('dragover', e=>e.preventDefault());
        el.addEventListener('drop', onDropMove);

        const n = document.createElement('div');
        n.className='n'; n.textContent=d;
        el.appendChild(n);

        if (indis[iso]){
          const m = document.createElement('div');
          m.className='blocked-msg'; m.textContent=indis[iso];
          el.appendChild(m);
        }

        eventos.filter(ev=>ev.data===iso).forEach(ev=>{
          const evt = document.createElement('div');
          evt.className='evt';
          evt.draggable=true;
          evt.dataset.eventoId=ev.id;

          const t = document.createElement('span');
          t.className='t'; t.textContent=ev.nomeEvento || 'Sem nome';

          const dup = document.createElement('span');
          dup.className='dup'; dup.title='Duplicar evento'; dup.textContent='ï¼‹';
          dup.onclick = ()=>duplicarEvento(ev);

          evt.appendChild(t); evt.appendChild(dup);

          evt.addEventListener('dragstart', e=> e.dataTransfer.setData('eventoId', ev.id));
          el.appendChild(evt);
        });

        grid.appendChild(el);
      }

      // completa atÃ© 42
      const usados = offset + daysInMonth;
      for (let i=usados; i<42; i++) grid.appendChild(document.createElement('div'));
    }

    function onDropMove(e){
      const id = e.dataTransfer.getData('eventoId');
      const data = this.dataset.data;
      if (!id || !data) return;
      db.ref(`eventos/${id}`).update({data})
        .then(()=>carregar())
        .catch(err=>alert('Erro ao mover: '+err.message));
    }

    function semanaISO(){
      const hoje=new Date();
      const dw=hoje.getDay();
      const inicio = new Date(hoje);
      const delta = (dw===0? -6 : 1-dw);
      inicio.setDate(hoje.getDate()+delta);
      const out=[];
      for(let i=0;i<7;i++){const d=new Date(inicio);d.setDate(inicio.getDate()+i);out.push(toISO(d));}
      return out;
    }

    async function duplicarEvento(ev){
      if(!confirm('Duplicar este evento?')) return;
      const novo={...ev}; delete novo.id;
      await db.ref('eventos').push(novo);
      carregar();
    }

    async function duplicarMes(){
      if(!confirm('Duplicar todos os eventos do mÃªs para o prÃ³ximo?')) return;

      const ano=mesRef.getFullYear(), mes=mesRef.getMonth();
      const doMes = eventos.filter(ev=>{
        const d=new Date(ev.data);
        return d.getMonth()===mes && d.getFullYear()===ano;
      });

      await Promise.all(doMes.map(ev=>{
        const nova = new Date(ev.data); nova.setMonth(nova.getMonth()+1);
        const ultimoNovo = new Date(nova.getFullYear(), nova.getMonth()+1, 0).getDate();
        if (nova.getDate()>ultimoNovo) nova.setDate(ultimoNovo);

        const n={...ev}; delete n.id;
        n.data = toISO(nova); n.status='aberto';
        delete n.vendaPDV;
        if (n.produtos){ n.produtos = n.produtos.map(p=>{const {congelado,assado,perda,...r}=p;return r;}); }
        return db.ref('eventos').push(n);
      }));

      carregar();
    }

    // === KPIs ===
    async function atualizarKPIs(){
      const ymAtual = ym(mesRef);
      const dAnt = new Date(mesRef); dAnt.setMonth(dAnt.getMonth()-1);
      const dProx= new Date(mesRef); dProx.setMonth(dProx.getMonth()+1);
      const ymAnt = ym(dAnt);
      const ymProx= ym(dProx);

      const somaMes = (ymKey)=>{
        let tot=0;
        eventos.forEach(ev=>{
          if(!ev?.data) return;
          const d=new Date(ev.data);
          const key=`${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
          if(key===ymKey) tot += vendaDoEvento(ev);
        });
        return tot;
      };

      const realAnt  = somaMes(ymAnt);
      const realAtu  = somaMes(ymAtual);

      const previsao = async (ymKey)=>{
        const s = await db.ref(`previsao_receita/${ymKey}/total`).once('value');
        return parseNumber(s.val());
      };

      const [prevAtu, prevProx] = await Promise.all([previsao(ymAtual), previsao(ymProx)]);

      document.getElementById('kpiRealAnt').textContent = brl(realAnt);
      document.getElementById('kpiRealMes').textContent = brl(realAtu);
      document.getElementById('kpiPrevMes').textContent = brl(prevAtu);
      document.getElementById('kpiPrevProx').textContent = brl(prevProx);
    }

    document.addEventListener('DOMContentLoaded', carregar);
  </script>
</body>
</html>
