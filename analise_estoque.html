<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Análise de Estoque</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --card-gap: 10px;
    --card-pad: 10px;
    --kpi-h: 64px;
    --chart-h: 220px;
    --muted: #6b7280;
  }
  .main-content{ padding:16px 20px; }

  .page-header h1{ margin:6px 0 6px; }
  .page-header p{ margin:0 0 10px; color:#667085; font-size:12.5px; }

  .quick-links{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
  .quick-links a{
    display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px;
    background:#fff; color:#111827; text-decoration:none; font-size:12.5px;
  }
  .quick-links a:hover{ background:#f9fafb; }

  .filters{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  .filters label{ font-size:12.5px; color:#374151 }
  .filters select{ padding:6px 8px; font-size:12.5px }
  .filters .inline{ display:flex; gap:8px; align-items:center; }

  .grid{ display:grid; gap:var(--card-gap); }
  .grid.kpis{ grid-template-columns: repeat(12, 1fr); }
  .grid.two{ grid-template-columns: 7fr 5fr; }
  .grid.full{ grid-template-columns: 1fr; }

  .card{
    background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:var(--card-pad);
  }
  .kpi{
    height:var(--kpi-h);
    display:flex; flex-direction:column; justify-content:center; gap:2px;
  }
  .kpi .label{ color:#475569; font-size:11.5px; line-height:1; }
  .kpi .value{ font-weight:800; font-size:17px; letter-spacing:.2px; line-height:1; }
  .kpi .sub{ color:#64748b; font-size:11px; line-height:1; }

  .num-pos{ color:#065f46 }   /* verde */
  .num-neg{ color:#b91c1c }   /* vermelho */

  .section-title{ font-size:13px; font-weight:700; color:#111827; margin-bottom:6px; }
  .muted{ color: var(--muted); font-size:12px; }

  .chart-box{ height:var(--chart-h); }
  .legend{ display:flex; gap:12px; font-size:12px; color:#374151; margin-top:6px; }
  .dot{ display:inline-block; width:10px; height:10px; border-radius:10px; margin-right:6px; }
  .lg-estoque{ background:#0ea5e9 }
  .lg-compra{ background:#a78bfa }
  .lg-cpv{ background:#f97316 }

  table.sm{ width:100%; border-collapse:collapse; }
  table.sm th, table.sm td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:12.5px; text-align:right; }
  table.sm th:first-child, table.sm td:first-child{ text-align:left; }
  table.sm thead th{ background:#fff7ec; font-weight:700; }

  .diag{ display:none; margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; }
  .diag.warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
  .diag.err{ background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }

  @media(max-width:1100px){
    .grid.kpis{ grid-template-columns: repeat(6, 1fr); }
    .grid.two{ grid-template-columns: 1fr; }
  }
  @media(max-width:700px){
    .grid.kpis{ grid-template-columns: repeat(3, 1fr); }
  }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Análise de Estoque</h1>
      <p>Foco em **estoque, compras e CPV**. Padrão abre no <strong>mês anterior</strong>. Reconciliação: <em>CPV ≈ Compras − ΔEstoque</em>.</p>
      
    </div>

    <section class="filters">
      <label>Ano: <select id="anoSelect"></select></label>
      <label>Mês: <select id="mesSelect"></select></label>
      <div class="inline">
        <label>Janela Cobertura:
          <select id="janelaCob">
            <option value="3">3 meses</option>
            <option value="6">6 meses</option>
            <option value="12" selected>12 meses</option>
          </select>
        </label>
      </div>
      <span class="muted">Cobertura = Estoque final ÷ média CPV da janela (em meses).</span>
    </section>

    <!-- KPIs -->
    <section class="grid kpis" id="kpiGrid">
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Valor de Estoque</div>
        <div class="value" id="kpiEstoque">—</div>
        <div class="sub muted" id="kpiEstoqueVar">Variação vs mês anterior: —</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Compra Produto (mês)</div>
        <div class="value" id="kpiCompras">—</div>
        <div class="sub muted">Categoria "Compras"</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Custo de Produto (mês)</div>
        <div class="value" id="kpiCPV">—</div>
        <div class="sub muted">movimentação.custoProdutoMes</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Contas a Pagar (Compras)</div>
        <div class="value" id="kpiPagarCompras">—</div>
        <div class="sub muted">movimentação.contasPagarCompras</div>
      </div>

      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Cobertura de Estoque</div>
        <div class="value" id="kpiCobertura">—</div>
        <div class="sub muted" id="kpiCoberturaBase">Base: média CPV janela</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Giro (12m)</div>
        <div class="value" id="kpiGiro">—</div>
        <div class="sub muted">= CPV 12m ÷ estoque médio</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Mês analisado</div>
        <div class="value" id="kpiRefMes">—</div>
        <div class="sub muted" id="kpiRefAno">—</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Diferença (CPV − [Compras−ΔEstoque])</div>
        <div class="value" id="kpiReconDiff">—</div>
        <div class="sub muted" id="kpiReconPct">—</div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid two" style="margin-top:10px;">
      <div class="card">
        <div class="section-title">Evolução (12 meses): Estoque × Compras × CPV</div>
        <div class="chart-box">
          <svg id="svg12" viewBox="0 0 1000 340" preserveAspectRatio="none" style="width:100%; height:100%;"></svg>
        </div>
        <div class="legend">
          <span><i class="dot lg-estoque"></i>Estoque (R$)</span>
          <span><i class="dot lg-compra"></i>Compras (R$)</span>
          <span><i class="dot lg-cpv"></i>CPV (R$)</span>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Reconciliação Rápida</div>
        <p class="muted" id="diagRecon">Valida se <em>CPV ≈ Compras − ΔEstoque</em> no mês.</p>
        <table class="sm" id="tblRecon">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Estoque Inicial</th>
              <th>Compras</th>
              <th>Estoque Final</th>
              <th>ΔEstoque</th>
              <th>CPV (fórmula)</th>
              <th>CPV (mov)</th>
              <th>Dif.</th>
              <th>Dif. %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Observações -->
    <section class="grid full" style="margin-top:10px;">
      <div class="card">
        <div class="section-title">Observações</div>
        <ul class="muted" style="margin-top:6px; line-height:1.35;">
          <li>Se faltar algum dado (ex.: estoque inicial), a reconciliação daquele mês ficará parcial.</li>
          <li>CPV (mov) vem de <code>financeiro/movimentacao/{ano}/{mes}/custoProdutoMes</code>.</li>
          <li>Compras vem da categoria “Compras” em <code>financeiro/consolidado</code>.</li>
          <li>Contas a Pagar (Compras) vem de <code>financeiro/movimentacao/{ano}/{mes}/contasPagarCompras</code>.</li>
        </ul>
      </div>
    </section>
  </div>

<script>
(function(){
  const diag = document.getElementById('diag');
  const showDiag = (msg, type="warn") => { diag.className = `diag ${type}`; diag.textContent = msg; diag.style.display = 'block'; };
  const clearDiag = () => { diag.style.display = 'none'; diag.textContent = ''; };

  try{
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  }catch(e){ console.error(e); showDiag('Falha ao inicializar Firebase.', 'err'); }
  const db = firebase.apps.length ? firebase.database() : null;

  // ---------- Utils ----------
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date();
  const mesAtual = hoje.getMonth()+1;
  const anoAtual = hoje.getFullYear();
  const mesPadrao = (mesAtual===1 ? 12 : mesAtual-1);
  const anoPadrao = (mesAtual===1 ? anoAtual-1 : anoAtual);

  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => isNaN(Number(v)) ? 0 : Number(v);
  const perc = v => Number(v||0).toLocaleString('pt-BR',{maximumFractionDigits:1}) + '%';
  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  // ---------- Elements ----------
  const anoSel = document.getElementById('anoSelect');
  const mesSel = document.getElementById('mesSelect');
  const janelaCob = document.getElementById('janelaCob');

  const kpi = {
    est: document.getElementById('kpiEstoque'),
    estVar: document.getElementById('kpiEstoqueVar'),
    comp: document.getElementById('kpiCompras'),
    cpv: document.getElementById('kpiCPV'),
    pagar: document.getElementById('kpiPagarCompras'),
    cob: document.getElementById('kpiCobertura'),
    cobBase: document.getElementById('kpiCoberturaBase'),
    giro: document.getElementById('kpiGiro'),
    refMes: document.getElementById('kpiRefMes'),
    refAno: document.getElementById('kpiRefAno'),
    reconDiff: document.getElementById('kpiReconDiff'),
    reconPct: document.getElementById('kpiReconPct'),
  };

  const svg12 = document.getElementById('svg12');
  const tbodyRecon = document.querySelector('#tblRecon tbody');
  const diagRecon = document.getElementById('diagRecon');

  // ---------- Data ----------
  async function getCategorias(){
    const snap = await db.ref('financeiro/categorias').once('value');
    const v = snap.val() || {};
    const arr = Object.keys(v).map(id => ({ id, nome: v[id]?.nome || '(sem nome)' }));
    return arr;
  }
  async function getCons(ano){
    const snap = await db.ref(`financeiro/consolidado/${ano}`).once('value');
    return snap.val() || {};
  }
  async function getMov(ano){
    const snap = await db.ref(`financeiro/movimentacao/${ano}`).once('value');
    return snap.val() || {};
  }

  // ---------- Helpers ----------
  const arr12 = ()=> Array.from({length:12}, ()=>0);
  const sum = a => a.reduce((x,y)=> x+num(y), 0);

  function findCategoriaIdByName(categorias, alvo){
    const n = norm(alvo);
    const f = categorias.find(c => norm(c.nome) === n);
    return f ? f.id : null;
  }

  function series12m(anoSel, consAno, consPrev, movAno, movPrev, idCompras){
    // Compras (consolidado), CPV (mov), Estoque (mov)
    const compras = arr12(), cpv = arr12(), estoque = arr12(), pagar = arr12();
    // ano atual
    for (let m=1;m<=12;m++){
      const row = consAno?.[m] || {};
      const raw = row?.[idCompras];
      const v = num(raw?.valor ?? raw);
      compras[m-1] = v;

      cpv[m-1] = num(movAno?.[m]?.custoProdutoMes);
      estoque[m-1] = num(movAno?.[m]?.valorEstoque);
      pagar[m-1] = num(movAno?.[m]?.contasPagarCompras);
    }
    return {compras, cpv, estoque, pagar};
  }

  function coberturaMes(estoqueFinal, cpvHist, janela){
    const base = cpvHist.slice(-janela).filter(v=>v!=null).map(num);
    const media = base.length ? sum(base)/base.length : 0;
    const meses = media>0 ? (estoqueFinal/media) : null;
    return {meses, mediaBase: media};
  }

  function giro12m(cpv12, estoque12){
    const cpvTot = sum(cpv12);
    const estValidos = estoque12.filter(v=>v>0);
    if (!estValidos.length) return null;
    // média simples do estoque (se tiver 12 pontos)
    const estMed = sum(estValidos)/estValidos.length;
    return estMed>0 ? (cpvTot/estMed) : null;
  }

  function reconRow(estIni, compras, estFim, cpvMov){
    const delta = estFim - estIni;
    const cpvFormula = compras - delta; // CPV = Compras + EI - EF = Compras - ΔEstoque
    const dif = cpvMov - cpvFormula;
    const base = Math.abs(cpvMov) > 0.0001 ? (dif/cpvMov*100) : null;
    return { delta, cpvFormula, dif, difPct: base };
  }

  function setText(el, txt){ el.textContent = txt; }

  function drawComboChart(labels, estoque, compras, cpv){
    // Simple SVG: barras (compras & cpv) + linha (estoque)
    const W=1000, H=340, padL=40, padR=20, padT=20, padB=50;
    const w = W - padL - padR, h = H - padT - padB;

    const allVals = [...estoque, ...compras, ...cpv].map(v=>Math.abs(num(v)));
    const maxY = Math.max(1, ...allVals);
    const scaleX = (i)=> padL + (i*(w/12)) + (w/24); // 12 barras centradas
    const scaleY = (v)=> padT + (h - (v/maxY)*h);

    let svg = '';
    // grid
    for (let i=0;i<=4;i++){
      const y = padT + (h/4)*i;
      svg += `<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="#f3f4f6" stroke-width="1"/>`;
    }
    // eixo X
    labels.forEach((lb,i)=>{
      const x = scaleX(i);
      svg += `<text x="${x}" y="${H-28}" fill="#6b7280" font-size="10" text-anchor="middle">${lb}</text>`;
    });

    // barras compras (roxo) e cpv (laranja)
    const bw = (w/12)*0.30;
    labels.forEach((_,i)=>{
      const x = scaleX(i);
      const vC = Math.max(0, num(compras[i]));
      const vP = Math.max(0, num(cpv[i]));

      const yC = scaleY(vC), hC = (padT+h) - yC;
      const yP = scaleY(vP), hP = (padT+h) - yP;

      svg += `<rect x="${x-bw-3}" y="${yC}" width="${bw}" height="${hC}" fill="#a78bfa" />`;
      svg += `<rect x="${x+3}"    y="${yP}" width="${bw}" height="${hP}" fill="#f97316" />`;
    });

    // linha estoque (azul)
    const pts = labels.map((_,i)=> [scaleX(i), scaleY(Math.max(0,num(estoque[i])))] );
    const p = pts.map(([x,y])=> x.toFixed(1)+','+y.toFixed(1)).join(' ');
    svg += `<polyline fill="none" stroke="#0ea5e9" stroke-width="2" points="${p}"/>`;

    svg12.innerHTML = svg;
  }

  // ---------- Render ----------
  async function render(){
    clearDiag();

    const ano = Number(anoSel.value);
    const mes = Number(mesSel.value);
    const jan = Number(janelaCob.value);

    const [cats, consAno, consPrev, movAno, movPrev] = await Promise.all([
      getCategorias(), getCons(ano), getCons(ano-1), getMov(ano), getMov(ano-1)
    ]);

    // id da categoria "Compras"
    const idCompras = findCategoriaIdByName(cats, 'compras');

    // séries 12m (do ano selecionado)
    const {compras, cpv, estoque, pagar} = series12m(ano, consAno, consPrev, movAno, movPrev, idCompras);

    // KPIs do mês selecionado
    const estFim = num(estoque[mes-1]);
    const estIni = (mes===1) ? num(movPrev?.[12]?.valorEstoque) : num(movAno?.[mes-1]?.valorEstoque);
    const comprasMes = num(compras[mes-1]);
    const cpvMes = num(cpv[mes-1]);
    const pagarMes = num(pagar[mes-1]);

    setText(kpi.est, estFim ? 'R$ ' + fmt(estFim) : '—');
    const varEst = (estFim && (estIni || estIni===0)) ? (estFim - estIni) : null;
    setText(kpi.estVar, (varEst===null) ? 'Variação vs mês anterior: —' : `Variação vs mês anterior: R$ ${fmt(varEst)} (${varEst>=0?'+':''}${perc(estIni? (varEst/estIni*100):0)})`);

    setText(kpi.comp, comprasMes ? 'R$ ' + fmt(comprasMes) : '—');
    setText(kpi.cpv, cpvMes ? 'R$ ' + fmt(cpvMes) : '—');
    setText(kpi.pagar, pagarMes ? 'R$ ' + fmt(pagarMes) : '—');

    // Cobertura
    const histCPV = [];
    for (let i=1;i<=12;i++) histCPV.push(num(cpv[i-1]));
    const {meses:cobMeses, mediaBase} = coberturaMes(estFim, histCPV.slice(0, mes), jan);
    setText(kpi.cob, (cobMeses!=null && isFinite(cobMeses)) ? cobMeses.toFixed(1)+' meses' : '—');
    setText(kpi.cobBase, 'Base: média CPV '+jan+'m = ' + (mediaBase? 'R$ '+fmt(mediaBase): '—'));

    // Giro (12m)
    // Precisamos de 12 meses (pode incluir ano anterior)
    const cpv12 = [];
    const est12 = [];
    for (let i=1;i<=12;i++){
      cpv12.push(num((i<=mes? movAno : movPrev)?.[i<=mes? i : (i) ]?.custoProdutoMes)); // simplificado; se faltarem meses, virá 0
      est12.push(num((i<=mes? movAno : movPrev)?.[i<=mes? i : (i) ]?.valorEstoque));
    }
    const giro = giro12m(cpv12, est12);
    setText(kpi.giro, (giro!=null && isFinite(giro)) ? giro.toFixed(2)+' x/ano' : '—');

    // Reconciliação (tabela)
    tbodyRecon.innerHTML = '';
    let diagFlag = false;
    for (let m=1;m<=12;m++){
      const eFim = num(estoque[m-1]);
      const eIni = (m===1) ? num(movPrev?.[12]?.valorEstoque) : num(movAno?.[m-1]?.valorEstoque);
      const comp = num(compras[m-1]);
      const cpvm = num(cpv[m-1]);

      const {delta, cpvFormula, dif, difPct} = reconRow(eIni, comp, eFim, cpvm);

      const tr = document.createElement('tr');
      const difOk = (cpvm===0 && Math.abs(cpvFormula) < 1) || (Math.abs(dif) <= Math.max(1, Math.abs(cpvm)*0.1)); // tolerância 10% ou R$1
      if (!difOk) diagFlag = true;

      tr.innerHTML = `
        <td style="text-align:left">${mesesPt[m-1]}</td>
        <td>${(eIni||eIni===0)? 'R$ '+fmt(eIni) : '—'}</td>
        <td>${comp? 'R$ '+fmt(comp) : '—'}</td>
        <td>${eFim? 'R$ '+fmt(eFim) : '—'}</td>
        <td>${(delta||delta===0)? 'R$ '+fmt(delta) : '—'}</td>
        <td>${(cpvFormula||cpvFormula===0)? 'R$ '+fmt(cpvFormula) : '—'}</td>
        <td>${cpvm? 'R$ '+fmt(cpvm) : '—'}</td>
        <td>${(dif||dif===0)? 'R$ '+fmt(dif) : '—'}</td>
        <td>${(difPct!=null && isFinite(difPct))? perc(difPct) : '—'}</td>
      `;
      tbodyRecon.appendChild(tr);
    }
    diagRecon.textContent = diagFlag
      ? 'Atenção: há meses com diferença acima de 10% entre CPV e (Compras − ΔEstoque). Verifique cadastros/lançamentos.'
      : 'OK: reconciliação dentro da tolerância (±10%) em todos os meses com dados.';

    // Gráfico 12m
    drawComboChart(mesesPt, estoque, compras, cpv);

    // Referências
    setText(kpi.refMes, mesesPt[mes-1]);
    setText(kpi.refAno, 'Ano ' + ano);
    // KPI Recon do mês escolhido
    const {delta: dM, cpvFormula: cfM, dif: dfM, difPct: dpM} = reconRow(estIni, comprasMes, estFim, cpvMes);
    setText(kpi.reconDiff, (dfM||dfM===0) ? 'R$ ' + fmt(dfM) : '—');
    setText(kpi.reconPct, (dpM!=null && isFinite(dpM)) ? perc(dpM) : '—');
  }

  async function carregarAnosEMeses(){
    // anos pelo consolidado (ou movimentação se não houver)
    const [cons, mov] = await Promise.all([
      db.ref('financeiro/consolidado').once('value'),
      db.ref('financeiro/movimentacao').once('value')
    ]);
    const anosC = Object.keys(cons.val()||{}).filter(a=>/^\d{4}$/.test(a)).map(Number);
    const anosM = Object.keys(mov.val()||{}).filter(a=>/^\d{4}$/.test(a)).map(Number);
    const anos = Array.from(new Set([...anosC, ...anosM])).sort((a,b)=>a-b);

    anoSel.innerHTML = '';
    if (!anos.length){
      const opt=document.createElement('option'); opt.value=anoPadrao; opt.textContent=anoPadrao; anoSel.appendChild(opt);
    }else{
      anos.forEach(a=>{
        const opt=document.createElement('option'); opt.value=a; opt.textContent=a; anoSel.appendChild(opt);
      });
      anoSel.value = String(anos.includes(anoPadrao)? anoPadrao : anos[anos.length-1]);
    }

    mesSel.innerHTML = '';
    for (let m=1;m<=12;m++){
      const opt=document.createElement('option'); opt.value=m; opt.textContent=(m.toString().padStart(2,'0'))+' - '+mesesPt[m-1];
      mesSel.appendChild(opt);
    }
    mesSel.value = String(mesPadrao);
    // se caiu em ano diferente do padrão, ficar em dez
    if (Number(anoSel.value)!==anoPadrao && mesPadrao!==12) { mesSel.value = '12'; }
  }

  anoSel.addEventListener('change', render);
  mesSel.addEventListener('change', render);
  janelaCob.addEventListener('change', render);

  (async function init(){
    await carregarAnosEMeses();
    await render();
  })();
})();
</script>
</body>
</html>
