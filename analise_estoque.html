<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Análise de Estoque</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --card-gap: 10px;
    --card-pad: 10px;
    --muted: #6b7280;
  }
  .main-content{ padding:16px 20px; }
  .page-header h1{ margin:6px 0 6px; }
  .page-header p{ margin:0 0 10px; color:#667085; font-size:12.5px; }

  .grid{ display:grid; gap:var(--card-gap); }
  .grid.kpis{ grid-template-columns: repeat(12, 1fr); }
  .grid.two{ grid-template-columns: 7fr 5fr; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:var(--card-pad); }

  .section-title{ font-size:13px; font-weight:700; color:#000; margin-bottom:6px; } /* <-- preto */
  .muted{ color: var(--muted); font-size:12px; }
  table.sm{ width:100%; border-collapse:collapse; }
  table.sm th, table.sm td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:12.5px; text-align:right; }
  table.sm th:first-child, table.sm td:first-child{ text-align:left; }
  table.sm thead th{ background:#fff7ec; font-weight:700; }

  .diag{ display:none; margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; }
  .diag.warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
</style>

<script defer src="assets/menu.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>
  <div class="main-content">
    <div class="page-header">
      <h1>Análise de Estoque</h1>
      <p>Foco em estoque, compras e CPV. Reconciliação: CPV ≈ Compras − ΔEstoque.</p>
      <div id="diag" class="diag warn" style="display:none"></div>
    </div>

    <section class="grid two">
      <div class="card">
        <div class="section-title">Evolução (12 meses): Estoque × Compras × CPV</div>
        <div id="grafico"></div>
      </div>

      <div class="card">
        <div class="section-title">Reconciliação Rápida</div> <!-- agora preto -->
        <p class="muted" id="diagRecon">Valida se CPV ≈ Compras − ΔEstoque.</p>
        <table class="sm" id="tblRecon">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Estoque Inicial</th>
              <th>Compras</th>
              <th>Estoque Final</th>
              <th>ΔEstoque</th>
              <th>CPV (fórmula)</th>
              <th>CPV (mov)</th>
              <th>Dif.</th>
              <th>Dif. %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
(async function(){
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp",
    storageBucket: "lepanapp.appspot.com",
    messagingSenderId: "542989944344",
    appId: "1:542989944344:web:576e28199960fd5440a56d"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tbody = document.querySelector("#tblRecon tbody");
  const diagRecon = document.getElementById("diagRecon");
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const num = v => isNaN(Number(v)) ? 0 : Number(v);
  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const perc = v => Number(v||0).toLocaleString('pt-BR',{maximumFractionDigits:1})+'%';
  const hasVal = v => v!==undefined && v!==null && !(typeof v==='number' && isNaN(v));

  const hoje = new Date();
  const mesAtual = hoje.getMonth()+1;
  const anoAtual = hoje.getFullYear();
  const mesPadrao = mesAtual===1?12:mesAtual-1;
  const anoPadrao = mesAtual===1?anoAtual-1:anoAtual;

  const cfgSnap = await db.ref('configuracao').once('value');
  const cfg = cfgSnap.val() || {};
  const cfgEstoqueInicial = Number(cfg.valorEstoqueInicial) || 0;

  const consSnap = await db.ref(`financeiro/consolidado/${anoPadrao}`).once('value');
  const movSnap = await db.ref(`financeiro/movimentacao/${anoPadrao}`).once('value');
  const movPrevSnap = await db.ref(`financeiro/movimentacao/${anoPadrao-1}`).once('value');
  const cons = consSnap.val()||{};
  const mov = movSnap.val()||{};
  const movPrev = movPrevSnap.val()||{};

  const catSnap = await db.ref('financeiro/categorias').once('value');
  const cats = catSnap.val()||{};
  const idCompras = Object.keys(cats).find(k => (cats[k]?.nome||'').toLowerCase().includes('compras'));

  const arr12 = ()=>Array.from({length:12},()=>0);
  const compras=arr12(),cpv=arr12(),estoque=arr12();

  for(let m=1;m<=12;m++){
    const row=cons?.[m]||{};
    const v=row?.[idCompras];
    compras[m-1]=num(v?.valor??v);
    cpv[m-1]=num(mov?.[m]?.custoProdutoMes);
    estoque[m-1]=num(mov?.[m]?.valorEstoque);
  }

  function estoqueInicialDoMes(ano,mes){
    if(mes===1){
      const prevDec=movPrev?.[12]?.valorEstoque;
      if(hasVal(prevDec)) return num(prevDec);
      return cfgEstoqueInicial>0?cfgEstoqueInicial:null; // usa sempre o configurado se não houver anterior
    }else{
      const prev=mov?.[mes-1]?.valorEstoque;
      if(hasVal(prev)) return num(prev);
      return null;
    }
  }

  function reconRow(estIni,compras,estFim,cpvMov){
    const delta=(hasVal(estFim)&&hasVal(estIni))?(num(estFim)-num(estIni)):null;
    const cpvFormula=(delta==null)?null:num(compras)-delta;
    const dif=(cpvFormula==null)?null:num(cpvMov)-cpvFormula;
    const base=(cpvFormula==null||Math.abs(num(cpvMov))<1e-6)?null:(dif/num(cpvMov)*100);
    return {delta,cpvFormula,dif,difPct:base};
  }

  tbody.innerHTML='';
  let alert=false;
  for(let m=1;m<=12;m++){
    const eFim=hasVal(estoque[m-1])?num(estoque[m-1]):null;
    const eIni=estoqueInicialDoMes(anoPadrao,m);
    const comp=num(compras[m-1]);
    const cpvm=num(cpv[m-1]);
    const {delta,cpvFormula,dif,difPct}=reconRow(eIni,comp,eFim,cpvm);
    const tr=document.createElement('tr');
    const difOk=(cpvm===0&&(cpvFormula==null||Math.abs(cpvFormula)<1))
      ||(dif!=null&&Math.abs(dif)<=Math.max(1,Math.abs(cpvm)*0.1));
    if(!difOk) alert=true;
    tr.innerHTML=`
      <td style="text-align:left">${mesesPt[m-1]}</td>
      <td>${hasVal(eIni)?'R$ '+fmt(eIni):'—'}</td>
      <td>${comp?'R$ '+fmt(comp):'—'}</td>
      <td>${hasVal(eFim)?'R$ '+fmt(eFim):'—'}</td>
      <td>${(delta!=null)?'R$ '+fmt(delta):'—'}</td>
      <td>${(cpvFormula!=null)?'R$ '+fmt(cpvFormula):'—'}</td>
      <td>${cpvm?'R$ '+fmt(cpvm):'—'}</td>
      <td>${(dif!=null)?'R$ '+fmt(dif):'—'}</td>
      <td>${(difPct!=null&&isFinite(difPct))?perc(difPct):'—'}</td>
    `;
    tbody.appendChild(tr);
  }
  diagRecon.textContent=alert
    ?"Atenção: há meses com diferença acima de 10% entre CPV e (Compras − ΔEstoque)."
    :"OK: reconciliação dentro da tolerância (±10%) nos meses com dados.";
})();
</script>
</body>
</html>
