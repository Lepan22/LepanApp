<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Análise de Estoque</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --card-gap: 10px;
    --card-pad: 10px;
    --kpi-h: 64px;
    --chart-h: 220px;
    --muted: #6b7280;
    --ok: #065f46;
    --warn: #a16207;
    --bad: #b91c1c;
    --soft: #f3f4f6;
  }
  .main-content{ padding:16px 20px; }
  .page-header h1{ margin:6px 0 6px; }
  .page-header p{ margin:0 0 10px; color:#667085; font-size:12.5px; }

  .filters{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  .filters label{ font-size:12.5px; color:#374151 }
  .filters select{ padding:6px 8px; font-size:12.5px }

  .grid{ display:grid; gap:var(--card-gap); }
  .grid.kpis{ grid-template-columns: repeat(12, 1fr); }
  .grid.two{ grid-template-columns: 7fr 5fr; }
  .grid.full{ grid-template-columns: 1fr; }

  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:var(--card-pad); }
  .kpi{ height:var(--kpi-h); display:flex; flex-direction:column; justify-content:center; gap:2px; }
  .kpi .label{ color:#475569; font-size:11.5px; line-height:1; }
  .kpi .value{ font-weight:800; font-size:17px; letter-spacing:.2px; line-height:1; }
  .kpi .sub{ color:#64748b; font-size:11px; line-height:1; }

  .section-title{ font-size:13px; font-weight:700; color:#111827; margin-bottom:6px; }
  .muted{ color: var(--muted); font-size:12px; }
  .ok{ color: var(--ok); } .warn{ color: var(--warn); } .bad{ color: var(--bad); }

  .chart-box{ height:var(--chart-h); }
  .legend{ display:flex; gap:12px; font-size:12px; color:#374151; margin-top:6px; }
  .dot{ display:inline-block; width:10px; height:10px; border-radius:10px; margin-right:6px; }
  .lg-estoque{ background:#0ea5e9 } .lg-compra{ background:#a78bfa } .lg-cpv{ background:#f97316 }

  table.sm{ width:100%; border-collapse:collapse; }
  table.sm th, table.sm td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:12.5px; text-align:right; }
  table.sm th:first-child, table.sm td:first-child{ text-align:left; }
  table.sm thead th{ background:#fff7ec; font-weight:700; }
  tfoot td{ font-weight:700; background:#fafafa; }

  .diag{ display:none; margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; }
  .diag.warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }

  .resume-grid{ display:grid; gap:10px; grid-template-columns: repeat(2,1fr); }
  .resume-item{ border:1px dashed #e5e7eb; border-radius:10px; padding:10px; }
  .resume-item h4{ margin:0 0 6px; font-size:13px; }
  .resume-item .big{ font-weight:800; font-size:18px; }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#fff; }
  @media(max-width:980px){ .grid.two{ grid-template-columns: 1fr; } .resume-grid{ grid-template-columns: 1fr; } }
</style>

<script defer src="assets/menu.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Análise de Estoque</h1>
      <p>Reconciliação mensal de <strong>Estoque × Compras × CPV</strong> e visão de <strong>Perdas & Ajustes</strong>.</p>
      <div id="diag" class="diag warn" style="display:none"></div>
    </div>

    <section class="filters">
      <label>Ano: <select id="anoSelect"></select></label>
      <label>Mês: <select id="mesSelect"></select></label>
      <label>Janela Cobertura:
        <select id="janelaCob">
          <option value="3">3 meses</option>
          <option value="6">6 meses</option>
          <option value="12" selected>12 meses</option>
        </select>
      </label>
      <span class="muted">Cobertura = Estoque final ÷ média CPV (janela, em meses).</span>
    </section>

    <!-- KPIs -->
    <section class="grid kpis" id="kpiGrid">
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Valor de Estoque</div>
        <div class="value" id="kpiEstoque">—</div>
        <div class="sub muted" id="kpiEstoqueVar">Variação vs mês anterior: —</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Compra Produto (mês)</div>
        <div class="value" id="kpiCompras">—</div>
        <div class="sub muted">movimentação.compraProdutoMes</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Custo de Produto (mês)</div>
        <div class="value" id="kpiCPV">—</div>
        <div class="sub muted">movimentação.custoProdutoMes</div>
      </div>
      <div class="card kpi" style="grid-column: span 3;">
        <div class="label">Contas a Pagar (Compras)</div>
        <div class="value" id="kpiPagarCompras">—</div>
        <div class="sub muted">movimentação.contasPagarCompras</div>
      </div>
    </section>

    <!-- Gráfico + Tabela -->
    <section class="grid two" style="margin-top:10px;">
      <div class="card">
        <div class="section-title">Evolução (12 meses): Estoque × Compras × CPV</div>
        <div class="chart-box">
          <svg id="svg12" viewBox="0 0 1000 340" preserveAspectRatio="none" style="width:100%; height:100%;"></svg>
        </div>
        <div class="legend">
          <span><i class="dot lg-estoque"></i>Estoque (R$)</span>
          <span><i class="dot lg-compra"></i>Compras (R$)</span>
          <span><i class="dot lg-cpv"></i>CPV (R$)</span>
        </div>
      </div>

      <div class="card">
        <div class="section-title" id="tituloRecon" style="color:#000 !important;">Reconciliação Rápida</div>
        <p class="muted" id="diagRecon">CPV (fórmula) = Compras − ΔEstoque. Dif. = CPV (mov) − CPV (fórmula).</p>
        <table class="sm" id="tblRecon">
          <thead>
            <tr>
              <th>Mês</th>
              <th>Estoque Inicial</th>
              <th>Compras</th>
              <th>Estoque Final</th>
              <th>ΔEstoque</th>
              <th>CPV (fórmula)</th>
              <th>CPV (mov)</th>
              <th>Dif.</th>
              <th>Dif. %</th>
              <th>Perda Não Operacional</th>
              <th>Ajuste CMV/Estoque (Import)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td style="text-align:left">TOTAL (YTD)</td>
              <td id="tfEstIni">—</td>
              <td id="tfCompras">—</td>
              <td id="tfEstFim">—</td>
              <td id="tfDelta">—</td>
              <td id="tfCpvForm">—</td>
              <td id="tfCpvMov">—</td>
              <td id="tfDif">—</td>
              <td id="tfDifPct">—</td>
              <td id="tfPerdaNP">—</td>
              <td id="tfAjuste">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Resumo -->
    <section class="grid full" style="margin-top:10px;">
      <div class="card">
        <div class="section-title">Resumo de Perdas & Ajustes (YTD)</div>
        <div class="resume-grid">
          <div class="resume-item">
            <h4>CPV acumulado</h4>
            <div>Fórmula: <span class="big" id="rsCpvForm">—</span></div>
            <div>Mov (ERP): <span class="big" id="rsCpvMov">—</span></div>
            <div>Diferença: <span id="rsDif">—</span> <span class="pill" id="rsDifPct">—</span></div>
          </div>
          <div class="resume-item">
            <h4>Perdas & Ajustes</h4>
            <div>Perda Não Operac. (YTD): <span class="big" id="rsPerdaNP">—</span></div>
            <div>Perda Operacional (DRE, Import): <span class="big" id="rsPerdaOp">—</span></div>
            <div>Ajustes CMV/Estoque (Import): <span class="big" id="rsAjuste">—</span></div>
          </div>
          <div class="resume-item">
            <h4>Meta de Perda</h4>
            <div>Meta configurada: <span class="big" id="rsMeta">—</span></div>
            <div>Perda N-Operac. / CPV Mov: <span class="big" id="rsPctReal">—</span> <span class="pill" id="rsSemaforo">—</span></div>
          </div>
          <div class="resume-item">
            <h4>Diferença Residual</h4>
            <div>Dif. − Ajustes CMV: <span class="big" id="rsResidual">—</span></div>
            <div class="muted">Se próximo de 0, diferenças de competência foram cobertas pelos ajustes.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const diag = document.getElementById('diag');
  const showDiag = (msg, type="warn") => { diag.className = `diag ${type}`; diag.textContent = msg; diag.style.display = 'block'; };
  const clearDiag = () => { diag.style.display = 'none'; diag.textContent = ''; };

  try{
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  }catch(e){ console.error(e); showDiag('Falha ao inicializar Firebase.', 'err'); }
  const db = firebase.apps.length ? firebase.database() : null;

  // ---------- Utils ----------
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date();
  const mesAtual = hoje.getMonth()+1;
  const anoAtual = hoje.getFullYear();
  const mesPadrao = (mesAtual===1 ? 12 : mesAtual-1);
  const anoPadrao = (mesAtual===1 ? anoAtual-1 : anoAtual);

  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => isNaN(Number(v)) ? 0 : Number(v);
  const perc = v => Number(v||0).toLocaleString('pt-BR',{maximumFractionDigits:1}) + '%';
  const hasVal = v => v!==undefined && v!==null && !(typeof v==='number' && isNaN(v));
  const sum  = a => a.reduce((x,y)=> x+num(y), 0);

  const norm = s => String(s||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

  // ---------- Elements ----------
  const anoSel = document.getElementById('anoSelect');
  const mesSel = document.getElementById('mesSelect');
  const janelaCob = document.getElementById('janelaCob');

  const kpi = {
    est: document.getElementById('kpiEstoque'),
    estVar: document.getElementById('kpiEstoqueVar'),
    comp: document.getElementById('kpiCompras'),
    cpv: document.getElementById('kpiCPV'),
    pagar: document.getElementById('kpiPagarCompras'),
  };

  const svg12 = document.getElementById('svg12');
  const tbody = document.querySelector('#tblRecon tbody');
  const tf = {
    estIni: document.getElementById('tfEstIni'),
    compras: document.getElementById('tfCompras'),
    estFim: document.getElementById('tfEstFim'),
    delta: document.getElementById('tfDelta'),
    cpvForm: document.getElementById('tfCpvForm'),
    cpvMov: document.getElementById('tfCpvMov'),
    dif: document.getElementById('tfDif'),
    difPct: document.getElementById('tfDifPct'),
    perdaNP: document.getElementById('tfPerdaNP'),
    ajuste: document.getElementById('tfAjuste'),
  };
  const rs = {
    cpvForm: document.getElementById('rsCpvForm'),
    cpvMov: document.getElementById('rsCpvMov'),
    dif: document.getElementById('rsDif'),
    difPct: document.getElementById('rsDifPct'),
    perdaNP: document.getElementById('rsPerdaNP'),
    perdaOp: document.getElementById('rsPerdaOp'),
    ajuste: document.getElementById('rsAjuste'),
    meta: document.getElementById('rsMeta'),
    pctReal: document.getElementById('rsPctReal'),
    semaforo: document.getElementById('rsSemaforo'),
    residual: document.getElementById('rsResidual'),
  };

  // ---------- Data ----------
  async function getMov(ano){
    const snap = await db.ref(`financeiro/movimentacao/${ano}`).once('value');
    return snap.val() || {};
  }
  async function getConfig(){
    const snap = await db.ref('configuracao').once('value');
    return snap.val() || {};
  }
  async function getImport(ano){
    const snap = await db.ref(`import_financeiro/${ano}`).once('value');
    return snap.val() || {};
  }

  // séries dos extras do mês
  function seriesFromExtras(movAno){
    const compras = Array.from({length:12}, (_,i)=> num(movAno?.[i+1]?.compraProdutoMes));
    const cpv     = Array.from({length:12}, (_,i)=> num(movAno?.[i+1]?.custoProdutoMes));
    const estoque = Array.from({length:12}, (_,i)=> num(movAno?.[i+1]?.valorEstoque));
    const perdaNP = Array.from({length:12}, (_,i)=> num(movAno?.[i+1]?.perdaProdutoNaoOperacional));
    const pagar   = Array.from({length:12}, (_,i)=> num(movAno?.[i+1]?.contasPagarCompras));
    return { compras, cpv, estoque, perdaNP, pagar };
  }

  // estoque inicial (jan usa config.valorEstoqueInicial)
  function estoqueInicialDoMes(ano, mes, movAno, movPrev, cfg){
    const cfgInicial = Number(cfg?.valorEstoqueInicial);
    if (mes === 1){
      if (isFinite(cfgInicial) && cfgInicial > 0) return cfgInicial;
      const prevDec = movPrev?.[12]?.valorEstoque;
      return hasVal(prevDec) ? num(prevDec) : null;
    }
    const prev = movAno?.[mes-1]?.valorEstoque;
    return hasVal(prev) ? num(prev) : null;
  }

  // Import: somatórios por mês
  function totalsFromImport(importAno){
    const tot = {
      ajusteMes: Array.from({length:12}, ()=>0),
      perdaOpMes: Array.from({length:12}, ()=>0),
    };
    for (let m=1;m<=12;m++){
      const rows = importAno?.[m] || {};
      Object.values(rows).forEach(row=>{
        const cat = norm(row?.categoria || '') + ' ' + norm(row?.subcategoria || '');
        const val = num(row?.valor ?? row?.valorTotal);
        if (!val) return;
        // Ajustes CMV/Estoque
        const isAjuste = (cat.includes('ajuste') && (cat.includes('estoque') || cat.includes('cmv')));
        if (isAjuste) tot.ajusteMes[m-1] += Math.abs(val);
        // Perda Operacional (DRE)
        const isPerdaOp = cat.includes('perda operacional');
        if (isPerdaOp) tot.perdaOpMes[m-1] += Math.abs(val);
      });
    }
    return tot;
  }

  function reconRow(estIni, compras, estFim, cpvMov){
    const delta = (hasVal(estFim) && hasVal(estIni)) ? (num(estFim) - num(estIni)) : null;
    const cpvFormula = (delta==null) ? null : num(compras) - delta; // CPV = Compras − Δ
    const dif = (cpvFormula==null) ? null : num(cpvMov) - cpvFormula;
    const base = (cpvFormula==null || Math.abs(num(cpvMov)) < 1e-6) ? null : (dif/num(cpvMov)*100);
    return { delta, cpvFormula, dif, difPct: base };
  }

  function setText(el, txt){ el.textContent = txt; }

  function drawComboChart(labels, estoque, compras, cpv){
    const W=1000, H=340, padL=40, padR=20, padT=20, padB=50;
    const w = W - padL - padR, h = H - padT - padB;

    const allVals = [...estoque, ...compras, ...cpv].map(v=>Math.abs(num(v)));
    const maxY = Math.max(1, ...allVals);
    const scaleX = (i)=> padL + (i*(w/12)) + (w/24);
    const scaleY = (v)=> padT + (h - (v/maxY)*h);

    let svg = '';
    for (let i=0;i<=4;i++){
      const y = padT + (h/4)*i;
      svg += `<line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="#f3f4f6" stroke-width="1"/>`;
    }
    labels.forEach((lb,i)=>{
      const x = scaleX(i);
      svg += `<text x="${x}" y="${H-28}" fill="#6b7280" font-size="10" text-anchor="middle">${lb}</text>`;
    });

    const bw = (w/12)*0.30;
    labels.forEach((_,i)=>{
      const x = scaleX(i);
      const vC = Math.max(0, num(compras[i]));
      const vP = Math.max(0, num(cpv[i]));

      const yC = scaleY(vC), hC = (padT+h) - yC;
      const yP = scaleY(vP), hP = (padT+h) - yP;

      svg += `<rect x="${x-bw-3}" y="${yC}" width="${bw}" height="${hC}" fill="#a78bfa" />`;
      svg += `<rect x="${x+3}"    y="${yP}" width="${bw}" height="${hP}" fill="#f97316" />`;
    });

    const pts = labels.map((_,i)=> [scaleX(i), scaleY(Math.max(0,num(estoque[i])))] );
    const p = pts.map(([x,y])=> x.toFixed(1)+','+y.toFixed(1)).join(' ');
    svg += `<polyline fill="none" stroke="#0ea5e9" stroke-width="2" points="${p}"/>`;

    svg12.innerHTML = svg;
  }

  async function render(){
    clearDiag();

    const ano = Number(anoSel.value);
    const mes = Number(mesSel.value);
    const jan = Number(janelaCob.value);

    const [movAno, movPrev, cfg, importAno] = await Promise.all([
      getMov(ano), getMov(ano-1), getConfig(), getImport(ano)
    ]);

    const { compras, cpv, estoque, perdaNP, pagar } = seriesFromExtras(movAno);
    const { ajusteMes, perdaOpMes } = totalsFromImport(importAno);

    // KPIs do mês selecionado
    const estFim = hasVal(estoque[mes-1]) ? num(estoque[mes-1]) : null;
    const estIni = estoqueInicialDoMes(ano, mes, movAno, movPrev, cfg);
    const comprasMes = num(compras[mes-1]);
    const cpvMes = num(cpv[mes-1]);
    const pagarMes = num(pagar[mes-1]);

    setText(kpi.est, hasVal(estFim) ? 'R$ ' + fmt(estFim) : '—');
    const varEst = (hasVal(estFim) && hasVal(estIni)) ? (estFim - estIni) : null;
    const varPct = (hasVal(estIni) && estIni !== 0) ? (varEst/estIni*100) : null;
    setText(kpi.estVar, (varEst===null) ? 'Variação vs mês anterior: —'
      : `Variação vs mês anterior: R$ ${fmt(varEst)} ${hasVal(varPct) ? '('+(varPct>=0?'+':'')+perc(varPct)+')' : ''}`);
    setText(kpi.comp, comprasMes ? 'R$ ' + fmt(comprasMes) : '—');
    setText(kpi.cpv, cpvMes ? 'R$ ' + fmt(cpvMes) : '—');
    setText(kpi.pagar, pagarMes ? 'R$ ' + fmt(pagarMes) : '—');

    // Tabela por mês
    tbody.innerHTML = '';
    let tot = { compras:0, cpvForm:0, cpvMov:0, delta:0, dif:0, perdaNP:0, ajuste:0, estIni:null, estFim:null };
    for (let m=1;m<=12;m++){
      const eFim = hasVal(estoque[m-1]) ? num(estoque[m-1]) : null;
      const eIni = estoqueInicialDoMes(ano, m, movAno, movPrev, cfg);
      const comp = num(compras[m-1]);
      const cpvm = num(cpv[m-1]);
      const perdaNPM = num(perdaNP[m-1]);
      const ajusteM = num(ajusteMes[m-1]);

      const {delta, cpvFormula, dif, difPct} = reconRow(eIni, comp, eFim, cpvm);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left">${mesesPt[m-1]}</td>
        <td>${hasVal(eIni)? 'R$ '+fmt(eIni) : '—'}</td>
        <td>${comp? 'R$ '+fmt(comp) : '—'}</td>
        <td>${hasVal(eFim)? 'R$ '+fmt(eFim) : '—'}</td>
        <td>${(delta!=null)? 'R$ '+fmt(delta) : '—'}</td>
        <td>${(cpvFormula!=null)? 'R$ '+fmt(cpvFormula) : '—'}</td>
        <td>${cpvm? 'R$ '+fmt(cpvm) : '—'}</td>
        <td>${(dif!=null)? 'R$ '+fmt(dif) : '—'}</td>
        <td>${(difPct!=null && isFinite(difPct))? perc(difPct) : '—'}</td>
        <td>${perdaNPM? 'R$ '+fmt(perdaNPM) : '—'}</td>
        <td>${ajusteM? 'R$ '+fmt(ajusteM) : '—'}</td>
      `;
      tbody.appendChild(tr);

      if (m===1) tot.estIni = eIni;
      if (m===12) tot.estFim = eFim;
      tot.compras += comp;
      if (delta!=null) tot.delta += delta;
      if (cpvFormula!=null) tot.cpvForm += cpvFormula;
      tot.cpvMov += cpvm;
      if (dif!=null) tot.dif += dif;
      tot.perdaNP += perdaNPM;
      tot.ajuste += ajusteM;
    }

    // Totais
    tf.estIni.textContent = hasVal(tot.estIni)? 'R$ '+fmt(tot.estIni): '—';
    tf.estFim.textContent = hasVal(tot.estFim)? 'R$ '+fmt(tot.estFim): '—';
    tf.compras.textContent = 'R$ '+fmt(tot.compras);
    tf.delta.textContent = 'R$ '+fmt(tot.delta);
    tf.cpvForm.textContent = 'R$ '+fmt(tot.cpvForm);
    tf.cpvMov.textContent = 'R$ '+fmt(tot.cpvMov);
    tf.dif.textContent = 'R$ '+fmt(tot.dif);
    tf.difPct.textContent = (tot.cpvMov ? perc(tot.dif/tot.cpvMov*100) : '—');
    tf.perdaNP.textContent = 'R$ '+fmt(tot.perdaNP);
    tf.ajuste.textContent = 'R$ '+fmt(tot.ajuste);

    // Resumo YTD
    const perdaOpYTD = sum(perdaOpMes);
    const meta = Number((await getConfig())?.percentualPerdaOperacional) || 2;
    const pctReal = (tot.cpvMov>0) ? (tot.perdaNP/tot.cpvMov*100) : 0;
    const residual = tot.dif - tot.ajuste;

    rs.cpvForm.textContent = 'R$ '+fmt(tot.cpvForm);
    rs.cpvMov.textContent  = 'R$ '+fmt(tot.cpvMov);
    rs.dif.textContent     = 'R$ '+fmt(tot.dif);
    rs.difPct.textContent  = tot.cpvMov? perc(tot.dif/tot.cpvMov*100): '—';

    rs.perdaNP.textContent = 'R$ '+fmt(tot.perdaNP);
    rs.perdaOp.textContent = 'R$ '+fmt(perdaOpYTD);
    rs.ajuste.textContent  = 'R$ '+fmt(tot.ajuste);

    rs.meta.textContent    = perc(meta);
    rs.pctReal.textContent = perc(pctReal);
    rs.residual.textContent= 'R$ '+fmt(residual);

    // Semáforo
    let cls = 'ok', txt='OK';
    if (pctReal > meta + 1) { cls='bad'; txt='Acima da meta'; }
    else if (pctReal > meta) { cls='warn'; txt='Leve acima da meta'; }
    rs.semaforo.className = 'pill ' + cls;
    rs.semaforo.textContent = txt;

    // Cobertura & gráfico
    const {meses:cobMeses, mediaBase} = (function cobertura(estoqueFinal, cpvHist, janela){
      const base = cpvHist.slice(-jan).map(num);
      const media = base.length ? sum(base)/base.length : 0;
      const meses = media>0 ? (num(estoque[mes-1]||0)/media) : null;
      return {meses, mediaBase: media};
    })(estFim??0, cpv.slice(0, mes), jan);

    drawComboChart(mesesPt, estoque, compras, cpv);
  }

  async function carregarAnosEMeses(){
    const movAll = await db.ref('financeiro/movimentacao').once('value');
    const anos = Object.keys(movAll.val()||{}).filter(a=>/^\d{4}$/.test(a)).map(Number).sort((a,b)=>a-b);

    anoSel.innerHTML = '';
    if (!anos.length){
      const opt=document.createElement('option'); opt.value=anoPadrao; opt.textContent=anoPadrao; anoSel.appendChild(opt);
    }else{
      anos.forEach(a=>{
        const opt=document.createElement('option'); opt.value=a; opt.textContent=a; anoSel.appendChild(opt);
      });
      anoSel.value = String(anos.includes(anoPadrao)? anoPadrao : anos[anos.length-1]);
    }

    mesSel.innerHTML = '';
    for (let m=1;m<=12;m++){
      const opt=document.createElement('option'); opt.value=m; opt.textContent=(m.toString().padStart(2,'0'))+' - '+mesesPt[m-1];
      mesSel.appendChild(opt);
    }
    mesSel.value = String(mesPadrao);
    if (Number(anoSel.value)!==anoPadrao && mesPadrao!==12) { mesSel.value = '12'; }
  }

  anoSel.addEventListener('change', render);
  mesSel.addEventListener('change', render);
  janelaCob.addEventListener('change', render);

  (async function init(){
    await carregarAnosEMeses();
    await render();
  })();
})();
</script>
</body>
</html>
