<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Le Pan pan ‚Äî Painel Operacional</title>

  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="assets/base.css" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="assets/menu.js" defer></script>

  <style>
    :root{
      --accent:#ff7f00;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#fff;
      --soft:#fff8ef;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
    }
    .main-content{ padding-top:10px }

    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .page-header h1{ font-size:18px; margin:0 }

    /* Atalhos */
    .quick-links{
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:8px
    }
    @media (max-width:1100px){ .quick-links{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:720px){ .quick-links{grid-template-columns:repeat(2,1fr)} }
    .qbtn{
      display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--line);
      border-left:3px solid var(--accent);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:#111
    }
    .qbtn:hover{ background:#fff7ed }
    .qbtn .icon{font-size:18px}

    /* KPIs topo */
    .kpi-grid{
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px
    }
    @media (max-width:1100px){ .kpi-grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .kpi-grid{grid-template-columns:1fr} }
    .kcard{
      background:var(--soft);border:1px solid var(--line);border-left:3px solid var(--accent);
      border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:2px;min-height:64px
    }
    .kcard .label{font-size:12px;color:#374151}
    .kcard .value{font-size:20px;font-weight:800;color:var(--accent);line-height:1}

    /* Colunas */
    .cols-2{display:grid;grid-template-columns:1.1fr .9fr;gap:10px;margin-top:4px}
    @media (max-width:1050px){ .cols-2{grid-template-columns:1fr} }

    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .box h3{margin:0 0 8px 0;font-size:14px}
    .legend{display:flex;gap:12px;font-size:12px;color:#6b7280;margin-bottom:8px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}

    table{width:100%;border-collapse:collapse;font-size:12.5px}
    thead th{background:#f8fafc;color:#111;padding:6px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{padding:6px;border-bottom:1px solid var(--line)}
    .status-badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid;display:inline-flex;align-items:center;gap:6px}
    .status-prev{color:#92400e;border-color:#f59e0b;background:#fffbeb}
    .status-conf{color:#065f46;border-color:#10b981;background:#ecfdf5}

    /* Barra de progresso */
    .goal{
      background:#f3f4f6;border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px
    }
    .goal h4{margin:0 0 6px 0;font-size:12px;color:#374151}
    .progress-wrap{background:#e5e7eb;border-radius:999px;overflow:hidden;height:10px}
    .progress-bar{height:10px;background:linear-gradient(90deg,#10b981,#60a5fa)}
    .goal-row{display:flex;justify-content:space-between;font-size:12px;color:#374151;margin-top:4px}

    /* Gr√°ficos */
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:1050px){ .charts{grid-template-columns:1fr} }
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .chart-card canvas{height:260px !important;}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <div class="page-header">
        <h1>Painel Operacional</h1>
      </div>

      <!-- Atalhos (abrem em nova guia) -->
      <div class="quick-links">
        <a class="qbtn" href="eventos.html" target="_blank" rel="noopener noreferrer"><span class="icon">üìã</span><div><div style="font-weight:700">Eventos</div><small class="muted">Criar/editar eventos</small></div></a>
        <a class="qbtn" href="agenda.html" target="_blank" rel="noopener noreferrer"><span class="icon">üóìÔ∏è</span><div><div style="font-weight:700">Agenda</div><small class="muted">Semana e proje√ß√µes</small></div></a>
        <a class="qbtn" href="planejamento_evento.html" target="_blank" rel="noopener noreferrer"><span class="icon">üß©</span><div><div style="font-weight:700">Planejamento</div><small class="muted">Equipe, log√≠stica, equipamento</small></div></a>
        <a class="qbtn" href="relatorio/relatorio_Semanal.html" target="_blank" rel="noopener noreferrer"><span class="icon">üìà</span><div><div style="font-weight:700">Relat√≥rio Semanal</div><small class="muted">Resultados da semana</small></div></a>
        <a class="qbtn" href="gestao_Cliente.html" target="_blank" rel="noopener noreferrer"><span class="icon">üë•</span><div><div style="font-weight:700">Clientes</div><small class="muted">Ativos e prospects</small></div></a>
      </div>

      <!-- KPIs topo -->
      <div class="kpi-grid">
        <div class="kcard">
          <div class="label">Eventos desta semana</div>
          <div class="value" id="kpi-semana">0</div>
          <small id="kpi-semana-detalhe" style="color:var(--muted)"></small>
        </div>
        <div class="kcard">
          <div class="label">Venda prevista da semana</div>
          <div class="value">R$ <span id="kpi-estimativa-semana">0,00</span></div>
        </div>
        <div class="kcard">
          <div class="label">Venda real no m√™s</div>
          <div class="value">R$ <span id="kpi-venda-mes">0,00</span></div>
        </div>
        <div class="kcard">
          <div class="label">Lucro no m√™s (Fech./Final.)</div>
          <div class="value">R$ <span id="kpi-lucro-mes">0,00</span></div>
        </div>
      </div>

      <!-- Semana + M√™s atual + Clientes -->
      <div class="cols-2">
        <!-- Lista da semana + metas -->
        <div class="box">
          <h3>Semana (Seg‚ÄìDom)</h3>

          <!-- Previsto x Realizado (barra de metas) -->
          <div class="goal">
            <h4>Previsto x Realizado</h4>
            <div class="progress-wrap"><div id="pb-semana" class="progress-bar" style="width:0%"></div></div>
            <div class="goal-row">
              <span>Previsto: <strong>R$ <span id="meta-previsto">0,00</span></strong></span>
              <span>Realizado: <strong>R$ <span id="meta-realizado">0,00</span></strong> (<span id="meta-pct">0%</span>)</span>
            </div>
          </div>

          <div class="legend" style="margin-top:8px">
            <span><span class="dot ok"></span>Confirmado</span>
            <span><span class="dot warn"></span>Previsto</span>
          </div>

          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Evento</th>
                <th>Status</th>
                <th style="text-align:right">Estimativa</th>
              </tr>
            </thead>
            <tbody id="lista-semana"></tbody>
          </table>
        </div>

        <!-- Coluna direita com M√™s atual e Clientes -->
        <div class="box" id="box-mes">
          <h3>M√™s atual</h3>
          <table>
            <thead><tr><th>M√©trica</th><th style="text-align:right">Valor</th></tr></thead>
            <tbody id="tabela-mes">
              <tr><td>Eventos (total)</td><td style="text-align:right" id="mes-eventos-total">0</td></tr>
              <tr><td>Eventos Abertos</td><td style="text-align:right" id="mes-eventos-abertos">0</td></tr>
              <tr><td>Finalizados/Fechados</td><td style="text-align:right" id="mes-eventos-fechados">0</td></tr>
              <tr><td>Estimativa do m√™s</td><td style="text-align:right">R$ <span id="mes-estimativa">0,00</span></td></tr>
              <tr><td>Margem Real do m√™s</td><td style="text-align:right"><span id="mes-margem-real">0,0%</span></td></tr>
              <tr><td>Margem Prevista (config)</td><td style="text-align:right"><span id="mes-margem-prev">0,0%</span></td></tr>
            </tbody>
          </table>

          <h3 style="margin-top:12px">Clientes ‚Äî resumo</h3>
          <div class="kpi-grid" style="grid-template-columns:1fr 1fr;gap:8px">
            <div class="kcard" style="min-height:60px">
              <div class="label">Clientes ativos</div>
              <div class="value" id="kpi-clientes-ativos">0</div>
            </div>
            <div class="kcard" style="min-height:60px">
              <div class="label">Prospects quentes</div>
              <div class="value" id="kpi-clientes-quentes">0</div>
            </div>
          </div>

          <h3 style="margin-top:12px">Margens recentes</h3>
          <table>
            <thead><tr><th>M√™s</th><th style="text-align:right">Margem</th></tr></thead>
            <tbody id="tb-margens"></tbody>
          </table>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="charts">
        <div class="chart-card">
          <h3 style="margin:0 0 6px 0">Vendas x Lucro (ano)</h3>
          <canvas id="graficoVendaLucro"></canvas>
        </div>
        <div class="chart-card">
          <h3 style="margin:0 0 6px 0">Eventos por m√™s (ano)</h3>
          <canvas id="graficoEventos"></canvas>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== Helpers ===== */
    const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    function toDate(dateStr){ if(!dateStr) return null; const [y,m,d]=dateStr.split('-'); return new Date(+y, +m-1, +d); }
    function mondayOf(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day=x.getDay(); const diff=(day===0?-6:1)-day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function within(date,start,end){ const x=new Date(date.getFullYear(), date.getMonth(), date.getDate()); return x>=start && x<=end; }
    function brMoney(n){ return Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function currency(n){ return Number(n||0).toLocaleString('pt-BR',{style:'currency', currency:'BRL'}); }
    function pct(v){ return (Number(v||0)).toFixed(1).replace('.',',')+'%'; }
    function fmt(data){ const d=toDate(data); if(!d) return '-'; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}`; }

    /* ===== Painel ===== */
    async function carregarPainel(){
      const [evSnap, cliSnap, cfgLucroSnap] = await Promise.all([
        db.ref('eventos').once('value'),
        db.ref('clientes').once('value'),
        db.ref('configuracao/percentualLucro').once('value')
      ]);

      const hoje = new Date();
      const semanaIni = mondayOf(hoje);
      const semanaFim = addDays(semanaIni, 6);
      const anoAtual = hoje.getFullYear();
      const mesAtual = hoje.getMonth();
      const margemPrevista = Number(cfgLucroSnap.val() ?? 40);

      const eventos = evSnap.val() || {};
      const clientes = cliSnap.val() || {};

      /* KPIs e listas */
      let eventosSemana = 0, estimativaSemana = 0;
      let vendaSemanaReal = 0; // realizado na semana (finalizados/fechados)
      let vendaMes = 0, lucroMes = 0, eventosMesFechados = 0;
      let eventosMesTotal = 0, eventosMesAbertos = 0, estimativaMes = 0;

      const linhasSemana = [];

      Object.values(eventos).forEach(e=>{
        if(!e || !e.data) return;
        const dt = toDate(e.data);
        const status = (e.status || 'Aberto');
        const vendaPDV = Number(e.vendaPDV || 0);
        const estim = Number(e.estimativaVenda || 0);
        const final = (status==='Finalizado' || status==='Fechado');

        // Semana
        if (within(dt, semanaIni, semanaFim)) {
          eventosSemana++;
          estimativaSemana += estim;

          if (final) vendaSemanaReal += vendaPDV;

          // Detecta "Previsto" somente se flag de proje√ß√£o existir; sen√£o √© Confirmado
          const previsto = (e.previsto === true) || (e.projetado === true) || (e.tipo === 'projetado') || (e.origem === 'projecao');
          const badge = previsto
            ? `<span class="status-badge status-prev">‚óè Previsto</span>`
            : `<span class="status-badge status-conf">‚óè Confirmado</span>`;

          linhasSemana.push(`
            <tr>
              <td>${fmt(e.data)}</td>
              <td>${e.nomeEvento || '-'}</td>
              <td>${badge}</td>
              <td style="text-align:right">R$ ${brMoney(estim)}</td>
            </tr>
          `);
        }

        // M√™s atual
        if (dt.getFullYear()===anoAtual && dt.getMonth()===mesAtual) {
          eventosMesTotal++;
          estimativaMes += estim;
          if (status==='Aberto') eventosMesAbertos++;
          if (final){
            eventosMesFechados++;
            vendaMes += vendaPDV;
            lucroMes += Number(e.lucroFinal || 0);
          }
        }
      });

      // KPIs topo
      document.getElementById('kpi-semana').innerText = eventosSemana;
      document.getElementById('kpi-semana-detalhe').innerText =
        `${fmt(semanaIni.toISOString().slice(0,10))}‚Äì${fmt(semanaFim.toISOString().slice(0,10))}`;
      document.getElementById('kpi-estimativa-semana').innerText = brMoney(estimativaSemana);
      document.getElementById('kpi-venda-mes').innerText = brMoney(vendaMes);
      document.getElementById('kpi-lucro-mes').innerText = brMoney(lucroMes);

      // Semana: metas
      const ating = estimativaSemana > 0 ? Math.min(100, (vendaSemanaReal/estimativaSemana)*100) : 0;
      document.getElementById('meta-previsto').innerText = brMoney(estimativaSemana);
      document.getElementById('meta-realizado').innerText = brMoney(vendaSemanaReal);
      document.getElementById('meta-pct').innerText = pct(ating);
      document.getElementById('pb-semana').style.width = ating + '%';

      // Semana: tabela
      const tbody = document.getElementById('lista-semana');
      tbody.innerHTML = linhasSemana.length ? linhasSemana.join('') :
        `<tr><td colspan="4" style="color:#6b7280">Nenhum evento nesta semana.</td></tr>`;

      // M√™s atual (box)
      document.getElementById('mes-eventos-total').innerText   = eventosMesTotal;
      document.getElementById('mes-eventos-abertos').innerText = eventosMesAbertos;
      document.getElementById('mes-eventos-fechados').innerText= eventosMesFechados;
      document.getElementById('mes-estimativa').innerText      = brMoney(estimativaMes);

      const margemRealMes = vendaMes>0 ? (lucroMes/vendaMes)*100 : 0;
      document.getElementById('mes-margem-real').innerText = pct(margemRealMes);
      document.getElementById('mes-margem-prev').innerText = pct(margemPrevista);

      // Clientes ‚Äî resumo (robusto)
      let ativos = 0, quentes = 0;
      Object.values(clientes).forEach(c=>{
        const st = (c.status || '').toLowerCase();
        const ativo1 = c.clienteAtivo && (c.clienteAtivo.status === 'Ativo');
        const ativo2 = c.clienteAtivo && (c.clienteAtivo.statusEvento === 'Ativo');
        if (st === 'quente') quentes++;
        if (ativo1 || ativo2) ativos++;
      });
      document.getElementById('kpi-clientes-ativos').innerText = ativos;
      document.getElementById('kpi-clientes-quentes').innerText = quentes;

      /* Margens recentes (3 √∫ltimos meses) */
      const margens = []; // [{mesLabel, pct}]
      for (let i=2; i>=0; i--){
        const ref = new Date(anoAtual, mesAtual - i, 1);
        const y = ref.getFullYear(), m = ref.getMonth();
        let v=0, l=0;
        Object.values(eventos).forEach(e=>{
          if(!e || !e.data) return;
          const dt = toDate(e.data);
          if (dt.getFullYear()===y && dt.getMonth()===m && (e.status==='Finalizado' || e.status==='Fechado')){
            v += Number(e.vendaPDV || 0);
            l += Number(e.lucroFinal || 0);
          }
        });
        margens.push({ mesLabel: meses[m], pct: v>0 ? (l/v)*100 : 0 });
      }
      const tbm = document.getElementById('tb-margens');
      tbm.innerHTML = margens.map(x=>`<tr><td>${x.mesLabel}</td><td style="text-align:right">${pct(x.pct)}</td></tr>`).join('');

      /* Gr√°ficos do ano */
      const serieVenda = Array(12).fill(0);
      const serieLucro = Array(12).fill(0);
      const serieEventos = Array(12).fill(0);

      Object.values(eventos).forEach(e=>{
        if(!e || !e.data) return;
        const dt = toDate(e.data);
        if (dt.getFullYear() !== anoAtual) return;
        const m = dt.getMonth();
        const final = (e.status==='Finalizado' || e.status==='Fechado');

        if(final){
          serieVenda[m] += Number(e.vendaPDV || 0);
          serieLucro[m] += Number(e.lucroFinal || 0);
        }
        serieEventos[m] += 1;
      });

      desenharGraficos(serieVenda, serieLucro, serieEventos);
    }

    function desenharGraficos(venda, lucro, eventos){
      new Chart(document.getElementById('graficoVendaLucro'), {
        type: 'line',
        data: {
          labels: meses,
          datasets: [
            { label: 'Venda PDV', data: venda, borderWidth: 2, pointRadius: 2, tension: .25 },
            { label: 'Lucro', data: lucro, borderWidth: 2, pointRadius: 2, tension: .25 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v.toLocaleString('pt-BR') } } }
        }
      });

      new Chart(document.getElementById('graficoEventos'), {
        type: 'bar',
        data: { labels: meses, datasets: [{ label: 'Eventos', data: eventos, borderWidth: 1 }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', carregarPainel);
  </script>
</body>
</html>
