<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agenda | Le Pan pan</title>

  <!-- Estilos base do projeto -->
  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Menu lateral -->
  <script src="assets/menu.js" defer></script>

  <style>
    /* ====== Layout da página ====== */
    .page {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .page-header h1 { margin-bottom: 12px; }

    /* ====== KPIs ====== */
    .kpi-grid{
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .kpi{
      border-radius: 12px;
      padding: 14px;
      background: var(--card, #fff);
      box-shadow: var(--shadow, 0 2px 8px rgba(0,0,0,.06));
    }
    .kpi h3{
      font-size: 14px;
      margin: 0 0 6px;
      color: var(--muted-2, #555);
      font-weight: 600;
    }
    .kpi .value{
      font-size: 22px;
      font-weight: 700;
    }
    .kpi.warn{
      outline: 2px solid #ffb84d;
      background: #fff8eb;
    }

    /* ====== Cabeçalho do mês ====== */
    .month-bar{
      display: flex; align-items: center; justify-content: space-between;
      margin: 6px 0 10px;
      gap: 8px;
    }
    .month-bar .title{
      font-size: 18px; font-weight: 700;
    }
    .month-bar .nav button{
      border: 1px solid #ddd; background: #fff; border-radius: 8px;
      padding: 6px 10px; cursor: pointer;
    }

    /* ====== Calendário ====== */
    .cal{
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 8px;
      background: transparent;
    }
    .cal-weekdays{
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 6px; font-weight: 700; font-size: 12px; opacity: .85;
    }
    .cal-grid{
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .day{
      min-height: 110px;
      background: #fff;
      border-radius: 10px;
      box-shadow: var(--shadow, 0 2px 8px rgba(0,0,0,.06));
      padding: 6px;
      display: flex;
      flex-direction: column;
    }
    .day.out{
      background: #fafafa;
      color: #666;
    }
    .day .head{
      display: flex; align-items: center; justify-content: space-between;
      font-size: 11px; margin-bottom: 4px;
    }
    .day .head .date-badge{
      font-weight: 700;
    }
    .day.today{
      outline: 2px solid #4da3ff;
    }

    /* ====== Evento no dia ====== */
    .ev{
      font-size: 9px;               /* pedido anterior: 9px */
      line-height: 1.25;
      border-radius: 8px;
      padding: 4px 6px;
      margin-bottom: 4px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      align-items: center;
      cursor: default;
    }
    .ev.confirmado{
      background: #eefaf1;
      border: 1px solid #b6e3c1;
    }
    .ev.previsto{
      background: #fff3e0;          /* âmbar/laranja claro */
      border: 1px solid #ffd699;
    }
    .ev .name{
      font-weight: 600;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .ev .est{
      font-variant-numeric: tabular-nums;
      opacity: .9;
    }
    .ev .sel{
      display: flex; align-items: center; gap: 4px;
    }
    .ev select{
      font-size: 9px; padding: 2px 4px; border-radius: 6px; border: 1px solid #ccc;
      background: #fff;
    }
    .ev .act{
      display: flex; gap: 6px;
    }
    .tiny-btn{
      font-size: 9px; padding: 2px 6px; border: 1px solid #ddd; background: #fff;
      border-radius: 6px; cursor: pointer;
    }

    /* Lista lateral opcional (se quiser ligar no futuro) */
    @media (max-width: 900px){
      .kpi-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="menu-container"></div>

  <main class="page">
    <div class="page-header">
      <h1>Agenda</h1>
      <p style="margin:6px 0 2px;color:#666">Dica: eventos <b>Previstos</b> aparecem em laranja. Use o seletor para alternar entre
        <b>Confirmado</b> e <b>Previsto</b>.</p>
    </div>

    <!-- KPIs -->
    <section class="kpi-grid">
      <div class="kpi" id="kpiPrevistaTotal">
        <h3>Venda Prevista Mês (Total)</h3>
        <div class="value" id="kpiPrevistaTotalValue">R$ 0,00</div>
      </div>
      <div class="kpi" id="kpiPrevistaAConfirmar">
        <h3>Venda Prevista Mês — à confirmar</h3>
        <div class="value" id="kpiPrevistaAConfirmarValue">R$ 0,00</div>
      </div>
    </section>

    <!-- Cabeçalho do mês -->
    <section class="month-bar">
      <div class="title" id="monthTitle">Mês/Ano</div>
      <div class="nav">
        <button id="btnPrev">&larr; Mês anterior</button>
        <button id="btnToday">Hoje</button>
        <button id="btnNext">Próximo mês &rarr;</button>
      </div>
    </section>

    <!-- Calendário -->
    <section class="cal">
      <div class="cal-weekdays">
        <div style="text-align:center">S</div>
        <div style="text-align:center">T</div>
        <div style="text-align:center">Q</div>
        <div style="text-align:center">Q</div>
        <div style="text-align:center">S</div>
        <div style="text-align:center">S</div>
        <div style="text-align:center">D</div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </section>
  </main>

  <script>
    // ===== UTIL =====
    const BRL = v => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const pad2 = n => String(n).padStart(2,'0');

    // Datas (mantém referência ao mês exibido)
    let current = new Date(); // hoje
    current.setDate(1);       // pivô: primeiro dia do mês corrente

    // Firebase app deve estar inicializado globalmente no projeto
    const db = () => firebase.database();

    // Caminho dos eventos no Realtime Database
    const EVT_PATH = '/eventos';

    // Cache de eventos do mês atual (para não recomputar a cada render)
    let eventosDoMes = [];

    // ====== Render do calendário ======
    function renderMonthHeader() {
      const tit = document.getElementById('monthTitle');
      const formatter = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
      tit.textContent = formatter.format(current).replace(/^\w/, c => c.toUpperCase());
    }

    function getMonthRange(date) {
      const start = new Date(date.getFullYear(), date.getMonth(), 1);
      const end   = new Date(date.getFullYear(), date.getMonth() + 1, 1);
      return { start, end };
    }

    function buildCalendarDays() {
      const grid = document.getElementById('calGrid');
      grid.innerHTML = '';

      const { start, end } = getMonthRange(current);
      const firstWeekday = (start.getDay() + 6) % 7; // ajusta para semana começando em segunda? No layout está S T Q Q S S D, então manter DOM=0 no fim.
      // Para manter "S T Q Q S S D" (Seg a Dom) como cabeçalho visual, vamos preencher como:
      // 0..6 -> Seg(1) a Dom(0). Pra simplificar, usamos offset de segunda:
      const mondayOffset = ((start.getDay() + 6) % 7); // 0 = segunda

      // Quantos dias do mês?
      const daysInMonth = Math.round((end - start) / (24*3600*1000));

      // Quantos quadradinhos "antes" (dias do mês anterior para completar a linha inicial)
      const before = mondayOffset;
      // E depois (para completar a grade em múltiplos de 7)
      const totalCells = Math.ceil((before + daysInMonth) / 7) * 7;
      const after = totalCells - (before + daysInMonth);

      const today = new Date(); today.setHours(0,0,0,0);

      // Dias do mês anterior
      for (let i = before; i > 0; i--) {
        const d = new Date(start); d.setDate(start.getDate() - i);
        grid.appendChild(dayCell(d, true, today));
      }
      // Dias do mês atual
      for (let i = 0; i < daysInMonth; i++) {
        const d = new Date(start); d.setDate(start.getDate() + i);
        grid.appendChild(dayCell(d, false, today));
      }
      // Dias do mês seguinte
      for (let i = 1; i <= after; i++) {
        const d = new Date(end); d.setDate(end.getDate() + i - 1);
        grid.appendChild(dayCell(d, true, today));
      }
    }

    function dayCell(date, isOutMonth, todayRef) {
      const cell = document.createElement('div');
      cell.className = 'day' + (isOutMonth ? ' out' : '');

      const head = document.createElement('div');
      head.className = 'head';
      const badge = document.createElement('div');
      badge.className = 'date-badge';
      badge.textContent = pad2(date.getDate());
      const right = document.createElement('div');
      right.textContent = ''; // reservado
      head.appendChild(badge);
      head.appendChild(right);
      cell.appendChild(head);

      // Destacar hoje
      const cmp = new Date(date); cmp.setHours(0,0,0,0);
      if (!isOutMonth && cmp.getTime() === todayRef.getTime()) {
        cell.classList.add('today');
      }

      // Renderizar eventos deste dia
      const y = date.getFullYear();
      const m = pad2(date.getMonth() + 1);
      const d = pad2(date.getDate());
      const key = `${y}-${m}-${d}`;

      const doDia = eventosDoMes.filter(ev => ev.__ymd === key);
      for (const ev of doDia) {
        cell.appendChild(eventPill(ev));
      }

      return cell;
    }

    function eventPill(ev) {
      const pill = document.createElement('div');
      const estado = (ev.confirmacao === 'previsto') ? 'previsto' : 'confirmado';
      pill.className = `ev ${estado}`;

      // Nome do evento
      const name = document.createElement('div');
      name.className = 'name';
      name.title = ev.nomeEvento || '(Sem nome)';
      name.textContent = ev.nomeEvento || '(Sem nome)';

      // Estimativa
      const est = document.createElement('div');
      est.className = 'est';
      const estVal = Number(ev.estimativaVenda || 0);
      est.textContent = BRL(estVal);

      // Seletor Confirmado/Previsto
      const selWrap = document.createElement('div');
      selWrap.className = 'sel';
      const sel = document.createElement('select');
      sel.innerHTML = `
        <option value="confirmado">Confirmado</option>
        <option value="previsto">Previsto</option>
      `;
      sel.value = estado;
      sel.title = 'Definir confirmação deste evento';

      sel.addEventListener('change', async (e) => {
        const novo = e.target.value;
        try {
          await db().ref(\`${EVT_PATH}/${ev._id}/confirmacao\`).set(novo);
          pill.classList.toggle('previsto', novo === 'previsto');
          pill.classList.toggle('confirmado', novo !== 'previsto');
          // Recalcular KPI à confirmar
          computeKPIs();
        } catch (err) {
          console.error('Erro ao atualizar confirmacao:', err);
          alert('Não foi possível salvar. Verifique a conexão.');
          sel.value = estado; // volta
        }
      });

      selWrap.appendChild(sel);

      // Ações (ver/excluir como você já usa)
      const act = document.createElement('div');
      act.className = 'act';
      const btnView = document.createElement('button');
      btnView.className = 'tiny-btn';
      btnView.textContent = 'Ver';
      btnView.title = 'Abrir gestão do evento';
      btnView.addEventListener('click', () => {
        if (ev._id) {
          window.open(\`GestaoEvento.html?id=\${ev._id}\`, '_blank');
        }
      });

      const btnDel = document.createElement('button');
      btnDel.className = 'tiny-btn';
      btnDel.textContent = 'Excluir';
      btnDel.title = 'Excluir evento';
      btnDel.addEventListener('click', async () => {
        if (!ev._id) return;
        const ok = confirm('Tem certeza que deseja excluir este evento?');
        if (!ok) return;
        try {
          await db().ref(\`${EVT_PATH}/${ev._id}\`).remove();
        } catch (err) {
          console.error('Erro ao excluir:', err);
          alert('Erro ao excluir.');
        }
      });

      act.appendChild(btnView);
      act.appendChild(btnDel);

      // Montagem
      const left = document.createElement('div');
      left.appendChild(name);
      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.gap = '6px';
      right.appendChild(est);
      right.appendChild(selWrap);

      pill.appendChild(left);
      pill.appendChild(right);
      pill.appendChild(act);

      return pill;
    }

    // ====== KPIs ======
    function computeKPIs() {
      // Considera eventos do mês exibido (já filtrados em eventosDoMes)
      let totalPrevista = 0;
      let totalPrevistaAConfirmar = 0;

      for (const ev of eventosDoMes) {
        const est = Number(ev.estimativaVenda || 0);
        totalPrevista += est;
        if ((ev.confirmacao || 'confirmado') === 'previsto') {
          totalPrevistaAConfirmar += est;
        }
      }

      document.getElementById('kpiPrevistaTotalValue').textContent = BRL(totalPrevista);
      const kpiAConf = document.getElementById('kpiPrevistaAConfirmar');
      document.getElementById('kpiPrevistaAConfirmarValue').textContent = BRL(totalPrevistaAConfirmar);
      // Destaque quando há valor à confirmar
      if (totalPrevistaAConfirmar > 0) kpiAConf.classList.add('warn'); else kpiAConf.classList.remove('warn');
    }

    // ====== Carregar eventos do mês atual ======
    let eventosRef = null;

    function watchMonth() {
      // Remove listeners anteriores
      if (eventosRef) {
        eventosRef.off();
      }

      const { start, end } = getMonthRange(current);
      // Normalizamos datas no formato YYYY-MM-DD (projeto costuma salvar em string ou timestamp)
      // Estratégia: buscar todos eventos e filtrar por data (caso não tenha índice por data)
      eventosRef = db().ref(EVT_PATH);
      eventosRef.on('value', snap => {
        const vals = snap.val() || {};
        const arr = [];

        for (const [id, ev] of Object.entries(vals)) {
          // Pega data
          let ymd = null;
          if (ev.data) {
            // Aceita "YYYY-MM-DD", "DD/MM/YYYY" ou timestamp numérico
            if (typeof ev.data === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(ev.data)) {
              ymd = ev.data;
            } else if (typeof ev.data === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(ev.data)) {
              const [dd, mm, yy] = ev.data.split('/');
              ymd = `${yy}-${mm}-${dd}`;
            } else if (typeof ev.data === 'number') {
              const d = new Date(ev.data);
              ymd = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            }
          }

          // Se não tem data, pula da grade (mas você pode listar em uma “sem data” se quiser)
          if (!ymd) continue;

          // Filtra por mês
          const [Y, M, D] = ymd.split('-').map(Number);
          const dt = new Date(Y, M-1, D);
          if (dt >= start && dt < end) {
            arr.push({
              _id: id,
              __ymd: ymd,
              nomeEvento: ev.nomeEvento || ev.nome || '(Sem nome)',
              estimativaVenda: ev.estimativaVenda || 0,
              confirmacao: ev.confirmacao || 'confirmado', // default
              status: ev.status || 'Aberto'
            });
          }
        }

        eventosDoMes = arr.sort((a,b) => a.__ymd.localeCompare(b.__ymd));
        renderMonthHeader();
        buildCalendarDays();
        computeKPIs();
      });

      // Atualizações pontuais (child_added/changed/removed) opcional —
      // como usamos 'value', já re-renderiza tudo de uma vez.
    }

    // ====== Navegação do mês ======
    document.getElementById('btnPrev').addEventListener('click', () => {
      current.setMonth(current.getMonth() - 1);
      watchMonth();
    });
    document.getElementById('btnNext').addEventListener('click', () => {
      current.setMonth(current.getMonth() + 1);
      watchMonth();
    });
    document.getElementById('btnToday').addEventListener('click', () => {
      const now = new Date();
      current = new Date(now.getFullYear(), now.getMonth(), 1);
      watchMonth();
    });

    // ====== Boot ======
    (function init() {
      // Se o app não estiver inicializado, esta chamada lançará erro no console.
      try {
        // Checagem simples (se precisar)
        if (!firebase.apps.length) {
          console.warn('Firebase app não inicializado. Certifique-se de incluir sua config antes desta página.');
        }
      } catch (e) {}
      watchMonth();
    })();
  </script>
</body>
</html>
