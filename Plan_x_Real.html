<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planejado x Real</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --ind-w: 110px;   /* Centro/Categoria (fixo à esquerda) */
    --year-w: 110px;  /* Largura de cada coluna anual sticky */
    --col-w: 120px;   /* Largura de cada mês */
    --fs: 12px;
    --fs-sm: 10.6px;
  }
  .main-content { padding:14px 18px; }
  body, table, input, button, select { font-size: var(--fs); }
  .page-header h1 { margin:4px 0 2px; color:#111 !important; } /* título preto */
  .page-header p  { margin:0 0 8px; color:#666; font-size:var(--fs-sm); }

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .badge{background:#f6f6f6;border:1px solid #e5e5e5;padding:2px 6px;border-radius:6px;font-size:11.5px;}
  select{height:30px}

  /* viewport rolável com sticky header e sticky resultado */
  .table-viewport {
    border:1px solid #eee; border-radius:8px; background:#fff;
    height:72vh; overflow:auto; position:relative;
  }
  table.fx { width:100%; border-collapse:collapse; }
  .fx th, .fx td { border:1px solid #e6e6e6; padding:6px 8px; }

  /* cabeçalho sticky */
  .fx thead th {
    position: sticky; top: 0; z-index: 5;
    background:#fff7ec; font-weight:600;
    color:#111 !important; text-shadow:none !important; /* títulos em preto */
  }
  /* reforço: qualquer th específico também preto */
  .fx th.ind, .fx th.annual1, .fx th.annual2, .fx th.month {
    color:#111 !important; text-shadow:none !important;
  }

  /* três primeiras colunas fixas */
  .fx th.ind, .fx td.ind {
    position: sticky; left:0; z-index:6; background:#fafafa;
    width:var(--ind-w); min-width:var(--ind-w); max-width:var(--ind-w);
    text-align:left; white-space:nowrap;
  }
  .fx th.annual1, .fx td.annual1 {
    position: sticky; left:var(--ind-w); z-index:4; background:#fafafa;
    width:var(--year-w); min-width:var(--year-w); max-width:var(--year-w);
    text-align:right; white-space:nowrap;
  }
  .fx th.annual2, .fx td.annual2 {
    position: sticky; left:calc(var(--ind-w) + var(--year-w)); z-index:4; background:#fafafa;
    width:var(--year-w); min-width:var(--year-w); max-width:var(--year-w);
    text-align:right; white-space:nowrap;
  }
  .fx thead th.month, .fx tbody td.month { min-width:var(--col-w); width:var(--col-w); text-align:right; }

  .row-odd  td { background:#ffffff; }
  .row-even td { background:#f7f7fb; }

  .toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; font-weight:700; }
  .caret  { font-size:11px; color:#555; width:12px; text-align:center; }
  tr.cat-row.hidden { display:none; }

  .num { text-align:right; white-space:nowrap; }
  .muted{ color:#6b7280; font-size: var(--fs-sm); }
  .pct  { color:#475569; font-size:var(--fs-sm); margin-left:4px; }

  .delta-pos{ color:#059669; } /* verde */
  .delta-neg{ color:#dc2626; } /* vermelho */

  /* célula em 2 linhas: Linha de cima (negrito) + delta% ao lado; Linha de baixo (muted) */
  .cell2{ display:flex; flex-direction:column; gap:2px; align-items:flex-end; }
  .line-top{ font-weight:600; }
  .line-bottom{ color:#6b7280; font-size:var(--fs-sm); }

  .grp-total { font-weight:700; }

  /* Resultado sticky no rodapé */
  tr.resultado td{
    position: sticky; bottom: 0; z-index: 7;
    background:#fff7f0; font-weight:800; border-top:2px solid #f97316;
  }
  tr.resultado td.ind     { left: 0; }
  tr.resultado td.annual1 { left: var(--ind-w); }
  tr.resultado td.annual2 { left: calc(var(--ind-w) + var(--year-w)); }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Planejado x Real</h1>
      <p>
        <b>Planejado (Anual)</b>: linha de cima mostra o <b>Híbrido</b> (Real até mês base + Planejado restante) com Δ% vs Planejado Anual; linha de baixo mostra o <b>Planejado Anual</b>.<br/>
        <b>Acumulado (até mês base)</b>: linha de cima é o <b>Real acumulado</b> e a de baixo o <b>Planejado acumulado</b>, com Δ% ao lado.<br/>
        Meses: linha de cima = <b>Real</b>, linha de baixo = <span class="muted">Planejado</span>, com Δ%.
      </p>
    </div>

    <section class="controls">
      <label>Ano:
        <select id="anoSelect">
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>
      </label>
      <span class="badge" id="ctx">—</span>
    </section>

    <div class="table-viewport">
      <table class="fx" id="tbl">
        <thead>
          <tr id="hdr">
            <th class="ind">Centro/Categoria</th>
            <th class="annual1">Planejado (Anual)</th>
            <th class="annual2">Acumulado (até mês base)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  // Utils
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date();
  const ANO_ATUAL = hoje.getFullYear();
  const MES_ATUAL = hoje.getMonth()+1;
  const MES_BASE_ATUAL = ((MES_ATUAL-2+12)%12)+1; // mês anterior (1..12)

  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const num  = v => isNaN(Number(v)) ? 0 : Number(v);
  const cur  = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  // Firebase
  try{
    const cfg = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(cfg);
  }catch(e){ console.error(e); }
  const db = firebase.database();

  // Estado
  const categorias = new Map(); // id -> {nome, centro}
  const grupos = new Map();     // centro -> [ids]

  // Real
  const realMensal = new Map(); // id -> [12]
  const realAnual  = new Map(); // id -> soma
  const receitaRealMensal = Array(12).fill(0);
  let receitaRealAnual = 0;

  // Planejado
  const projMensal = new Map(); // id -> [12]
  const projAnual  = new Map(); // id -> soma
  const receitaProjMensal = Array(12).fill(0);
  let receitaProjAnual = 0;

  // Meses a exibir e mês base (para o ano selecionado)
  let mesesExibidos = [];
  let MES_BASE = MES_BASE_ATUAL; // recalculado por ano selecionado

  // ---- Categorias
  async function loadCategorias(){
    categorias.clear(); grupos.clear();
    const snap = await db.ref('financeiro/categorias').once('value');
    const v = snap.val() || {};
    Object.keys(v).forEach(id=>{
      const c = v[id]||{};
      const centro = c.centroDeCusto || c.centro || 'Outros';
      categorias.set(id, { id, nome: c.nome || id, centro });
      if (!grupos.has(centro)) grupos.set(centro, []);
      grupos.get(centro).push(id);
    });
    grupos.forEach(list=> list.sort((a,b)=>(categorias.get(a).nome).localeCompare(categorias.get(b).nome,'pt-BR')));
  }

  // ---- DRE Real (ano)
  async function loadReal(ANO){
    realMensal.clear(); realAnual.clear();
    receitaRealMensal.fill(0); receitaRealAnual = 0;
    const s = await db.ref(`financeiro/dre_fechado/${ANO}`).once('value');
    if (!s.exists()) return;
    const v = s.val()||{};
    Object.keys(v).forEach(mm=>{
      const m = Number(mm); if (!(m>=1&&m<=12)) return;
      const node = v[mm]||{};
      const recMes = num(node?.grupos?.Receita?.mes || 0);
      receitaRealMensal[m-1] = recMes; receitaRealAnual += recMes;

      const cats = node.categorias||{};
      Object.keys(cats).forEach(id=>{
        const val = num(cats[id]?.valorMes || 0);
        const arr = realMensal.get(id)||Array(12).fill(0); arr[m-1]=val; realMensal.set(id,arr);
        realAnual.set(id, num(realAnual.get(id)||0)+val);
      });
    });
  }

  // ---- Planejado (projeção salva)
  async function loadProj(ANO){
    projMensal.clear(); projAnual.clear();
    receitaProjMensal.fill(0); receitaProjAnual = 0;
    const s = await db.ref(`financeiro/planejamento_projecao/${ANO}`).once('value');
    const v = s.val() || {};
    if (Array.isArray(v.receitaProj)){
      for (let i=0;i<12;i++){ receitaProjMensal[i]=num(v.receitaProj[i]||0); receitaProjAnual+=receitaProjMensal[i]; }
    }
    const cats = v.categorias || {};
    Object.keys(cats).forEach(id=>{
      const arr = (cats[id]?.projMensal||[]).map(num);
      const pad = Array(12).fill(0); for(let i=0;i<12;i++) pad[i]=num(arr[i]||0);
      projMensal.set(id, pad);
      projAnual.set(id, pad.reduce((a,b)=>a+num(b),0));
    });
  }

  // ---- Cabeçalho e meses
  function defineMeses(ANO){
    if (ANO==2025) mesesExibidos = [10,11,12];
    else mesesExibidos = [1,2,3,4,5,6,7,8,9,10,11,12];

    if (ANO < ANO_ATUAL) MES_BASE = 12;
    else if (ANO > ANO_ATUAL) MES_BASE = 0;
    else MES_BASE = MES_BASE_ATUAL;
  }
  function buildHeader(ANO){
    const hdr = document.getElementById('hdr');
    hdr.innerHTML = `
      <th class="ind">Centro/Categoria</th>
      <th class="annual1">Planejado (Anual)</th>
      <th class="annual2">Acumulado (até mês base)</th>
    `;
    mesesExibidos.forEach(m=>{
      const th = document.createElement('th'); th.className='month'; th.textContent = mesesPt[m-1]; hdr.appendChild(th);
    });
  }

  // ---- Somatórios por grupo
  const ORDEM = ["Receita","CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"];

  function somaProjGrupo(nome){
    let tot=0; (grupos.get(nome)||[]).forEach(id=> tot += (projMensal.get(id)||Array(12).fill(0)).reduce((a,b)=>a+num(b),0));
    return tot;
  }
  function somaRealGrupo(nome){
    let tot=0; (grupos.get(nome)||[]).forEach(id=> tot += num(realAnual.get(id)||0));
    return tot;
  }
  function somaProjMesGrupo(nome,m){
    let tot=0; (grupos.get(nome)||[]).forEach(id=> tot += num((projMensal.get(id)||[])[m-1]||0) );
    return tot;
  }
  function somaRealMesGrupo(nome,m){
    let tot=0; (grupos.get(nome)||[]).forEach(id=> tot += num((realMensal.get(id)||[])[m-1]||0) );
    return tot;
  }
  function somaAcum(arr,m){ let s=0; for(let i=0;i<m;i++) s+=num(arr[i]||0); return s; }

  // ---- Híbrido (Real até MES_BASE + Planejado depois)
  function hibridoAnualCategoria(id){
    const r = realMensal.get(id)||Array(12).fill(0);
    const p = projMensal.get(id)||Array(12).fill(0);
    let s=0;
    for(let i=0;i<12;i++){
      const mes = i+1;
      s += (mes<=MES_BASE ? num(r[i]) : num(p[i]));
    }
    return s;
  }
  function hibridoAnualReceita(){
    let s=0;
    for(let i=0;i<12;i++){
      const mes = i+1;
      s += (mes<=MES_BASE ? num(receitaRealMensal[i]) : num(receitaProjMensal[i]));
    }
    return s;
  }

  // ---- Tabela
  function montarTabela(ANO){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';

    // ordem de centros
    const centros = Array.from(grupos.keys());
    const ordenados = [...ORDEM, ...centros.filter(c=>!ORDEM.includes(c))];

    const headers = {};
    // linhas de grupo + categorias
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const key = norm(g).replace(/\s+/g,'-');
      // linha de grupo
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ind"><span class="toggle" data-grp="${key}" data-open="1"><span class="caret">▼</span> ${g}</span></td>
        <td class="annual1 num grp-total">—</td>
        <td class="annual2 num grp-total">—</td>
        ${mesesExibidos.map(()=>`<td class="month num grp-total">—</td>`).join('')}
      `;
      tr.dataset.grpkey = key;
      tbody.appendChild(tr);
      headers[g]=tr;

      // categorias do grupo
      (grupos.get(g)||[]).forEach(id=>{
        const cat = categorias.get(id);
        const arrP = projMensal.get(id)||Array(12).fill(0);
        const arrR = realMensal.get(id)||Array(12).fill(0);

        const pAnual   = arrP.reduce((a,b)=>a+num(b),0);
        const hAnual   = hibridoAnualCategoria(id);
        const pAcumYTD = somaAcum(arrP, Math.max(MES_BASE,0));
        const rAcumYTD = somaAcum(arrR, Math.max(MES_BASE,0));

        // Coluna Planejado (Anual) COMPARANDO HÍBRIDO
        const dAnnual = pAnual ? ((hAnual - pAnual)/pAnual*100) : 0;
        const kAnnual = (hAnual - pAnual)>=0 ? 'delta-pos' : 'delta-neg';

        const trc = document.createElement('tr'); trc.className='cat-row'; trc.dataset.grp=key;

        const c0 = document.createElement('td'); c0.className='ind'; c0.textContent = cat.nome;

        const c1 = document.createElement('td'); c1.className='annual1';
        c1.innerHTML = `<div class="cell2">
            <div class="line-top">${cur(hAnual)} <span class="${kAnnual}">(${dAnnual.toFixed(1)}%)</span></div>
            <div class="line-bottom">${cur(pAnual)}</div>
          </div>`;

        // Coluna ACUMULADO (YTD): Real (topo) x Planejado (baixo)
        const dY = pAcumYTD ? ((rAcumYTD - pAcumYTD)/pAcumYTD*100) : 0;
        const kY = (rAcumYTD - pAcumYTD)>=0 ? 'delta-pos' : 'delta-neg';
        const c2 = document.createElement('td'); c2.className='annual2';
        c2.innerHTML = `<div class="cell2">
            <div class="line-top">${cur(rAcumYTD)} <span class="${kY}">(${dY.toFixed(1)}%)</span></div>
            <div class="line-bottom">${cur(pAcumYTD)}</div>
          </div>`;

        trc.appendChild(c0); trc.appendChild(c1); trc.appendChild(c2);

        // Meses: Real (topo) x Planejado (baixo)
        mesesExibidos.forEach(m=>{
          const rp = num(arrR[m-1]||0);
          const pp = num(arrP[m-1]||0);
          const d  = pp ? (rp - pp)/pp*100 : 0;
          const klass = (rp - pp)>=0 ? 'delta-pos' : 'delta-neg';
          const td = document.createElement('td'); td.className='month';
          td.innerHTML = `
            <div class="cell2">
              <div class="line-top">${cur(rp)} <span class="${klass}">(${d.toFixed(1)}%)</span></div>
              <div class="line-bottom">${cur(pp)}</div>
            </div>`;
          trc.appendChild(td);
        });

        tbody.appendChild(trc);
      });
    });

    // preencher totais por grupo
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const head = headers[g];

      const pAnualG = somaProjGrupo(g);
      // híbrido do grupo
      const hAnualG = (function(){ let t=0; (grupos.get(g)||[]).forEach(id=> t+=hibridoAnualCategoria(id)); return t; })();
      // acumulados do grupo
      const pAcumG = (function(){ let s=0; for(let i=1;i<=MES_BASE;i++) s+=somaProjMesGrupo(g,i); return s; })();
      const rAcumG = (function(){ let s=0; for(let i=1;i<=MES_BASE;i++) s+=somaRealMesGrupo(g,i); return s; })();

      // Planejado anual comparando Híbrido
      const dAnn = pAnualG ? ((hAnualG - pAnualG)/pAnualG*100) : 0;
      const kAnn = (hAnualG - pAnualG)>=0 ? 'delta-pos' : 'delta-neg';
      head.children[1].innerHTML = `<div class="cell2">
        <div class="line-top">${cur(hAnualG)} <span class="${kAnn}">(${dAnn.toFixed(1)}%)</span></div>
        <div class="line-bottom">${cur(pAnualG)}</div>
      </div>`;

      // Acumulado (YTD)
      const dYG = pAcumG ? ((rAcumG - pAcumG)/pAcumG*100) : 0;
      const kYG = (rAcumG - pAcumG)>=0 ? 'delta-pos' : 'delta-neg';
      head.children[2].innerHTML = `<div class="cell2">
        <div class="line-top">${cur(rAcumG)} <span class="${kYG}">(${dYG.toFixed(1)}%)</span></div>
        <div class="line-bottom">${cur(pAcumG)}</div>
      </div>`;

      // Meses
      mesesExibidos.forEach((m,idx)=>{
        const r = somaRealMesGrupo(g,m);
        const p = somaProjMesGrupo(g,m);
        const d = p? ((r-p)/p*100) : 0;
        const klass = (r-p)>=0 ? 'delta-pos' : 'delta-neg';
        head.children[3+idx].innerHTML = `
          <div class="cell2">
            <div class="line-top">${cur(r)} <span class="${klass}">(${d.toFixed(1)}%)</span></div>
            <div class="line-bottom">${cur(p)}</div>
          </div>`;
      });
    });

    // ===== Resultado (sticky)
    const trRes = document.createElement('tr'); trRes.className='resultado';
    // Planejado (resultado anual)
    const pRecAnual = somaProjGrupo("Receita");
    const pOutAnual = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
      .map(g=>somaProjGrupo(g)).reduce((a,b)=>a+b,0));
    const pResAnual = pRecAnual - pOutAnual;

    // Híbrido (resultado anual)
    const hRecAnual = (function(){ let t=0; (grupos.get("Receita")||[]).forEach(id=> t+=hibridoAnualCategoria(id)); return t; })();
    const hOutAnual = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
      .map(gr=>{ let t=0; (grupos.get(gr)||[]).forEach(id=> t+=hibridoAnualCategoria(id)); return t; })
      .reduce((a,b)=>a+b,0));
    const hResAnual = hRecAnual - hOutAnual;

    // Acumulado YTD (resultado)
    let pResY=0, rResY=0;
    for(let i=1;i<=MES_BASE;i++){
      const pr = somaProjMesGrupo("Receita",i);
      const po = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
        .map(g=>somaProjMesGrupo(g,i)).reduce((a,b)=>a+b,0));
      const rr = somaRealMesGrupo("Receita",i);
      const ro = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
        .map(g=>somaRealMesGrupo(g,i)).reduce((a,b)=>a+b,0));
      pResY += (pr - po);
      rResY += (rr - ro);
    }
    const dY = pResY ? ((rResY - pResY)/pResY*100) : 0;
    const kY = (rResY - pResY)>=0 ? 'delta-pos' : 'delta-neg';

    const cellsMes = mesesExibidos.map(m=>{
      const pr = somaProjMesGrupo("Receita",m);
      const po = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
        .map(g=>somaProjMesGrupo(g,m)).reduce((a,b)=>a+b,0));
      const rr = somaRealMesGrupo("Receita",m);
      const ro = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
        .map(g=>somaRealMesGrupo(g,m)).reduce((a,b)=>a+b,0));
      const p = pr - po;
      const r = rr - ro;
      const d = p? ((r-p)/p*100):0;
      const klass = (r-p)>=0 ? 'delta-pos' : 'delta-neg';
      return `<td class="month">
        <div class="cell2">
          <div class="line-top">${cur(r)} <span class="${klass}">(${d.toFixed(1)}%)</span></div>
          <div class="line-bottom">${cur(p)}</div>
        </div>
      </td>`;
    }).join('');

    trRes.innerHTML = `
      <td class="ind">Resultado</td>
      <td class="annual1"><div class="cell2">
        <div class="line-top">${cur(hResAnual)} <span class="${(hResAnual-pResAnual)>=0?'delta-pos':'delta-neg'}">(${pResAnual?(((hResAnual-pResAnual)/pResAnual*100).toFixed(1)): '0.0'}%)</span></div>
        <div class="line-bottom">${cur(pResAnual)}</div>
      </div></td>
      <td class="annual2"><div class="cell2">
        <div class="line-top">${cur(rResY)} <span class="${kY}">(${dY.toFixed(1)}%)</span></div>
        <div class="line-bottom">${cur(pResY)}</div>
      </div></td>
      ${cellsMes}
    `;
    tbody.appendChild(trRes);

    // zebra & toggles
    let i=0; tbody.querySelectorAll('tr').forEach(tr=>{ tr.classList.add( (i%2===0)?'row-odd':'row-even' ); i++; });
    tbody.querySelectorAll('.toggle').forEach(tg=>{
      tg.addEventListener('click', ()=>{
        const grp = tg.dataset.grp; const open = tg.dataset.open==='1';
        tg.dataset.open = open ? '0':'1';
        tg.querySelector('.caret').textContent = open ? '►' : '▼';
        document.querySelectorAll(`tr.cat-row[data-grp="${grp}"]`).forEach(r=> r.classList.toggle('hidden', open));
      });
    });
  }

  // ---- Rebuild
  async function rebuild(ANO){
    defineMeses(ANO);
    document.getElementById('ctx').textContent =
      `Ano ${ANO} • Mês base: ${MES_BASE? ('0'+MES_BASE).slice(-2) : '—'} • Meses: ${ANO==2025?'Out/Nov/Dez':'Jan–Dez'}`;
    await loadCategorias();
    await loadReal(ANO);
    await loadProj(ANO);
    buildHeader(ANO);
    montarTabela(ANO);
  }

  // start
  const selAno = document.getElementById('anoSelect');
  selAno.onchange = ()=> rebuild(Number(selAno.value));
  rebuild(2025);
})();
</script>
</body>
</html>
