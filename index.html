<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Le Pan pan ‚Äî Painel Operacional</title>

  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="assets/base.css" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="assets/menu.js" defer></script>

  <style>
    :root{
      --accent:#ff7f00;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#fff;
      --soft:#fff8ef;
      --ok:#16a34a;
      --warn:#f59e0b;
    }
    .main-content{ padding-top:10px }
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .page-header h1{ font-size:18px; margin:0 }

    /* Atalhos */
    .quick-links{
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:8px
    }
    @media (max-width:1100px){ .quick-links{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:720px){ .quick-links{grid-template-columns:repeat(2,1fr)} }
    .qbtn{
      display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--line);
      border-left:3px solid var(--accent);border-radius:10px;background:#fff;text-decoration:none;color:#111
    }
    .qbtn:hover{ background:#fff7ed }
    .qbtn .icon{font-size:18px}

    /* KPIs compactos em uma linha */
    .kpi-row{
      display:grid;
      grid-template-columns:repeat(6, minmax(180px,1fr));
      gap:8px;
      margin-bottom:8px
    }
    @media (max-width:1280px){ .kpi-row{ grid-template-columns:repeat(3,1fr) } }
    @media (max-width:720px){ .kpi-row{ grid-template-columns:repeat(2,1fr) } }

    .kcard{
      background:var(--soft);
      border:1px solid var(--line);
      border-left:3px solid var(--accent);
      border-radius:12px;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:64px
    }
    .klabel{font-size:11px;color:#374151}
    .kvalue{font-size:18px;font-weight:800;color:var(--accent);line-height:1}
    .kvalue-plain{font-size:18px;font-weight:800;color:#111;line-height:1}
    .pct{font-size:11px;color:#374151;text-align:right}
    .pwrap{background:#e5e7eb;border-radius:999px;overflow:hidden;height:6px;border:1px solid var(--line)}
    .pbar{height:6px;background:linear-gradient(90deg,#10b981,#60a5fa);width:0%}

    /* Layout: esquerda/ direita */
    .cols-2{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}
    @media (max-width:1100px){ .cols-2{grid-template-columns:1fr} }

    .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .box h3{margin:0 0 8px 0;font-size:14px}

    /* Semana */
    .legend{display:flex;gap:12px;font-size:12px;color:#6b7280;margin:6px 0 8px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}
    table{width:100%;border-collapse:collapse;font-size:12.5px}
    thead th{background:#f8fafc;padding:6px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{padding:6px;border-bottom:1px solid var(--line)}
    .status-badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid;display:inline-flex;align-items:center;gap:6px}
    .status-prev{color:#92400e;border-color:#f59e0b;background:#fffbeb}
    .status-conf{color:#065f46;border-color:#10b981;background:#ecfdf5}

    .week-totals{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .wcard{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px}
    .wlabel{font-size:12px;color:#374151}
    .wvalue{font-size:18px;font-weight:800;color:#111}

    /* An√°lise 3 √∫ltimos meses */
    .analise-box table{width:100%;border-collapse:collapse;font-size:12.5px}
    .analise-box thead th{background:#f8fafc;padding:6px;border-bottom:1px solid var(--line);text-align:left}
    .analise-box tbody td{padding:6px;border-bottom:1px solid var(--line)}

    /* Gr√°ficos */
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:1050px){ .charts{grid-template-columns:1fr} }
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .chart-card canvas{height:260px !important;}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <div class="page-header"><h1>Painel Operacional</h1></div>

      <!-- Atalhos -->
      <div class="quick-links">
        <a class="qbtn" href="eventos.html" target="_blank" rel="noopener"><span class="icon">üìã</span><div><div style="font-weight:700">Eventos</div><small> Criar/editar eventos</small></div></a>
        <a class="qbtn" href="agenda.html" target="_blank" rel="noopener"><span class="icon">üóìÔ∏è</span><div><div style="font-weight:700">Agenda</div><small> Semana e proje√ß√µes</small></div></a>
        <a class="qbtn" href="planejamento_evento.html" target="_blank" rel="noopener"><span class="icon">üß©</span><div><div style="font-weight:700">Planejamento</div><small> Equipe, log√≠stica, equipamento</small></div></a>
        <a class="qbtn" href="relatorio/relatorio_Semanal.html" target="_blank" rel="noopener"><span class="icon">üìà</span><div><div style="font-weight:700">Relat√≥rio Semanal</div><small> Resultados da semana</small></div></a>
        <a class="qbtn" href="gestao_Cliente.html" target="_blank" rel="noopener"><span class="icon">üë•</span><div><div style="font-weight:700">Clientes</div><small> Ativos e prospects</small></div></a>
      </div>

      <!-- KPIs compactos: 6 cards em uma linha -->
      <div class="kpi-row">
        <!-- Venda (Estimativa) -->
        <div class="kcard">
          <div class="klabel">Estimativa Venda M√™s</div>
          <div class="kvalue">R$ <span id="kpi-estimativa-mes">0,00</span></div>
          <div class="pwrap"><div id="pb-venda" class="pbar"></div></div>
          <div class="pct"><span id="kpi-venda-pct">0%</span></div>
        </div>
        <!-- Venda (Real) -->
        <div class="kcard">
          <div class="klabel">Venda Real M√™s</div>
          <div class="kvalue-plain">R$ <span id="kpi-venda-mes">0,00</span></div>
        </div>

        <!-- Lucro (Estimado) -->
        <div class="kcard">
          <div class="klabel">Lucro Estimado M√™s</div>
          <div class="kvalue">R$ <span id="kpi-lucro-estimado-mes">0,00</span></div>
          <div class="pwrap"><div id="pb-lucro" class="pbar"></div></div>
          <div class="pct"><span id="kpi-lucro-pct">0%</span></div>
        </div>
        <!-- Lucro (Real) -->
        <div class="kcard">
          <div class="klabel">Lucro no m√™s (Fech./Final.)</div>
          <div class="kvalue-plain">R$ <span id="kpi-lucro-mes">0,00</span></div>
        </div>

        <!-- Eventos (Estimados) -->
        <div class="kcard">
          <div class="klabel">Eventos Estimados no M√™s</div>
          <div class="kvalue"><span id="kpi-ev-est">0</span></div>
          <div class="pwrap"><div id="pb-ev" class="pbar"></div></div>
          <div class="pct"><span id="kpi-ev-pct">0%</span></div>
        </div>
        <!-- Eventos (Realizados) -->
        <div class="kcard">
          <div class="klabel">Eventos Realizados no M√™s</div>
          <div class="kvalue-plain"><span id="kpi-ev-real">0</span></div>
        </div>
      </div>

      <!-- Semana + An√°lise √∫ltimos 3 meses -->
      <div class="cols-2">
        <!-- Semana -->
        <div class="box">
          <h3>Semana (Seg‚ÄìDom)</h3>
          <div class="legend">
            <span><span class="dot ok"></span>Confirmado</span>
            <span><span class="dot warn"></span>Previsto</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Evento</th><th>Status</th>
                <th style="text-align:right">Estimativa</th>
              </tr>
            </thead>
            <tbody id="lista-semana"></tbody>
          </table>

          <div class="week-totals">
            <div class="wcard">
              <div class="wlabel">Eventos desta semana</div>
              <div class="wvalue" id="wk-qtd">0</div>
            </div>
            <div class="wcard">
              <div class="wlabel">Venda prevista da semana</div>
              <div class="wvalue">R$ <span id="wk-prev">0,00</span></div>
            </div>
          </div>
        </div>

        <!-- An√°lise 3 √∫ltimos meses -->
        <div class="box analise-box">
          <h3>An√°lise ‚Äî 3 √∫ltimos meses</h3>
          <table>
            <thead>
              <tr>
                <th>M√™s</th>
                <th style="text-align:right">Venda</th>
                <th style="text-align:right">Lucro</th>
                <th style="text-align:right">Margem</th>
              </tr>
            </thead>
            <tbody id="tb-ultimos"></tbody>
          </table>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="charts">
        <div class="chart-card">
          <h3 style="margin:0 0 6px 0">Vendas x Lucro (ano)</h3>
          <canvas id="graficoVendaLucro"></canvas>
        </div>
        <div class="chart-card">
          <h3 style="margin:0 0 6px 0">Eventos por m√™s (ano)</h3>
          <canvas id="graficoEventos"></canvas>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== Helpers ===== */
    const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    const toDate = s => { if(!s) return null; const [y,m,d]=s.split('-'); return new Date(+y, +m-1, +d); };
    const mondayOf = d => { const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day=x.getDay(); const diff=(day===0?-6:1)-day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; };
    const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const within = (date,start,end) => { const x=new Date(date.getFullYear(), date.getMonth(), date.getDate()); return x>=start && x<=end; };
    const brMoney = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const pct = v => (Number(v||0)).toFixed(1).replace('.',',')+'%';

    /* ===== Painel ===== */
    async function carregarPainel(){
      const [evSnap, cfgLucroSnap] = await Promise.all([
        db.ref('eventos').once('value'),
        db.ref('configuracao/percentualLucro').once('value')
      ]);

      const eventos = evSnap.val() || {};
      const margemPrevista = Number(cfgLucroSnap.val() ?? 40);

      const hoje = new Date();
      const semanaIni = mondayOf(hoje);
      const semanaFim = addDays(semanaIni, 6);
      const anoAtual = hoje.getFullYear();
      const mesAtual = hoje.getMonth();

      /* ===== Agrega√ß√µes ===== */
      let estimativaMes = 0, vendaMes = 0, lucroMes = 0;
      let evEstimadosMes = 0, evRealizadosMes = 0;

      let wkQtd=0, wkPrev=0;

      const serieVenda = Array(12).fill(0);
      const serieLucro = Array(12).fill(0);
      const serieEventos = Array(12).fill(0);

      const linhasSemana = [];

      Object.values(eventos).forEach(e=>{
        if(!e || !e.data) return;
        const dt = toDate(e.data);
        const status = (e.status || 'Aberto');
        const final = (status==='Finalizado' || status==='Fechado');
        const estim = Number(e.estimativaVenda || 0);
        const vendaPDV = Number(e.vendaPDV || 0);
        const lucroFinal = Number(e.lucroFinal || 0);

        /* Semana */
        if (within(dt, semanaIni, semanaFim)) {
          wkQtd++; wkPrev += estim;
          const previsto = (e.previsto === true) || (e.projetado === true) || (e.tipo === 'projetado') || (e.origem === 'projecao');
          const badge = previsto ? `<span class="status-badge status-prev">‚óè Previsto</span>` : `<span class="status-badge status-conf">‚óè Confirmado</span>`;
          linhasSemana.push(`
            <tr>
              <td>${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}</td>
              <td>${e.nomeEvento||'-'}</td>
              <td>${badge}</td>
              <td style="text-align:right">R$ ${brMoney(estim)}</td>
            </tr>
          `);
        }

        /* M√™s */
        if (dt.getFullYear()===anoAtual && dt.getMonth()===mesAtual){
          evEstimadosMes++;
          estimativaMes += estim;
          if (final){
            evRealizadosMes++;
            vendaMes += vendaPDV;
            lucroMes += lucroFinal;
          }
        }

        /* S√©ries anuais */
        if (dt.getFullYear()===anoAtual){
          const m = dt.getMonth();
          if (final){ serieVenda[m]+=vendaPDV; serieLucro[m]+=lucroFinal; }
          serieEventos[m]+=1;
        }
      });

      /* ===== KPIs ===== */
      // Venda
      const vendaPct = estimativaMes>0 ? Math.min(200,(vendaMes/estimativaMes)*100) : 0;
      document.getElementById('kpi-estimativa-mes').innerText = brMoney(estimativaMes);
      document.getElementById('kpi-venda-mes').innerText = brMoney(vendaMes);
      document.getElementById('kpi-venda-pct').innerText = pct(vendaPct);
      document.getElementById('pb-venda').style.width = vendaPct+'%';

      // Lucro
      const lucroEstimadoMes = estimativaMes * (margemPrevista/100);
      const lucroPct = lucroEstimadoMes>0 ? Math.min(200,(lucroMes/lucroEstimadoMes)*100) : 0;
      document.getElementById('kpi-lucro-estimado-mes').innerText = brMoney(lucroEstimadoMes);
      document.getElementById('kpi-lucro-mes').innerText = brMoney(lucroMes);
      document.getElementById('kpi-lucro-pct').innerText = pct(lucroPct);
      document.getElementById('pb-lucro').style.width = lucroPct+'%';

      // Eventos
      const evPct = evEstimadosMes>0 ? Math.min(200,(evRealizadosMes/evEstimadosMes)*100) : 0;
      document.getElementById('kpi-ev-est').innerText = evEstimadosMes;
      document.getElementById('kpi-ev-real').innerText = evRealizadosMes;
      document.getElementById('kpi-ev-pct').innerText = pct(evPct);
      document.getElementById('pb-ev').style.width = evPct+'%';

      /* ===== Semana ===== */
      document.getElementById('lista-semana').innerHTML =
        linhasSemana.length ? linhasSemana.join('') : `<tr><td colspan="4" style="color:#6b7280">Nenhum evento nesta semana.</td></tr>`;
      document.getElementById('wk-qtd').innerText = wkQtd;
      document.getElementById('wk-prev').innerText = brMoney(wkPrev);

      /* ===== An√°lise ‚Äî 3 √∫ltimos meses ===== */
      const tb = document.getElementById('tb-ultimos');
      const rows = [];
      for (let i=2; i>=0; i--){
        const ref = new Date(anoAtual, mesAtual - i, 1);
        const y = ref.getFullYear(), m = ref.getMonth();
        let v=0, l=0;
        Object.values(eventos).forEach(e=>{
          if(!e || !e.data) return;
          const d = toDate(e.data);
          if (d.getFullYear()===y && d.getMonth()===m && (e.status==='Finalizado' || e.status==='Fechado')){
            v += Number(e.vendaPDV||0);
            l += Number(e.lucroFinal||0);
          }
        });
        const margem = v>0 ? (l/v)*100 : 0;
        rows.push(
          `<tr>
            <td>${meses[m]}</td>
            <td style="text-align:right">R$ ${brMoney(v)}</td>
            <td style="text-align:right">R$ ${brMoney(l)}</td>
            <td style="text-align:right">${pct(margem)}</td>
          </tr>`
        );
      }
      tb.innerHTML = rows.join('');

      /* ===== Gr√°ficos ===== */
      new Chart(document.getElementById('graficoVendaLucro'), {
        type:'line',
        data:{ labels:meses, datasets:[ {label:'Venda PDV',data:serieVenda,borderWidth:2,pointRadius:2,tension:.25},{label:'Lucro',data:serieLucro,borderWidth:2,pointRadius:2,tension:.25} ] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}} }
      });
      new Chart(document.getElementById('graficoEventos'), {
        type:'bar',
        data:{ labels:meses, datasets:[{label:'Eventos',data:serieEventos,borderWidth:1}] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    document.addEventListener('DOMContentLoaded', carregarPainel);
  </script>
</body>
</html>
