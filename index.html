<script>
  // ... Firebase config e inicialização idênticos

  async function carregarKPIs() {
    let estimado = 0, realizado = 0, semana = 0;
    let estimativaMes = 0, vendaMes = 0, estimativaSemana = 0, lucroMes = 0;
    let clientesAtivos = 0, clientesNovos = 0, clientesQuentes = 0, clientesPerdidos = 0;

    const [projSnap, previsaoSnap, eventosSnap, clientesSnap] = await Promise.all([
      db.ref('projecao_eventos/' + currentMonthPath).once('value'),
      db.ref('previsao_receita/' + currentMonthPath + '/total').once('value'),
      db.ref('eventos').once('value'),
      db.ref('clientes').once('value')
    ]);

    if (projSnap.exists()) estimado = Object.keys(projSnap.val()).length;
    estimativaMes = previsaoSnap.val() || 0;

    const eventos = eventosSnap.val();
    if (eventos) {
      Object.values(eventos).forEach(evento => {
        if (!evento.data) return;
        const dataEvento = formatDateBR(evento.data);
        const status = (evento.status || '').toLowerCase();

        const dentroDoMes = dataEvento.getFullYear() === now.getFullYear() &&
                            dataEvento.getMonth() === now.getMonth();
        const dentroDaSemana = dataEvento >= weekStart && dataEvento <= weekEnd;

        const vendaPDV = Number(evento.vendaPDV || 0);
        const cmvReal = Number(evento.cmvReal || 0);
        const custoEquipe = (evento.equipe || []).reduce((s, e) => s + (Number(e.valor) || 0), 0);
        const custoLogistica = (evento.logistica || []).reduce((s, l) => s + (Number(l.valor) || 0), 0);
        const lucroCalculado = vendaPDV - cmvReal - custoLogistica - custoEquipe;

        if (dentroDoMes && (status === "fechado" || status === "finalizado")) {
          realizado++;
          vendaMes += vendaPDV;
          lucroMes += lucroCalculado;
        }

        if (dentroDaSemana) {
          estimativaSemana += Number(evento.estimativaVenda || 0);
          semana++;
        }
      });
    }

    const clientes = clientesSnap.val();
    if (clientes) {
      Object.values(clientes).forEach(cli => {
        const status = cli.status || '';
        const statusEvento = cli.clienteAtivo?.statusEvento;

        if (status.toLowerCase() === 'quente') clientesQuentes++;
        if (statusEvento === 'Ativo') clientesAtivos++;
        if (statusEvento === 'Inativo') clientesPerdidos++;

        if (cli.dataCadastro && status === 'Fechado') {
          const ano = new Date(cli.dataCadastro).getFullYear();
          if (ano === currentYear) clientesNovos++;
        }
      });
    }

    document.getElementById('kpi-clientes-ativos').innerText = clientesAtivos;
    document.getElementById('kpi-clientes-novos').innerText = clientesNovos;
    document.getElementById('kpi-clientes-quentes').innerText = clientesQuentes;
    document.getElementById('kpi-clientes-perdidos').innerText = clientesPerdidos;

    document.getElementById('kpi-estimado').innerText = estimado;
    document.getElementById('kpi-realizado').innerText = realizado;
    document.getElementById('kpi-semana').innerText = semana;
    document.getElementById('kpi-estimativa-mes').innerText = formatCurrency(estimativaMes);
    document.getElementById('kpi-venda-mes').innerText = formatCurrency(vendaMes);
    document.getElementById('kpi-estimativa-semana').innerText = formatCurrency(estimativaSemana);
    document.getElementById('kpi-lucro-mes').innerText = formatCurrency(lucroMes);
  }

  carregarKPIs();
</script>
