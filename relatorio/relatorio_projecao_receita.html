<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório – Projeção de Receita</title>
  <link rel="stylesheet" href="../assets/base.css" />
  <link rel="stylesheet" href="../assets/menu-styles.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="../assets/menu.js"></script>
  <style>
    .page-header h1 { margin-bottom: 10px; }
    .card-dashboard{
      background:#fff; border:1px solid #eee; border-radius:10px; padding:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.04); margin-top:6px;
    }
    .filtros-grid{ display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; align-items:end; }
    @media (max-width: 1100px){ .filtros-grid{ grid-template-columns:1fr; } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:#555; }
    .field input[type="date"], .field select{
      border:1px solid #ddd; border-radius:8px; padding:7px 9px; font-size:12px; background:#fff;
    }
    #filtroNomeEvento{ min-height: 160px; padding:8px; line-height:1.3; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .btn{ background:#ff7f00; color:#fff; padding:7px 12px; border:none; border-radius:8px; font-size:12px; cursor:pointer; }
    .btn:hover{ background:#e96f00; }
    .btn-outline{ background:#fff; color:#444; border:1px solid #ddd; }
    .btn-outline:hover{ background:#f6f6f6; }
    .quick{ display:flex; gap:6px; margin-right:auto; }
    .quick .btn{ padding:5px 8px; font-size:11px; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
    th, td { border:1px solid #ddd; padding:6px 8px; text-align:center; }
    th { background-color:#ffcc80; position: sticky; top: 0; z-index: 1; }
    tbody tr:nth-child(even){ background:#fafafa; }
    tfoot td { font-weight: bold; background: #f9f9f9; }
    .right{ text-align:right; }
    .left{ text-align:left; }
    .section-title{ margin-top:14px; font-weight:700; font-size:14px; color:#333; display:flex; align-items:center; gap:8px; }
    .section-title .pill{ font-size:10px; padding:2px 8px; border-radius:999px; background:#ffe9d1; color:#8a3b00; }
    .muted { color:#777; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar" id="menuLateral"></aside>

  <main class="main-content">
    <div class="page-header">
      <h1>Projeção de Receita</h1>
      <div class="muted">Lista todos os eventos no período filtrado e resume por semana (seg → dom).</div>
    </div>

    <div class="card-dashboard">
      <form id="filtrosForm">
        <div class="filtros-grid">
          <div class="field">
            <label for="filtroNomeEvento">Nome do Evento</label>
            <select id="filtroNomeEvento" multiple></select>
          </div>

          <div class="field">
            <label for="filtroDataInicio">Data Início</label>
            <input type="date" id="filtroDataInicio">
          </div>

          <div class="field">
            <label for="filtroDataFim">Data Fim</label>
            <input type="date" id="filtroDataFim">
          </div>

          <div class="field">
            <label for="filtroStatus">Status</label>
            <select id="filtroStatus">
              <option value="" selected>Todos</option>
              <option value="Aberto">Aberto</option>
              <option value="Fechado">Fechado</option>
              <option value="Finalizado">Finalizado</option>
              <option value="Previsto">Previsto</option>
              <option value="Confirmado">Confirmado</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <div class="quick">
            <button type="button" class="btn btn-outline" id="btnMesAtual">Mês atual</button>
            <button type="button" class="btn btn-outline" id="btnAnoAtual">Ano atual</button>
          </div>
          <button type="submit" class="btn">Aplicar Filtros</button>
          <button type="button" class="btn btn-outline" id="btnLimpar">Limpar</button>
        </div>
      </form>
    </div>

    <div class="section-title">Eventos no Período <span class="pill" id="resumoPeriodo"></span></div>
    <div id="tabelaEventos"></div>

    <div class="section-title">Resumo por Semana (Seg a Dom)</div>
    <div id="tabelaSemanas"></div>
  </main>
</div>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== Util =====
  const pad2 = n => String(n).padStart(2,'0');
  const BRL = v => (Number(v)||0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });

  function parseNum(v){
    if(v === null || v === undefined) return 0;
    if (typeof v === 'number') return v;
    if (typeof v === 'string'){
      // remove milhares e converte vírgula para ponto
      const s = v.replace(/\./g,'').replace(',','.');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    return 0;
  }

  function get(obj, path){
    // path "a/b/c"
    const segs = path.split('/');
    let cur = obj;
    for(const s of segs){
      if(cur && Object.prototype.hasOwnProperty.call(cur, s)){
        cur = cur[s];
      }else{
        return undefined;
      }
    }
    return cur;
  }

  function firstNumber(obj, paths){
    for(const p of paths){
      const v = get(obj, p);
      const n = parseNum(v);
      if (n) return n;
    }
    return 0;
  }

  function sumValores(maybeArrOrObj){
    if(!maybeArrOrObj) return 0;
    // array
    if(Array.isArray(maybeArrOrObj)){
      return maybeArrOrObj.reduce((acc, it)=>acc + parseNum(it && (it.valor ?? it.preco ?? it.custo)), 0);
    }
    // objeto mapeado por id
    if(typeof maybeArrOrObj === 'object'){
      return Object.values(maybeArrOrObj).reduce((acc, it)=>acc + parseNum(it && (it.valor ?? it.preco ?? it.custo)), 0);
    }
    return 0;
    }

  const pctTxt = (num, den) => den ? ((num/den)*100).toFixed(1)+'%' : '0,0%';

  function toISODate(anyDate){
    if(!anyDate) return null;
    if (typeof anyDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(anyDate)) return anyDate;
    if (typeof anyDate === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(anyDate)) {
      const [d,m,y]=anyDate.split('/'); return `${y}-${m}-${d}`;
    }
    if (typeof anyDate === 'number') {
      const d=new Date(anyDate); if(!isNaN(d)) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    const d=new Date(anyDate); if(!isNaN(d)) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    return null;
  }

  function startOfWeekMonday(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    const day = d.getDay(); // 0 dom .. 6 sáb
    const diff = (day === 0 ? -6 : 1 - day); // segunda como início
    d.setDate(d.getDate() + diff);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function endOfWeekSunday(dateISO){
    const begin = new Date(startOfWeekMonday(dateISO)+"T00:00:00");
    begin.setDate(begin.getDate()+6);
    return `${begin.getFullYear()}-${pad2(begin.getMonth()+1)}-${pad2(begin.getDate())}`;
  }
  function brLabel(dateISO){
    if(!dateISO) return '-';
    const [y,m,d] = dateISO.split('-');
    return `${d}/${m}/${y}`;
  }
  function getMonthRange(date = new Date()){
    const y = date.getFullYear(), m = date.getMonth();
    const first = new Date(y, m, 1);
    const last = new Date(y, m+1, 0);
    const fmt = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    return { ini: fmt(first), fim: fmt(last) };
  }

  // ===== Estado =====
  let eventos = [];

  // ===== Boot =====
  document.addEventListener('DOMContentLoaded', () => {
    carregarMenu('../');
    carregarEventos();
    wireFiltros();
  });

  function carregarEventos(){
    db.ref('eventos').once('value').then(snap=>{
      eventos = [];
      snap.forEach(child=>{
        const e = child.val() || {};
        e.id = child.key;

        // data em vários campos possíveis
        const dataISO = toISODate(e.data || e.dataEvento || e.dia || e.dt);
        e._dataISO = dataISO;

        eventos.push(e);
      });
      popularFiltroNomes();
      setDefaultPeriodoMes();
      aplicarFiltros();
    });
  }

  // ===== Filtros =====
  function popularFiltroNomes(){
    const selec = document.getElementById('filtroNomeEvento');
    const nomes = [...new Set(eventos.map(e => e.nomeEvento || e.nome || e.evento).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b,'pt-BR'));
    selec.innerHTML = '';
    nomes.forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n;
      selec.appendChild(opt);
    });
  }

  function setDefaultPeriodoMes(){
    const {ini,fim} = getMonthRange(new Date());
    document.getElementById('filtroDataInicio').value = ini;
    document.getElementById('filtroDataFim').value = fim;
    document.getElementById('resumoPeriodo').textContent = `${brLabel(ini)} a ${brLabel(fim)}`;
  }

  function wireFiltros(){
    document.getElementById('filtrosForm').addEventListener('submit', e=>{
      e.preventDefault(); aplicarFiltros();
    });
    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      document.querySelectorAll('#filtroNomeEvento option').forEach(o=>o.selected=false);
      document.getElementById('filtroStatus').value='';
      setDefaultPeriodoMes();
      aplicarFiltros();
    });
    document.getElementById('btnMesAtual').addEventListener('click', ()=>{
      setDefaultPeriodoMes(); aplicarFiltros();
    });
    document.getElementById('btnAnoAtual').addEventListener('click', ()=>{
      const y = (new Date()).getFullYear();
      document.getElementById('filtroDataInicio').value = `${y}-01-01`;
      document.getElementById('filtroDataFim').value = `${y}-12-31`;
      document.getElementById('resumoPeriodo').textContent = `01/01/${y} a 31/12/${y}`;
      aplicarFiltros();
    });
  }

  // ===== Core =====
  function aplicarFiltros(){
    const nomes = [...document.getElementById('filtroNomeEvento').selectedOptions].map(o=>o.value);
    const ini = document.getElementById('filtroDataInicio').value || null;
    const fim = document.getElementById('filtroDataFim').value || null;
    const status = document.getElementById('filtroStatus').value;

    if(ini && fim){
      document.getElementById('resumoPeriodo').textContent = `${brLabel(ini)} a ${brLabel(fim)}`;
    }

    const filtrados = eventos.filter(e=>{
      const dataOK = e._dataISO ? (!ini || e._dataISO >= ini) && (!fim || e._dataISO <= fim)
                                : (!ini && !fim);
      if(!dataOK) return false;
      const nomeEv = e.nomeEvento || e.nome || e.evento;
      if(nomes.length && !nomes.includes(nomeEv)) return false;
      const st = e.status || e.statusEvento || e.situacao;
      if(status && st !== status) return false;
      return true;
    });

    const linhas = filtrados.map(e=>{
      // Estimativa – procura em vários caminhos
      const estimativa = firstNumber(e, [
        'estimativaVenda',
        'estimativaVendaSemana',
        'previsaoVenda',
        'estimativa',
        'totais/estimativaVenda',
        'projecaoReceita'
      ]);

      // Equipe – soma arrays/objetos ou usa total pronto
      let custoEquipe = firstNumber(e, ['totalEquipe', 'custos/equipe/total']);
      if(!custoEquipe){
        custoEquipe += sumValores(e.equipe) + sumValores(e.equipeAlocada);
      }

      // Logística – idem
      let custoLog = firstNumber(e, ['totalLogistica', 'custos/logistica/total']);
      if(!custoLog){
        custoLog += sumValores(e.logistica) + sumValores(e.logisticaAlocada) + sumValores(e.frete);
      }

      const totalCusto = (custoEquipe || 0) + (custoLog || 0);
      const nomeEvento = e.nomeEvento || e.nome || e.evento || '-';

      return {
        id: e.id,
        data: e._dataISO || null,
        nomeEvento,
        estimativa,
        custoEquipe,
        custoLog,
        totalCusto,
        margemPct: estimativa ? ((estimativa - totalCusto)/estimativa*100) : 0
      };
    });

    linhas.sort((a,b)=> (a.data || '').localeCompare(b.data || ''));

    exibirTabelaEventos(linhas);
    exibirResumoSemanas(linhas);
  }

  // ===== Render =====
  function exibirTabelaEventos(linhas){
    if(!linhas.length){
      document.getElementById('tabelaEventos').innerHTML = '<div class="muted">Nenhum evento no período.</div>';
      return;
    }

    let tot = { est:0, eq:0, lg:0, tc:0 };
    let html = `<table>
      <thead>
        <tr>
          <th>Data</th>
          <th class="left">Nome do Evento</th>
          <th>Estimativa Venda</th>
          <th>Custo Equipe</th>
          <th>Custo Logística</th>
          <th>Total Custo</th>
          <th>Margem Estimada</th>
        </tr>
      </thead>
      <tbody>`;

    for(const l of linhas){
      tot.est += l.estimativa;
      tot.eq += l.custoEquipe;
      tot.lg += l.custoLog;
      tot.tc += l.totalCusto;

      html += `<tr>
        <td>${l.data ? brLabel(l.data) : '-'}</td>
        <td class="left">${l.nomeEvento}</td>
        <td class="right">${BRL(l.estimativa)}</td>
        <td class="right">${BRL(l.custoEquipe)}</td>
        <td class="right">${BRL(l.custoLog)}</td>
        <td class="right">${BRL(l.totalCusto)}</td>
        <td>${isFinite(l.margemPct) ? l.margemPct.toFixed(1)+'%' : '0,0%'}</td>
      </tr>`;
    }

    const margemTot = pctTxt(tot.est - tot.tc, tot.est);
    html += `</tbody>
      <tfoot>
        <tr>
          <td colspan="2" class="right"><strong>TOTAL</strong></td>
          <td class="right"><strong>${BRL(tot.est)}</strong></td>
          <td class="right"><strong>${BRL(tot.eq)}</strong></td>
          <td class="right"><strong>${BRL(tot.lg)}</strong></td>
          <td class="right"><strong>${BRL(tot.tc)}</strong></td>
          <td><strong>${margemTot}</strong></td>
        </tr>
      </tfoot>
    </table>`;

    document.getElementById('tabelaEventos').innerHTML = html;
  }

  function exibirResumoSemanas(linhas){
    if(!linhas.length){
      document.getElementById('tabelaSemanas').innerHTML = '<div class="muted">Semanas não encontradas no período.</div>';
      return;
    }

    const map = {};
    for(const l of linhas){
      const k = l.data ? startOfWeekMonday(l.data) : 'sem-data';
      if(!map[k]){
        const fim = l.data ? endOfWeekSunday(l.data) : null;
        map[k] = { label: l.data ? `${brLabel(k)} a ${brLabel(fim)}` : 'Sem data', est:0, eq:0, lg:0, tc:0 };
      }
      map[k].est += l.estimativa;
      map[k].eq  += l.custoEquipe;
      map[k].lg  += l.custoLog;
      map[k].tc  += l.totalCusto;
    }

    const keys = Object.keys(map).sort();
    let total = { est:0, eq:0, lg:0, tc:0 };
    let html = `<table>
      <thead>
        <tr>
          <th>Semana</th>
          <th>Estimativa Venda</th>
          <th>Custo Equipe</th>
          <th>Custo Logística</th>
          <th>Total Custo</th>
          <th>Margem Estimada</th>
        </tr>
      </thead>
      <tbody>`;

    for(const k of keys){
      const s = map[k];
      total.est += s.est; total.eq += s.eq; total.lg += s.lg; total.tc += s.tc;
      html += `<tr>
        <td class="left">${s.label}</td>
        <td class="right">${BRL(s.est)}</td>
        <td class="right">${BRL(s.eq)}</td>
        <td class="right">${BRL(s.lg)}</td>
        <td class="right">${BRL(s.tc)}</td>
        <td>${pctTxt(s.est - s.tc, s.est)}</td>
      </tr>`;
    }

    html += `</tbody>
      <tfoot>
        <tr>
          <td class="right"><strong>TOTAL</strong></td>
          <td class="right"><strong>${BRL(total.est)}</strong></td>
          <td class="right"><strong>${BRL(total.eq)}</strong></td>
          <td class="right"><strong>${BRL(total.lg)}</strong></td>
          <td class="right"><strong>${BRL(total.tc)}</strong></td>
          <td><strong>${pctTxt(total.est - total.tc, total.est)}</strong></td>
        </tr>
      </tfoot>
    </table>`;

    document.getElementById('tabelaSemanas').innerHTML = html;
  }
</script>
</body>
</html>
