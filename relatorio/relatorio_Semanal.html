<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relatório por Evento</title>
  <link rel="stylesheet" href="../assets/base.css" />
  <link rel="stylesheet" href="../assets/menu-styles.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="../assets/menu.js" defer></script>
  <style>
    /* ===== Ajustes visuais simples (mantém seu padrão) ===== */
    .page-header h1{ margin-bottom:12px; }

    .kpi-grid{
      display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:14px;
    }
    @media (max-width:1100px){ .kpi-grid{ grid-template-columns:1fr; } }

    .kpi-card{
      background:#fff; border:1px solid #eee; border-radius:12px; padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    .kpi-title{ display:flex; justify-content:space-between; font-weight:700; font-size:14px; margin-bottom:8px; }
    .kpi-rows{ display:grid; grid-template-columns:1fr auto; row-gap:6px; font-size:13px; }
    .pill{ font-size:11px; padding:2px 8px; border-radius:999px; background:#ffe9d1; color:#8a3b00; }
    .kpi-footnote{ font-size:11px; color:#777; margin-top:4px; }

    .card-dashboard{ background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.04); }

    /* Filtros: layout básico, sem invenção */
    .form-row{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; align-items:flex-end; }
    .form-row > div{ display:flex; flex-direction:column; }
    label, select, input{ font-size:12px; }
    #filtroNomeEvento{ min-width:320px; min-height:140px; }

    .btn{ background:#ff7f00; color:#fff; padding:6px 10px; border:none; border-radius:6px; font-size:12px; cursor:pointer; }
    .btn:hover{ background:#e96f00; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
    th,td{ border:1px solid #ddd; padding:6px 8px; text-align:center; }
    th{ background:#ffcc80; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#fafafa; }
    tfoot td{ font-weight:bold; background:#f9f9f9; }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar" id="menuLateral"></aside>

  <main class="main-content">
    <div class="page-header">
      <h1>Relatório por Evento</h1>
      <div class="kpi-footnote">Resumos: Anual = ano corrente | Mensal = mês corrente | Dinâmico = conforme filtros abaixo.</div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-title"><span>Resumo Anual</span><span class="pill" id="anoCorrente">Ano</span></div>
        <div class="kpi-rows">
          <div>Faturamento</div><div id="anualFaturamento">R$ 0,00</div>
          <div>Lucro</div><div id="anualLucro">R$ 0,00</div>
          <div>Margem</div><div id="anualMargem">0,0%</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title"><span>Resumo Mensal</span><span class="pill" id="mesCorrente">Mês</span></div>
        <div class="kpi-rows">
          <div>Faturamento</div><div id="mensalFaturamento">R$ 0,00</div>
          <div>Lucro</div><div id="mensalLucro">R$ 0,00</div>
          <div>Margem</div><div id="mensalMargem">0,0%</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title"><span>Resumo Dinâmico</span><span class="pill">Filtro</span></div>
        <div class="kpi-rows">
          <div>Faturamento</div><div id="filtroFaturamento">R$ 0,00</div>
          <div>Lucro</div><div id="filtroLucro">R$ 0,00</div>
          <div>Margem</div><div id="filtroMargem">0,0%</div>
        </div>
        <div class="kpi-footnote" id="filtroResumoInfo"></div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card-dashboard">
      <form id="filtrosForm">
        <div class="form-row">
          <div>
            <label for="filtroNomeEvento">Nome do Evento</label>
            <select id="filtroNomeEvento" multiple></select>
          </div>
          <div>
            <label for="filtroDataInicio">Data Início</label>
            <input type="date" id="filtroDataInicio">
          </div>
          <div>
            <label for="filtroDataFim">Data Fim</label>
            <input type="date" id="filtroDataFim">
          </div>
          <div>
            <label for="filtroStatus">Status</label>
            <select id="filtroStatus">
              <option value="" selected>Todos</option>
              <option value="Fechado">Fechado</option>
              <option value="Aberto">Aberto</option>
              <option value="Finalizado">Finalizado</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button type="submit" class="btn">Aplicar Filtros</button>
          <button type="button" class="btn" id="btnLimpar">Limpar Filtros</button>
        </div>
      </form>

      <div id="tabelaResultado"></div>
    </div>
  </main>
</div>

<script>
  // ===== Boot =====
  document.addEventListener('DOMContentLoaded', () => {
    carregarMenu('../');
    initFirebase();
    carregarEventos();
    wireUI();
  });

  // ===== Firebase =====
  let db;
  function initFirebase(){
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
  }

  // ===== Utils =====
  const BRL = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const PCT = (num,den)=> den ? ((num/den)*100).toFixed(1)+'%' : '0,0%';
  const pad2 = n => String(n).padStart(2,'0');

  function toISODate(anyDate){
    if(!anyDate) return null;
    // já ISO
    if (typeof anyDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(anyDate)) return anyDate;
    // BR
    if (typeof anyDate === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(anyDate)) {
      const [d,m,y] = anyDate.split('/');
      return `${y}-${m}-${d}`;
    }
    // timestamp
    if (typeof anyDate === 'number') {
      const d = new Date(anyDate);
      if (!isNaN(d)) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    // fallback
    const d = new Date(anyDate);
    if (!isNaN(d)) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    return null;
  }

  function hojeInfo(){ const n=new Date(); return {y:n.getFullYear(), m:n.getMonth()+1}; }
  function setDatasPadrao(){
    const hoje = new Date();
    const ini = new Date(); ini.setDate(hoje.getDate()-6);
    const fmt = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    document.getElementById('filtroDataInicio').value = fmt(ini);
    document.getElementById('filtroDataFim').value = fmt(hoje);
  }

  // ===== Dados =====
  let eventos = [];

  function carregarEventos(){
    db.ref('eventos').once('value').then(snap=>{
      eventos = [];
      snap.forEach(ch=>{
        const e = ch.val(); e.id = ch.key;
        e._dataISO = toISODate(e.data); // <- normaliza pra filtrar certo
        eventos.push(e);
      });
      popularNomes();
      setDatasPadrao();
      atualizarResumosFixos();
      aplicarFiltros();
    });
  }

  function popularNomes(){
    const sel = document.getElementById('filtroNomeEvento');
    const nomes = [...new Set(eventos.map(e=>e?.nomeEvento).filter(n=>!!n))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
    sel.innerHTML = '';
    nomes.forEach(n=>{
      const opt = document.createElement('option');
      opt.value = n; opt.textContent = n;
      sel.appendChild(opt);
    });
  }

  // ===== Filtros =====
  function wireUI(){
    document.getElementById('filtrosForm').addEventListener('submit', (e)=>{ e.preventDefault(); aplicarFiltros(); });
    document.getElementById('btnLimpar').addEventListener('click', ()=>{ 
      [...document.getElementById('filtroNomeEvento').options].forEach(o=>o.selected=false);
      document.getElementById('filtroStatus').value='';
      setDatasPadrao();
      aplicarFiltros();
    });
    // aplica ao mudar qualquer campo
    ['filtroNomeEvento','filtroDataInicio','filtroDataFim','filtroStatus'].forEach(id=>{
      document.getElementById(id).addEventListener('change', aplicarFiltros);
    });
  }

  function aplicarFiltros(){
    const nomes = [...document.getElementById('filtroNomeEvento').selectedOptions].map(o=>o.value);
    const di = document.getElementById('filtroDataInicio').value || null;
    const df = document.getElementById('filtroDataFim').value || null;
    const st = document.getElementById('filtroStatus').value;

    const linhas = [];

    eventos.filter(e=>{
      // Data: se tem _dataISO, valida; se não tem e há filtro de data, descarta
      const dataOK = e._dataISO ? (!di || e._dataISO>=di) && (!df || e._dataISO<=df) : (!di && !df);
      if(!dataOK) return false;

      if(nomes.length && !nomes.includes(e.nomeEvento)) return false;
      if(st && e.status !== st) return false;
      return true;
    }).forEach(e=>{
      const venda = parseFloat(e.vendaPDV)||0;
      const lucro = parseFloat(e.lucroFinal)||0;
      const perda = parseFloat(e.custoPerda)||0;
      const equipe = Array.isArray(e.equipe) ? e.equipe.reduce((a,i)=>a+(parseFloat(i.valor)||0),0) : 0;
      const logistica = Array.isArray(e.logistica) ? e.logistica.reduce((a,i)=>a+(parseFloat(i.valor)||0),0) : 0;

      linhas.push({
        data: e._dataISO || (e.data || '-'),
        nome: e.nomeEvento || '-',
        venda, lucro, perda, equipe, logistica
      });
    });

    // ordena por data desc
    linhas.sort((a,b)=> (a.data<b.data?1:-1));

    renderTabela(linhas);
    atualizarResumoDinamico(linhas, {nomes, di, df, st});
  }

  // ===== Tabela =====
  function renderTabela(rows){
    let html = `<table><thead><tr>
      <th>Data</th><th style="text-align:left">Nome do Evento</th>
      <th>Venda PDV</th><th>Lucro</th><th>% Lucro</th>
      <th>Perda</th><th>% Perda</th>
      <th>Custo Equipe</th><th>% Equipe</th>
      <th>Custo Logística</th><th>% Logística</th>
    </tr></thead><tbody>`;

    const tot = {v:0,l:0,p:0,e:0,g:0};

    rows.forEach(r=>{
      tot.v+=r.venda; tot.l+=r.lucro; tot.p+=r.perda; tot.e+=r.equipe; tot.g+=r.logistica;
      const pct = (x)=> r.venda ? (x/r.venda*100).toFixed(1) : '0.0';
      html += `<tr>
        <td>${r.data}</td>
        <td style="text-align:left">${r.nome}</td>
        <td>${BRL(r.venda)}</td>
        <td>${BRL(r.lucro)}</td>
        <td>${pct(r.lucro)}%</td>
        <td>${BRL(r.perda)}</td>
        <td>${pct(r.perda)}%</td>
        <td>${BRL(r.equipe)}</td>
        <td>${pct(r.equipe)}%</td>
        <td>${BRL(r.logistica)}</td>
        <td>${pct(r.logistica)}%</td>
      </tr>`;
    });

    const pctT = (x)=> tot.v ? (x/tot.v*100).toFixed(1) : '0.0';
    html += `<tr style="font-weight:bold; background:#f9f9f9">
      <td colspan="2" style="text-align:right">TOTAL</td>
      <td>${BRL(tot.v)}</td>
      <td>${BRL(tot.l)}</td>
      <td>${pctT(tot.l)}%</td>
      <td>${BRL(tot.p)}</td>
      <td>${pctT(tot.p)}%</td>
      <td>${BRL(tot.e)}</td>
      <td>${pctT(tot.e)}%</td>
      <td>${BRL(tot.g)}</td>
      <td>${pctT(tot.g)}%</td>
    </tr></tbody></table>`;

    document.getElementById('tabelaResultado').innerHTML = html;
  }

  // ===== KPIs =====
  function acum(lista){
    return lista.reduce((acc,e)=>{
      acc.v += (parseFloat(e.vendaPDV)||0);
      acc.l += (parseFloat(e.lucroFinal)||0);
      return acc;
    },{v:0,l:0});
  }

  function atualizarResumosFixos(){
    const {y,m} = hojeInfo();
    const yS = String(y), ym = `${y}-${pad2(m)}`;
    const ok = new Set(['Fechado','Finalizado']);

    const anual = eventos.filter(e=> e._dataISO && e._dataISO.startsWith(yS) && ok.has(e.status));
    const mensal = eventos.filter(e=> e._dataISO && e._dataISO.startsWith(ym) && ok.has(e.status));

    const A = acum(anual), M = acum(mensal);

    document.getElementById('anoCorrente').textContent = yS;
    document.getElementById('mesCorrente').textContent = `${pad2(m)}/${y}`;

    document.getElementById('anualFaturamento').textContent = BRL(A.v);
    document.getElementById('anualLucro').textContent = BRL(A.l);
    document.getElementById('anualMargem').textContent = PCT(A.l,A.v);

    document.getElementById('mensalFaturamento').textContent = BRL(M.v);
    document.getElementById('mensalLucro').textContent = BRL(M.l);
    document.getElementById('mensalMargem').textContent = PCT(M.l,M.v);
  }

  function atualizarResumoDinamico(rows,info){
    const tot = rows.reduce((a,r)=>{ a.v+=r.venda; a.l+=r.lucro; return a; },{v:0,l:0});
    document.getElementById('filtroFaturamento').textContent = BRL(tot.v);
    document.getElementById('filtroLucro').textContent = BRL(tot.l);
    document.getElementById('filtroMargem').textContent = PCT(tot.l,tot.v);

    const parts=[];
    if(info.nomes?.length) parts.push(`Eventos: ${info.nomes.length}`);
    if(info.di) parts.push(`De: ${info.di}`);
    if(info.df) parts.push(`Até: ${info.df}`);
    if(info.st) parts.push(`Status: ${info.st}`);
    document.getElementById('filtroResumoInfo').textContent = parts.join(' | ');
  }
</script>
</body>
</html>
