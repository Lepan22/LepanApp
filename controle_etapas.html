<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Controle de Etapas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    :root { --cor-primaria: #ff7f00; --cor-secundaria: #f9f9f9; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 220px;
      background-color: var(--cor-primaria);
      color: white;
      padding: 20px 10px;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .sidebar a, .sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-decoration: none;
      font-weight: bold;
      border: 1px solid white;
      color: white;
      background: transparent;
      padding: 5px;
      text-align: center;
      border-radius: 4px;
    }
    .sidebar a:hover, .sidebar button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      text-decoration: none;
    }
    .menu-top { margin-bottom: 20px; }
    .submenu { margin-bottom: 20px; }
    hr { border-top: 1px solid rgba(255, 255, 255, 0.3); margin: 10px 0; }
    .main-content { flex-grow: 1; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 0.75rem; }
    th, td { border: 1px solid #ddd; text-align: center; padding: 6px; }
    th { background-color: var(--cor-primaria); color: white; font-weight: bold; }
    .btn { padding: 5px 10px; background: var(--cor-primaria); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.75rem; }
    .btn:hover { background: #e96f00; }
    .filtros { margin-bottom: 15px; font-size: 0.75rem; }
    .form-label { font-weight: bold; margin-right: 5px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="layout">
  <div class="sidebar">
    <div>
      <h4 class="text-center">Le PanApp</h4>
      <div class="menu-top">
        <a href="index.html">Home</a>
        <a href="Cadastro.html">Cadastros</a>
        <a href="clientes.html">Clientes</a>
        <a href="eventos.html">Eventos</a>
        <a href="relatorio.html">Relatórios</a>
      </div>
      <hr>
      <div class="submenu">
        <a href="GestaoEvento.html">Criar</a>
        <a href="compra_evento.html">Compras</a>
        <a href="controle_etapas.html">Etapas</a>
        <a href="media_produtos.html">Média Produto</a>
        <a href="relatorio/eventos_relatorio.html">Visão por Cliente</a>
        <a href="relatorio/equipe_relatorio.html">Visão por Equipe</a>
      </div>
    </div>
    <button onclick="history.back()">Voltar</button>
  </div>

  <div class="main-content">
    <h1>Controle de Etapas dos Eventos</h1>

    <div class="filtros">
      <label class="form-label">Status:</label>
      <select id="filtroStatus" class="form-select form-select-sm d-inline-block w-auto">
        <option value="Todos">Todos</option>
        <option value="Aberto" selected>Aberto</option>
        <option value="Fechado">Fechado</option>
        <option value="Finalizado">Finalizado</option>
      </select>

      <label class="form-label ms-2">Data Início:</label>
      <input type="date" id="filtroDataInicio" class="form-control form-control-sm d-inline-block w-auto">

      <label class="form-label ms-2">Data Fim:</label>
      <input type="date" id="filtroDataFim" class="form-control form-control-sm d-inline-block w-auto">
    </div>

    <table>
      <thead>
        <tr>
          <th>Evento</th>
          <th>Data</th>
          <th>Produtos</th>
          <th>Equipe</th>
          <th>Logística</th>
          <th>Cliente</th>
          <th>Divulgação</th>
          <th>Compra</th>
          <th>Gestão</th>
        </tr>
      </thead>
      <tbody id="tabelaEventos"></tbody>
    </table>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp",
    storageBucket: "lepanapp.appspot.com",
    messagingSenderId: "542989944344",
    appId: "1:542989944344:web:576e28199960fd5440a56d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function formatDateBR(dataISO) {
    if (!dataISO) return '';
    const [ano, mes, dia] = dataISO.split("-");
    return `${dia}/${mes}/${ano}`;
  }

  function isWithinRange(dataStr, inicio, fim) {
    if (!dataStr) return false;
    const data = new Date(dataStr);
    return (!inicio || data >= new Date(inicio)) && (!fim || data <= new Date(fim));
  }

  function carregarEventos() {
    db.ref('eventos').once('value').then(snapshot => {
      const tabela = document.getElementById('tabelaEventos');
      tabela.innerHTML = '';

      const statusFiltro = document.getElementById('filtroStatus').value;
      const dataInicio = document.getElementById('filtroDataInicio').value;
      const dataFim = document.getElementById('filtroDataFim').value;

      snapshot.forEach(child => {
        const evento = child.val();
        const id = child.key;

        if (statusFiltro !== 'Todos' && evento.status !== statusFiltro) return;
        if (!isWithinRange(evento.data, dataInicio, dataFim)) return;

        const etapas = evento.etapas || {
          produtosDefinidos: false,
          equipeConfirmada: false,
          logisticaDefinida: false,
          clienteConfirmado: false,
          divulgacaoRealizada: false,
          compraInsumos: false
        };

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${evento.nomeEvento || id}</td>
          <td>${evento.data ? formatDateBR(evento.data) : '-'}</td>
          <td><input type="checkbox" ${etapas.produtosDefinidos ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'produtosDefinidos', this.checked)"></td>
          <td><input type="checkbox" ${etapas.equipeConfirmada ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'equipeConfirmada', this.checked)"></td>
          <td><input type="checkbox" ${etapas.logisticaDefinida ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'logisticaDefinida', this.checked)"></td>
          <td><input type="checkbox" ${etapas.clienteConfirmado ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'clienteConfirmado', this.checked)"></td>
          <td><input type="checkbox" ${etapas.divulgacaoRealizada ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'divulgacaoRealizada', this.checked)"></td>
          <td><input type="checkbox" ${etapas.compraInsumos ? 'checked' : ''} onchange="atualizarEtapa('${id}', 'compraInsumos', this.checked)"></td>
          <td><button class="btn" onclick="gestaoEvento('${id}')">Gestão</button></td>
        `;
        tabela.appendChild(row);
      });
    });
  }

  function atualizarEtapa(eventoId, etapa, valor) {
    const refEtapa = db.ref(`eventos/${eventoId}/etapas`);
    refEtapa.update({ [etapa]: valor })
      .then(() => console.log(`Etapa ${etapa} do evento ${eventoId} atualizada para ${valor}`))
      .catch(err => console.error('Erro ao atualizar:', err));
  }

  function gestaoEvento(id) {
    window.location.href = `GestaoEvento.html?id=${id}`;
  }

  document.getElementById('filtroStatus').addEventListener('change', carregarEventos);
  document.getElementById('filtroDataInicio').addEventListener('change', carregarEventos);
  document.getElementById('filtroDataFim').addEventListener('change', carregarEventos);

  document.addEventListener('DOMContentLoaded', () => {
    const hoje = new Date();
    const dia = hoje.getDay();
    const inicio = new Date(hoje);
    inicio.setDate(hoje.getDate() - dia);
    const fim = new Date(inicio);
    fim.setDate(inicio.getDate() + 6);

    document.getElementById('filtroDataInicio').value = inicio.toISOString().split('T')[0];
    document.getElementById('filtroDataFim').value = fim.toISOString().split('T')[0];

    carregarEventos();
  });
</script>

</body>
</html>
