<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Regras de DRE por Categoria</title>

  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>

  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>

  <style>
    .page-header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
    }
    .page-header h1{ margin:0; font-size:20px; color:#111827; } /* força texto escuro */
    .page-header .muted{ color:#6b7280; }

    .filters{
      display:grid; grid-template-columns:1fr 180px 160px; gap:10px; margin-bottom:10px; align-items:end;
    }
    @media (max-width: 900px){ .filters{ grid-template-columns:1fr 1fr; } }
    .filters label{ font-size:12px; color:#374151; }
    .filters input, .filters select, .filters button{
      width:100%; box-sizing:border-box; padding:6px; font-size:12px;
    }
    .filters button{
      height:32px; border:1px solid #ddd; border-radius:8px; background:#ff7f2a; color:#fff; cursor:pointer;
    }

    table{ width:100%; border-collapse:collapse; background:#fff; }
    thead th{
      background:#fff7ec; color:#111827; /* força texto escuro no cabeçalho */
      text-align:left; border:1px solid #e5e7eb; padding:8px; font-size:12.5px;
    }
    tbody td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:12.5px; vertical-align:top; }
    .nowrap{ white-space:nowrap; }
    .muted{ color:#6b7280; font-size:11.5px; }
    .dre-select, .dre-input{ width:100%; box-sizing:border-box; padding:5px; font-size:12px; }
    .param-wrap{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .param-wrap>div{ display:none; }
    .param-wrap[data-mode="competencia_driver"] .param-driver{ display:block; grid-column: span 2; }
    .param-wrap[data-mode="competencia_media"]  .param-media { display:block; }
    .row-actions button{
      font-size:11.5px; padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:6px; cursor:pointer;
    }
    .row-actions button:hover{ background:#f3f4f6; }
    .save-all{ margin-top:10px; display:inline-flex; gap:8px; }
    .save-all button{ height:34px; padding:0 12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:12px; }
    .save{ background:#10b981; color:#fff; border-color:#0ea5e9; }
    .reset{ background:#fff; }
    tr.changed{ background:#f8fffb; }
    .pill{ display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #e5e7eb; background:#fff; }
    .vright{ text-align:right; }
  </style>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Regras de DRE por Categoria</h1>
      <span class="muted">Edite regra, parâmetros e Valor DRE. Acompanhe acumulado anual e média mensal.</span>
    </div>

    <div class="filters">
      <label>
        Busca (nome / centro de custo)
        <input type="text" id="busca" placeholder="Digite para filtrar…">
      </label>
      <label>
        Tipo
        <select id="filtroTipo">
          <option value="">Todos</option>
          <option value="Entrada">Entrada</option>
          <option value="Saída">Saída</option>
          <option value="Entrada/Saída">Entrada/Saída</option>
        </select>
      </label>
      <button id="limparFiltros">Limpar filtros</button>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th style="width:22%;">Categoria</th>
          <th style="width:10%;">Tipo</th>
          <th style="width:20%;">Centro de Custo</th>
          <th style="width:14%;">Regra DRE</th>
          <th style="width:16%;">Parâmetros</th>
          <th style="width:10%;">Valor DRE</th>
          <th style="width:18%;" class="nowrap">Acumulado (ano) / Média mensal</th>
          <th class="nowrap">Ações</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="save-all">
      <button class="reset" id="descartarAlteracoes">Descartar alterações</button>
      <button class="save" id="salvarAlteracoes">Salvar alterações (em lote)</button>
      <span id="badgeAlteracoes" class="pill muted">0 alteração(ões)</span>
    </div>
  </div>

  <script type="module">
    import { db } from './assets/firebase-config.js';
    import { ref, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // ---------- Elementos
    const elBusca = document.getElementById('busca');
    const elFiltroTipo = document.getElementById('filtroTipo');
    const elLimparFiltros = document.getElementById('limparFiltros');
    const tbody = document.getElementById('lista');
    const btnSalvarAlteracoes = document.getElementById('salvarAlteracoes');
    const btnDescartarAlteracoes = document.getElementById('descartarAlteracoes');
    const badgeAlteracoes = document.getElementById('badgeAlteracoes');

    // ---------- Estados
    const cache = new Map();   // id -> categoria
    const edits = new Map();   // id -> { dre_regra, dre_percentual_base, dre_media_janela, dre_valor }
    const idxNome = new Map(); // nome lower -> id
    const resumoAno = new Map(); // id -> { soma:number, meses:Set<number> }

    const hoje = new Date();
    const ANO = hoje.getFullYear();
    const MES_IDX_ATUAL = hoje.getMonth(); // 0..11
    const MESES_DECORRIDOS = MES_IDX_ATUAL + 1;

    // ---------- Utils
    const esc = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
    const fmtMoeda = (n=0) => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    function parsePercentToDecimal(txt){
      if (txt == null) return null;
      let s = String(txt).trim();
      if (!s) return null;
      s = s.replace('%','').replace(/\s+/g,'').replace(',','.');
      let v = Number(s);
      if (isNaN(v)) return null;
      if (v > 1) v = v/100;
      return v;
    }
    function formatDecimalToPercent(dec){
      if (dec == null || dec === '') return '';
      const n = Number(dec);
      if (isNaN(n)) return '';
      return (n*100).toLocaleString('pt-BR',{maximumFractionDigits:2}) + '%';
    }
    function rowDirty(id){
      const b = cache.get(id) || {};
      const e = edits.get(id);
      if (!e) return false;
      return (
        (e.dre_regra ?? b.dre_regra) !== b.dre_regra ||
        (e.dre_percentual_base ?? b.dre_percentual_base) !== b.dre_percentual_base ||
        (e.dre_media_janela ?? b.dre_media_janela) !== b.dre_media_janela ||
        (e.dre_valor ?? b.dre_valor) !== b.dre_valor
      );
    }
    function refreshBadge(){
      const count = Array.from(edits.keys()).filter(rowDirty).length;
      badgeAlteracoes.textContent = `${count} alteração(ões)`;
    }

    // ---------- Render
    function render(){
      const q = (elBusca.value || '').toLowerCase();
      const tipo = elFiltroTipo.value;

      const rows = [];
      cache.forEach((cat,id)=>{
        const texto = `${cat.nome||''} ${cat.centroDeCusto||''}`.toLowerCase();
        if (q && !texto.includes(q)) return;
        if (tipo && cat.tipo !== tipo) return;
        rows.push({id,cat});
      });
      rows.sort((a,b)=> (a.cat?.nome||'').localeCompare(b.cat?.nome||''));

      tbody.innerHTML = '';
      rows.forEach(({id,cat})=>{
        const e = edits.get(id) || {};
        const regra = (e.dre_regra ?? cat.dre_regra) || '';
        const driver = (e.dre_percentual_base ?? cat.dre_percentual_base);
        const mediaN = (e.dre_media_janela ?? cat.dre_media_janela);
        const valorDRE = (e.dre_valor ?? cat.dre_valor);

        const r = resumoAno.get(id) || { soma:0, meses: new Set() };
        const somaAno = Number(r.soma || 0);
        const mediaMes = somaAno / Math.max(1, MESES_DECORRIDOS);

        const tr = document.createElement('tr');
        if (rowDirty(id)) tr.classList.add('changed');

        tr.innerHTML = `
          <td><div><strong>${esc(cat.nome||'')}</strong></div><div class="muted">${esc(id)}</div></td>
          <td>${esc(cat.tipo||'')}</td>
          <td>${esc(cat.centroDeCusto||'')}</td>
          <td>
            <select class="dre-select" data-k="dre_regra" data-id="${id}">
              <option value="" ${!regra?'selected':''}>—</option>
              <option value="caixa" ${regra==='caixa'?'selected':''}>caixa</option>
              <option value="competencia_driver" ${regra==='competencia_driver'?'selected':''}>competencia_driver</option>
              <option value="competencia_media" ${regra==='competencia_media'?'selected':''}>competencia_media</option>
              <option value="especial" ${regra==='especial'?'selected':''}>especial</option>
            </select>
          </td>
          <td>
            <div class="param-wrap" data-id="${id}" data-mode="${regra||''}">
              <div class="param-driver">
                <label class="muted">% Receita (driver)</label>
                <input class="dre-input" data-k="dre_percentual_base" data-id="${id}" placeholder="Ex.: 5% ou 0,05"
                  value="${esc(formatDecimalToPercent(driver) || '')}">
              </div>
              <div class="param-media">
                <label class="muted">N meses (média)</label>
                <input class="dre-input" data-k="dre_media_janela" data-id="${id}" type="number" step="1" min="1"
                  value="${mediaN!=null?esc(mediaN):''}">
              </div>
            </div>
          </td>
          <td>
            <input class="dre-input vright" data-k="dre_valor" data-id="${id}" placeholder="0,00"
              value="${valorDRE!=null ? esc(String(valorDRE).replace('.',',')) : ''}">
            <div class="muted">Salvo em: <code>categorias/${esc(id)}/dre_valor</code></div>
          </td>
          <td class="vright">
            <div><strong>${fmtMoeda(somaAno)}</strong></div>
            <div class="muted">/ ${fmtMoeda(mediaMes)}</div>
            <div class="muted">Ano ${ANO}</div>
          </td>
          <td class="row-actions nowrap"><button data-save="${id}">Salvar</button></td>
        `;
        tbody.appendChild(tr);
      });

      bindRowEvents();
      refreshBadge();
    }

    function bindRowEvents(){
      tbody.querySelectorAll('.dre-select').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const id = sel.getAttribute('data-id');
          const e = edits.get(id) || {};
          const v = sel.value || '';
          e.dre_regra = v || null;
          if (v !== 'competencia_driver') e.dre_percentual_base = null;
          if (v !== 'competencia_media')  e.dre_media_janela = null;
          edits.set(id, e);

          const wrap = tbody.querySelector(`.param-wrap[data-id="${id}"]`);
          if (wrap) wrap.setAttribute('data-mode', v || '');
          const tr = sel.closest('tr');
          if (rowDirty(id)) tr.classList.add('changed'); else tr.classList.remove('changed');
          refreshBadge();
        });
      });

      tbody.querySelectorAll('.dre-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-id');
          const k  = inp.getAttribute('data-k');
          const e  = edits.get(id) || {};
          let v = inp.value;

          if (k === 'dre_percentual_base'){
            const dec = parsePercentToDecimal(v);
            e[k] = (dec == null ? null : dec);
          } else if (k === 'dre_media_janela'){
            const n = Number(v);
            e[k] = (!v ? null : (isNaN(n) || n <= 0 ? null : Math.floor(n)));
          } else if (k === 'dre_valor'){
            const s = String(v).trim().replace(/\./g,'').replace(',','.');
            const n = Number(s);
            e[k] = isNaN(n) ? null : n;
          }
          edits.set(id, e);

          const tr = inp.closest('tr');
          if (rowDirty(id)) tr.classList.add('changed'); else tr.classList.remove('changed');
          refreshBadge();
        });
      });

      tbody.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-save');
          await saveRow(id);
        });
      });
    }

    async function saveRow(id){
      const b = cache.get(id) || {};
      const e = edits.get(id) || {};
      const regra = (e.dre_regra ?? b.dre_regra) || null;

      const payload = {
        dre_regra: regra,
        dre_percentual_base: regra === 'competencia_driver'
          ? (e.dre_percentual_base ?? b.dre_percentual_base ?? null)
          : null,
        dre_media_janela: regra === 'competencia_media'
          ? (e.dre_media_janela ?? b.dre_media_janela ?? null)
          : null,
        dre_valor: (e.dre_valor ?? b.dre_valor ?? null)
      };

      await update(ref(db, `financeiro/categorias/${id}`), payload);
      edits.delete(id);
      refreshBadge();
    }

    async function saveAll(){
      const ids = Array.from(edits.keys()).filter(rowDirty);
      for (const id of ids) await saveRow(id);
    }
    function discardAll(){ edits.clear(); refreshBadge(); render(); }

    elBusca.addEventListener('input', render);
    elFiltroTipo.addEventListener('change', render);
    elLimparFiltros.addEventListener('click', ()=>{ elBusca.value=''; elFiltroTipo.value=''; render(); });
    btnSalvarAlteracoes.addEventListener('click', saveAll);
    btnDescartarAlteracoes.addEventListener('click', discardAll);

    // ---------- Categorias
    onValue(ref(db, 'financeiro/categorias'), snap=>{
      cache.clear(); idxNome.clear();
      if (snap.exists()){
        snap.forEach(child=>{
          const id = child.key;
          const val = child.val() || {};
          cache.set(id, val);
          const nome = (val.nome||'').trim().toLowerCase();
          if (nome) idxNome.set(nome, id);
        });
      }
      render(); // render inicial (0 até carregar o fluxo)
    });

    // ---------- Fluxo: leitura ampla/robusta
    onValue(ref(db, 'financeiro/fluxo'), snap=>{
      // zera resumo
      resumoAno.clear();
      cache.forEach((_, id)=> resumoAno.set(id, { soma:0, meses:new Set() }) );

      if (!snap.exists()){ render(); return; }
      const raiz = snap.val() || {};

      // helpers
      const add = (catId, valor, mesIndex)=>{
        if (!resumoAno.has(catId)) resumoAno.set(catId,{soma:0,meses:new Set()});
        const r = resumoAno.get(catId);
        r.soma += Number(valor)||0;
        r.meses.add(mesIndex);
      };
      const matchCategoria = (obj)=>{
        const idPref = obj.categoriaId || obj.categoria || obj.categoria_id || null;
        if (idPref && cache.has(String(idPref))) return String(idPref);
        const nome = (obj.categoriaNome || obj.nomeCategoria || obj.nome_categoria || '').trim().toLowerCase();
        if (nome && idxNome.has(nome)) return idxNome.get(nome);
        return null;
      };
      const getValor = (obj)=>{
        // tenta vários campos comuns
        const cand = [obj.valor, obj.Valor, obj.valorPago, obj.valorReal, obj.amount, obj.total, obj.valor_liquido, obj.valorBruto];
        for (const v of cand){ const n = Number(v); if (!isNaN(n) && n !== 0) return n; }
        // se tiver 'valor' zero explícito ainda conta como 0
        if ('valor' in obj) return Number(obj.valor)||0;
        if ('Valor' in obj) return Number(obj.Valor)||0;
        return 0;
      };

      // percorre níveis: aceita YYYY-MM e YYYY/MM
      const reYM = /^(\d{4})[-/](\d{1,2})$/;

      Object.entries(raiz).forEach(([k, bloco])=>{
        // caso 1: chave no formato YYYY-MM
        let ano = null, mesIdx = null;
        const m1 = k.match(reYM);
        if (m1){ ano = Number(m1[1]); mesIdx = Math.max(0, Math.min(11, Number(m1[2])-1)); }

        // caso 2: nível ano -> meses
        if (!m1 && /^\d{4}$/.test(k)){
          const anoNode = Number(k);
          if (anoNode === ANO){
            Object.entries(bloco || {}).forEach(([km, sub])=>{
              const mesNum = Number(km);
              if (isNaN(mesNum)) return;
              const mesI = Math.max(0, Math.min(11, mesNum-1));
              // procurar coleções de lançamentos dentro de "sub"
              scanLancamentosColecao(sub, anoNode, mesI);
            });
          }
          return;
        }

        // caso 1: YYYY-MM no ano atual
        if (m1 && ano === ANO){
          // dentro do bloco, procure coleções de lançamentos
          scanLancamentosColecao(bloco, ano, mesIdx);
        }
      });

      function scanLancamentosColecao(node, anoNode, mesI){
        if (!node) return;

        // Coleções típicas
        const possiveis = ['lancamentos','Lancamentos','itens','Itens','movimentos','Movimentos','registros','Registros'];
        let conjuntos = [];
        for (const key of possiveis){
          if (node[key]) conjuntos.push(node[key]);
        }
        // Se não achou pelos nomes comuns, detectar coleções com objetos "com cara" de lançamento
        if (conjuntos.length === 0){
          // Se o próprio node parece uma coleção de lançamentos (obj de objs)
          if (pareceColecaoLanc(node)){
            conjuntos.push(node);
          } else {
            // procurar um nível abaixo
            Object.values(node).forEach(val=>{
              if (pareceColecaoLanc(val)) conjuntos.push(val);
            });
          }
        }

        conjuntos.forEach(coll=>{
          Object.values(coll || {}).forEach(l=>{
            const catId = matchCategoria(l);
            if (!catId) return;
            const v = getValor(l);
            if (v === 0) return;
            add(catId, v, mesI);
          });
        });
      }

      function pareceColecaoLanc(obj){
        // heurística: objeto com muitos filhos, e pelo menos 1 tem campo de valor ou categoria
        if (!obj || typeof obj !== 'object') return false;
        const vals = Object.values(obj);
        if (vals.length === 0) return false;
        let score = 0;
        for (const x of vals){
          if (!x || typeof x !== 'object') continue;
          if ('valor' in x || 'Valor' in x || 'valorPago' in x || 'valorReal' in x || 'amount' in x) score++;
          if ('categoriaId' in x || 'categoria' in x || 'categoria_id' in x || 'categoriaNome' in x || 'nomeCategoria' in x) score++;
        }
        return score >= 1;
      }

      render();
    });
  </script>
</body>
</html>
