<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Regras de DRE por Categoria</title>

  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>
  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>

  <style>
    .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .page-header h1{margin:0;font-size:20px;color:#111827;}
    .muted{color:#6b7280;font-size:11.5px;}

    .filters{display:grid;grid-template-columns:1fr 160px;gap:10px;margin-bottom:10px;align-items:end;}
    @media (max-width:900px){.filters{grid-template-columns:1fr;}}
    .filters label{font-size:12px;color:#374151;}
    .filters input,.filters button{width:100%;box-sizing:border-box;padding:6px;font-size:12px;}
    .filters button{height:32px;border:1px solid #ddd;border-radius:8px;background:#ff7f2a;color:#fff;cursor:pointer;}

    table{width:100%;border-collapse:collapse;background:#fff;}
    thead th{background:#fff7ec;color:#111827;text-align:left;border:1px solid #e5e7eb;padding:8px;font-size:12.5px;}
    tbody td{border:1px solid #e5e7eb;padding:6px 8px;font-size:12.5px;vertical-align:top;}
    .nowrap{white-space:nowrap;}
    .dre-select,.dre-input{width:100%;box-sizing:border-box;padding:5px;font-size:12px;}
    .param-wrap{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
    .param-wrap>div{display:none;}
    .param-wrap[data-mode="competencia_driver"] .param-driver{display:block;grid-column:span 2;}
    .param-wrap[data-mode="competencia_media"]  .param-media{display:block;}
    .row-actions button{font-size:11.5px;padding:6px 10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;}
    .row-actions button:hover{background:#f3f4f6;}
    .save-all{margin-top:10px;display:inline-flex;gap:8px;}
    .save-all button{height:34px;padding:0 12px;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:12px;}
    .save{background:#10b981;color:#fff;border-color:#0ea5e9;}
    .reset{background:#fff;}
    tr.changed{background:#f8fffb;}
    .pill{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid #e5e7eb;background:#fff;}
    .vright{text-align:right;}
    code{font-size:11px;}
  </style>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Regras de DRE por Categoria</h1>
      <span class="muted">Base de cálculo: mês anterior. YTD até o mês anterior.</span>
    </div>

    <div class="filters">
      <label>
        Busca (nome)
        <input type="text" id="busca" placeholder="Digite para filtrar…">
      </label>
      <button id="limparFiltros">Limpar filtros</button>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th style="width:26%;">Categoria</th>
          <th style="width:12%;">Regra DRE</th>
          <th style="width:18%;">Parâmetros</th>
          <th style="width:10%;">Valor DRE</th>
          <th style="width:12%;">DRE (calc.)</th>
          <th style="width:11%;" class="nowrap">DRE (Anual/Média)</th>
          <th style="width:11%;" class="nowrap">Fluxo (Anual/Média)</th>
          <th class="nowrap">Ações</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="save-all">
      <button class="reset" id="descartarAlteracoes">Descartar alterações</button>
      <button class="save" id="salvarAlteracoes">Salvar alterações (em lote)</button>
      <span id="badgeAlteracoes" class="pill muted">0 alteração(ões)</span>
    </div>
  </div>

  <script type="module">
    import { db } from './assets/firebase-config.js';
    import { ref, onValue, update } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // ---------- Elementos
    const elBusca = document.getElementById('busca');
    const elLimparFiltros = document.getElementById('limparFiltros');
    const tbody = document.getElementById('lista');
    const btnSalvarAlteracoes = document.getElementById('salvarAlteracoes');
    const btnDescartarAlteracoes = document.getElementById('descartarAlteracoes');
    const badgeAlteracoes = document.getElementById('badgeAlteracoes');

    // ---------- Estados
    const cache = new Map();        // id -> categoria
    const edits = new Map();        // id -> { dre_regra, dre_percentual_base, dre_media_janela, dre_valor }

    // Séries do CONSOLIDADO (usadas tanto para DRE quanto para o "Fluxo" desta tela)
    const serieMes = new Map();     // id -> Array(24) [ANO-1: 0..11, ANO: 12..23]
    const ytd = new Map();          // id -> soma YTD (até mês base)
    const valorMesBase = new Map(); // id -> valor do mês base (anterior)
    let somaEntradasMesBase = 0;    // p/ competencia_driver

    const hoje = new Date();
    const ANO = hoje.getFullYear();
    const ANO_ANT = ANO - 1;
    const MES_ATUAL = hoje.getMonth(); // 0..11
    const MES_BASE = (MES_ATUAL - 1 + 12) % 12;        // mês anterior
    const ANO_BASE = (MES_ATUAL === 0) ? ANO_ANT : ANO; // ano do mês base
    const MESES_YTD_BASE = (ANO_BASE === ANO_ANT) ? 12 : (MES_BASE + 1);

    // ---------- Utils
    const esc = (s='') => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
                                   .replaceAll('"','&quot;').replaceAll("'","&#39;");
    const fmtMoeda = (n=0) => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    function parsePercentToDecimal(txt){
      if (txt == null) return null;
      let s = String(txt).trim();
      if (!s) return null;
      s = s.replace('%','').replace(/\s+/g,'').replace(',','.');
      let v = Number(s);
      if (isNaN(v)) return null;
      if (v > 1) v = v/100;
      return v;
    }
    function formatDecimalToPercent(dec){
      if (dec == null || dec === '') return '';
      const n = Number(dec); if (isNaN(n)) return '';
      return (n*100).toLocaleString('pt-BR',{maximumFractionDigits:2}) + '%';
    }
    function rowDirty(id){
      const b = cache.get(id) || {};
      const e = edits.get(id);
      if (!e) return false;
      return (
        (e.dre_regra ?? b.dre_regra) !== b.dre_regra ||
        (e.dre_percentual_base ?? b.dre_percentual_base) !== b.dre_percentual_base ||
        (e.dre_media_janela ?? b.dre_media_janela) !== b.dre_media_janela ||
        (e.dre_valor ?? b.dre_valor) !== b.dre_valor
      );
    }
    function refreshBadge(){
      const count = Array.from(edits.keys()).filter(rowDirty).length;
      badgeAlteracoes.textContent = `${count} alteração(ões)`;
    }

    // ---------- Cálculo DRE (calc.) — mês anterior (sempre via CONSOLIDADO por categoria)
    function calcDREValue(id){
      const base = cache.get(id) || {};
      const e = edits.get(id) || {};
      const regra = (e.dre_regra ?? base.dre_regra) || null;

      if (!regra) return { valor: 0, desc: '—' };

      if (regra === 'caixa'){
        const v = Number(valorMesBase.get(id) || 0);
        return { valor: v, desc: 'mês anterior' };
      }

      if (regra === 'competencia_media'){
        const n = Number((e.dre_media_janela ?? base.dre_media_janela) || 0);
        const serie = serieMes.get(id) || Array(24).fill(0);
        const idxBase = (ANO_BASE === ANO ? 12 : 0) + MES_BASE; // índice absoluto do mês base
        let soma = 0, count = 0;
        if (n > 0){
          for (let i = idxBase - (n - 1); i <= idxBase; i++){
            if (i >= 0 && i < serie.length){ soma += Number(serie[i] || 0); count++; }
          }
        }
        const media = count ? (soma / count) : 0;
        return { valor: media, desc: `média ${n}m até mês anterior` };
      }

      if (regra === 'competencia_driver'){
        const p = Number((e.dre_percentual_base ?? base.dre_percentual_base) || 0);
        const v = p * Number(somaEntradasMesBase || 0);
        return { valor: v, desc: `${(p*100).toLocaleString('pt-BR',{maximumFractionDigits:2})}% das entradas (mês anterior)` };
      }

      return { valor: 0, desc: 'especial' };
    }

    // ---------- Render
    function render(){
      const q = (elBusca.value || '').toLowerCase();
      const rows = [];
      cache.forEach((cat,id)=>{
        const texto = `${cat.nome||''}`.toLowerCase();
        if (q && !texto.includes(q)) return;
        rows.push({id,cat});
      });
      rows.sort((a,b)=> (a.cat?.nome||'').localeCompare(b.cat?.nome||''));

      tbody.innerHTML = '';
      rows.forEach(({id,cat})=>{
        const e = edits.get(id) || {};
        const regra = (e.dre_regra ?? cat.dre_regra) || '';
        const driver = (e.dre_percentual_base ?? cat.dre_percentual_base);
        const mediaN = (e.dre_media_janela ?? cat.dre_media_janela);
        const valorDRE = (e.dre_valor ?? cat.dre_valor);

        // YTDs e médias (até mês base)
        const somaCat = Number((ytd.get(id) || 0));
        const mediaCat = somaCat / Math.max(1, MESES_YTD_BASE);

        // DRE(calc.)
        const { valor: dreCalc, desc: dreDesc } = calcDREValue(id);

        const tr = document.createElement('tr');
        if (rowDirty(id)) tr.classList.add('changed');

        tr.innerHTML = `
          <td><div><strong>${esc(cat.nome||'')}</strong></div><div class="muted">${esc(id)}</div></td>
          <td>
            <select class="dre-select" data-k="dre_regra" data-id="${id}">
              <option value="" ${!regra?'selected':''}>—</option>
              <option value="caixa" ${regra==='caixa'?'selected':''}>caixa</option>
              <option value="competencia_driver" ${regra==='competencia_driver'?'selected':''}>competencia_driver</option>
              <option value="competencia_media" ${regra==='competencia_media'?'selected':''}>competencia_media</option>
              <option value="especial" ${regra==='especial'?'selected':''}>especial</option>
            </select>
          </td>
          <td>
            <div class="param-wrap" data-id="${id}" data-mode="${regra||''}">
              <div class="param-driver">
                <label class="muted">% Receita (driver)</label>
                <input class="dre-input" data-k="dre_percentual_base" data-id="${id}" placeholder="Ex.: 5% ou 0,05"
                  value="${esc(formatDecimalToPercent(driver) || '')}">
              </div>
              <div class="param-media">
                <label class="muted">N meses (média)</label>
                <input class="dre-input" data-k="dre_media_janela" data-id="${id}" type="number" step="1" min="1"
                  value="${mediaN!=null?esc(mediaN):''}">
              </div>
            </div>
          </td>
          <td>
            <input class="dre-input vright" data-k="dre_valor" data-id="${id}" placeholder="0,00"
              value="${valorDRE!=null ? esc(String(valorDRE).replace('.',',')) : ''}">
            <div class="muted">Manual: <code>categorias/${esc(id)}/dre_valor</code></div>
          </td>
          <td class="vright">
            <div><strong>${fmtMoeda(dreCalc)}</strong></div>
            <div class="muted">${esc(dreDesc)}</div>
          </td>
          <td class="vright">
            <div><strong>${fmtMoeda(somaCat)}</strong></div>
            <div class="muted">/ ${fmtMoeda(mediaCat)}</div>
            <div class="muted">DRE YTD (até mês ant.)</div>
          </td>
          <td class="vright">
            <div><strong>${fmtMoeda(somaCat)}</strong></div>
            <div class="muted">/ ${fmtMoeda(mediaCat)}</div>
            <div class="muted">Fluxo (mesma base do Fluxo_financeiro)</div>
          </td>
          <td class="row-actions nowrap"><button data-save="${id}">Salvar</button></td>
        `;
        tbody.appendChild(tr);
      });

      // visibilidade de parâmetros
      tbody.querySelectorAll('.param-wrap').forEach(w=>{
        const id = w.getAttribute('data-id');
        const cat = cache.get(id) || {};
        const e = edits.get(id) || {};
        const regra = (e.dre_regra ?? cat.dre_regra) || '';
        w.setAttribute('data-mode', regra || '');
      });

      bindRowEvents();
      refreshBadge();
    }

    function bindRowEvents(){
      tbody.querySelectorAll('.dre-select').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const id = sel.getAttribute('data-id');
          const e = edits.get(id) || {};
          const v = sel.value || '';
          e.dre_regra = v || null;
          if (v !== 'competencia_driver') e.dre_percentual_base = null;
          if (v !== 'competencia_media')  e.dre_media_janela = null;
          edits.set(id, e);
          render();
        });
      });

      tbody.querySelectorAll('.dre-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-id');
          const k  = inp.getAttribute('data-k');
          const e  = edits.get(id) || {};
          let v = inp.value;

          if (k === 'dre_percentual_base'){
            const dec = parsePercentToDecimal(v);
            e[k] = (dec == null ? null : dec);
          } else if (k === 'dre_media_janela'){
            const n = Number(v);
            e[k] = (!v ? null : (isNaN(n) || n <= 0 ? null : Math.floor(n)));
          } else if (k === 'dre_valor'){
            const s = String(v).trim().replace(/\./g,'').replace(',','.');
            const n = Number(s);
            e[k] = isNaN(n) ? null : n;
          }
          edits.set(id, e);
          render();
        });
      });

      tbody.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-save');
          await saveRow(id);
        });
      });
    }

    async function saveRow(id){
      const b = cache.get(id) || {};
      const e = edits.get(id) || {};
      const regra = (e.dre_regra ?? b.dre_regra) || null;

      const payload = {
        dre_regra: regra,
        dre_percentual_base: regra === 'competencia_driver'
          ? (e.dre_percentual_base ?? b.dre_percentual_base ?? null)
          : null,
        dre_media_janela: regra === 'competencia_media'
          ? (e.dre_media_janela ?? b.dre_media_janela ?? null)
          : null,
        dre_valor: (e.dre_valor ?? b.dre_valor ?? null)
      };

      await update(ref(db, `financeiro/categorias/${id}`), payload);
      edits.delete(id);
      refreshBadge();
      render();
    }

    function discardAll(){ edits.clear(); refreshBadge(); render(); }
    async function saveAll(){
      const ids = Array.from(edits.keys()).filter(rowDirty);
      for (const id of ids) await saveRow(id);
    }

    elBusca.addEventListener('input', render);
    elLimparFiltros.addEventListener('click', ()=>{ elBusca.value=''; render(); });
    btnSalvarAlteracoes.addEventListener('click', saveAll);
    btnDescartarAlteracoes.addEventListener('click', discardAll);

    // ---------- Categorias
    onValue(ref(db,'financeiro/categorias'), snap=>{
      cache.clear();
      if (snap.exists()){
        snap.forEach(child=>{ cache.set(child.key, child.val() || {}); });
      }
      render();
    });

    // ---------- CONSOLIDADO (ANO-1 e ANO) — mesma base do Fluxo_financeiro.html
    const consCache = new Map(); // ano -> node

    onValue(ref(db, `financeiro/consolidado/${ANO_ANT}`), s => recomputeConsolidado(ANO_ANT, s.exists()?s.val():null));
    onValue(ref(db, `financeiro/consolidado/${ANO}`),     s => recomputeConsolidado(ANO,     s.exists()?s.val():null));

    function recomputeConsolidado(ano, node){
      consCache.set(ano, node);

      // zera agregados
      serieMes.clear();
      ytd.clear();
      valorMesBase.clear();
      somaEntradasMesBase = 0;

      // arrays base para todas categorias conhecidas
      cache.forEach((_, id)=> serieMes.set(id, Array(24).fill(0)) );

      // processa anos na ordem (ANO-1 -> ANO)
      [ANO_ANT, ANO].forEach(a=>{
        const n = consCache.get(a);
        if (!n) return;

        const baseOffset = (a === ANO) ? 12 : 0;

        // Formato array por mês (1..12) com ids de categoria (igual ao Fluxo_financeiro)
        if (Array.isArray(n)){
          n.forEach((mesNode, idx)=>{
            if (!mesNode || typeof mesNode !== 'object') return;
            const mesIdx = idx - 1; // [0]=null, [1]=jan
            if (mesIdx < 0 || mesIdx > 11) return;

            Object.entries(mesNode).forEach(([catId, val])=>{
              let numero = 0;
              if (typeof val === 'number') numero = val;
              else if (val && typeof val === 'object'){
                const cands = [val.valor, val.total, val.amount, val.Valor, val.valorReal, val.valor_liquido, val.valorBruto];
                for (const v of cands){
                  const num = Number(v);
                  if (!Number.isNaN(num) && num !== 0){ numero = num; break; }
                }
              }

              const arr = serieMes.get(catId) || Array(24).fill(0);
              arr[baseOffset + mesIdx] = Number(numero) || 0;
              serieMes.set(catId, arr);

              // YTD até mês base do ANO corrente
              if (a === ANO && (mesIdx+1) <= (MES_BASE + 1)){
                ytd.set(catId, Number(ytd.get(catId) || 0) + (Number(numero) || 0));
              }

              // Valor do mês base
              const isMesBase = ((a === ANO_BASE) && (mesIdx === MES_BASE));
              if (isMesBase){ valorMesBase.set(catId, Number(numero) || 0); }
            });
          });
        }
      });

      // soma das Entradas no MÊS BASE (competencia_driver)
      cache.forEach((cat, id)=>{
        if ((cat?.tipo) === 'Entrada'){
          somaEntradasMesBase += Number(valorMesBase.get(id) || 0);
        }
      });

      render();
    }
  </script>
</body>
</html>
