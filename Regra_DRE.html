<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Regras de DRE por Categoria</title>

  <!-- Estilos padrão do sistema -->
  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>

  <!-- Firebase (config no seu arquivo) + menu -->
  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>

  <style>
    /* Cabeçalho da página */
    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .page-header h1 { margin: 0; font-size: 20px; }

    /* Barra de filtros */
    .filters {
      display: grid;
      grid-template-columns: 1fr 180px 160px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }
    @media (max-width: 900px){
      .filters { grid-template-columns: 1fr 1fr; }
    }
    .filters label { font-size: 12px; color:#374151; }
    .filters input, .filters select, .filters button {
      width: 100%; box-sizing: border-box; padding: 6px; font-size: 12px;
    }
    .filters button {
      height: 32px; border: 1px solid #ddd; border-radius: 8px;
      background: #ff7f2a; color: #fff; cursor: pointer;
    }

    /* Tabela */
    table {
      width: 100%; border-collapse: collapse; background: #fff;
    }
    thead th {
      background: #fff7ec; text-align: left; border: 1px solid #e5e7eb; padding: 8px; font-size: 12.5px;
    }
    tbody td {
      border: 1px solid #e5e7eb; padding: 6px 8px; font-size: 12.5px; vertical-align: top;
    }
    .nowrap { white-space: nowrap; }
    .muted { color:#6b7280; font-size: 11.5px; }

    /* Inputs na tabela */
    .dre-select, .dre-input {
      width: 100%; box-sizing: border-box; padding: 5px; font-size: 12px;
    }
    .param-wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .param-wrap > div { display: none; }
    .param-wrap[data-mode="competencia_driver"] .param-driver { display: block; grid-column: span 2; }
    .param-wrap[data-mode="competencia_media"] .param-media { display: block; }

    .row-actions button {
      font-size: 11.5px; padding: 6px 10px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer;
    }
    .row-actions button:hover { background:#f3f4f6; }
    .save-all {
      margin-top: 10px; display: inline-flex; gap: 8px;
    }
    .save-all button {
      height: 34px; padding: 0 12px; border:1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 12px;
    }
    .save { background:#10b981; color:#fff; border-color:#0ea5e9; }
    .reset { background:#fff; }

    /* Estado alterado */
    tr.changed { background: #f8fffb; }
    .pill {
      display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid #e5e7eb; background:#fff;
    }
  </style>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Regras de DRE por Categoria</h1>
      <span class="muted">Edição focada apenas em regra e parâmetros do DRE</span>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <label>
        Busca (nome / centro de custo)
        <input type="text" id="busca" placeholder="Digite para filtrar…">
      </label>
      <label>
        Tipo
        <select id="filtroTipo">
          <option value="">Todos</option>
          <option value="Entrada">Entrada</option>
          <option value="Saída">Saída</option>
          <option value="Entrada/Saída">Entrada/Saída</option>
        </select>
      </label>
      <button id="limparFiltros">Limpar filtros</button>
    </div>

    <!-- Tabela -->
    <table id="tabela">
      <thead>
        <tr>
          <th style="width: 26%;">Categoria</th>
          <th style="width: 12%;">Tipo</th>
          <th style="width: 26%;">Centro de Custo</th>
          <th style="width: 16%;">Regra DRE</th>
          <th>Parâmetros</th>
          <th class="nowrap">Ações</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div class="save-all">
      <button class="reset" id="descartarAlteracoes">Descartar alterações</button>
      <button class="save" id="salvarAlteracoes">Salvar alterações (em lote)</button>
      <span id="badgeAlteracoes" class="pill muted">0 alteração(ões)</span>
    </div>
  </div>

  <script type="module">
    import { db } from './assets/firebase-config.js';
    import {
      ref, onValue, update
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    const elBusca = document.getElementById('busca');
    const elFiltroTipo = document.getElementById('filtroTipo');
    const elLimparFiltros = document.getElementById('limparFiltros');
    const tbody = document.getElementById('lista');
    const btnSalvarAlteracoes = document.getElementById('salvarAlteracoes');
    const btnDescartarAlteracoes = document.getElementById('descartarAlteracoes');
    const badgeAlteracoes = document.getElementById('badgeAlteracoes');

    const cache = new Map();          // id -> categoria original
    const edits = new Map();          // id -> { dre_regra, dre_percentual_base, dre_media_janela }
    let viewRows = [];                // ids após filtro

    // Utils
    const esc = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

    function parsePercentToDecimal(txt){
      if (txt == null) return null;
      let s = String(txt).trim();
      if (!s) return null;
      s = s.replace('%','').replace(/\s+/g,'').replace(',','.');
      let v = Number(s);
      if (isNaN(v)) return null;
      if (v > 1) v = v / 100;
      return v;
    }

    function formatDecimalToPercent(dec){
      if (dec == null || dec === '') return '';
      const n = Number(dec);
      if (isNaN(n)) return '';
      return (n*100).toLocaleString('pt-BR', {maximumFractionDigits:2}) + '%';
    }

    function rowDirty(id){
      const base = cache.get(id) || {};
      const e = edits.get(id);
      if (!e) return false;
      return (
        (e.dre_regra ?? base.dre_regra) !== base.dre_regra ||
        (e.dre_percentual_base ?? base.dre_percentual_base) !== base.dre_percentual_base ||
        (e.dre_media_janela ?? base.dre_media_janela) !== base.dre_media_janela
      );
    }

    function refreshBadge(){
      const count = Array.from(edits.keys()).filter(rowDirty).length;
      badgeAlteracoes.textContent = `${count} alteração(ões)`;
    }

    // Render
    function render(){
      const q = (elBusca.value || '').toLowerCase();
      const tipo = elFiltroTipo.value;

      const rows = [];
      cache.forEach((cat, id) => {
        const texto = `${cat.nome||''} ${cat.centroDeCusto||''}`.toLowerCase();
        if (q && !texto.includes(q)) return;
        if (tipo && cat.tipo !== tipo) return;
        rows.push({id, cat});
      });
      // ordena por nome
      rows.sort((a,b)=> (a.cat?.nome||'').localeCompare(b.cat?.nome||''));

      viewRows = rows.map(r=>r.id);
      tbody.innerHTML = '';

      rows.forEach(({id,cat})=>{
        const e = edits.get(id) || {};
        const regra = (e.dre_regra ?? cat.dre_regra) || '';
        const driver = (e.dre_percentual_base ?? cat.dre_percentual_base);
        const mediaN = (e.dre_media_janela ?? cat.dre_media_janela);

        const tr = document.createElement('tr');
        if (rowDirty(id)) tr.classList.add('changed');

        tr.innerHTML = `
          <td><div><strong>${esc(cat.nome||'')}</strong></div><div class="muted">${esc(id)}</div></td>
          <td>${esc(cat.tipo||'')}</td>
          <td>${esc(cat.centroDeCusto||'')}</td>
          <td>
            <select class="dre-select" data-k="dre_regra" data-id="${id}">
              <option value="" ${!regra?'selected':''}>—</option>
              <option value="caixa" ${regra==='caixa'?'selected':''}>caixa</option>
              <option value="competencia_driver" ${regra==='competencia_driver'?'selected':''}>competencia_driver</option>
              <option value="competencia_media" ${regra==='competencia_media'?'selected':''}>competencia_media</option>
              <option value="especial" ${regra==='especial'?'selected':''}>especial</option>
            </select>
          </td>
          <td>
            <div class="param-wrap" data-id="${id}" data-mode="${regra||''}">
              <div class="param-driver">
                <label class="muted"> % Receita (driver) </label>
                <input class="dre-input" data-k="dre_percentual_base" data-id="${id}" placeholder="Ex.: 5% ou 0,05"
                       value="${esc(formatDecimalToPercent(driver) || '')}">
              </div>
              <div class="param-media">
                <label class="muted"> N meses (média) </label>
                <input class="dre-input" data-k="dre_media_janela" data-id="${id}" type="number" step="1" min="1"
                       value="${mediaN!=null?esc(mediaN):''}">
              </div>
            </div>
          </td>
          <td class="row-actions nowrap">
            <button data-save="${id}">Salvar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      bindRowEvents();
      refreshBadge();
    }

    function bindRowEvents(){
      // Select de regra
      tbody.querySelectorAll('.dre-select').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const id = sel.getAttribute('data-id');
          const k = sel.getAttribute('data-k');
          const v = sel.value || '';
          const e = edits.get(id) || {};
          e[k] = v || null;

          // Zera params se trocar tipo
          if (v !== 'competencia_driver') e.dre_percentual_base = null;
          if (v !== 'competencia_media')  e.dre_media_janela = null;

          edits.set(id, e);

          // Atualiza UI dos parâmetros
          const wrap = tbody.querySelector(`.param-wrap[data-id="${id}"]`);
          if (wrap) wrap.setAttribute('data-mode', v || '');

          // Visual de alterado
          const tr = sel.closest('tr');
          if (rowDirty(id)) tr.classList.add('changed'); else tr.classList.remove('changed');

          refreshBadge();
        });
      });

      // Inputs de parâmetros
      tbody.querySelectorAll('.dre-input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-id');
          const k  = inp.getAttribute('data-k');
          const e  = edits.get(id) || {};
          let v = inp.value;

          if (k === 'dre_percentual_base') {
            const dec = parsePercentToDecimal(v);
            e[k] = (dec == null ? null : dec);
          } else if (k === 'dre_media_janela') {
            const n = Number(v);
            e[k] = (!v ? null : (isNaN(n) || n <= 0 ? null : Math.floor(n)));
          }
          edits.set(id, e);

          // Visual de alterado
          const tr = inp.closest('tr');
          if (rowDirty(id)) tr.classList.add('changed'); else tr.classList.remove('changed');

          refreshBadge();
        });
      });

      // Botões salvar por linha
      tbody.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-save');
          await saveRow(id);
        });
      });
    }

    async function saveRow(id){
      const base = cache.get(id) || {};
      const e = edits.get(id) || {};

      // Monta payload somente com campos DRE
      const payload = {
        dre_regra: (e.dre_regra ?? base.dre_regra) || null,
        dre_percentual_base: (e.dre_regra ?? base.dre_regra) === 'competencia_driver'
          ? (e.dre_percentual_base ?? base.dre_percentual_base ?? null)
          : null,
        dre_media_janela: (e.dre_regra ?? base.dre_regra) === 'competencia_media'
          ? (e.dre_media_janela ?? base.dre_media_janela ?? null)
          : null
      };

      await update(ref(db, `financeiro/categorias/${id}`), payload);
      // Após salvar, sincronização pelo onValue atualizará cache; aqui só limpamos a marca da linha
      edits.delete(id);
      refreshBadge();
    }

    async function saveAll(){
      const ids = Array.from(edits.keys()).filter(rowDirty);
      for (const id of ids) {
        await saveRow(id);
      }
    }

    function discardAll(){
      edits.clear();
      refreshBadge();
      render();
    }

    // Eventos globais
    elBusca.addEventListener('input', render);
    elFiltroTipo.addEventListener('change', render);
    elLimparFiltros.addEventListener('click', ()=>{
      elBusca.value = '';
      elFiltroTipo.value = '';
      render();
    });
    btnSalvarAlteracoes.addEventListener('click', saveAll);
    btnDescartarAlteracoes.addEventListener('click', discardAll);

    // Carregamento inicial
    onValue(ref(db, 'financeiro/categorias'), snap=>{
      cache.clear();
      if (snap.exists()){
        snap.forEach(child=>{
          cache.set(child.key, child.val() || {});
        });
      }
      render();
    });
  </script>
</body>
</html>
