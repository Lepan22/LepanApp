<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fluxo Financeiro</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  .main-content { padding:16px 20px; }

  .page-header h1 { margin:6px 0 6px; }
  .page-header p  { margin:0 0 12px; color:#666; font-size:13px; }

  .diag { margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; display:none; }
  .diag.warn { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
  .diag.err  { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }

  .filters { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .badge   { background:#f6f6f6; border:1px solid #e5e5e5; padding:2px 6px; border-radius:6px; font-size:12px; }

  .legend { font-size:11.5px; color:#666; display:flex; gap:10px; align-items:center; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:3px; vertical-align:middle; margin-right:4px; }
  .dot.past   { background:#f1f5f9; border:1px solid #e5e7eb; }
  .dot.today  { background:#fff3c4; border:1px solid #fde68a; }
  .dot.future { background:#ffffff; border:1px solid #e5e7eb; }

  .table-wrap { overflow-x:auto; border:1px solid #eee; border-radius:8px; }

  /* 1ª col 420 + 2ª col 160 + 12 * 120 = 2.000 → min 2.050 */
  table.fx { width:100%; border-collapse:collapse; table-layout:fixed; min-width:2050px; background:#fff; }
  .fx th, .fx td { border:1px solid #e6e6e6; padding:6px 8px; font-size:12.5px; }

  .fx thead th { background:#fff7ec; color:#000; font-weight:600; }

  /* Coluna “Centro/Categoria” fixa e larga */
  .fx th.ind, .fx td.ind {
    position:sticky; left:0; z-index:3;
    background:#fafafa;
    width:420px; min-width:420px; max-width:420px;
    text-align:left; white-space:nowrap;
  }

  /* 2ª coluna: “Consolidado no Ano” fixa também */
  .fx th.year, .fx td.year {
    position:sticky; left:420px; z-index:2;
    background:#fafafa;
    width:160px; min-width:160px; max-width:160px;
  }

  /* Demais colunas (meses) */
  .fx th:not(.ind):not(.year), .fx td:not(.ind):not(.year) { width:120px; }

  .num { text-align:right; }
  .muted { color:#6b7280; }
  .pct { color:#475569; font-size:11.5px; }

  /* Destaques de cor por grupo */
  .grp-receita   > td.ind { background:#ecfdf5; font-weight:700; }   /* verde claro */
  .grp-cmv       > td.ind { background:#fff7ed; font-weight:700; }   /* laranja claro */
  .grp-despesa   > td.ind { background:#fef2f2; font-weight:700; }   /* vermelho claro */
  .totais-row    > td.ind { background:#f1f5f9; font-weight:800; }   /* cinza claro */

  /* Passado / hoje / futuro nas células de meses */
  .past   { background:#fbfbfb; }
  .today  { background:#fffbe6; }
  .future { background:#ffffff; }

  .toggle {
    display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none;
  }
  .caret { font-size:12px; color:#555; width:14px; text-align:center; }

  /* Linhas colapsáveis (categorias) */
  tr.cat-row { transition: height .15s ease; }
  tr.cat-row.hidden { display:none; }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 (sem módulos) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Fluxo Financeiro</h1>
      <p>Quebra por <strong>Centro de Custo</strong> e <strong>Categoria</strong>, com <em>Consolidado no Ano</em> e percentuais sobre a Receita.</p>
      <div id="diag" class="diag warn"></div>
    </div>

    <section class="filters">
      <label>Ano Fiscal:
        <select id="anoSelect"></select>
      </label>
      <span class="badge">Percentuais calculados sobre a <strong>Receita</strong> do ano selecionado.</span>
      <span class="legend">
        <span><span class="dot past"></span>Passado</span>
        <span><span class="dot today"></span>Hoje</span>
        <span><span class="dot future"></span>Futuro</span>
      </span>
    </section>

    <div class="table-wrap">
      <table class="fx" id="tbl">
        <thead>
          <tr id="hdrMeses">
            <th class="ind">Centro/Categoria</th>
            <th class="year">Consolidado (Ano)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const diag = document.getElementById('diag');
  const showDiag = (msg, type="warn") => { diag.className = `diag ${type}`; diag.textContent = msg; diag.style.display = 'block'; };
  const clearDiag = () => { diag.style.display = 'none'; diag.textContent = ''; };

  // Firebase
  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch(e){ console.error(e); showDiag('Falha ao inicializar Firebase.', 'err'); }
  const db = firebase.apps.length ? firebase.database() : null;

  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date(); const mesAtual = hoje.getMonth()+1; const anoAtual = hoje.getFullYear();

  const anoSelect = document.getElementById('anoSelect');
  const hdrMeses  = document.getElementById('hdrMeses');
  const tbody     = document.getElementById('tbody');

  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => isNaN(Number(v)) ? 0 : Number(v);
  const ccKey = cc => (String(cc||'despesa').trim().toLowerCase()==='receita' ? 'receita' : (String(cc||'').trim().toLowerCase()==='cmv' ? 'cmv' : 'despesa'));

  function paintCell(td, m, anoSel){
    const isTodayCol = (m===mesAtual && anoSel===anoAtual);
    td.classList.add(isTodayCol ? 'today' : ( (anoSel<anoAtual || (anoSel===anoAtual && m<mesAtual)) ? 'past' : 'future'));
  }

  function buildHeader(){
    hdrMeses.innerHTML = '<th class="ind">Centro/Categoria</th><th class="year">Consolidado (Ano)</th>';
    for (let m=1;m<=12;m++){
      const th = document.createElement('th'); th.textContent = mesesPt[m-1]; hdrMeses.appendChild(th);
    }
  }

  async function getCategorias(){
    const snap = await db.ref('financeiro/categorias').once('value');
    const v = snap.val() || {};
    const arr = Object.keys(v).map(id => ({ id, nome: v[id]?.nome || '(sem nome)', grupo: ccKey(v[id]?.centroDeCusto) }));
    // ordena: Receita, CMV, Despesa; dentro, por nome
    const order = { receita:0, cmv:1, despesa:2 };
    arr.sort((a,b)=> (order[a.grupo]-order[b.grupo]) || a.nome.localeCompare(b.nome));
    return arr;
  }

  async function getConsolidado(ano){
    const snap = await db.ref(`financeiro/consolidado/${ano}`).once('value');
    return snap.val() || {};
  }

  function buildRow(label, cls){
    const tr = document.createElement('tr');
    tr.className = cls || '';
    const tdInd  = document.createElement('td'); tdInd.className = 'ind'; tdInd.textContent = label;
    const tdYear = document.createElement('td'); tdYear.className = 'year num'; tdYear.textContent = '—';
    tr.appendChild(tdInd); tr.appendChild(tdYear);
    for (let m=1;m<=12;m++){
      const td = document.createElement('td'); td.className='num'; td.textContent='—'; tr.appendChild(td);
    }
    return tr;
  }

  function buildGroupHeader(grpKey, label, startOpen=true){
    const tr = document.createElement('tr');
    tr.className = `grp-${grpKey}`;
    const tdInd = document.createElement('td'); tdInd.className='ind';
    tdInd.innerHTML = `<span class="toggle" data-grp="${grpKey}" data-open="${startOpen? '1':'0'}">
      <span class="caret">${startOpen ? '▼' : '►'}</span> ${label}
    </span>`;
    const tdYear = document.createElement('td'); tdYear.className='year num'; tdYear.textContent='—';
    tr.appendChild(tdInd); tr.appendChild(tdYear);
    for (let m=1;m<=12;m++){
      const td=document.createElement('td'); td.className='num'; tr.appendChild(td);
      paintCell(td, m, Number(anoSelect.value));
      td.textContent='—';
    }
    return tr;
  }

  function attachToggle(){
    tbody.querySelectorAll('.toggle').forEach(tg=>{
      tg.addEventListener('click', ()=>{
        const grp = tg.dataset.grp;
        const open = tg.dataset.open==='1';
        tg.dataset.open = open ? '0':'1';
        tg.querySelector('.caret').textContent = open ? '►':'▼';
        tbody.querySelectorAll(`tr.cat-row[data-grp="${grp}"]`).forEach(r=>{
          r.classList.toggle('hidden', open);
        });
      });
    });
  }

  async function carregar(anoSel){
    clearDiag();
    buildHeader();
    tbody.innerHTML = '';

    // Header de grupos
    const grpLabels = { receita: 'Receita', cmv: 'CMV', despesa: 'Despesas' };
    const headers = {
      receita: buildGroupHeader('receita', grpLabels.receita, true),
      cmv:     buildGroupHeader('cmv',     grpLabels.cmv,     true),
      despesa: buildGroupHeader('despesa', grpLabels.despesa, true)
    };
    tbody.appendChild(headers.receita);
    tbody.appendChild(headers.cmv);
    tbody.appendChild(headers.despesa);

    // Linhas de categorias (inicialmente visíveis)
    const categorias = await getCategorias();
    const linhasCat = {}; // id -> tr
    categorias.forEach(cat=>{
      const tr = buildRow(cat.nome, 'cat-row'); tr.dataset.grp = cat.grupo; tr.classList.add('cat-row');
      tbody.appendChild(tr);
      linhasCat[cat.id] = { tr, grupo: cat.grupo };
    });

    // Linha de totais (ano/mês)
    const trTot = buildRow('Resultado Operacional (Receita − CMV − Despesas)', 'totais-row');
    tbody.appendChild(trTot);

    // Dados
    const dados = await getConsolidado(anoSel);

    // Acumuladores por grupo e por categoria
    const initArr = ()=> Array.from({length:12}, ()=>0);
    const grp = { receita:initArr(), cmv:initArr(), despesa:initArr() };
    const catSum = {}; // id -> [12]

    // Preenchimento
    Object.keys(dados).forEach(m=>{
      const i = Number(m)-1;
      const porCat = dados[m] || {};
      Object.keys(porCat).forEach(id=>{
        const v = num(porCat[id]?.valor);
        if (!catSum[id]) catSum[id] = initArr();
        catSum[id][i] += v;
        const g = linhasCat[id]?.grupo || 'despesa';
        grp[g][i] += v;
      });
    });

    // Totais por mês e por ano
    const sum = arr => arr.reduce((a,b)=>a+num(b),0);
    const anoReceita = sum(grp.receita);
    const anoCMV     = sum(grp.cmv);
    const anoDesp    = sum(grp.despesa);
    const anoRO      = anoReceita - anoCMV - anoDesp;

    // Preencher cabeçalhos dos grupos (valores + % no ano)
    function fillGroupRow(trHeader, arr, anoTotal, anoReceitaBase){
      // Consolidado ano
      const pct = anoReceitaBase ? (anoTotal/anoReceitaBase*100) : 0;
      trHeader.children[1].innerHTML = `${anoTotal? anoTotal.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}):'—'}<br><span class="pct">${pct.toFixed(1)}%</span>`;
      // Meses
      for(let m=1;m<=12;m++){
        const td = trHeader.children[m+1];
        paintCell(td, m, anoSel);
        const v = arr[m-1];
        td.textContent = v ? v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—';
      }
    }
    fillGroupRow(headers.receita, grp.receita, anoReceita, anoReceita);
    fillGroupRow(headers.cmv,     grp.cmv,     anoCMV,     anoReceita);
    fillGroupRow(headers.despesa, grp.despesa, anoDesp,    anoReceita);

    // Preencher categorias
    categorias.forEach(cat=>{
      const tr = linhasCat[cat.id].tr;
      const arr = catSum[cat.id] || initArr();
      const anoCat = sum(arr);
      const base = (cat.grupo==='receita') ? anoReceita : anoReceita; // todos % sobre receita
      const pct = base ? (anoCat/base*100) : 0;

      // Consolidado ano com %
      tr.children[1].innerHTML = `${anoCat? anoCat.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}):'—'}<br><span class="pct">${pct.toFixed(1)}%</span>`;

      for(let m=1;m<=12;m++){
        const td = tr.children[m+1];
        paintCell(td, m, anoSel);
        const v = arr[m-1];
        td.textContent = v ? v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—';
        if (anoReceita) td.title = `${((v/anoReceita)*100).toFixed(2)}% da Receita no ano`;
      }

      // Insere a categoria logo após o header do seu grupo (mantendo bloco coeso)
      const grpHeader = headers[cat.grupo];
      tbody.insertBefore(tr, grpHeader.nextSibling);
    });

    // Resultado Operacional
    trTot.children[1].textContent = anoRO.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    for(let m=1;m<=12;m++){
      const v = grp.receita[m-1] - grp.cmv[m-1] - grp.despesa[m-1];
      const td = trTot.children[m+1];
      paintCell(td, m, anoSel);
      td.textContent = v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    attachToggle();
  }

  // Init
  (async function init(){
    for(let y=anoAtual-2; y<=anoAtual+1; y++){
      const opt=document.createElement('option'); opt.value=y; opt.textContent=y;
      if(y===anoAtual) opt.selected=true; anoSelect.appendChild(opt);
    }
    // header meses
    for (let m=1;m<=12;m++){
      const th=document.createElement('th'); th.textContent=mesesPt[m-1]; hdrMeses.appendChild(th);
    }
    await carregar(Number(anoSelect.value));
    anoSelect.addEventListener('change', ()=> carregar(Number(anoSelect.value)));
  })();
})();
</script>
</body>
</html>
