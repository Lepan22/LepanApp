<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fluxo Financeiro</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  .main-content { padding:16px 20px; }

  .page-header h1 { margin:6px 0 6px; }
  .page-header p  { margin:0 0 12px; color:#666; font-size:13px; }

  .diag { margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; display:none; }
  .diag.warn { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
  .diag.err  { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }

  .filters { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .badge   { background:#f6f6f6; border:1px solid #e5e5e5; padding:2px 6px; border-radius:6px; font-size:12px; }
  .legend  { font-size:11.5px; color:#666; display:flex; gap:10px; align-items:center; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:3px; vertical-align:middle; margin-right:4px; }
  .dot.past   { background:#f1f5f9; border:1px solid #e5e7eb; }
  .dot.today  { background:#fff3c4; border:1px solid #fde68a; }
  .dot.future { background:#ffffff; border:1px solid #e5e7eb; }

  .table-wrap { overflow-x:auto; border:1px solid #eee; border-radius:8px; }

  /* 1ª col 420 + 2ª col 160 + 12*120 = 2.000 → min 2.040 */
  table.fx { width:100%; border-collapse:collapse; table-layout:fixed; min-width:2040px; background:#fff; }
  .fx th, .fx td { border:1px solid #e6e6e6; padding:6px 8px; font-size:12.5px; }

  .fx thead th { background:#fff7ec; color:#000; font-weight:600; }

  /* Coluna “Centro/Categoria” fixa e larga */
  .fx th.ind, .fx td.ind {
    position:sticky; left:0; z-index:3;
    background:#fafafa;
    width:420px; min-width:420px; max-width:420px;
    text-align:left; white-space:nowrap;
  }

  /* 2ª coluna: “Consolidado (Ano)” fixa também */
  .fx th.year, .fx td.year {
    position:sticky; left:420px; z-index:2;
    background:#fafafa;
    width:160px; min-width:160px; max-width:160px;
  }

  /* Meses */
  .fx th:not(.ind):not(.year), .fx td:not(.ind):not(.year) { width:120px; }

  .num { text-align:right; }
  .pct { color:#475569; font-size:11.2px; display:block; }

  /* Destaques por grupo */
  .grp-receita              > td.ind { background:#ecfdf5; font-weight:700; }
  .grp-cmv                  > td.ind { background:#fff7ed; font-weight:700; }
  .grp-despesa-variavel     > td.ind { background:#fef9c3; font-weight:700; }
  .grp-despesa-fixa         > td.ind { background:#fde2e2; font-weight:700; }
  .grp-investimento         > td.ind { background:#e0f2fe; font-weight:700; }
  .grp-retirada             > td.ind { background:#e9d5ff; font-weight:700; }
  .grp-outros               > td.ind { background:#f1f5f9; font-weight:700; }

  .totais-row > td.ind { background:#e5e7eb; font-weight:800; }

  /* Passado/Hoje/Futuro nas células de meses */
  .past   { background:#fbfbfb; }
  .today  { background:#fffbe6; }
  .future { background:#ffffff; }

  .toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
  .caret  { font-size:12px; color:#555; width:14px; text-align:center; }

  tr.cat-row.hidden { display:none; }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Fluxo Financeiro</h1>
      <p>Centros e categorias <strong>exatamente como no cadastro</strong>, com consolidado anual fixo e <strong>percentuais no ano e no mês</strong> (sempre sobre a Receita).</p>
      <div id="diag" class="diag warn"></div>
    </div>

    <section class="filters">
      <label>Ano Fiscal:
        <select id="anoSelect"></select>
      </label>
      <span class="badge">% = valor ÷ <strong>Receita</strong> (do ano/ do mês) × 100</span>
      <span class="legend">
        <span><span class="dot past"></span>Passado</span>
        <span><span class="dot today"></span>Hoje</span>
        <span><span class="dot future"></span>Futuro</span>
      </span>
    </section>

    <div class="table-wrap">
      <table class="fx" id="tbl">
        <thead>
          <tr id="hdrMeses">
            <th class="ind">Centro/Categoria</th>
            <th class="year">Consolidado (Ano)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const diag = document.getElementById('diag');
  const showDiag = (msg, type="warn") => { diag.className = `diag ${type}`; diag.textContent = msg; diag.style.display = 'block'; };
  const clearDiag = () => { diag.style.display = 'none'; diag.textContent = ''; };

  // Firebase
  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch(e){ console.error(e); showDiag('Falha ao inicializar Firebase.', 'err'); }
  const db = firebase.apps.length ? firebase.database() : null;

  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date(); const mesAtual = hoje.getMonth()+1; const anoAtual = hoje.getFullYear();

  const anoSelect = document.getElementById('anoSelect');
  const hdrMeses  = document.getElementById('hdrMeses');
  const tbody     = document.getElementById('tbody');

  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const num = v => isNaN(Number(v)) ? 0 : Number(v);

  // Ordem pedida
  const ORDEM_CENTROS = ["Receita","CMV","Despesa Variável","Despesa Fixa","Investimento","Retirada"];
  const slug = s => String(s||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

  function paintCell(td, m, anoSel){
    const isTodayCol = (m===mesAtual && anoSel===anoAtual);
    td.classList.add(isTodayCol ? 'today' : ( (anoSel<anoAtual || (anoSel===anoAtual && m<mesAtual)) ? 'past' : 'future'));
  }

  function buildHeader(){
    hdrMeses.innerHTML = '<th class="ind">Centro/Categoria</th><th class="year">Consolidado (Ano)</th>';
    for (let m=1;m<=12;m++){
      const th = document.createElement('th'); th.textContent = mesesPt[m-1]; hdrMeses.appendChild(th);
    }
  }

  async function getCategorias(){
    const snap = await db.ref('financeiro/categorias').once('value');
    const v = snap.val() || {};
    const arr = Object.keys(v).map(id => ({
      id,
      nome: v[id]?.nome || '(sem nome)',
      centro: v[id]?.centroDeCusto || 'Outros'
    }));
    // ordena por ORDEM_CENTROS; centros não listados vão para o fim (ordem alfabética)
    arr.sort((a,b)=>{
      const ia = ORDEM_CENTROS.indexOf(a.centro), ib = ORDEM_CENTROS.indexOf(b.centro);
      if (ia!==-1 || ib!==-1){
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        if (ia!==ib) return ia-ib;
      }
      if (a.centro!==b.centro) return a.centro.localeCompare(b.centro);
      return a.nome.localeCompare(b.nome);
    });
    return arr;
  }

  async function getConsolidado(ano){
    const snap = await db.ref(`financeiro/consolidado/${ano}`).once('value');
    return snap.val() || {};
  }

  function buildRow(label, cls){
    const tr = document.createElement('tr'); tr.className = cls || '';
    const tdInd  = document.createElement('td'); tdInd.className = 'ind';  tdInd.textContent = label;
    const tdYear = document.createElement('td'); tdYear.className = 'year num'; tdYear.innerHTML = '—';
    tr.appendChild(tdInd); tr.appendChild(tdYear);
    for (let m=1;m<=12;m++){
      const td = document.createElement('td'); td.className='num'; td.innerHTML='—'; tr.appendChild(td);
    }
    return tr;
  }

  function buildGroupHeader(centro, startOpen=true){
    const key = slug(centro||'Outros');
    const tr = document.createElement('tr'); tr.className = `grp-${key}`;
    const tdInd = document.createElement('td'); tdInd.className='ind';
    tdInd.innerHTML = `<span class="toggle" data-grp="${key}" data-open="${startOpen? '1':'0'}">
      <span class="caret">${startOpen ? '▼' : '►'}</span> ${centro}
    </span>`;
    const tdYear = document.createElement('td'); tdYear.className='year num'; tdYear.innerHTML='—';
    tr.appendChild(tdInd); tr.appendChild(tdYear);
    for (let m=1;m<=12;m++){
      const td=document.createElement('td'); td.className='num'; tr.appendChild(td);
      paintCell(td, m, Number(anoSelect.value));
      td.innerHTML='—';
    }
    tr.dataset.grpkey = key;
    tr.dataset.rotulo = centro;
    return tr;
  }

  function attachToggle(){
    tbody.querySelectorAll('.toggle').forEach(tg=>{
      tg.addEventListener('click', ()=>{
        const grp = tg.dataset.grp;
        const open = tg.dataset.open==='1';
        tg.dataset.open = open ? '0':'1';
        tg.querySelector('.caret').textContent = open ? '►':'▼';
        tbody.querySelectorAll(`tr.cat-row[data-grp="${grp}"]`).forEach(r=> r.classList.toggle('hidden', open));
      });
    });
  }

  function setCellValueWithPct(td, valor, basePct){
    const hasVal = Math.abs(valor) > 0.0000001;
    const pct = (basePct>0) ? (valor/basePct*100) : null;
    if (!hasVal && pct===null){ td.innerHTML = '—'; return; }
    const vStr = fmt(valor);
    const pStr = (pct===null) ? '—' : `${pct.toFixed(1)}%`;
    td.innerHTML = `${vStr}<span class="pct">${pStr}</span>`;
  }

  async function carregar(anoSel){
    clearDiag();
    buildHeader();
    tbody.innerHTML = '';

    const categorias = await getCategorias();
    const dados = await getConsolidado(anoSel);

    // Lista de centros, na ordem
    const centrosSet = new Map();
    ORDEM_CENTROS.forEach(c=>centrosSet.set(c,true));
    categorias.forEach(c=>{ if(!centrosSet.has(c.centro)) centrosSet.set(c.centro,true); });
    const centros = Array.from(centrosSet.keys());

    // Headers de grupo
    const headers = {}; // centro -> <tr>
    centros.forEach(c=>{
      const tr = buildGroupHeader(c, true);
      headers[c] = tr;
      tbody.appendChild(tr);
    });

    // Linhas de categorias
    const linhasCat = {}; // id -> {tr, centro}
    categorias.forEach(cat=>{
      const tr = buildRow(cat.nome, 'cat-row'); 
      tr.dataset.grp = slug(cat.centro);
      tbody.appendChild(tr);
      linhasCat[cat.id] = { tr, centro: cat.centro };
      tbody.insertBefore(tr, headers[cat.centro].nextSibling);
    });

    // Acumular valores por mês para grupo e categoria
    const initArr = ()=> Array.from({length:12}, ()=>0);
    const grpSums = {}; // centro -> [12]
    const catSums = {}; // id -> [12]
    centros.forEach(c=> grpSums[c] = initArr() );

    Object.keys(dados).forEach(m=>{
      const i = Number(m)-1;
      const porCat = dados[m] || {};
      Object.keys(porCat).forEach(id=>{
        const v = num(porCat[id]?.valor);
        if (!catSums[id]) catSums[id] = initArr();
        catSums[id][i] += v;

        const centro = linhasCat[id]?.centro || 'Outros';
        if (!grpSums[centro]) grpSums[centro] = initArr();
        grpSums[centro][i] += v;
      });
    });

    // Receita mês a mês e do ano (base de %)
    const sum = arr => arr.reduce((a,b)=>a+num(b),0);
    const recArr = (grpSums["Receita"] || initArr());
    const recAno = sum(recArr);
    const recMes = m => num(recArr[m-1]);

    // Preencher headers de grupo (valor + % no ano e no mês)
    centros.forEach(c=>{
      const tr = headers[c];
      const arr = grpSums[c] || initArr();
      const anoVal = sum(arr);

      // Ano
      setCellValueWithPct(tr.children[1], anoVal, recAno);

      // Meses
      for (let m=1;m<=12;m++){
        const td = tr.children[m+1];
        paintCell(td, m, anoSel);
        setCellValueWithPct(td, arr[m-1], recMes(m));
      }
    });

    // Categorias
    categorias.forEach(cat=>{
      const tr = linhasCat[cat.id].tr;
      const arr = catSums[cat.id] || initArr();
      const anoVal = sum(arr);

      setCellValueWithPct(tr.children[1], anoVal, recAno);

      for (let m=1;m<=12;m++){
        const td = tr.children[m+1];
        paintCell(td, m, anoSel);
        setCellValueWithPct(td, arr[m-1], recMes(m));
      }
    });

    // Resultado final
    const trRes = buildRow('Resultado', 'totais-row');
    tbody.appendChild(trRes);

    const getGrp = nome => grpSums[nome] || initArr();
    const resArr = initArr();
    const cmvArr   = getGrp('CMV');
    const dvArr    = getGrp('Despesa Variável');
    const dfArr    = getGrp('Despesa Fixa');
    const invArr   = getGrp('Investimento');
    const retArr   = getGrp('Retirada');

    for (let m=1;m<=12;m++){
      resArr[m-1] = (recArr[m-1] - cmvArr[m-1] - dvArr[m-1] - dfArr[m-1] - invArr[m-1] - retArr[m-1]);
      const td = trRes.children[m+1];
      paintCell(td, m, anoSel);
      setCellValueWithPct(td, resArr[m-1], recMes(m));
    }
    const resAno = sum(resArr);
    setCellValueWithPct(trRes.children[1], resAno, recAno);

    attachToggle();
  }

  // Init
  (async function init(){
    // anos
    for(let y=anoAtual-2; y<=anoAtual+1; y++){
      const opt=document.createElement('option'); opt.value=y; opt.textContent=y;
      if(y===anoAtual) opt.selected=true; anoSelect.appendChild(opt);
    }
    // meses no header
    for (let m=1;m<=12;m++){
      const th=document.createElement('th'); th.textContent=mesesPt[m-1]; hdrMeses.appendChild(th);
    }
    await carregar(Number(anoSelect.value));
    anoSelect.addEventListener('change', ()=> carregar(Number(anoSelect.value)));
  })();
})();
</script>
</body>
</html>
