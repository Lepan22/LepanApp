<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Importação Financeira (Consolidado por Categoria)</title>

  <!-- Estilos padrão do sistema -->
  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>

  <style>
    /* Layout simples, foco em importação */
    .page {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
      background: #fff;
    }
    .content { padding: 16px 20px; }

    .page-header h1 { margin: 6px 0 6px; }
    .page-header p { margin: 0 0 12px; color: #666; font-size: 13px; }

    .filters {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .badge { background:#f6f6f6; border:1px solid #e5e5e5; padding:2px 6px; border-radius:6px; font-size:12px; }

    .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
    table.fin { width: 100%; border-collapse: collapse; min-width: 1200px; table-layout: fixed; background: #fff; }
    .fin th, .fin td { border: 1px solid #e6e6e6; padding: 6px 8px; font-size: 13px; }
    .fin thead th { background: #fff7ec; }

    /* Primeira coluna fixa para facilitar leitura na rolagem */
    .fin th.cat, .fin td.cat {
      position: sticky; left: 0; z-index: 2; background: #fafafa; min-width: 260px; text-align: left;
    }

    /* Segunda linha do thead (controles de import) */
    .controls { font-size: 12px; }
    .controls input[type="file"] { width: 100%; }
    .controls .btn { width: 100%; margin-top: 4px; }

    .btn {
      cursor: pointer; border: 1px solid #ddd; background:#fff;
      padding: 6px 10px; border-radius: 8px; font-size: 13px;
    }
    .btn.primary { background: #ff7f2a; color: white; border-color: #ff7f2a; }
    .status { font-size: 12px; margin-top: 4px; min-height: 16px; }
    .ok { color: #1a7f37; }
    .err { color: #b42318; }
    .muted { color:#777; }

    .num { text-align: right; }

    /* Cabeçalho da coluna de meses mais estreito em telas menores */
    @media (max-width: 1100px){
      .fin th, .fin td { padding: 5px 6px; font-size: 12px; }
      .fin th.cat, .fin td.cat { min-width: 220px; }
    }
  </style>

  <!-- Firebase v9 (modular) -->
  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>
</head>
<body>
<div class="page">
  <aside id="menuLateral" class="sidebar"></aside>

  <main class="content">
    <div class="page-header">
      <h1>Importar Consolidado por Categoria</h1>
      <p>Liste e importe os valores mensais por <strong>categoria fixa</strong>. Se houver categoria desconhecida no CSV, a importação é cancelada e um erro é exibido.</p>
    </div>

    <section class="filters">
      <label>Ano Fiscal:
        <select id="anoSelect"></select>
      </label>
      <span class="badge">CSV: <code>categoria;valor</code> ou <code>categoria,valor</code> · decimais com vírgula ou ponto</span>
    </section>

    <div class="table-wrap">
      <table class="fin" id="tabela">
        <thead>
          <tr id="hdrMeses">
            <th class="cat">Categoria (ordem do fluxo)</th>
            <!-- Meses inseridos via JS -->
          </tr>
          <tr id="hdrImport">
            <th class="cat">Importar por mês</th>
            <!-- Controles de import inseridos via JS -->
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- Linhas por categoria inseridas via JS -->
        </tbody>
      </table>
    </div>
  </main>
</div>

<script type="module">
  import { db } from './assets/firebase-config.js';
  import {
    ref, get, child, update
  } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

  // ==== CATEGORIAS FIXAS (conforme backup) EM ORDEM DE FLUXO ====
  // 1) Receita (Entrada)
  // 2) CMV/Operacional (Saídas): Compras, Equipe, Logística, Insumos
  const CATEGORIAS = [
    { id: "-ORwxJ5ghaRNe8hCg99T", nome: "Venda em Evento",       tipo: "Entrada", centroDeCusto: "Receita" },
    { id: "-ORwxayboKaO0dasMjno", nome: "Compras",              tipo: "Saída",   centroDeCusto: "CMV" },
    { id: "-ORwxeXiv2Cq62g2T_ie", nome: "Equipe Evento",        tipo: "Saída",   centroDeCusto: "CMV" },
    { id: "-ORwxhVTCxwYjiaYy3E4", nome: "Logistica Operacional",tipo: "Saída",   centroDeCusto: "CMV" },
    { id: "-ORwyBpPwR-lOzYF139t", nome: "Insumos",              tipo: "Saída",   centroDeCusto: "CMV" },
  ];
  const NOME_TO_CAT = Object.fromEntries(CATEGORIAS.map(c => [c.nome.toLowerCase(), c]));

  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const anoSelect = document.getElementById('anoSelect');
  const hdrMeses  = document.getElementById('hdrMeses');
  const hdrImport = document.getElementById('hdrImport');
  const tbody     = document.getElementById('tbody');

  // ====== Helpers ======
  function fmt(n){
    const v = Number(n||0);
    return v.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function parseNumber(txt) {
    // aceita "1.234,56" ou "1234.56" ou "1234"
    if (txt == null) return 0;
    let s = String(txt).trim();
    // se tem vírgula como decimal, remove pontos de milhar
    if (s.includes(',')) s = s.replace(/\./g,'').replace(',','.');
    return Number(s) || 0;
  }
  function parseCSV(text){
    // aceita ; ou , como separador, exige cabecalho categoria/valor (case-insensitive)
    const linhas = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if (!linhas.length) return {rows:[], err:"CSV vazio."};
    const head = linhas[0].split(/[;,]/).map(h => h.trim().toLowerCase());
    const iCat = head.indexOf('categoria');
    const iVal = head.indexOf('valor');
    if (iCat === -1 || iVal === -1) return {rows:[], err:"Cabeçalho inválido. Use 'categoria;valor'."};

    const rows = [];
    for (let i=1;i<linhas.length;i++){
      const cols = linhas[i].split(/[;,]/);
      const cat  = (cols[iCat]||"").trim();
      const val  = parseNumber(cols[iVal]);
      if (cat) rows.push({ categoria: cat, valor: val });
    }
    return {rows, err:null};
  }

  function anoAtual(){ return new Date().getFullYear(); }

  // ====== UI ======
  function buildHeaders(){
    hdrMeses.innerHTML = '<th class="cat">Categoria (ordem do fluxo)</th>';
    hdrImport.innerHTML = '<th class="cat">Importar por mês</th>';

    for (let m=1;m<=12;m++){
      const thM = document.createElement('th');
      thM.textContent = mesesPt[m-1];
      hdrMeses.appendChild(thM);

      const thI = document.createElement('th');
      thI.className = 'controls';
      thI.innerHTML = `
        <input type="file" accept=".csv" id="file_${m}">
        <button class="btn primary" data-mes="${m}">Importar</button>
        <div class="status" id="st_${m}"></div>
      `;
      thI.querySelector('button').addEventListener('click', () => onImportClick(m));
      hdrImport.appendChild(thI);
    }
  }

  function buildBody(){
    tbody.innerHTML = '';
    CATEGORIAS.forEach(cat => {
      const tr = document.createElement('tr');
      const tdCat = document.createElement('td');
      tdCat.className = 'cat';
      tdCat.innerHTML = `<strong>${cat.nome}</strong><br><span class="muted">${cat.tipo} · ${cat.centroDeCusto} · <small>${cat.id}</small></span>`;
      tr.appendChild(tdCat);

      for (let m=1;m<=12;m++){
        const td = document.createElement('td');
        td.className = 'num';
        td.id = `val_${cat.id}_${m}`;
        td.textContent = '—';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  }

  function fillYearOptions(){
    const a = anoAtual();
    for (let y=a-2; y<=a+1; y++){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if (y === a) opt.selected = true;
      anoSelect.appendChild(opt);
    }
  }

  // ====== DB Load/Save ======
  async function loadYearData(year){
    // Lê financeiro/consolidado/{ano}/{mes}/{catId}/valor
    const snap = await get(child(ref(db), `financeiro/consolidado/${year}`));
    const dados = snap.val() || {};
    // limpar tela
    CATEGORIAS.forEach(c=>{
      for (let m=1;m<=12;m++){
        const td = document.getElementById(`val_${c.id}_${m}`);
        if (td) td.textContent = '—';
      }
    });
    // preencher
    Object.keys(dados).forEach(mes=>{
      const porCat = dados[mes] || {};
      Object.keys(porCat).forEach(catId=>{
        const td = document.getElementById(`val_${catId}_${mes}`);
        if (td){
          const v = Number((porCat[catId] && porCat[catId].valor) || 0);
          td.textContent = fmt(v);
        }
      });
    });
  }

  async function onImportClick(mes){
    const year = Number(anoSelect.value);
    const file = document.getElementById(`file_${mes}`).files[0];
    const st = document.getElementById(`st_${mes}`);
    st.textContent = '';

    if (!file){
      st.innerHTML = '<span class="err">Selecione um CSV.</span>';
      return;
    }

    // Ler arquivo
    const text = await file.text();
    const {rows, err} = parseCSV(text);
    if (err){
      st.innerHTML = `<span class="err">${err}</span>`;
      return;
    }
    if (!rows.length){
      st.innerHTML = '<span class="err">CSV sem linhas válidas.</span>';
      return;
    }

    // Validar categorias
    const desconhecidas = [];
    const normalizadas = rows.map(r=>{
      const key = r.categoria.trim().toLowerCase();
      const cat = NOME_TO_CAT[key];
      if (!cat) desconhecidas.push(r.categoria);
      return { cat, valor: r.valor, nomeOriginal: r.categoria };
    });

    if (desconhecidas.length){
      st.innerHTML = `<span class="err">Categorias não encontradas: ${desconhecidas.join(', ')}. Nada foi salvo.</span>`;
      return;
    }

    // Montar updates atômicos
    const updates = {};
    normalizadas.forEach(it=>{
      const base = `financeiro/consolidado/${year}/${mes}/${it.cat.id}`;
      updates[`${base}/valor`] = it.valor;
      updates[`${base}/nome`]  = it.cat.nome;
      updates[`${base}/tipo`]  = it.cat.tipo;
      updates[`${base}/centroDeCusto`] = it.cat.centroDeCusto;
    });

    try{
      await update(ref(db), updates);
      st.innerHTML = `<span class="ok">Importado com sucesso (${rows.length} linhas).</span>`;
      // Atualiza os valores na tela
      normalizadas.forEach(it=>{
        const td = document.getElementById(`val_${it.cat.id}_${mes}`);
        if (td) td.textContent = fmt(it.valor);
      });
    }catch(e){
      console.error(e);
      st.innerHTML = `<span class="err">Erro ao salvar.</span>`;
    }
  }

  // ====== Init ======
  (function init(){
    fillYearOptions();
    buildHeaders();
    buildBody();
    loadYearData(Number(anoSelect.value));

    anoSelect.addEventListener('change', () => {
      loadYearData(Number(anoSelect.value));
    });
  })();
</script>
</body>
</html>
