<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Importação Financeira (Consolidado por Categoria)</title>

  <!-- Estilos do projeto -->
  <link rel="stylesheet" href="assets/base.css"/>
  <link rel="stylesheet" href="assets/menu-styles.css"/>

  <style>
    .page { display:grid; grid-template-columns:260px 1fr; min-height:100vh; background:#fff; }
    .content { padding:16px 20px; }
    .page-header h1 { margin:6px 0 6px; }
    .page-header p { margin:0 0 12px; color:#666; font-size:13px; }

    .diag { margin:6px 0 10px; padding:8px 10px; border-radius:8px; font-size:13px; display:none; }
    .diag.warn { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; }
    .diag.err  { background:#fef2f2; border:1px solid #fecaca; color:#991b1b; }
    .diag.ok   { background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; }

    .filters { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .badge { background:#f6f6f6; border:1px solid #e5e5e5; padding:2px 6px; border-radius:6px; font-size:12px; }

    .table-wrap { overflow-x:auto; border:1px solid #eee; border-radius:8px; }
    table.fin { width:100%; border-collapse:collapse; min-width:1200px; table-layout:fixed; background:#fff; }
    .fin th, .fin td { border:1px solid #e6e6e6; padding:6px 8px; font-size:13px; }
    .fin thead th { background:#fff7ec; }

    /* primeira coluna fixa */
    .fin th.cat, .fin td.cat {
      position:sticky; left:0; z-index:2; background:#fafafa; min-width:260px; text-align:left;
    }

    .controls { font-size:12px; }
    .controls input[type="file"] { width:100%; }
    .controls .btn { width:100%; margin-top:4px; }

    .btn { cursor:pointer; border:1px solid #ddd; background:#fff; padding:6px 10px; border-radius:8px; font-size:13px; }
    .btn.primary { background:#ff7f2a; color:#fff; border-color:#ff7f2a; }
    .status { font-size:12px; margin-top:4px; min-height:16px; }
    .num { text-align:right; }
    .ok  { color:#1a7f37; }
    .err { color:#b42318; }

    @media (max-width:1100px){
      .fin th, .fin td { padding:5px 6px; font-size:12px; }
      .fin th.cat, .fin td.cat { min-width:220px; }
    }
  </style>

  <!-- Menu -->
  <script defer src="assets/menu.js"></script>

  <!-- Firebase v8 (sem módulos) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
<div class="page">
  <aside id="menu"></aside>

  <main class="content">
    <div class="page-header">
      <h1>Importar Consolidado por Categoria</h1>
      <p>Importe valores mensais por <strong>categoria</strong>. Se o CSV tiver categoria desconhecida, a importação é cancelada e o erro é exibido.</p>
      <div id="diag" class="diag warn"></div>
    </div>

    <section class="filters">
      <label>Ano Fiscal:
        <select id="anoSelect"></select>
      </label>
      <span class="badge">CSV: <code>categoria;valor</code> ou <code>categoria,valor</code> · aceita vírgula/ponto</span>
    </section>

    <div class="table-wrap">
      <table class="fin" id="tabela">
        <thead>
          <tr id="hdrMeses">
            <th class="cat">Categoria</th>
          </tr>
          <tr id="hdrImport">
            <th class="cat">Importar por mês</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<script>
(function(){
  // ===== Mensagens de diagnóstico =====
  const diag = document.getElementById('diag');
  const showDiag = (msg, type="warn") => { diag.className = `diag ${type}`; diag.textContent = msg; diag.style.display = 'block'; };
  const clearDiag = () => { diag.style.display = 'none'; diag.textContent = ''; };

  // ===== Firebase (inline, igual ao projeto) =====
  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch (e) {
    console.error(e);
    showDiag('Falha ao inicializar Firebase.', 'err');
  }
  const db = firebase.apps.length ? firebase.database() : null;

  // ===== Dom =====
  const mesesPt   = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const anoSelect = document.getElementById('anoSelect');
  const hdrMeses  = document.getElementById('hdrMeses');
  const hdrImport = document.getElementById('hdrImport');
  const tbody     = document.getElementById('tbody');

  // ===== Utils =====
  const fmt = n => Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  function parseNumber(txt){
    if (txt == null) return 0;
    let s = String(txt).trim();
    if (!s) return 0;
    if (s.includes(',')) s = s.replace(/\./g,'').replace(',','.');
    const v = Number(s);
    return isNaN(v) ? 0 : v;
  }
  // Lê CSV com fallback para Windows-1252 (Excel/Windows)
  async function readCSVText(file){
    const buf = await file.arrayBuffer();
    let text = new TextDecoder('utf-8', {fatal:false}).decode(buf);
    if (/\uFFFD/.test(text)) { // caractere substituto => provável CP-1252
      try { text = new TextDecoder('windows-1252', {fatal:false}).decode(buf); } catch(e) {}
    }
    return text;
  }
  function parseCSV(text){
    const linhas = String(text).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!linhas.length) return { rows:[], err:"CSV vazio." };
    const head = linhas[0].split(/[;,]/).map(h=>h.trim().toLowerCase());
    const iCat = head.indexOf('categoria');
    const iVal = head.indexOf('valor');
    if (iCat === -1 || iVal === -1) return { rows:[], err:"Cabeçalho inválido. Use 'categoria;valor'." };
    const rows = [];
    for (let i=1;i<linhas.length;i++){
      const cols = linhas[i].split(/[;,]/);
      const cat  = (cols[iCat]||"").trim();
      const val  = parseNumber(cols[iVal]);
      if (cat) rows.push({ categoria: cat, valor: val });
    }
    return { rows, err:null };
  }
  // Normaliza nome: sem acento, sem pontuação, case-insensitive, & -> " e "
  function normalizeName(s){
    return String(s || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // remove acentos
      .replace(/&/g,' e ')
      .replace(/[^\p{L}\p{N} ]+/gu,' ')               // só letras/números/espaço
      .replace(/\s+/g,' ')
      .trim();
  }
  const anoAtual = () => new Date().getFullYear();

  // Ordenação no fluxo: Receita → CMV → Outras; dentro do grupo, por nome
  function sortFluxo(cats){
    const pri = c => {
      const cc = (c.centroDeCusto||'').toLowerCase();
      if (cc==='receita') return 0;
      if (cc==='cmv')     return 1;
      return 2;
    };
    return cats.sort((a,b)=>{
      const pa = pri(a), pb = pri(b);
      if (pa!==pb) return pa-pb;
      return (a.nome||'').localeCompare(b.nome||'');
    });
  }

  // ===== UI =====
  function buildHeaders(){
    for (let m=1;m<=12;m++){
      const th = document.createElement('th');
      th.textContent = mesesPt[m-1];
      hdrMeses.appendChild(th);

      const thImp = document.createElement('th');
      thImp.className = 'controls';
      thImp.innerHTML = `
        <input type="file" accept=".csv" id="file_${m}">
        <button class="btn primary" data-mes="${m}">Importar</button>
        <div class="status" id="st_${m}"></div>
      `;
      thImp.querySelector('button').addEventListener('click', ()=> onImportClick(m));
      hdrImport.appendChild(thImp);
    }
  }

  function buildBody(categorias){
    tbody.innerHTML = '';
    if (!categorias.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.className = 'cat';
      td.colSpan = 13;
      td.textContent = 'Nenhuma categoria encontrada.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    categorias.forEach(cat => {
      const tr = document.createElement('tr');

      const tdCat = document.createElement('td');
      tdCat.className = 'cat';
      tdCat.textContent = cat.nome || '(sem nome)'; // mostra só o nome
      tr.appendChild(tdCat);

      for (let m=1;m<=12;m++){
        const td = document.createElement('td');
        td.className = 'num';
        td.id = `v_${cat.id}_${m}`;
        td.textContent = '—';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  }

  function fillYearOptions(){
    const a = anoAtual();
    for (let y=a-2; y<=a+1; y++){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if (y===a) opt.selected = true;
      anoSelect.appendChild(opt);
    }
  }

  // ===== Dados =====
  async function fetchCategorias(){
    if (!db){ showDiag('Firebase não inicializado.', 'err'); return []; }
    try{
      const snap = await db.ref('financeiro/categorias').once('value');
      const val = snap.val() || {};
      const cats = Object.keys(val).map(id => ({ id, ...val[id] }));
      clearDiag();
      return sortFluxo(cats);
    }catch(err){
      console.error(err);
      showDiag('Erro ao ler categorias (regras de leitura/conexão).', 'err');
      return [];
    }
  }

  async function loadYearData(year){
    if (!db) return;
    try{
      const snap = await db.ref(`financeiro/consolidado/${year}`).once('value');
      const dados = snap.val() || {};
      document.querySelectorAll('[id^="v_"]').forEach(td => td.textContent = '—');
      Object.keys(dados).forEach(mes=>{
        const porCat = dados[mes] || {};
        Object.keys(porCat).forEach(catId=>{
          const td = document.getElementById(`v_${catId}_${mes}`);
          if (td){
            const v = Number((porCat[catId] && porCat[catId].valor) || 0);
            td.textContent = fmt(v);
          }
        });
      });
      clearDiag();
    }catch(err){
      console.error(err);
      showDiag('Erro ao carregar valores do ano.', 'err');
    }
  }

  async function onImportClick(mes){
    const st = document.getElementById(`st_${mes}`);
    st.textContent = '';
    if (!db){ st.innerHTML = '<span class="err">Firebase não inicializado.</span>'; return; }

    const fileEl = document.getElementById(`file_${mes}`);
    const file = fileEl.files && fileEl.files[0];
    if (!file){ st.innerHTML = '<span class="err">Selecione um CSV.</span>'; return; }

    const year = Number(anoSelect.value);
    const text = await readCSVText(file);
    const { rows, err } = parseCSV(text);
    if (err){ st.innerHTML = `<span class="err">${err}</span>`; return; }
    if (!rows.length){ st.innerHTML = '<span class="err">CSV sem linhas válidas.</span>'; return; }

    // mapa nome->categoria (normalizado)
    let allCats = {};
    try{
      const snapCats = await db.ref('financeiro/categorias').once('value');
      allCats = snapCats.val() || {};
    }catch(e){
      console.error(e);
      st.innerHTML = '<span class="err">Erro ao ler categorias.</span>';
      return;
    }
    const nomeToCat = {};
    Object.keys(allCats).forEach(id=>{
      const nrm = normalizeName(allCats[id]?.nome);
      if (nrm) nomeToCat[nrm] = { id, ...allCats[id] };
    });

    const desconhecidas = [];
    const normalizadas = rows.map(r=>{
      const key = normalizeName(r.categoria);
      const cat = nomeToCat[key] || null;
      if (!cat) desconhecidas.push(r.categoria);
      return { cat, valor: r.valor, nomeOriginal: r.categoria };
    });

    if (desconhecidas.length){
      st.innerHTML = `<span class="err">Categorias não encontradas: ${desconhecidas.join(', ')}. Nada foi salvo.</span>`;
      return;
    }

    // Atualizações (atômicas)
    const updates = {};
    normalizadas.forEach(it=>{
      const base = `financeiro/consolidado/${year}/${mes}/${it.cat.id}`;
      updates[`${base}/valor`] = it.valor;
    });

    try{
      await db.ref().update(updates);
      st.innerHTML = `<span class="ok">Importado com sucesso (${rows.length} linhas).</span>`;
      // Atualiza grade visível
      normalizadas.forEach(it=>{
        const td = document.getElementById(`v_${it.cat.id}_${mes}`);
        if (td) td.textContent = fmt(it.valor);
      });
    }catch(e){
      console.error(e);
      st.innerHTML = `<span class="err">Erro ao salvar.</span>`;
    }
  }

  // ===== init =====
  (async function init(){
    fillYearOptions();
    buildHeaders();
    const categorias = await fetchCategorias();
    buildBody(categorias);
    await loadYearData(Number(anoSelect.value));
    anoSelect.addEventListener('change', ()=> loadYearData(Number(anoSelect.value)));
  })();
})();
</script>
</body>
</html>
