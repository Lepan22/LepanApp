<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planejamento de Eventos da Semana</title>

  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="assets/base.css" />

  <style>
    body { font-size: 14px; margin-top: 10px; }
    input, select, textarea, button {
      padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
    }
    button { background-color: #198754; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #146c43; }

    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th { background-color: #ff7f00; color: white; padding: 6px; position: sticky; top: 0; z-index: 1; }
    td { border: 1px solid #ddd; padding: 4px; vertical-align: top; }
    tr:nth-child(even) td { background: #fafafa; }

    .equipe-col { width: 260px; }
    .equipe-alocada-list { display: flex; flex-wrap: wrap; gap: 6px; }

    /* CHIP no evento */
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; padding: 4px 8px;
    }
    .chip[draggable="true"] { cursor: grab; }
    .chip strong { font-weight: 600; }
    .chip input[type="number"] { width: 80px; padding: 2px 6px; font-size: 12px; height: 26px; text-align: right; }
    .chip .remove {
      background: #ef4444; color: #fff; border: none; border-radius: 9999px;
      width: 20px; height: 20px; line-height: 20px; text-align: center; cursor: pointer;
    }

    /* POOL por dia */
    .pool-wrap { margin: 8px 0 10px; }
    .pool-title { font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .pool { display: flex; gap: 8px; flex-wrap: wrap; padding: 6px; border: 1px dashed #cbd5e1; border-radius: 10px; background: #fff; }
    .pool .pool-chip {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 9999px;
      border: 1px solid #cbd5e1; background: #ffffff; box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .pool .pool-chip[draggable="true"] { cursor: grab; }
    .pool .ocupado { font-size: 11px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 2px 6px; border-radius: 9999px; }

    .date-header { margin-top: 16px; margin-bottom: 6px; font-weight: 700; font-size: 15px; color: #111; }

    textarea.observacao { width: 100%; min-height: 60px; resize: vertical; }

    /* Dropzones */
    .dropzone { min-height: 48px; border: 2px dashed transparent; border-radius: 10px; padding: 4px; }
    .dropzone.over { border-color: #198754; background: #f0fff4; }
    .pool.dropzone { border-color: #cbd5e1; }
    .pool.dropzone.over { border-color: #2563eb; background: #eef2ff; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="assets/menu.js" defer></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <h2>Planejamento de Eventos da Semana</h2>
      <div id="eventos-container"><p>Carregando eventos...</p></div>
    </main>
  </div>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Estado =====
    let allEquipe = {};
    let allLogistica = {};
    let allEquipamentos = {};
    let allEventos = [];

    // ===== Util =====
    function getWeekRange() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday);
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { start: monday, end: sunday };
    }
    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
      return new Intl.DateTimeFormat('pt-BR', options).format(date);
    }
    function getEquipeDoEvento(evento) {
      if (evento && Array.isArray(evento.equipe)) return evento.equipe;
      if (evento && Array.isArray(evento.equipeAlocada)) return evento.equipeAlocada;
      return [];
    }
    function getLogisticaDoEvento(evento) {
      return Array.isArray(evento.logistica) ? evento.logistica : [];
    }
    function getEquipamentosDoEvento(evento) {
      return Array.isArray(evento.equipamentos) ? evento.equipamentos : [];
    }

    async function fetchEquipe() { const s = await db.ref('equipe').once('value'); allEquipe = s.val() || {}; }
    async function fetchLogistica() { const s = await db.ref('logistica').once('value'); allLogistica = s.val() || {}; }
    async function fetchEquipamentos() { const s = await db.ref('equipamentos').once('value'); allEquipamentos = s.val() || {}; }

    async function fetchEventos() {
      try {
        await Promise.all([fetchEquipe(), fetchLogistica(), fetchEquipamentos()]);
        const snapshot = await db.ref('eventos').once('value');
        const eventosData = snapshot.val() || {};
        const { start, end } = getWeekRange();

        allEventos = Object.keys(eventosData)
          .map(key => ({ id: key, ...eventosData[key] }))
          .filter(evento => {
            if (!evento.data) return false;
            const eventoDate = new Date(evento.data + 'T00:00:00');
            return eventoDate >= start && eventoDate <= end;
          })
          .sort((a, b) => new Date(a.data) - new Date(b.data));

        renderEventos();
      } catch (err) {
        console.error('Erro ao buscar eventos:', err);
        document.getElementById('eventos-container').innerHTML = '<p>Erro ao carregar os eventos.</p>';
      }
    }

    // ===== DnD helpers =====
    function setDnD(el, { onDrop }) {
      el.addEventListener('dragover', ev => { ev.preventDefault(); el.classList.add('over'); });
      el.addEventListener('dragleave', () => el.classList.remove('over'));
      el.addEventListener('drop', ev => {
        ev.preventDefault();
        el.classList.remove('over');
        try {
          const data = JSON.parse(ev.dataTransfer.getData('text/plain'));
          onDrop && onDrop(data);
        } catch (_) {}
      });
    }
    function makeDraggable(el, payload) {
      el.setAttribute('draggable', 'true');
      el.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', JSON.stringify(payload));
      });
    }

    function findEvento(id) { return allEventos.find(e => e.id === id); }

    function membroOcupadoNoDia(membroId, eventosDoDia) {
      for (const e of eventosDoDia) {
        const equipe = getEquipeDoEvento(e);
        const hit = equipe.find(m => m.membroId === membroId);
        if (hit) return { eventId: e.id, valor: hit.valor };
      }
      return null;
    }

    async function addMembroAoEvento(eventoId, membroId, valor) {
      const ev = findEvento(eventoId);
      const equipe = [...getEquipeDoEvento(ev)];
      if (equipe.some(m => m.membroId === membroId)) return; // já está
      const v = (valor != null ? valor : (allEquipe[membroId]?.valorDiaria || 0));
      equipe.push({ membroId, valor: v });
      await db.ref(`eventos/${eventoId}/equipe`).set(equipe);
    }
    async function removerMembroDoEvento(eventoId, membroId) {
      const ev = findEvento(eventoId);
      const equipe = getEquipeDoEvento(ev).filter(m => m.membroId !== membroId);
      await db.ref(`eventos/${eventoId}/equipe`).set(equipe);
    }
    async function moverMembro(antigoEventoId, novoEventoId, membroId, valor) {
      if (antigoEventoId) await removerMembroDoEvento(antigoEventoId, membroId);
      await addMembroAoEvento(novoEventoId, membroId, valor);
    }

    // ===== Render =====
    function renderEventos() {
      const container = document.getElementById('eventos-container');
      container.innerHTML = '';

      if (allEventos.length === 0) {
        container.innerHTML = '<p>Nenhum evento encontrado para a semana atual.</p>';
        return;
      }

      const eventosAgrupados = allEventos.reduce((acc, evento) => {
        (acc[evento.data] ||= []).push(evento);
        return acc;
      }, {});

      for (const data in eventosAgrupados) {
        const eventosDoDia = eventosAgrupados[data];

        // Cabeçalho da data
        const header = document.createElement('div');
        header.className = 'date-header';
        header.textContent = formatDate(data);
        container.appendChild(header);

        // ===== POOL por dia =====
        const poolWrap = document.createElement('div');
        poolWrap.className = 'pool-wrap';

        const title = document.createElement('div');
        title.className = 'pool-title';
        title.textContent = 'Pool de Equipe — arraste para o evento';
        poolWrap.appendChild(title);

        const pool = document.createElement('div');
        pool.className = 'pool dropzone';
        setDnD(pool, {
          // soltar no pool remove do evento (desalocar)
          onDrop: async (payload) => {
            if (payload.type === 'from-event') {
              await removerMembroDoEvento(payload.eventId, payload.membroId);
              fetchEventos();
            }
          }
        });

        // monta chips do pool
        const todosIds = Object.keys(allEquipe).sort((a,b) =>
          (allEquipe[a].apelido || '').localeCompare(allEquipe[b].apelido || '')
        );
        todosIds.forEach(id => {
          const chip = document.createElement('div');
          chip.className = 'pool-chip';
          const nome = allEquipe[id].apelido || allEquipe[id].nomeCompleto || 'Sem nome';
          chip.textContent = nome;

          const ocupado = membroOcupadoNoDia(id, eventosDoDia);
          if (ocupado) {
            const tag = document.createElement('span');
            tag.className = 'ocupado';
            const ev = findEvento(ocupado.eventId);
            tag.textContent = 'em: ' + (ev?.nomeEvento || 'evento');
            chip.appendChild(tag);
          }

          makeDraggable(chip, { type: 'from-pool', membroId: id, data });
          pool.appendChild(chip);
        });

        poolWrap.appendChild(pool);
        container.appendChild(poolWrap);

        // ===== Tabela do dia =====
        const table = document.createElement('table');
        table.innerHTML = `<thead><tr>
            <th>Evento</th>
            <th class="equipe-col">Equipe Selecionada (arraste aqui)</th>
            <th class="equipe-col">Logística Alocada</th>
            <th class="equipe-col">Editar Logística</th>
            <th class="equipe-col">Equipamento Alocado</th>
            <th class="equipe-col">Equipamento</th>
            <th class="equipe-col">OBS</th>
          </tr></thead>`;
        const tbody = document.createElement('tbody');

        // Para bloqueio de equipamento por dia
        const equipamentosUsadosNoDia = new Set();
        eventosDoDia.forEach(e => (e.equipamentos||[]).forEach(eq => equipamentosUsadosNoDia.add(eq.equipamentoId)));

        eventosDoDia.forEach(evento => {
          const row = document.createElement('tr');
          row.id = `row-${evento.id}`;

          // Nome do evento
          const nomeTd = document.createElement('td');
          nomeTd.textContent = evento.nomeEvento || 'Sem nome';
          row.appendChild(nomeTd);

          // ===== Equipe Selecionada (dropzone) =====
          const equipeTd = document.createElement('td');
          equipeTd.className = 'equipe-col';
          const equipeList = document.createElement('div');
          equipeList.className = 'equipe-alocada-list dropzone';
          setDnD(equipeList, {
            onDrop: async (payload) => {
              if (payload.type === 'from-pool') {
                // se estiver em outro evento do mesmo dia, move
                const ocupado = membroOcupadoNoDia(payload.membroId, eventosDoDia);
                const valor = ocupado?.valor ?? (allEquipe[payload.membroId]?.valorDiaria || 0);
                await moverMembro(ocupado?.eventId || null, evento.id, payload.membroId, valor);
                fetchEventos();
              } else if (payload.type === 'from-event' && payload.eventId !== evento.id) {
                // mover entre eventos
                const valor = payload.valor ?? (allEquipe[payload.membroId]?.valorDiaria || 0);
                await moverMembro(payload.eventId, evento.id, payload.membroId, valor);
                fetchEventos();
              }
            }
          });

          const equipeDoEvento = getEquipeDoEvento(evento);
          if (equipeDoEvento.length > 0) {
            equipeDoEvento.forEach(membro => {
              if (!membro?.membroId || !allEquipe[membro.membroId]) return;
              const chip = document.createElement('div');
              chip.className = 'chip';
              const strong = document.createElement('strong');
              strong.textContent = allEquipe[membro.membroId].apelido || allEquipe[membro.membroId].nomeCompleto || 'Sem nome';

              const input = document.createElement('input');
              input.type = 'number';
              input.step = '0.01';
              input.dataset.membroId = membro.membroId;
              const defaultValor = allEquipe[membro.membroId].valorDiaria || 0;
              input.value = (membro.valor != null ? parseFloat(membro.valor) : defaultValor).toFixed(2);
              input.addEventListener('change', async () => {
                // atualiza somente o valor deste membro
                const ev = findEvento(evento.id);
                const nova = getEquipeDoEvento(ev).map(x => x.membroId === membro.membroId
                  ? { ...x, valor: parseFloat(input.value) || 0 }
                  : x
                );
                await db.ref(`eventos/${evento.id}/equipe`).set(nova);
                fetchEventos();
              });

              const remover = document.createElement('button');
              remover.className = 'remove';
              remover.textContent = '×';
              remover.title = 'Remover';
              remover.addEventListener('click', async () => {
                await removerMembroDoEvento(evento.id, membro.membroId);
                fetchEventos();
              });

              // permitir arrastar este chip para outro evento ou de volta ao pool
              makeDraggable(chip, { type: 'from-event', eventId: evento.id, membroId: membro.membroId, valor: parseFloat(input.value) || 0 });

              chip.appendChild(strong);
              chip.appendChild(input);
              chip.appendChild(remover);
              equipeList.appendChild(chip);
            });
          } else {
            const vazio = document.createElement('div');
            vazio.textContent = 'Arraste nomes do pool para cá';
            equipeList.appendChild(vazio);
          }
          equipeTd.appendChild(equipeList);
          row.appendChild(equipeTd);

          // ===== Logística Alocada =====
          const logisticaTd = document.createElement('td');
          logisticaTd.className = 'equipe-col';
          const logisticaList = document.createElement('ul');
          logisticaList.className = 'equipe-alocada-list';
          const logisticaDoEvento = getLogisticaDoEvento(evento);
          if (logisticaDoEvento.length > 0) {
            logisticaDoEvento.forEach(prestador => {
              if (prestador?.prestadorId && allLogistica[prestador.prestadorId]) {
                const li = document.createElement('li');
                const label = document.createElement('label');
                label.textContent = allLogistica[prestador.prestadorId].nome;
                const input = document.createElement('input');
                input.type = 'number';
                input.dataset.prestadorId = prestador.prestadorId;
                input.placeholder = "R$";
                input.step = "0.01";
                input.value = prestador.valor ? parseFloat(prestador.valor).toFixed(2) : '';
                input.addEventListener('change', () => updateLogistica(evento.id));
                li.appendChild(label);
                li.appendChild(input);
                logisticaList.appendChild(li);
              }
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'Nenhuma logística alocada';
            logisticaList.appendChild(li);
          }
          logisticaTd.appendChild(logisticaList);
          row.appendChild(logisticaTd);

          // ===== Editar Logística =====
          const logisticaSelectTd = document.createElement('td');
          logisticaSelectTd.className = 'equipe-col';
          const logisticaSelect = document.createElement('select');
          logisticaSelect.multiple = true;
          for (const id in allLogistica) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = allLogistica[id].nome;
            if (logisticaDoEvento.find(p => p.prestadorId === id)) option.selected = true;
            logisticaSelect.appendChild(option);
          }
          logisticaSelect.addEventListener('change', () => updateLogistica(evento.id));
          logisticaSelectTd.appendChild(logisticaSelect);
          row.appendChild(logisticaSelectTd);

          // ===== Equipamento Alocado =====
          const equipamentoAlocadoTd = document.createElement('td');
          equipamentoAlocadoTd.className = 'equipe-col';
          const equipamentoList = document.createElement('ul');
          equipamentoList.className = 'equipe-alocada-list';
          const equipamentosDoEvento = getEquipamentosDoEvento(evento);
          if (equipamentosDoEvento.length > 0) {
            equipamentosDoEvento.forEach(eq => {
              if (eq?.equipamentoId && allEquipamentos[eq.equipamentoId]) {
                const li = document.createElement('li');
                li.textContent = allEquipamentos[eq.equipamentoId].nome;
                equipamentoList.appendChild(li);
              }
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'Nenhum equipamento alocado';
            equipamentoList.appendChild(li);
          }
          equipamentoAlocadoTd.appendChild(equipamentoList);
          row.appendChild(equipamentoAlocadoTd);

          // ===== Editar Equipamento =====
          const equipamentoTd = document.createElement('td');
          equipamentoTd.className = 'equipe-col';
          const equipamentoSelect = document.createElement('select');
          equipamentoSelect.multiple = true;
          const usadosNesteEvento = new Set(equipamentosDoEvento.map(e => e.equipamentoId));
          for (const id in allEquipamentos) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = allEquipamentos[id].nome;
            if (usadosNesteEvento.has(id)) option.selected = true;
            else if (equipamentosUsadosNoDia.has(id)) option.disabled = true;
            equipamentoSelect.appendChild(option);
          }
          equipamentoSelect.addEventListener('change', () => updateEquipamento(evento.id));
          equipamentoTd.appendChild(equipamentoSelect);
          row.appendChild(equipamentoTd);

          // ===== OBS =====
          const obsTd = document.createElement('td');
          obsTd.className = 'equipe-col';
          const obsTextarea = document.createElement('textarea');
          obsTextarea.className = 'observacao';
          obsTextarea.placeholder = 'OBS';
          obsTextarea.value = evento.observacao || '';
          obsTextarea.addEventListener('change', () => db.ref(`eventos/${evento.id}/observacao`).set(obsTextarea.value));
          obsTd.appendChild(obsTextarea);
          row.appendChild(obsTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      }
    }

    // ===== Updates (logística/equipamento – sem mudanças) =====
    async function updateLogistica(eventoId) {
      const row = document.getElementById(`row-${eventoId}`);
      if (!row) return;
      const select = row.querySelectorAll('select')[0];
      const options = Array.from(select.selectedOptions);
      const novaLogistica = options.map(opt => {
        const prestadorId = opt.value;
        const input = row.querySelector(`input[data-prestador-id="${prestadorId}"]`);
        let valor = input ? parseFloat(input.value) || 0 : 0;
        return { prestadorId, valor };
      });
      await db.ref(`eventos/${eventoId}/logistica`).set(novaLogistica);
      fetchEventos();
    }

    async function updateEquipamento(eventoId) {
      const row = document.getElementById(`row-${eventoId}`);
      if (!row) return;
      const selects = row.querySelectorAll('select');
      const equipamentoSelect = selects[1];
      const options = Array.from(equipamentoSelect.selectedOptions);
      const novosEquipam
