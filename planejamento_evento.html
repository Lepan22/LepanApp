<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planejamento de Eventos da Semana</title>

  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="assets/base.css" />

  <style>
    body { font-size: 14px; margin-top: 10px; }
    input, select, textarea, button {
      padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
    }
    button { background-color: #198754; color: #fff; font-weight: bold; cursor: pointer; transition: background-color .2s; }
    button:hover { background-color: #146c43; }

    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th { background-color: #ff7f00; color: #fff; padding: 6px; position: sticky; top: 0; z-index: 1; }
    td { border: 1px solid #ddd; padding: 6px; vertical-align: top; }
    tr:nth-child(even) td { background: #fafafa; }

    .equipe-col { width: 280px; }
    .list-col { width: 260px; }
    .obs-col { width: 220px; }

    .equipe-alocada-list, .logistica-alocada-list, .equip-alocada-list {
      display: flex; flex-wrap: wrap; gap: 6px; min-height: 44px;
    }

    /* Chips */
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; padding: 4px 8px;
    }
    .chip[draggable="true"] { cursor: grab; }
    .chip strong { font-weight: 600; }
    .chip input[type="number"] { width: 80px; padding: 2px 6px; font-size: 12px; height: 26px; text-align: right; }
    .chip .remove {
      background: #ef4444; color: #fff; border: none; border-radius: 9999px;
      width: 20px; height: 20px; line-height: 20px; text-align: center; cursor: pointer;
    }

    /* Pool */
    .pool-wrap { margin: 8px 0 12px; }
    .pool-title { font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .pool { display: flex; gap: 8px; flex-wrap: wrap; padding: 6px; border: 1px dashed #cbd5e1; border-radius: 10px; background: #fff; }
    .pool .pool-chip {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 9999px;
      border: 1px solid #cbd5e1; background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .pool .pool-chip[draggable="true"] { cursor: grab; }
    .pool .ocupado {
      font-size: 11px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 2px 6px; border-radius: 9999px;
    }

    .date-header { margin-top: 16px; margin-bottom: 6px; font-weight: 700; font-size: 15px; color: #111; }

    textarea.observacao { width: 100%; min-height: 60px; resize: vertical; }

    /* Dropzones: contorno sem cobrir conteúdo */
    .dropzone { border: 2px dashed transparent; border-radius: 10px; padding: 4px; }
    .dropzone.over { outline: 2px dashed #198754; outline-offset: -6px; background: transparent; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="assets/menu.js" defer></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <h2>Planejamento de Eventos da Semana</h2>
      <div id="eventos-container"><p>Carregando eventos...</p></div>
    </main>
  </div>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Estado =====
    let allEquipe = {};
    let allLogistica = {};
    let allEquipamentos = {};
    let allEventos = [];

    // ===== Util =====
    function getWeekRange() {
      const today = new Date();
      const dow = today.getDay();
      const diffToMonday = dow === 0 ? -6 : 1 - dow;
      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday);
      monday.setHours(0,0,0,0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23,59,59,999);
      return { start: monday, end: sunday };
    }
    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
      return new Intl.DateTimeFormat('pt-BR', options).format(date);
    }
    function getEquipeDoEvento(e) {
      if (e && Array.isArray(e.equipe)) return e.equipe;
      if (e && Array.isArray(e.equipeAlocada)) return e.equipeAlocada;
      return [];
    }
    function getLogisticaDoEvento(e) {
      return Array.isArray(e.logistica) ? e.logistica : [];
    }
    function getEquipamentosDoEvento(e) {
      return Array.isArray(e.equipamentos) ? e.equipamentos : [];
    }

    async function fetchEquipe() { const s = await db.ref('equipe').once('value'); allEquipe = s.val() || {}; }
    async function fetchLogistica() { const s = await db.ref('logistica').once('value'); allLogistica = s.val() || {}; }
    async function fetchEquipamentos() { const s = await db.ref('equipamentos').once('value'); allEquipamentos = s.val() || {}; }

    async function fetchEventos() {
      try {
        await Promise.all([fetchEquipe(), fetchLogistica(), fetchEquipamentos()]);
        const snapshot = await db.ref('eventos').once('value');
        const eventosData = snapshot.val() || {};
        const { start, end } = getWeekRange();

        allEventos = Object.keys(eventosData)
          .map(key => ({ id: key, ...eventosData[key] }))
          .filter(ev => {
            if (!ev.data) return false;
            const d = new Date(ev.data + 'T00:00:00');
            return d >= start && d <= end;
          })
          .sort((a,b) => new Date(a.data) - new Date(b.data));

        renderEventos();
      } catch (err) {
        console.error('Erro ao buscar eventos:', err);
        document.getElementById('eventos-container').innerHTML = '<p>Erro ao carregar os eventos.</p>';
      }
    }

    // ===== DnD helpers =====
    function setDnD(el, { onDrop }) {
      el.addEventListener('dragover', ev => { ev.preventDefault(); el.classList.add('over'); });
      el.addEventListener('dragleave', () => el.classList.remove('over'));
      el.addEventListener('drop', ev => {
        ev.preventDefault();
        el.classList.remove('over');
        try {
          const data = JSON.parse(ev.dataTransfer.getData('text/plain'));
          onDrop && onDrop(data);
        } catch (_) {}
      });
    }
    function makeDraggable(el, payload) {
      el.setAttribute('draggable', 'true');
      el.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', JSON.stringify(payload));
      });
    }

    function findEvento(id) { return allEventos.find(e => e.id === id); }

    // Ocupações (Equipe/Equipamento)
    function membroOcupadoNoDia(membroId, eventosDoDia) {
      for (const e of eventosDoDia) {
        const eq = getEquipeDoEvento(e);
        const hit = eq.find(m => m.membroId === membroId);
        if (hit) return { eventId: e.id, valor: hit.valor };
      }
      return null;
    }
    function equipamentoOcupadoNoDia(equipId, eventosDoDia) {
      for (const e of eventosDoDia) {
        const eqs = getEquipamentosDoEvento(e) || [];
        if (eqs.find(x => x.equipamentoId === equipId)) return { eventId: e.id };
      }
      return null;
    }

    // Equipe (move)
    async function addMembroAoEvento(eventoId, membroId, valor) {
      const ev = findEvento(eventoId);
      const equipe = [...getEquipeDoEvento(ev)];
      if (!equipe.some(m => m.membroId === membroId)) {
        const v = (valor != null ? valor : (allEquipe[membroId]?.valorDiaria || 0));
        equipe.push({ membroId, valor: v });
        await db.ref(`eventos/${eventoId}/equipe`).set(equipe);
      }
    }
    async function removerMembroDoEvento(eventoId, membroId) {
      const ev = findEvento(eventoId);
      const equipe = getEquipeDoEvento(ev).filter(m => m.membroId !== membroId);
      await db.ref(`eventos/${eventoId}/equipe`).set(equipe);
    }
    async function moverMembro(fromId, toId, membroId, valor) {
      if (fromId) await removerMembroDoEvento(fromId, membroId);
      await addMembroAoEvento(toId, membroId, valor);
    }

    // Logística (NÃO bloqueia – pode repetir em vários eventos)
    async function addPrestadorAoEvento(eventoId, prestadorId, valor) {
      const ev = findEvento(eventoId);
      const l = [...getLogisticaDoEvento(ev)];
      if (!l.some(p => p.prestadorId === prestadorId)) l.push({ prestadorId, valor: valor ?? 0 });
      await db.ref(`eventos/${eventoId}/logistica`).set(l);
    }
    async function removerPrestadorDoEvento(eventoId, prestadorId) {
      const ev = findEvento(eventoId);
      const l = getLogisticaDoEvento(ev).filter(p => p.prestadorId !== prestadorId);
      await db.ref(`eventos/${eventoId}/logistica`).set(l);
    }
    // mover (evento -> evento) vira CÓPIA (mantém no original)
    async function copiarPrestador(fromId, toId, prestadorId, valor) {
      await addPrestadorAoEvento(toId, prestadorId, valor);
    }

    // Equipamento (move e bloqueia no dia)
    async function addEquipAoEvento(eventoId, equipamentoId) {
      const ev = findEvento(eventoId);
      const eqs = [...getEquipamentosDoEvento(ev)];
      if (!eqs.some(e => e.equipamentoId === equipamentoId)) {
        eqs.push({ equipamentoId });
        await db.ref(`eventos/${eventoId}/equipamentos`).set(eqs);
      }
    }
    async function removerEquipDoEvento(eventoId, equipamentoId) {
      const ev = findEvento(eventoId);
      const eqs = getEquipamentosDoEvento(ev).filter(e => e.equipamentoId !== equipamentoId);
      await db.ref(`eventos/${eventoId}/equipamentos`).set(eqs);
    }
    async function moverEquip(fromId, toId, equipamentoId) {
      if (fromId) await removerEquipDoEvento(fromId, equipamentoId);
      await addEquipAoEvento(toId, equipamentoId);
    }

    // ===== Render =====
    function renderEventos() {
      const container = document.getElementById('eventos-container');
      container.innerHTML = '';

      if (allEventos.length === 0) {
        container.innerHTML = '<p>Nenhum evento encontrado para a semana atual.</p>';
        return;
      }

      const porDia = allEventos.reduce((acc, ev) => { (acc[ev.data] ||= []).push(ev); return acc; }, {});

      for (const data in porDia) {
        const eventosDoDia = porDia[data];

        // Cabeçalho da data
        const header = document.createElement('div');
        header.className = 'date-header';
        header.textContent = formatDate(data);
        container.appendChild(header);

        // ===== POOL Equipe =====
        const poolEquipeWrap = document.createElement('div');
        poolEquipeWrap.className = 'pool-wrap';
        poolEquipeWrap.innerHTML = `<div class="pool-title">Pool de Equipe — arraste para o evento</div>`;
        const poolEquipe = document.createElement('div');
        poolEquipe.className = 'pool dropzone';
        setDnD(poolEquipe, { onDrop: async (payload) => {
          if (payload.type === 'from-event-eq') {
            await removerMembroDoEvento(payload.eventId, payload.membroId);
            fetchEventos();
          }
        }});
        // conteúdo do pool equipe
        Object.keys(allEquipe).sort((a,b) =>
          (allEquipe[a].apelido || '').localeCompare(allEquipe[b].apelido || '')
        ).forEach(id => {
          const chip = document.createElement('div');
          chip.className = 'pool-chip';
          chip.textContent = allEquipe[id].apelido || allEquipe[id].nomeCompleto || 'Sem nome';
          const ocupado = membroOcupadoNoDia(id, eventosDoDia);
          if (ocupado) {
            const tag = document.createElement('span');
            tag.className = 'ocupado';
            const ev = findEvento(ocupado.eventId);
            tag.textContent = 'em: ' + (ev?.nomeEvento || 'evento');
            chip.appendChild(tag);
          }
          makeDraggable(chip, { type: 'from-pool-eq', membroId: id, data });
          poolEquipe.appendChild(chip);
        });
        poolEquipeWrap.appendChild(poolEquipe);
        container.appendChild(poolEquipeWrap);

        // ===== POOL Logística =====
        const poolLogWrap = document.createElement('div');
        poolLogWrap.className = 'pool-wrap';
        poolLogWrap.innerHTML = `<div class="pool-title">Pool de Logística — arraste para o evento</div>`;
        const poolLog = document.createElement('div');
        poolLog.className = 'pool dropzone';
        setDnD(poolLog, { onDrop: async (payload) => {
          if (payload.type === 'from-event-log') {
            await removerPrestadorDoEvento(payload.eventId, payload.prestadorId);
            fetchEventos();
          }
        }});
        Object.keys(allLogistica).sort((a,b)=>
          (allLogistica[a].nome||'').localeCompare(allLogistica[b].nome||'')
        ).forEach(id => {
          const chip = document.createElement('div');
          chip.className = 'pool-chip';
          chip.textContent = allLogistica[id].nome || 'Sem nome';
          makeDraggable(chip, { type: 'from-pool-log', prestadorId: id, data });
          poolLog.appendChild(chip);
        });
        poolLogWrap.appendChild(poolLog);
        container.appendChild(poolLogWrap);

        // ===== POOL Equipamentos =====
        const poolEqpWrap = document.createElement('div');
        poolEqpWrap.className = 'pool-wrap';
        poolEqpWrap.innerHTML = `<div class="pool-title">Pool de Equipamentos — arraste para o evento</div>`;
        const poolEqp = document.createElement('div');
        poolEqp.className = 'pool dropzone';
        setDnD(poolEqp, { onDrop: async (payload) => {
          if (payload.type === 'from-event-eqp') {
            await removerEquipDoEvento(payload.eventId, payload.equipamentoId);
            fetchEventos();
          }
        }});
        Object.keys(allEquipamentos).sort((a,b)=>
          (allEquipamentos[a].nome||'').localeCompare(allEquipamentos[b].nome||'')
        ).forEach(id => {
          const chip = document.createElement('div');
          chip.className = 'pool-chip';
          chip.textContent = allEquipamentos[id].nome || 'Equipamento';
          const ocupado = equipamentoOcupadoNoDia(id, eventosDoDia);
          if (ocupado) {
            const tag = document.createElement('span');
            tag.className = 'ocupado';
            const ev = findEvento(ocupado.eventId);
            tag.textContent = 'em: ' + (ev?.nomeEvento || 'evento');
            chip.appendChild(tag);
          }
          makeDraggable(chip, { type: 'from-pool-eqp', equipamentoId: id, data });
          poolEqp.appendChild(chip);
        });
        poolEqpWrap.appendChild(poolEqp);
        container.appendChild(poolEqpWrap);

        // ===== Tabela do dia =====
        const table = document.createElement('table');
        table.innerHTML = `<thead><tr>
            <th>Evento</th>
            <th class="equipe-col">Equipe Selecionada (arraste aqui)</th>
            <th class="list-col">Logística Alocada (arraste aqui)</th>
            <th class="list-col">Editar Logística (select)</th>
            <th class="list-col">Equipamento Alocado (arraste aqui)</th>
            <th class="list-col">Equipamento (select)</th>
            <th class="obs-col">OBS</th>
          </tr></thead>`;
        const tbody = document.createElement('tbody');

        const equipamentosUsadosNoDia = new Set();
        eventosDoDia.forEach(e => (e.equipamentos||[]).forEach(eq => equipamentosUsadosNoDia.add(eq.equipamentoId)));

        eventosDoDia.forEach(evento => {
          const row = document.createElement('tr');
          row.id = `row-${evento.id}`;

          // Nome do evento
          const nomeTd = document.createElement('td');
          nomeTd.textContent = evento.nomeEvento || 'Sem nome';
          row.appendChild(nomeTd);

          // ===== Equipe Selecionada (dropzone) =====
          const equipeTd = document.createElement('td'); equipeTd.className = 'equipe-col';
          const equipeList = document.createElement('div'); equipeList.className = 'equipe-alocada-list dropzone';
          setDnD(equipeList, {
            onDrop: async (payload) => {
              if (payload.type === 'from-pool-eq') {
                const ocupado = membroOcupadoNoDia(payload.membroId, eventosDoDia);
                const valor = ocupado?.valor ?? (allEquipe[payload.membroId]?.valorDiaria || 0);
                await moverMembro(ocupado?.eventId || null, evento.id, payload.membroId, valor);
                fetchEventos();
              } else if (payload.type === 'from-event-eq' && payload.eventId !== evento.id) {
                const valor = payload.valor ?? (allEquipe[payload.membroId]?.valorDiaria || 0);
                await moverMembro(payload.eventId, evento.id, payload.membroId, valor);
                fetchEventos();
              }
            }
          });

          const equipeDoEvento = getEquipeDoEvento(evento);
          if (equipeDoEvento.length > 0) {
            equipeDoEvento.forEach(membro => {
              if (!membro?.membroId || !allEquipe[membro.membroId]) return;
              const chip = document.createElement('div');
              chip.className = 'chip';
              const strong = document.createElement('strong');
              strong.textContent = allEquipe[membro.membroId].apelido || allEquipe[membro.membroId].nomeCompleto || 'Sem nome';

              const input = document.createElement('input');
              input.type = 'number';
              input.step = '0.01';
              input.dataset.membroId = membro.membroId;
              const defaultValor = allEquipe[membro.membroId].valorDiaria || 0;
              input.value = (membro.valor != null ? parseFloat(membro.valor) : defaultValor).toFixed(2);
              input.addEventListener('change', async () => {
                const ev = findEvento(evento.id);
                const nova = getEquipeDoEvento(ev).map(x => x.membroId === membro.membroId
                  ? { ...x, valor: parseFloat(input.value) || 0 }
                  : x
                );
                await db.ref(`eventos/${evento.id}/equipe`).set(nova);
                fetchEventos();
              });

              const remover = document.createElement('button');
              remover.className = 'remove';
              remover.textContent = '×';
              remover.title = 'Remover';
              remover.addEventListener('click', async () => {
                await removerMembroDoEvento(evento.id, membro.membroId);
                fetchEventos();
              });

              makeDraggable(chip, { type: 'from-event-eq', eventId: evento.id, membroId: membro.membroId, valor: parseFloat(input.value) || 0 });

              chip.appendChild(strong); chip.appendChild(input); chip.appendChild(remover);
              equipeList.appendChild(chip);
            });
          } else {
            const vazio = document.createElement('div');
            vazio.textContent = 'Arraste nomes do pool para cá';
            equipeList.appendChild(vazio);
          }
          equipeTd.appendChild(equipeList);
          row.appendChild(equipeTd);

          // ===== Logística Alocada (dropzone – CÓPIA) =====
          const logisticaTd = document.createElement('td'); logisticaTd.className = 'list-col';
          const logisticaList = document.createElement('div'); logisticaList.className = 'logistica-alocada-list dropzone';
          setDnD(logisticaList, {
            onDrop: async (payload) => {
              if (payload.type === 'from-pool-log') {
                await addPrestadorAoEvento(evento.id, payload.prestadorId, 0);
                fetchEventos();
              } else if (payload.type === 'from-event-log' && payload.eventId !== evento.id) {
                await copiarPrestador(payload.eventId, evento.id, payload.prestadorId, payload.valor ?? 0);
                fetchEventos();
              }
            }
          });

          const logisticaDoEvento = getLogisticaDoEvento(evento);
          if (logisticaDoEvento.length > 0) {
            logisticaDoEvento.forEach(prest => {
              if (!prest?.prestadorId || !allLogistica[prest.prestadorId]) return;
              const chip = document.createElement('div');
              chip.className = 'chip';
              const strong = document.createElement('strong');
              strong.textContent = allLogistica[prest.prestadorId].nome || 'Sem nome';

              const input = document.createElement('input');
              input.type = 'number'; input.step = '0.01';
              input.dataset.prestadorId = prest.prestadorId;
              input.value = prest.valor != null ? parseFloat(prest.valor).toFixed(2) : '0.00';
              input.addEventListener('change', async () => {
                const ev = findEvento(evento.id);
                const nova = getLogisticaDoEvento(ev).map(x => x.prestadorId === prest.prestadorId
                  ? { ...x, valor: parseFloat(input.value) || 0 }
                  : x
                );
                await db.ref(`eventos/${evento.id}/logistica`).set(nova);
                fetchEventos();
              });

              const remover = document.createElement('button');
              remover.className = 'remove'; remover.textContent = '×'; remover.title = 'Remover';
              remover.addEventListener('click', async () => {
                await removerPrestadorDoEvento(evento.id, prest.prestadorId);
                fetchEventos();
              });

              makeDraggable(chip, { type: 'from-event-log', eventId: evento.id, prestadorId: prest.prestadorId, valor: parseFloat(input.value) || 0 });

              chip.appendChild(strong); chip.appendChild(input); chip.appendChild(remover);
              logisticaList.appendChild(chip);
            });
          } else {
            const vazio = document.createElement('div');
            vazio.textContent = 'Arraste do pool de logística';
            logisticaList.appendChild(vazio);
          }
          logisticaTd.appendChild(logisticaList);
          row.appendChild(logisticaTd);

          // ===== Editar Logística (select múltiplo – continua) =====
          const logisticaSelectTd = document.createElement('td'); logisticaSelectTd.className = 'list-col';
          const logisticaSelect = document.createElement('select'); logisticaSelect.multiple = true;
          for (const id in allLogistica) {
            const option = document.createElement('option');
            option.value = id; option.textContent = allLogistica[id].nome;
            if (logisticaDoEvento.find(p => p.prestadorId === id)) option.selected = true;
            logisticaSelect.appendChild(option);
          }
          logisticaSelect.addEventListener('change', async () => {
            const options = Array.from(logisticaSelect.selectedOptions);
            const novaLog = options.map(opt => {
              const prestadorId = opt.value;
              const input = row.querySelector(`input[data-prestadorId="${prestadorId}"], input[data-prestador-id="${prestadorId}"]`);
              const valor = input ? parseFloat(input.value) || 0 : 0;
              return { prestadorId, valor };
            });
            await db.ref(`eventos/${evento.id}/logistica`).set(novaLog);
            fetchEventos();
          });
          logisticaSelectTd.appendChild(logisticaSelect);
          row.appendChild(logisticaSelectTd);

          // ===== Equipamento Alocado (dropzone – MOVE) =====
          const equipAlocadoTd = document.createElement('td'); equipAlocadoTd.className = 'list-col';
          const equipList = document.createElement('div'); equipList.className = 'equip-alocada-list dropzone';
          setDnD(equipList, {
            onDrop: async (payload) => {
              if (payload.type === 'from-pool-eqp') {
                const ocupado = equipamentoOcupadoNoDia(payload.equipamentoId, eventosDoDia);
                await moverEquip(ocupado?.eventId || null, evento.id, payload.equipamentoId);
                fetchEventos();
              } else if (payload.type === 'from-event-eqp' && payload.eventId !== evento.id) {
                await moverEquip(payload.eventId, evento.id, payload.equipamentoId);
                fetchEventos();
              }
            }
          });

          const equipamentosDoEvento = getEquipamentosDoEvento(evento);
          if (equipamentosDoEvento.length > 0) {
            equipamentosDoEvento.forEach(eq => {
              if (!eq?.equipamentoId || !allEquipamentos[eq.equipamentoId]) return;
              const chip = document.createElement('div');
              chip.className = 'chip';
              const strong = document.createElement('strong');
              strong.textContent = allEquipamentos[eq.equipamentoId].nome || 'Equipamento';

              const remover = document.createElement('button');
              remover.className = 'remove'; remover.textContent = '×'; remover.title = 'Remover';
              remover.addEventListener('click', async () => {
                await removerEquipDoEvento(evento.id, eq.equipamentoId);
                fetchEventos();
              });

              makeDraggable(chip, { type: 'from-event-eqp', eventId: evento.id, equipamentoId: eq.equipamentoId });

              chip.appendChild(strong); chip.appendChild(remover);
              equipList.appendChild(chip);
            });
          } else {
            const vazio = document.createElement('div');
            vazio.textContent = 'Arraste do pool de equipamentos';
            equipList.appendChild(vazio);
          }
          equipAlocadoTd.appendChild(equipList);
          row.appendChild(equipAlocadoTd);

          // ===== Equipamento (select múltiplo – bloqueia usados no dia) =====
          const equipamentoTd = document.createElement('td'); equipamentoTd.className = 'list-col';
          const equipamentoSelect = document.createElement('select'); equipamentoSelect.multiple = true;
          const usadosNesteEvento = new Set(equipamentosDoEvento.map(e => e.equipamentoId));
          for (const id in allEquipamentos) {
            const option = document.createElement('option');
            option.value = id; option.textContent = allEquipamentos[id].nome;
            if (usadosNesteEvento.has(id)) option.selected = true;
            else if (equipamentosUsadosNoDia.has(id)) option.disabled = true;
            equipamentoSelect.appendChild(option);
          }
          equipamentoSelect.addEventListener('change', async () => {
            const options = Array.from(equipamentoSelect.selectedOptions);
            const novos = options.map(opt => ({ equipamentoId: opt.value }));
            await db.ref(`eventos/${evento.id}/equipamentos`).set(novos);
            fetchEventos();
          });
          equipamentoTd.appendChild(equipamentoSelect);
          row.appendChild(equipamentoTd);

          // ===== OBS =====
          const obsTd = document.createElement('td'); obsTd.className = 'obs-col';
          const obsTextarea = document.createElement('textarea');
          obsTextarea.className = 'observacao'; obsTextarea.placeholder = 'OBS';
          obsTextarea.value = evento.observacao || '';
          obsTextarea.addEventListener('change', () => db.ref(`eventos/${evento.id}/observacao`).set(obsTextarea.value));
          obsTd.appendChild(obsTextarea);
          row.appendChild(obsTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      }
    }

    document.addEventListener('DOMContentLoaded', fetchEventos);
  </script>
</body>
</html>
