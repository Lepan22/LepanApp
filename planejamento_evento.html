<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Planejamento da Semana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="assets/base.css" />
  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    .evento-box {
      border-left: 5px solid orange;
      margin-bottom: 1rem;
      padding-left: 1rem;
    }
    .evento {
      margin-left: 1rem;
      margin-bottom: 1.5rem;
    }
    .equipe-select {
      max-width: 250px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menu"></aside>
    <main>
      <h1>Planejamento da Semana</h1>
      <div id="planejamento-container"></div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="assets/menu.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBzDP7O1dglJrJyxV5ciRA-wJdy0kLdUfg",
      authDomain: "lepanapp-default-rtdb.firebaseio.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "1006088740548",
      appId: "1:1006088740548:web:25aa8c3f2c3b6dc1beef4e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function carregarDados() {
      const [eventosSnap, equipeSnap] = await Promise.all([
        db.ref('eventos').once('value'),
        db.ref('equipe').once('value')
      ]);

      const eventos = Object.entries(eventosSnap.val() || {}).map(([id, e]) => ({
        id, ...e
      }));

      const membros = Object.entries(equipeSnap.val() || {}).map(([id, e]) => ({
        id, apelido: e.apelido || e.nome, nomeCompleto: e.nome
      }));

      return { eventos, membros };
    }

    function getSemanaAtual() {
      const hoje = new Date();
      const diaSemana = hoje.getDay(); // 0 (domingo) a 6 (sábado)
      const segunda = new Date(hoje);
      segunda.setDate(hoje.getDate() - ((diaSemana + 6) % 7));
      const domingo = new Date(segunda);
      domingo.setDate(segunda.getDate() + 6);
      return { segunda, domingo };
    }

    function formatarDataExtensa(date) {
      return date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
    }

    function criarElemento(tag, classe, texto) {
      const el = document.createElement(tag);
      if (classe) el.className = classe;
      if (texto) el.textContent = texto;
      return el;
    }

    function agruparEventosPorDia(eventos) {
      const grupos = {};
      eventos.forEach(evento => {
        const data = new Date(evento.data);
        const dia = data.toISOString().split('T')[0];
        if (!grupos[dia]) grupos[dia] = [];
        grupos[dia].push(evento);
      });
      return grupos;
    }

    function atualizarDisponibilidade(choicesMap, membrosPorDia) {
      for (const [data, choicesList] of Object.entries(choicesMap)) {
        const usados = membrosPorDia[data] || [];
        choicesList.forEach(({ choices, membroId }) => {
          choices.clearStore();
          const listaAtualizada = allMembros
            .filter(m => !usados.includes(m.id) || m.id === membroId)
            .map(m => ({ value: m.id, label: m.apelido }));
          choices.setChoices(listaAtualizada, 'value', 'label', true);
        });
      }
    }

    let allMembros = [];

    async function montarPlanejamento() {
      const { eventos, membros } = await carregarDados();
      allMembros = membros;

      const { segunda, domingo } = getSemanaAtual();
      const eventosSemana = eventos.filter(e => {
        const data = new Date(e.data);
        return data >= segunda && data <= domingo;
      }).sort((a, b) => new Date(a.data) - new Date(b.data));

      const container = document.getElementById('planejamento-container');
      container.innerHTML = '';

      const grupos = agruparEventosPorDia(eventosSemana);
      const membrosPorDia = {};
      const choicesMap = {};

      Object.entries(grupos).forEach(([dataStr, eventos]) => {
        const data = new Date(dataStr);
        const box = criarElemento('div', 'evento-box');
        const diaHeader = criarElemento('h3', null, formatarDataExtensa(data));
        box.appendChild(diaHeader);

        choicesMap[dataStr] = [];
        membrosPorDia[dataStr] = [];

        eventos.forEach(evento => {
          const bloco = criarElemento('div', 'evento');
          const titulo = criarElemento('div', null, evento.nomeEvento || 'Evento sem nome');
          const labelEquipe = criarElemento('label', null, 'Equipe:');
          const select = document.createElement('select');
          select.className = 'equipe-select';
          select.setAttribute('multiple', '');
          select.id = `select-${evento.id}`;

          // Adiciona membros alocados (já selecionados)
          const alocados = evento.equipeAlocada || [];
          alocados.forEach(m => {
            const membro = membros.find(mem => mem.id === m.membroId);
            if (membro) {
              const opt = new Option(membro.apelido, membro.id, true, true);
              select.appendChild(opt);
              membrosPorDia[dataStr].push(membro.id);
            }
          });

          bloco.appendChild(titulo);
          bloco.appendChild(labelEquipe);
          bloco.appendChild(select);
          box.appendChild(bloco);

          // Inicia Choices após opções adicionadas
          const choices = new Choices(select, {
            removeItemButton: true,
            shouldSort: false,
            placeholderValue: 'Selecione membros...'
          });

          choicesMap[dataStr].push({ choices, membroId: null });

          select.addEventListener('change', () => {
            const selecionados = Array.from(select.selectedOptions).map(o => o.value);
            membrosPorDia[dataStr] = membrosPorDia[dataStr].filter(id => !alocados.includes(id));
            membrosPorDia[dataStr].push(...selecionados);
            atualizarDisponibilidade(choicesMap, membrosPorDia);
          });
        });

        container.appendChild(box);
      });

      atualizarDisponibilidade(choicesMap, membrosPorDia);
    }

    window.addEventListener('DOMContentLoaded', montarPlanejamento);
  </script>
</body>
</html>
