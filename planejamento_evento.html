<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Planejamento da Semana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    body {
      font-family: sans-serif;
      background: #fef7f0;
      margin: 0;
      padding: 0 20px;
    }
    h1 {
      font-size: 1.5rem;
      margin-top: 20px;
    }
    .dia-header {
      border-left: 4px solid orange;
      padding-left: 8px;
      margin-top: 40px;
      font-weight: bold;
      color: #333;
    }
    .evento {
      display: flex;
      align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #ccc;
    }
    .evento-nome {
      width: 180px;
      font-weight: bold;
    }
    .coluna {
      width: 300px;
    }
    .choices__list--multiple .choices__item {
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Planejamento da Semana</h1>
  <div id="listaEventos"></div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const semana = obterSemanaAtual();
    const choicesInstances = {};
    const selectsPorDia = {};

    async function carregarDados() {
      const [eventosSnap, equipeSnap] = await Promise.all([
        db.ref("eventos").once("value"),
        db.ref("equipe").once("value")
      ]);
      const eventos = eventosSnap.val() || {};
      const equipe = equipeSnap.val() || {};

      const equipeMap = {};
      Object.entries(equipe).forEach(([id, dados]) => {
        equipeMap[id] = dados.apelido || "Sem apelido";
      });

      const eventosSemana = Object.entries(eventos)
        .map(([id, dados]) => {
          const dataObj = new Date(dados.data);
          const dataLocal = new Date(dataObj.getTime() + 3 * 60 * 60 * 1000);
          return {
            id,
            dataISO: dados.data,
            data: dataLocal,
            diaStr: dataLocal.toISOString().slice(0, 10),
            nomeEvento: dados.nomeEvento,
            equipe: (dados.equipe || []).map(m => m.membroId).filter(Boolean)
          };
        })
        .filter(ev => ev.data >= semana.inicio && ev.data <= semana.fim)
        .sort((a, b) => a.data - b.data);

      exibirEventos(eventosSemana, equipeMap);
    }

    function exibirEventos(lista, equipeMap) {
      const container = document.getElementById("listaEventos");
      container.innerHTML = "";

      const eventosPorDia = {};
      for (const ev of lista) {
        if (!eventosPorDia[ev.diaStr]) eventosPorDia[ev.diaStr] = [];
        eventosPorDia[ev.diaStr].push(ev);
      }

      Object.entries(eventosPorDia).forEach(([diaStr, eventosDoDia]) => {
        const data = new Date(diaStr + "T00:00:00-03:00");
        const diaFormatado = data.toLocaleDateString("pt-BR", { weekday: 'short', day: '2-digit', month: '2-digit' });

        const header = document.createElement("div");
        header.className = "dia-header";
        header.textContent = `${diaFormatado}`;
        container.appendChild(header);

        selectsPorDia[diaStr] = [];

        eventosDoDia.forEach(evento => {
          const div = document.createElement("div");
          div.className = "evento";

          const nome = document.createElement("div");
          nome.className = "evento-nome";
          nome.textContent = evento.nomeEvento;
          div.appendChild(nome);

          const colunaEquipe = document.createElement("div");
          colunaEquipe.className = "coluna";

          const label = document.createElement("label");
          label.textContent = "Equipe:";
          colunaEquipe.appendChild(label);

          const select = document.createElement("select");
          select.setAttribute("multiple", true);
          select.dataset.eventoId = evento.id;
          select.dataset.dia = diaStr;

          Object.entries(equipeMap).forEach(([id, apelido]) => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = apelido;
            if (evento.equipe.includes(id)) {
              opt.setAttribute("selected", "selected");
            }
            select.appendChild(opt);
          });

          colunaEquipe.appendChild(select);
          div.appendChild(colunaEquipe);
          container.appendChild(div);

          selectsPorDia[diaStr].push(select);
        });
      });

      setTimeout(() => {
        Object.entries(selectsPorDia).forEach(([diaStr, selects]) => {
          selects.forEach(select => {
            const choices = new Choices(select, {
              removeItemButton: true,
              placeholderValue: "Selecione membros...",
              searchEnabled: true,
              shouldSort: false
            });
            choicesInstances[select.dataset.eventoId] = choices;

            select.addEventListener("change", () => atualizarRestricoes(diaStr));
          });
          atualizarRestricoes(diaStr);
        });
      }, 0);
    }

    function atualizarRestricoes(diaStr) {
      const selects = selectsPorDia[diaStr];
      const todosSelecionados = new Set();

      // Coleta os membros alocados em todos os selects do dia
      selects.forEach(select => {
        const selected = Array.from(select.options)
          .filter(opt => opt.selected)
          .map(opt => opt.value);
        selected.forEach(id => todosSelecionados.add(id));
      });

      // Atualiza cada select removendo os nomes já usados (exceto os que já estão selecionados nele)
      selects.forEach(select => {
        const choices = choicesInstances[select.dataset.eventoId];
        const selecionadosNeste = new Set(
          Array.from(select.options).filter(opt => opt.selected).map(opt => opt.value)
        );

        // Refaz a lista com base nos que ainda podem ser escolhidos
        const novaLista = [];
        Array.from(select.options).forEach(opt => {
          const id = opt.value;
          const nome = opt.textContent;
          if (selecionadosNeste.has(id) || !todosSelecionados.has(id)) {
            novaLista.push({ value: id, label: nome, selected: selecionadosNeste.has(id) });
          }
        });

        choices.clearChoices();
        choices.setChoices(novaLista, 'value', 'label', true);
      });
    }

    function obterSemanaAtual() {
      const hoje = new Date();
      const diaSemana = hoje.getDay();
      const segunda = new Date(hoje);
      segunda.setDate(hoje.getDate() - ((diaSemana + 6) % 7));
      segunda.setHours(0, 0, 0, 0);
      const domingo = new Date(segunda);
      domingo.setDate(segunda.getDate() + 6);
      domingo.setHours(23, 59, 59, 999);
      return { inicio: segunda, fim: domingo };
    }

    carregarDados();
  </script>
</body>
</html>
