<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planejamento de Eventos da Semana</title>

  <link rel="stylesheet" href="assets/menu-styles.css" />
  <link rel="stylesheet" href="assets/base.css" />

  <style>
    body { font-size: 14px; margin-top: 10px; }
    input, select, textarea, button {
      padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
    }
    button { background-color: #198754; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #146c43; }

    table { border-collapse: collapse; width: 100%; font-size: 13px; }
    th { background-color: #ff7f00; color: white; padding: 6px; position: sticky; top: 0; z-index: 1; }
    td { border: 1px solid #ddd; padding: 4px; vertical-align: top; }
    tr:nth-child(even) td { background: #fafafa; }

    .equipe-col { width: 240px; }
    .equipe-alocada-list { display: flex; flex-wrap: wrap; gap: 6px; }

    /* CHIP do membro selecionado */
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; padding: 4px 8px;
    }
    .chip strong { font-weight: 600; }
    .chip input[type="number"] {
      width: 80px; padding: 2px 6px; font-size: 12px; height: 26px; text-align: right;
    }
    .chip .remove {
      background: #ef4444; color: #fff; border: none; border-radius: 9999px;
      width: 20px; height: 20px; line-height: 20px; text-align: center; cursor: pointer;
    }

    /* Seletor com busca */
    .picker {
      position: relative; display: flex; flex-direction: column; gap: 6px;
    }
    .picker .search {
      width: 100%; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px;
    }
    .picker .dropdown {
      max-height: 260px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    .picker .row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 6px 8px; border-bottom: 1px solid #f1f1f1;
    }
    .picker .row:last-child { border-bottom: none; }
    .picker .row.disabled { opacity: 0.55; pointer-events: none; background: #fcfcfc; }
    .picker .row label { display: flex; gap: 8px; align-items: center; cursor: pointer; }
    .picker .tag-ocupado {
      font-size: 11px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;
      padding: 2px 6px; border-radius: 9999px;
    }

    .date-header {
      margin-top: 16px; margin-bottom: 6px; font-weight: 700; font-size: 15px; color: #111;
    }

    /* Inputs pequenos */
    .equipe-alocada-list input[data-membro-id] { width: 80px; max-width: 80px; font-size: 12px; padding: 2px 6px; height: 26px; }

    textarea.observacao { width: 100%; min-height: 60px; resize: vertical; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="assets/menu.js" defer></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>

    <main class="main-content">
      <h2>Planejamento de Eventos da Semana</h2>
      <div id="eventos-container"><p>Carregando eventos...</p></div>
    </main>
  </div>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Estado =====
    let allEquipe = {};
    let allLogistica = {};
    let allEquipamentos = {};
    let allEventos = [];

    // ===== Util =====
    function getWeekRange() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday);
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { start: monday, end: sunday };
    }
    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
      return new Intl.DateTimeFormat('pt-BR', options).format(date);
    }

    // ===== Fetch =====
    async function fetchEquipe() {
      const snapshot = await db.ref('equipe').once('value');
      allEquipe = snapshot.val() || {};
    }
    async function fetchLogistica() {
      const snapshot = await db.ref('logistica').once('value');
      allLogistica = snapshot.val() || {};
    }
    async function fetchEquipamentos() {
      const snapshot = await db.ref('equipamentos').once('value');
      allEquipamentos = snapshot.val() || {};
    }
    async function fetchEventos() {
      try {
        await fetchEquipe();
        await fetchLogistica();
        await fetchEquipamentos();

        const snapshot = await db.ref('eventos').once('value');
        const eventosData = snapshot.val() || {};
        const { start, end } = getWeekRange();

        allEventos = Object.keys(eventosData)
          .map(key => ({ id: key, ...eventosData[key] }))
          .filter(evento => {
            if (!evento.data) return false;
            const eventoDate = new Date(evento.data + 'T00:00:00');
            return eventoDate >= start && eventoDate <= end;
          })
          .sort((a, b) => new Date(a.data) - new Date(b.data));

        renderEventos();
      } catch (error) {
        console.error("Erro ao buscar eventos:", error);
        document.getElementById('eventos-container').innerHTML = '<p>Erro ao carregar os eventos. Verifique o console.</p>';
      }
    }

    // ===== Helpers por Evento =====
    function getEquipeDoEvento(evento) {
      if (evento && Array.isArray(evento.equipe)) return evento.equipe;
      if (evento && Array.isArray(evento.equipeAlocada)) return evento.equipeAlocada;
      return [];
    }
    function getLogisticaDoEvento(evento) {
      return Array.isArray(evento.logistica) ? evento.logistica : [];
    }
    function getEquipamentosDoEvento(evento) {
      return Array.isArray(evento.equipamentos) ? evento.equipamentos : [];
    }

    // Retorna sets: membros já alocados no mesmo dia (outros eventos) e um mapa do "em qual evento"
    function getMembrosIndisponiveisNoDia(eventoAtual, eventosDoDia) {
      const indisponiveis = new Set();
      const ocupadoPor = {}; // membroId -> nomeEvento
      eventosDoDia.forEach(e => {
        if (e.id !== eventoAtual.id) {
          getEquipeDoEvento(e).forEach(m => {
            if (m?.membroId) {
              indisponiveis.add(m.membroId);
              if (!ocupadoPor[m.membroId]) ocupadoPor[m.membroId] = e.nomeEvento || 'Outro evento';
            }
          });
        }
      });
      return { indisponiveis, ocupadoPor };
    }

    // ===== UI: Picker de Equipe com busca + checkboxes + chips =====
    function buildEquipePicker(containerTd, eventoAtual, eventosDoDia) {
      containerTd.innerHTML = '';
      const equipeAtual = getEquipeDoEvento(eventoAtual) || [];
      const selecionadosSet = new Set(equipeAtual.map(m => m.membroId));

      const { indisponiveis, ocupadoPor } = getMembrosIndisponiveisNoDia(eventoAtual, eventosDoDia);

      // Chips dos selecionados (com valor)
      const chips = document.createElement('div');
      chips.className = 'equipe-alocada-list';
      function renderChips() {
        chips.innerHTML = '';
        equipeAtual.forEach(m => {
          if (!m?.membroId || !allEquipe[m.membroId]) return;
          const chip = document.createElement('div');
          chip.className = 'chip';

          const nome = allEquipe[m.membroId].apelido || allEquipe[m.membroId].nomeCompleto || 'Sem nome';
          const strong = document.createElement('strong');
          strong.textContent = nome;

          const input = document.createElement('input');
          input.type = 'number';
          input.step = '0.01';
          input.placeholder = 'R$';
          input.dataset.membroId = m.membroId;
          const defaultValor = allEquipe[m.membroId].valorDiaria || 0;
          input.value = (m.valor != null ? parseFloat(m.valor) : defaultValor).toFixed(2);
          input.addEventListener('change', () => updateEquipe(eventoAtual.id));

          const remover = document.createElement('button');
          remover.className = 'remove';
          remover.textContent = '×';
          remover.title = 'Remover';
          remover.addEventListener('click', () => {
            selecionadosSet.delete(m.membroId);
            // remove do array
            const idx = equipeAtual.findIndex(x => x.membroId === m.membroId);
            if (idx > -1) equipeAtual.splice(idx, 1);
            renderChips();
            renderDropdown(search.value);
            updateEquipe(eventoAtual.id);
          });

          chip.appendChild(strong);
          chip.appendChild(input);
          chip.appendChild(remover);
          chips.appendChild(chip);
        });
      }

      // Seletor (busca + lista)
      const picker = document.createElement('div');
      picker.className = 'picker';

      const search = document.createElement('input');
      search.className = 'search';
      search.type = 'text';
      search.placeholder = 'Buscar pessoa da equipe...';

      const dropdown = document.createElement('div');
      dropdown.className = 'dropdown';

      function addOuRemoveSelecionado(membroId) {
        if (selecionadosSet.has(membroId)) {
          // remover
          selecionadosSet.delete(membroId);
          const i = equipeAtual.findIndex(x => x.membroId === membroId);
          if (i > -1) equipeAtual.splice(i, 1);
        } else {
          // adicionar com valor padrão
          const defaultValor = allEquipe[membroId]?.valorDiaria || 0;
          equipeAtual.push({ membroId, valor: defaultValor });
          selecionadosSet.add(membroId);
        }
        renderChips();
        renderDropdown(search.value);
        updateEquipe(eventoAtual.id);
      }

      function renderDropdown(filtro = '') {
        dropdown.innerHTML = '';
        const termo = filtro.trim().toLowerCase();

        const membros = Object.keys(allEquipe)
          .map(id => ({ id, apelido: allEquipe[id].apelido || '', nome: allEquipe[id].nomeCompleto || '' }))
          .filter(m => {
            if (!termo) return true;
            return m.apelido.toLowerCase().includes(termo) || m.nome.toLowerCase().includes(termo);
          })
          // ordenar: selecionados primeiro, depois livres, depois indisponíveis
          .sort((a,b) => {
            const sA = selecionadosSet.has(a.id) ? 0 : (indisponiveis.has(a.id) ? 2 : 1);
            const sB = selecionadosSet.has(b.id) ? 0 : (indisponiveis.has(b.id) ? 2 : 1);
            if (sA !== sB) return sA - sB;
            return (allEquipe[a.id].apelido || '').localeCompare(allEquipe[b.id].apelido || '');
          });

        membros.forEach(m => {
          const row = document.createElement('div');
          row.className = 'row' + (indisponiveis.has(m.id) && !selecionadosSet.has(m.id) ? ' disabled' : '');
          const label = document.createElement('label');

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selecionadosSet.has(m.id);
          cb.addEventListener('change', () => addOuRemoveSelecionado(m.id));

          const nome = document.createElement('span');
          nome.textContent = allEquipe[m.id].apelido || allEquipe[m.id].nomeCompleto || 'Sem nome';

          label.appendChild(cb);
          label.appendChild(nome);
          row.appendChild(label);

          if (indisponiveis.has(m.id) && !selecionadosSet.has(m.id)) {
            const tag = document.createElement('span');
            tag.className = 'tag-ocupado';
            tag.textContent = 'Ocupado em: ' + (ocupadoPor[m.id] || 'outro evento');
            row.appendChild(tag);
          }

          dropdown.appendChild(row);
        });

        if (!dropdown.children.length) {
          const vazio = document.createElement('div');
          vazio.className = 'row';
          vazio.textContent = 'Nenhum resultado.';
          dropdown.appendChild(vazio);
        }
      }

      search.addEventListener('input', () => renderDropdown(search.value));

      picker.appendChild(search);
      picker.appendChild(dropdown);

      // Monta TD
      containerTd.appendChild(chips);
      containerTd.appendChild(picker);

      // Render inicial
      renderChips();
      renderDropdown('');
    }

    // ===== Render =====
    function renderEventos() {
      const container = document.getElementById('eventos-container');
      container.innerHTML = '';

      if (allEventos.length === 0) {
        container.innerHTML = '<p>Nenhum evento encontrado para a semana atual.</p>';
        return;
      }

      const eventosAgrupados = allEventos.reduce((acc, evento) => {
        const data = evento.data;
        if (!acc[data]) acc[data] = [];
        acc[data].push(evento);
        return acc;
      }, {});

      for (const data in eventosAgrupados) {
        const header = document.createElement('div');
        header.className = 'date-header';
        header.textContent = formatDate(data);
        container.appendChild(header);

        const table = document.createElement('table');
        table.innerHTML = `<thead><tr>
            <th>Evento</th>
            <th class="equipe-col">Equipe Selecionada</th>
            <th class="equipe-col">Adicionar/Remover Equipe</th>
            <th class="equipe-col">Logística Alocada</th>
            <th class="equipe-col">Editar Logística</th>
            <th class="equipe-col">Equipamento Alocado</th>
            <th class="equipe-col">Equipamento</th>
            <th class="equipe-col">OBS</th>
          </tr></thead>`;
        const tbody = document.createElement('tbody');

        const equipamentosUsadosNoDia = new Set();
        eventosAgrupados[data].forEach(e => {
          if (e.equipamentos) {
            e.equipamentos.forEach(eq => equipamentosUsadosNoDia.add(eq.equipamentoId));
          }
        });

        eventosAgrupados[data].forEach(evento => {
          const row = document.createElement('tr');
          row.id = `row-${evento.id}`;

          // Nome
          const nomeTd = document.createElement('td');
          nomeTd.textContent = evento.nomeEvento || 'Sem nome';
          row.appendChild(nomeTd);

          // ===== Equipe Selecionada (chips + valores) =====
          const equipeTd = document.createElement('td');
          equipeTd.className = 'equipe-col';
          // (somente leitura visual: vai ser populado dentro do picker também – os chips são geridos lá)
          // Para manter valor exibido mesmo sem interação, montamos uma lista simples aqui:
          const equipeList = document.createElement('div');
          equipeList.className = 'equipe-alocada-list';
          const equipeDoEvento = getEquipeDoEvento(evento);
          if (equipeDoEvento.length > 0) {
            equipeDoEvento.forEach(membro => {
              if (membro?.membroId && allEquipe[membro.membroId]) {
                const chip = document.createElement('div');
                chip.className = 'chip';
                const strong = document.createElement('strong');
                strong.textContent = allEquipe[membro.membroId].apelido || allEquipe[membro.membroId].nomeCompleto || 'Sem nome';
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.dataset.membroId = membro.membroId;
                const defaultValor = allEquipe[membro.membroId].valorDiaria || 0;
                input.value = (membro.valor != null ? parseFloat(membro.valor) : defaultValor).toFixed(2);
                input.addEventListener('change', () => updateEquipe(evento.id));
                const remover = document.createElement('button');
                remover.className = 'remove';
                remover.textContent = '×';
                remover.title = 'Remover';
                remover.addEventListener('click', () => {
                  // Remover visual imediato:
                  chip.remove();
                  // Atualiza no DB:
                  const atual = getEquipeDoEvento(allEventos.find(e => e.id === evento.id)) || [];
                  const novo = atual.filter(x => x.membroId !== membro.membroId);
                  db.ref(`eventos/${evento.id}/equipe`).set(novo).then(fetchEventos);
                });

                chip.appendChild(strong);
                chip.appendChild(input);
                chip.appendChild(remover);
                equipeList.appendChild(chip);
              }
            });
          } else {
            const vazio = document.createElement('div');
            vazio.textContent = 'Nenhuma equipe alocada';
            equipeList.appendChild(vazio);
          }
          equipeTd.appendChild(equipeList);
          row.appendChild(equipeTd);

          // ===== Picker de Equipe =====
          const equipePickerTd = document.createElement('td');
          equipePickerTd.className = 'equipe-col';
          buildEquipePicker(equipePickerTd, evento, eventosAgrupados[data]);
          row.appendChild(equipePickerTd);

          // ===== Logística Alocada =====
          const logisticaTd = document.createElement('td');
          logisticaTd.className = 'equipe-col';
          const logisticaList = document.createElement('ul');
          logisticaList.className = 'equipe-alocada-list';
          const logisticaDoEvento = getLogisticaDoEvento(evento);
          if (logisticaDoEvento.length > 0) {
            logisticaDoEvento.forEach(prestador => {
              if (prestador?.prestadorId && allLogistica[prestador.prestadorId]) {
                const li = document.createElement('li');
                const label = document.createElement('label');
                label.textContent = allLogistica[prestador.prestadorId].nome;
                const input = document.createElement('input');
                input.type = 'number';
                input.dataset.prestadorId = prestador.prestadorId;
                input.placeholder = "R$";
                input.step = "0.01";
                input.value = prestador.valor ? parseFloat(prestador.valor).toFixed(2) : '';
                input.addEventListener('change', () => updateLogistica(evento.id));
                li.appendChild(label);
                li.appendChild(input);
                logisticaList.appendChild(li);
              }
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'Nenhuma logística alocada';
            logisticaList.appendChild(li);
          }
          logisticaTd.appendChild(logisticaList);
          row.appendChild(logisticaTd);

          // ===== Editar Logística (continua select múltiplo simples) =====
          const logisticaSelectTd = document.createElement('td');
          logisticaSelectTd.className = 'equipe-col';
          const logisticaSelect = document.createElement('select');
          logisticaSelect.multiple = true;
          for (const id in allLogistica) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = allLogistica[id].nome;
            if (logisticaDoEvento.find(p => p.prestadorId === id)) option.selected = true;
            logisticaSelect.appendChild(option);
          }
          logisticaSelect.addEventListener('change', () => updateLogistica(evento.id));
          logisticaSelectTd.appendChild(logisticaSelect);
          row.appendChild(logisticaSelectTd);

          // ===== Equipamento Alocado =====
          const equipamentoAlocadoTd = document.createElement('td');
          equipamentoAlocadoTd.className = 'equipe-col';
          const equipamentoList = document.createElement('ul');
          equipamentoList.className = 'equipe-alocada-list';
          const equipamentosDoEvento = getEquipamentosDoEvento(evento);
          if (equipamentosDoEvento.length > 0) {
            equipamentosDoEvento.forEach(eq => {
              if (eq?.equipamentoId && allEquipamentos[eq.equipamentoId]) {
                const li = document.createElement('li');
                li.textContent = allEquipamentos[eq.equipamentoId].nome;
                equipamentoList.appendChild(li);
              }
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'Nenhum equipamento alocado';
            equipamentoList.appendChild(li);
          }
          equipamentoAlocadoTd.appendChild(equipamentoList);
          row.appendChild(equipamentoAlocadoTd);

          // ===== Editar Equipamento (mantém lógica) =====
          const equipamentoTd = document.createElement('td');
          equipamentoTd.className = 'equipe-col';
          const equipamentoSelect = document.createElement('select');
          equipamentoSelect.multiple = true;
          const usadosNesteEvento = new Set(equipamentosDoEvento.map(e => e.equipamentoId));
          for (const id in allEquipamentos) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = allEquipamentos[id].nome;
            if (usadosNesteEvento.has(id)) {
              option.selected = true;
            } else if (equipamentosUsadosNoDia.has(id)) {
              option.disabled = true;
            }
            equipamentoSelect.appendChild(option);
          }
          equipamentoSelect.addEventListener('change', () => updateEquipamento(evento.id));
          equipamentoTd.appendChild(equipamentoSelect);
          row.appendChild(equipamentoTd);

          // ===== OBS =====
          const obsTd = document.createElement('td');
          obsTd.className = 'equipe-col';
          const obsTextarea = document.createElement('textarea');
          obsTextarea.className = 'observacao';
          obsTextarea.placeholder = 'OBS';
          obsTextarea.value = evento.observacao || '';
          obsTextarea.addEventListener('change', () => {
            const texto = obsTextarea.value;
            db.ref(`eventos/${evento.id}/observacao`).set(texto);
          });
          obsTd.appendChild(obsTextarea);
          row.appendChild(obsTd);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      }
    }

    // ===== Updates =====
    async function updateEquipe(eventoId) {
      const row = document.getElementById(`row-${eventoId}`);
      if (!row) return;

      // Lemos todos os chips/inputs que existem no DOM para compor o array
      const inputs = row.querySelectorAll('input[data-membro-id]');
      const novaEquipe = [];
      inputs.forEach(inp => {
        const membroId = inp.dataset.membroId;
        const valor = parseFloat(inp.value) || 0;
        novaEquipe.push({ membroId, valor });
      });

      await db.ref(`eventos/${eventoId}/equipe`).set(novaEquipe);
      // Recarrega para refletir bloqueios/estado
      fetchEventos();
    }

    async function updateLogistica(eventoId) {
      const row = document.getElementById(`row-${eventoId}`);
      if (!row) return;
      const select = row.querySelectorAll('select')[0]; // primeiro select após equipePickerTd
      const options = Array.from(select.selectedOptions);
      const novaLogistica = options.map(opt => {
        const prestadorId = opt.value;
        const input = row.querySelector(`input[data-prestador-id="${prestadorId}"]`);
        let valor = input ? parseFloat(input.value) || 0 : 0;
        return { prestadorId, valor };
      });

      await db.ref(`eventos/${eventoId}/logistica`).set(novaLogistica);
      fetchEventos();
    }

    async function updateEquipamento(eventoId) {
      const row = document.getElementById(`row-${eventoId}`);
      if (!row) return;
      const selects = row.querySelectorAll('select');
      const equipamentoSelect = selects[1]; // segundo select (após logística)
      const options = Array.from(equipamentoSelect.selectedOptions);
      const novosEquipamentos = options.map(opt => ({ equipamentoId: opt.value }));
      await db.ref(`eventos/${eventoId}/equipamentos`).set(novosEquipamentos);
      fetchEventos();
    }

    document.addEventListener('DOMContentLoaded', fetchEventos);
  </script>
</body>
</html>
