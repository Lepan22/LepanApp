<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análise DRE Mensal</title>
  <link rel="stylesheet" href="assets/base.css" />
  <link rel="stylesheet" href="assets/menu-styles.css" />
  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>
  <style>
    .filtros {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tabela-dre-container {
      overflow-x: auto;
    }

    .tabela-dre {
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
      table-layout: fixed;
      min-width: max-content;
      background: white;
    }

    .tabela-dre th, .tabela-dre td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: right;
      width: 90px;
      white-space: nowrap;
    }

    .tabela-dre th:first-child,
    .tabela-dre td:first-child {
      text-align: left;
      width: 220px;
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 2;
    }

    .tabela-dre th:nth-child(2),
    .tabela-dre td:nth-child(2) {
      position: sticky;
      left: 220px;
      background: #f8f8f8;
      z-index: 1;
    }

    .grupo {
      background-color: #eee;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <h2>Análise DRE - Visão Mensal</h2>

    <div class="filtros">
      <label>
        Ano:
        <select id="filtroAno">
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
        </select>
      </label>
      <button onclick="carregarDRE()">Atualizar</button>
    </div>

    <div class="tabela-dre-container">
      <div id="tabelaDRE"></div>
    </div>
  </div>

  <script type="module">
    import { db } from './assets/firebase-config.js';
    import { get, ref } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    function formatarMoeda(valor) {
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2
      }).format(valor);
    }

    function formatarPercentual(valor) {
      return valor.toFixed(2).replace('.', ',') + '%';
    }

    async function carregarDRE() {
      const ano = document.getElementById('filtroAno').value;
      const snapCategorias = await get(ref(db, 'financeiro/categorias'));
      const mapCategorias = {};
      snapCategorias.forEach(cat => {
        const v = cat.val();
        if (v.nome) mapCategorias[v.nome] = v.centroDeCusto || "Outros";
      });

      const snap = await get(ref(db, `financeiro/consolidado`));
      const meses = Array.from({ length: 12 }, (_, i) => i + 1);
      const estrutura = {};

      snap.forEach(item => {
        const val = item.val();
        if (val.ano == ano) {
          const mes = val.mes;
          const entradas = val.entradas || {};
          const saidas = val.saidas || {};

          for (let [nome, valor] of Object.entries(entradas)) {
            estrutura["Receita"] = estrutura["Receita"] || { total: 0 };
            estrutura["Receita"][mes] = (estrutura["Receita"][mes] || 0) + valor;
            estrutura["Receita"].total += valor;
          }

          for (let [nome, valor] of Object.entries(saidas)) {
            const tipo = mapCategorias[nome] || "Outros";
            estrutura[tipo] = estrutura[tipo] || { total: 0 };
            estrutura[tipo][mes] = (estrutura[tipo][mes] || 0) + valor;
            estrutura[tipo].total += valor;
          }
        }
      });

      // Cálculos adicionais
      const Receita = estrutura["Receita"] || {};
      const CMV = estrutura["CMV"] || {};
      const Fixa = estrutura["Despesa Fixa"] || {};
      const Variavel = estrutura["Despesa Variável"] || {};
      const Outros = estrutura["Outros"] || {};

      const resumo = {
        "Lucro Bruto": {},
        "Lucro Operacional": {},
        "Lucro Líquido": {},
        "Margem Bruta (%)": {},
        "Margem Operacional (%)": {},
        "Margem Líquida (%)": {}
      };

      for (const mes of meses) {
        const entrada = Receita[mes] || 0;
        const cmv = CMV[mes] || 0;
        const fixa = Fixa[mes] || 0;
        const variavel = Variavel[mes] || 0;
        const outros = Outros[mes] || 0;

        const lucroBruto = entrada - cmv;
        const operacional = lucroBruto - fixa - variavel;
        const liquido = operacional - outros;

        resumo["Lucro Bruto"][mes] = lucroBruto;
        resumo["Lucro Operacional"][mes] = operacional;
        resumo["Lucro Líquido"][mes] = liquido;

        resumo["Margem Bruta (%)"][mes] = entrada ? (lucroBruto / entrada) * 100 : 0;
        resumo["Margem Operacional (%)"][mes] = entrada ? (operacional / entrada) * 100 : 0;
        resumo["Margem Líquida (%)"][mes] = entrada ? (liquido / entrada) * 100 : 0;
      }

      for (let categoria in resumo) {
        resumo[categoria].total = meses.reduce((soma, m) => soma + (resumo[categoria][m] || 0), 0);
        estrutura[categoria] = resumo[categoria];
      }

      renderizarTabela(estrutura, meses);
    }

    function renderizarTabela(dados, meses) {
      let html = `<table class="tabela-dre"><thead><tr><th>Categoria</th><th>Total</th>`;
      for (const m of meses) html += `<th>${m.toString().padStart(2, '0')}</th>`;
      html += `</tr></thead><tbody>`;

      for (let [categoria, valores] of Object.entries(dados)) {
        const isResumo = categoria.includes("Lucro") || categoria.includes("Margem");
        const classe = isResumo ? 'grupo' : '';
        const total = valores.total || 0;
        const totalFmt = categoria.includes("Margem") ? formatarPercentual(total / meses.length)
            : formatarMoeda(categoria.startsWith("Despesa") || categoria === "CMV" || categoria === "Outros" ? -total : total);

        html += `<tr class="${classe}"><td>${categoria}</td><td>${totalFmt}</td>`;
        for (const m of meses) {
          const val = valores[m] || 0;
          const fmt = categoria.includes("Margem")
            ? formatarPercentual(val)
            : formatarMoeda(categoria.startsWith("Despesa") || categoria === "CMV" || categoria === "Outros" ? -val : val);
          html += `<td>${fmt}</td>`;
        }
        html += `</tr>`;
      }

      html += `</tbody></table>`;
      document.getElementById('tabelaDRE').innerHTML = html;
    }

    carregarDRE();
  </script>
</body>
</html>
