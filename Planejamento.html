<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planejamento</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --ind-w: 110px;   /* Centro/Categoria (fixo à esquerda) */
    --year-w: 110px;  /* DRE Projetado (Anual) */
    --year2-w: 110px; /* Consolidado DRE Real (Ano) */
    --col-w: 120px;   /* Largura de cada mês */
    --fs: 12px;
    --fs-sm: 10.6px;
  }
  .main-content { padding:14px 18px; }
  body, table, input, button, select { font-size: var(--fs); }
  .page-header h1 { margin:4px 0 2px; color:#111 !important; }
  .page-header p  { margin:0 0 8px; color:#666; font-size:var(--fs-sm); }

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .badge{background:#f6f6f6;border:1px solid #e5e5e5;padding:2px 6px;border-radius:6px;font-size:11.5px;}
  select{height:30px}
  .btn{height:32px;border:1px solid #ddd;border-radius:8px;background:#10b981;color:#fff;padding:0 12px;cursor:pointer;}
  .btn.secondary{background:#fff;color:#111;border-color:#ddd}

  /* viewport rolável com sticky header e sticky resultado */
  .table-viewport {
    border:1px solid #eee; border-radius:8px; background:#fff;
    height:72vh; overflow:auto; position:relative;
  }
  table.fx { width:100%; border-collapse:collapse; }
  .fx th, .fx td { border:1px solid #e6e6e6; padding:6px 8px; }

  /* cabeçalho sticky */
  .fx thead th {
    position: sticky; top: 0; z-index: 5;
    background:#fff7ec; font-weight:600;
    color:#111 !important; text-shadow:none !important;
  }
  .fx th.ind, .fx th.annual1, .fx th.annual2, .fx th.month { color:#111 !important; }

  /* três primeiras colunas fixas */
  .fx th.ind, .fx td.ind {
    position: sticky; left:0; z-index:6; background:#fafafa;
    width:var(--ind-w); min-width:var(--ind-w); max-width:var(--ind-w);
    text-align:left; white-space:nowrap;
  }
  .fx th.annual1, .fx td.annual1 {
    position: sticky; left:var(--ind-w); z-index:4; background:#fafafa;
    width:var(--year-w); min-width:var(--year-w); max-width:var(--year-w);
    text-align:right; white-space:nowrap;
  }
  .fx th.annual2, .fx td.annual2 {
    position: sticky; left:calc(var(--ind-w) + var(--year-w)); z-index:4; background:#fafafa;
    width:var(--year2-w); min-width:var(--year2-w); max-width:var(--year2-w);
    text-align:right; white-space:nowrap;
  }
  .fx thead th.month, .fx tbody td.month { min-width:var(--col-w); width:var(--col-w); text-align:right; }

  .row-odd  td { background:#ffffff; }
  .row-even td { background:#f7f7fb; }

  .toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; font-weight:700; }
  .caret  { font-size:11px; color:#555; width:12px; text-align:center; }
  tr.cat-row.hidden { display:none; }

  .num { text-align:right; white-space:nowrap; }
  .muted{ color:#6b7280; font-size: var(--fs-sm); }
  .pct  { color:#475569; font-size:var(--fs-sm); margin-left:4px; }

  .delta-pos{ color:#059669; }
  .delta-neg{ color:#dc2626; }

  /* célula mensal com dois inputs (valor e %) empilhados */
  .cell-edit{ display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
  .cell-edit input{
    width:100%; box-sizing:border-box; text-align:right;
    padding:4px 6px; border:1px solid #dadada; border-radius:6px; background:#fff;
  }
  .cell-edit input.pct{ font-size:var(--fs-sm); }

  .grp-total { font-weight:700; }

  /* Resultado sticky no rodapé */
  tr.resultado td{
    position: sticky; bottom: 0; z-index: 7;
    background:#fff7f0; font-weight:800; border-top:2px solid #f97316;
  }
  tr.resultado td.ind     { left: 0; }
  tr.resultado td.annual1 { left: var(--ind-w); }
  tr.resultado td.annual2 { left: calc(var(--ind-w) + var(--year-w)); }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Planejamento</h1>
      <p>
        Cada categoria tem **Valor** e **% sobre Receita** por mês.<br/>
        • Se **% = 0** (ou vazio), o **Valor** é **fixo**.<br/>
        • Se **% &gt; 0**, o valor = **% × Receita** do mês.<br/>
        Qualquer alteração propaga para os meses seguintes.
      </p>
    </div>

    <section class="controls">
      <label>Ano:
        <select id="anoSelect">
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>
      </label>
      <button id="salvar" class="btn">Salvar projeção do ano</button>
      <button id="descartar" class="btn secondary">Descartar alterações (não salvas)</button>
      <span class="badge" id="ctx">—</span>
      <span class="badge" id="status">—</span>
    </section>

    <div class="table-viewport">
      <table class="fx" id="tbl">
        <thead>
          <tr id="hdr">
            <th class="ind">Centro/Categoria</th>
            <th class="annual1">DRE Projetado (Anual)</th>
            <th class="annual2">Consolidado DRE Real (Ano)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  // ===== Utils
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date();
  const ANO_ATUAL = hoje.getFullYear();
  const MES_ATUAL = hoje.getMonth()+1;
  const MES_BASE_ATUAL = ((MES_ATUAL-2+12)%12)+1; // mês anterior (1..12)

  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const num  = v => isNaN(Number(v)) ? 0 : Number(v);
  const toBR = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fromBR = s => {
    const t = String(s||'').replace(/\./g,'').replace(',','.');
    const v = Number(t); return isNaN(v) ? 0 : v;
  };
  const toPctStr = d => (Number(d||0)*100).toLocaleString('pt-BR',{maximumFractionDigits:2});
  const fromPctStr = s => {
    const t = String(s||'').replace('%','').replace(/\s+/g,'').replace(',','.');
    let v = Number(t); if (isNaN(v)) return 0; if (v>1) v = v/100; return v;
  };

  // ===== Firebase
  try{
    const cfg = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(cfg);
  }catch(e){ console.error(e); }
  const db = firebase.database();

  // ===== Estado
  const categorias = new Map(); // id -> {nome, centro}
  const grupos = new Map();     // centro -> [ids]

  // Real (consolidado do ano para comparação)
  const realAnual  = new Map(); // id -> soma
  let receitaRealAnual = 0;

  // Planejado (editável)
  let receitaProjMensal = Array(12).fill(0);
  const pctMensal = new Map();   // id -> [12] (0 = fixo)
  const valorMensal = new Map(); // id -> [12] (manual quando fixo; calculado quando % > 0)

  // Snapshots para detectar alterações
  let snap_receita = Array(12).fill(0);
  const snap_pct = new Map();
  const snap_val = new Map();

  // Meses exibidos
  let mesesExibidos = [];
  let MES_BASE = MES_BASE_ATUAL;

  // ===== Carregamento
  async function loadCategorias(){
    categorias.clear(); grupos.clear();
    const s = await db.ref('financeiro/categorias').once('value');
    const v = s.val() || {};
    Object.keys(v).forEach(id=>{
      const c = v[id]||{};
      const centro = c.centroDeCusto || c.centro || 'Outros';
      categorias.set(id, { id, nome: c.nome || id, centro });
      if (!grupos.has(centro)) grupos.set(centro, []);
      grupos.get(centro).push(id);
    });
    grupos.forEach(arr=> arr.sort((a,b)=> (categorias.get(a).nome).localeCompare(categorias.get(b).nome,'pt-BR')));
  }

  async function loadRealAno(ANO){
    realAnual.clear(); receitaRealAnual = 0;
    const s = await db.ref(`financeiro/dre_fechado/${ANO}`).once('value');
    const v = s.val() || {};
    Object.keys(v).forEach(mm=>{
      const m = Number(mm); if (!m) return;
      const node = v[mm]||{};
      receitaRealAnual += num(node?.grupos?.Receita?.mes || 0);
      const cats = node.categorias || {};
      Object.keys(cats).forEach(id=>{
        const val = num(cats[id]?.valorMes || 0);
        realAnual.set(id, num(realAnual.get(id)||0) + val);
      });
    });
  }

  async function loadPlanejamento(ANO){
    // zera buffers
    receitaProjMensal = Array(12).fill(0);
    pctMensal.clear(); valorMensal.clear();

    const s = await db.ref(`financeiro/planejamento_projecao/${ANO}`).once('value');
    const v = s.val() || {};
    if (Array.isArray(v.receitaProj)) receitaProjMensal = v.receitaProj.map(num);

    const cats = v.categorias || {};
    // popular tudo (inclusive categorias sem registro → arrays zerados)
    categorias.forEach((_, id)=>{
      const c = cats[id] || {};
      const pv = Array.isArray(c.projMensal) ? c.projMensal.map(num) : Array(12).fill(0);
      const pp = Array.isArray(c.pctMensal)  ? c.pctMensal.map(num)  : Array(12).fill(0);
      valorMensal.set(id, pv);
      pctMensal.set(id, pp);
    });

    // snapshots
    snap_receita = receitaProjMensal.slice(0);
    categorias.forEach((_, id)=>{
      snap_val.set(id, (valorMensal.get(id)||[]).slice(0));
      snap_pct.set(id, (pctMensal.get(id)||[]).slice(0));
    });
  }

  // ===== Helpers de cálculo
  function efetivoMes(id, mIndex){
    const p = (pctMensal.get(id)||[])[mIndex] || 0;
    if (p>0){
      return p * num(receitaProjMensal[mIndex]||0);
    }
    return (valorMensal.get(id)||[])[mIndex] || 0;
  }
  function somaAnualEfetivo(id){
    let s=0; for (let i=0;i<12;i++) s += efetivoMes(id,i); return s;
  }
  function somaAnoGrupoEfetivo(g){
    let t=0; (grupos.get(g)||[]).forEach(id=> t += somaAnualEfetivo(id)); return t;
  }
  function somaMesGrupoEfetivo(g, mIndex){
    let t=0; (grupos.get(g)||[]).forEach(id=> t += efetivoMes(id,mIndex)); return t;
  }

  // ===== Render
  function defineMeses(ANO){
    if (ANO==2025) mesesExibidos = [10,11,12];
    else mesesExibidos = [1,2,3,4,5,6,7,8,9,10,11,12];

    if (ANO < ANO_ATUAL) MES_BASE = 12;
    else if (ANO > ANO_ATUAL) MES_BASE = 0;
    else MES_BASE = MES_BASE_ATUAL;
  }

  function buildHeader(ANO){
    const hdr = document.getElementById('hdr');
    hdr.innerHTML = `
      <th class="ind">Centro/Categoria</th>
      <th class="annual1">DRE Projetado (Anual)</th>
      <th class="annual2">Consolidado DRE Real (Ano)</th>
    `;
    mesesExibidos.forEach(m=>{
      const th = document.createElement('th'); th.className='month'; th.textContent = mesesPt[m-1]; hdr.appendChild(th);
    });
  }

  function montarTabela(ANO){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';

    // Linha de receita (prevista)
    const trRec = document.createElement('tr');
    trRec.innerHTML = `
      <td class="ind"><b>Receita (previsão)</b></td>
      <td class="annual1 num">${toBR(receitaProjMensal.reduce((a,b)=>a+num(b),0))}</td>
      <td class="annual2 num">${toBR(receitaRealAnual)}</td>
      ${mesesExibidos.map(m=>{
        const i=m-1;
        return `<td class="month">
          <div class="cell-edit">
            <input data-k="receita" data-i="${i}" value="${toBR(receitaProjMensal[i])}">
          </div>
        </td>`;
      }).join('')}
    `;
    tbody.appendChild(trRec);

    // Centros na ordem
    const ORDEM = ["Receita","CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"];
    const centros = Array.from(grupos.keys());
    const ordenados = [...ORDEM, ...centros.filter(c=>!ORDEM.includes(c))];

    const headers = {};
    // Cabeçalhos por grupo
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const key = norm(g).replace(/\s+/g,'-');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ind"><span class="toggle" data-grp="${key}" data-open="1"><span class="caret">▼</span> ${g}</span></td>
        <td class="annual1 num grp-total">—</td>
        <td class="annual2 num grp-total">—</td>
        ${mesesExibidos.map(()=>`<td class="month num grp-total">—</td>`).join('')}
      `;
      tr.dataset.grpkey = key;
      tbody.appendChild(tr);
      headers[g]=tr;

      // categorias do grupo
      (grupos.get(g)||[]).forEach(id=>{
        const cat = categorias.get(id);
        const arrV = (valorMensal.get(id)||[]);
        const arrP = (pctMensal.get(id)||[]);
        const anualEf = somaAnualEfetivo(id);
        const realAno = num(realAnual.get(id)||0);

        const trc = document.createElement('tr'); trc.className='cat-row'; trc.dataset.grp=key;

        const c0 = document.createElement('td'); c0.className='ind'; c0.textContent = cat.nome;
        const c1 = document.createElement('td'); c1.className='annual1 num'; c1.innerHTML = toBR(anualEf);
        const c2 = document.createElement('td'); c2.className='annual2 num'; c2.innerHTML = toBR(realAno);
        trc.appendChild(c0); trc.appendChild(c1); trc.appendChild(c2);

        mesesExibidos.forEach(m=>{
          const i=m-1;
          const val = num(arrV[i]||0);
          const pct = num(arrP[i]||0);
          const td = document.createElement('td'); td.className='month';
          td.innerHTML = `
            <div class="cell-edit">
              <input data-k="val" data-id="${cat.id}" data-i="${i}" value="${toBR(pct>0 ? efetivoMes(cat.id,i) : val)}" ${pct>0?'':'style="font-weight:600"'} >
              <input class="pct" data-k="pct" data-id="${cat.id}" data-i="${i}" placeholder="0%" value="${pct>0? (toPctStr(pct)) : ''}">
            </div>`;
          trc.appendChild(td);
        });

        tbody.appendChild(trc);
      });
    });

    // Totais de grupo + resultado
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const head = headers[g];
      const anualProj = somaAnoGrupoEfetivo(g);
      const anualReal = (grupos.get(g)||[]).reduce((s,id)=> s + num(realAnual.get(id)||0), 0);
      head.children[1].textContent = toBR(anualProj);
      head.children[2].textContent = toBR(anualReal);

      mesesExibidos.forEach((m,idx)=>{
        const tot = somaMesGrupoEfetivo(g, m-1);
        head.children[3+idx].textContent = toBR(tot);
      });
    });

    // Resultado
    const trRes = document.createElement('tr'); trRes.className='resultado';
    const pRecAnual = receitaProjMensal.reduce((a,b)=>a+num(b),0);
    const pOutAnual = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
      .map(g=>somaAnoGrupoEfetivo(g)).reduce((a,b)=>a+b,0));
    const pResAnual = pRecAnual - pOutAnual;

    const rRecAnual = receitaRealAnual;
    const rOutAnual = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
      .map(g=> (grupos.get(g)||[]).reduce((s,id)=> s + num(realAnual.get(id)||0), 0))
      .reduce((a,b)=>a+b,0));
    const rResAnual = rRecAnual - rOutAnual;

    const mesesTDs = mesesExibidos.map(m=>{
      const i=m-1;
      const pr = receitaProjMensal[i];
      const po = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
        .map(g=>somaMesGrupoEfetivo(g,i)).reduce((a,b)=>a+b,0));
      const p = pr - po;
      return `<td class="month">${toBR(p)}</td>`;
    }).join('');

    trRes.innerHTML = `
      <td class="ind">Resultado</td>
      <td class="annual1 num">${toBR(pResAnual)}</td>
      <td class="annual2 num">${toBR(rResAnual)}</td>
      ${mesesTDs}
    `;
    tbody.appendChild(trRes);

    bindInputs();
    paintZebra();
    document.getElementById('ctx').textContent =
      `Ano ${ANO} • Mês base: ${MES_BASE?('0'+MES_BASE).slice(-2):'—'} • Meses: ${ANO==2025?'Out/Nov/Dez':'Jan–Dez'}`;
  }

  function paintZebra(){
    const tbody = document.getElementById('tbody');
    let i=0; tbody.querySelectorAll('tr').forEach(tr=>{ tr.classList.remove('row-odd','row-even'); tr.classList.add( (i%2===0)?'row-odd':'row-even' ); i++; });
    tbody.querySelectorAll('.toggle').forEach(tg=>{
      tg.onclick = ()=>{
        const grp = tg.dataset.grp; const open = tg.dataset.open==='1';
        tg.dataset.open = open ? '0':'1';
        tg.querySelector('.caret').textContent = open ? '►' : '▼';
        tbody.querySelectorAll(`tr.cat-row[data-grp="${grp}"]`).forEach(r=> r.classList.toggle('hidden', open));
      };
    });
  }

  // ===== Edição / Propagação
  function bindInputs(){
    const tbody = document.getElementById('tbody');

    // Receita
    tbody.querySelectorAll('input[data-k="receita"]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const i = Number(inp.dataset.i);
        const val = fromBR(inp.value);
        // propaga receita para os meses seguintes
        for (let m=i;m<12;m++) receitaProjMensal[m] = val;
        // recalc categorias com % > 0 a partir desse mês
        categorias.forEach((_, id)=>{
          const arrP = pctMensal.get(id)||Array(12).fill(0);
          for (let m=i;m<12;m++){
            if (num(arrP[m]||0) > 0){
              const arrV = valorMensal.get(id)||Array(12).fill(0);
              arrV[m] = num(arrP[m]) * val;
              valorMensal.set(id, arrV);
            }
          }
        });
        montarTabela(Number(document.getElementById('anoSelect').value));
      });
    });

    // Valor e %
    tbody.querySelectorAll('input[data-k]').forEach(inp=>{
      if (inp.dataset.k === 'val' || inp.dataset.k === 'pct'){
        inp.addEventListener('input', ()=>{
          const id = inp.dataset.id, i = Number(inp.dataset.i);
          const arrV = (valorMensal.get(id)||Array(12).fill(0));
          const arrP = (pctMensal.get(id)||Array(12).fill(0));

          if (inp.dataset.k === 'pct'){
            const p = fromPctStr(inp.value); // 0..1
            for (let m=i;m<12;m++) arrP[m] = p;  // propaga %
            // se % > 0, recalc valor como p * receita do mês
            if (p>0){
              for (let m=i;m<12;m++){
                arrV[m] = p * num(receitaProjMensal[m]||0);
              }
            }
            pctMensal.set(id, arrP);
            valorMensal.set(id, arrV);
          } else {
            // valor manual: só propaga se % = 0 (fixo)
            const pMes = num((pctMensal.get(id)||[])[i]||0);
            const val = fromBR(inp.value);
            if (pMes===0){
              for (let m=i;m<12;m++) arrV[m] = val;
              valorMensal.set(id, arrV);
            }
          }

          montarTabela(Number(document.getElementById('anoSelect').value));
        });
      }
    });
  }

  // ===== Persistência
  function houveAlteracao(){
    if (JSON.stringify(snap_receita)!==JSON.stringify(receitaProjMensal)) return true;
    let changed=false;
    categorias.forEach((_, id)=>{
      if (JSON.stringify(snap_val.get(id)||[])!==JSON.stringify(valorMensal.get(id)||[])) changed=true;
      if (JSON.stringify(snap_pct.get(id)||[])!==JSON.stringify(pctMensal.get(id)||[])) changed=true;
    });
    return changed;
  }

  async function salvar(ANO){
    const payload = {
      receitaProj: receitaProjMensal.map(num),
      categorias: {}
    };
    categorias.forEach((_, id)=>{
      payload.categorias[id] = {
        projMensal: (valorMensal.get(id)||Array(12).fill(0)).map(num),
        pctMensal:  (pctMensal.get(id)||Array(12).fill(0)).map(num)
      };
    });
    await db.ref(`financeiro/planejamento_projecao/${ANO}`).set(payload);
    // refresh snapshots
    snap_receita = receitaProjMensal.slice(0);
    categorias.forEach((_, id)=>{
      snap_val.set(id, (valorMensal.get(id)||[]).slice(0));
      snap_pct.set(id, (pctMensal.get(id)||[]).slice(0));
    });
    setStatus('Projeção salva ✅');
  }

  function descartar(){
    receitaProjMensal = snap_receita.slice(0);
    categorias.forEach((_, id)=>{
      valorMensal.set(id, (snap_val.get(id)||[]).slice(0));
      pctMensal.set(id, (snap_pct.get(id)||[]).slice(0));
    });
    montarTabela(Number(document.getElementById('anoSelect').value));
    setStatus('Alterações descartadas.');
  }

  function setStatus(s){ document.getElementById('status').textContent = s; setTimeout(()=>{document.getElementById('status').textContent='—';}, 2500); }

  // ===== Rebuild
  async function rebuild(ANO){
    defineMeses(ANO);
    await loadCategorias();
    await loadRealAno(ANO);
    await loadPlanejamento(ANO);
    buildHeader(ANO);
    montarTabela(ANO);
  }

  // start
  const selAno = document.getElementById('anoSelect');
  document.getElementById('salvar').onclick   = ()=> salvar(Number(selAno.value));
  document.getElementById('descartar').onclick= ()=> descartar();
  selAno.onchange = ()=> rebuild(Number(selAno.value));
  rebuild(2025);
})();
</script>
</body>
</html>
