<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planejamento (Projeções)</title>

<link rel="stylesheet" href="assets/base.css"/>
<link rel="stylesheet" href="assets/menu-styles.css"/>

<style>
  :root{
    --ind-w: 110px;   /* Centro/Categoria */
    --year-w: 110px;  /* Projetado/Real Anual */
    --col-w: 120px;   /* Mês (podemos reduzir se quiser) */
    --fs: 12px;
    --fs-sm: 10.6px;
  }
  .main-content { padding:14px 18px; }
  body, table, input, button, select { font-size: var(--fs); }

  .page-header h1 { margin:4px 0 2px; }
  .page-header p  { margin:0 0 8px; color:#666; font-size:var(--fs-sm); }

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .btn{height:30px;padding:0 10px;border:1px solid #e5e5e5;border-radius:8px;background:#fff;cursor:pointer;font-size:11.5px;}
  .btn.primary{background:#ff7f2a;color:#fff;border-color:#f97316;}
  .badge{background:#f6f6f6;border:1px solid #e5e5e5;padding:2px 6px;border-radius:6px;font-size:11.5px;}

  /* Área rolável com barras vert/horz e cabeçalho/rodapé stickies */
  .table-viewport {
    border:1px solid #eee; border-radius:8px; background:#fff;
    height:72vh;             /* altura visível; ajuste se quiser */
    overflow:auto;           /* barras vertical e horizontal */
    position:relative;
  }
  table.fx { width:100%; border-collapse:collapse; }
  .fx th, .fx td { border:1px solid #e6e6e6; padding:6px 8px; }

  /* Cabeçalho sticky no topo do viewport rolável */
  .fx thead th {
    position: sticky; top: 0; z-index: 5;
    background:#fff7ec; color:#000; font-weight:600;
  }

  /* Colunas fixas (primeiras três) */
  .fx th.ind, .fx td.ind {
    position: sticky; left: 0; z-index: 6;      /* acima do header de meses */
    background:#fafafa; width:var(--ind-w); min-width:var(--ind-w); max-width:var(--ind-w);
    text-align:left; white-space:nowrap;
  }
  .fx th.annual1, .fx td.annual1 {
    position: sticky; left: var(--ind-w); z-index: 4;
    background:#fafafa; width:var(--year-w); min-width:var(--year-w); max-width:var(--year-w);
    text-align:right; white-space:nowrap;
  }
  .fx th.annual2, .fx td.annual2 {
    position: sticky; left: calc(var(--ind-w) + var(--year-w)); z-index: 4;
    background:#fafafa; width:var(--year-w); min-width:var(--year-w); max-width:var(--year-w);
    text-align:right; white-space:nowrap;
  }
  .fx thead th.month, .fx tbody td.month { min-width:var(--col-w); width:var(--col-w); text-align:right; }

  .row-odd  td { background:#ffffff; }
  .row-even td { background:#f7f7fb; }

  .toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer; user-select:none; font-weight:700; }
  .caret  { font-size:11px; color:#555; width:12px; text-align:center; }
  tr.cat-row.hidden { display:none; }

  .num { text-align:right; white-space:nowrap; }
  .pct { color:#475569; font-size:var(--fs-sm); margin-left:4px; }
  .muted{ color:#6b7280; font-size: var(--fs-sm); }

  .money{ width:100%; box-sizing:border-box; padding:5px; text-align:right; font-size:11.6px; }
  .in-pct{ width:64px; box-sizing:border-box; padding:4px; text-align:right; font-size:11px; }
  .inline { display:flex; align-items:center; gap:6px; justify-content:flex-end; }
  .grp-total { font-weight:700; }

  /* Resultado sticky no rodapé do viewport */
  tr.resultado td{
    position: sticky; bottom: 0; z-index: 7;
    background:#fff7f0; font-weight:800; border-top:2px solid #f97316;
  }
  tr.resultado td.ind     { left: 0; }
  tr.resultado td.annual1 { left: var(--ind-w); }
  tr.resultado td.annual2 { left: calc(var(--ind-w) + var(--year-w)); }
</style>

<script defer src="assets/menu.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <div class="page-header">
      <h1>Planejamento</h1>
      <p>Compras e categorias <code>competencia_driver</code> têm <b>%</b> editável ao lado do valor; o valor é <b>% × Receita do mês</b>. Meses em R$ com máscara e propagação a partir do mês alterado. Cabeçalho fixo e “Resultado” fixo.</p>
    </div>

    <section class="controls">
      <label>Ano:
        <select id="anoSelect">
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>
      </label>
      <button class="btn primary" id="btnSalvar">Salvar projeção do ano</button>
      <span class="badge" id="ctx">—</span>
    </section>

    <div class="table-viewport">
      <table class="fx" id="tbl">
        <thead>
          <tr id="hdr">
            <th class="ind">Centro/Categoria</th>
            <th class="annual1">DRE Projetado (Anual)</th>
            <th class="annual2">Consolidado DRE Real (Ano)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  const mesesPt = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const hoje = new Date(); const ANO_ATUAL = hoje.getFullYear(); const MES_ATUAL = hoje.getMonth()+1;
  const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const num  = v => isNaN(Number(v)) ? 0 : Number(v);
  const cur  = n => Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const parseMoney = s => num(String(s||'').replace(/\./g,'').replace(',','.'));
  const fmtMoneyStr = n => cur(n);

  // Firebase
  try{
    const cfg = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp",
      storageBucket: "lepanapp.appspot.com",
      messagingSenderId: "542989944344",
      appId: "1:542989944344:web:576e28199960fd5440a56d",
      measurementId: "G-VTNGJR7YRL"
    };
    if (!firebase.apps.length) firebase.initializeApp(cfg);
  }catch(e){ console.error(e); }
  const db = firebase.database();

  // Estado
  const categorias = new Map(); const grupos = new Map();
  const realMensal = new Map(); const realAnual = new Map();
  const projMensal = new Map(); const pctDriver = new Map();
  const receitaProj = Array(12).fill(0); const receitaReal = Array(12).fill(0);

  let cmvPctRef = 0, mesesExibidos = [], receitaRealAno = 0, projReceitaAnual = 0;

  async function loadCategorias(){
    categorias.clear(); grupos.clear();
    const s = await db.ref('financeiro/categorias').once('value');
    const v = s.val()||{};
    Object.keys(v).forEach(id=>{
      const c = v[id]||{};
      const centro = c.centroDeCusto || c.centro || 'Outros';
      categorias.set(id, {
        id, nome: c.nome || id, centro,
        dre_regra: c.dre_regra || 'caixa',
        dre_percentual_base: (c.dre_percentual_base!=null) ? Number(c.dre_percentual_base) : null,
        dre_media_janela: c.dre_media_janela ? Number(c.dre_media_janela) : null,
        dre_valor: (c.dre_valor!=null) ? Number(c.dre_valor) : null
      });
      if (!grupos.has(centro)) grupos.set(centro, []);
      grupos.get(centro).push(id);
    });
    grupos.forEach(list=> list.sort((a,b)=>(categorias.get(a).nome).localeCompare(categorias.get(b).nome,'pt-BR')));
  }

  async function loadDREReal(ANO){
    realMensal.clear(); realAnual.clear(); for (let i=0;i<12;i++) receitaReal[i]=0; receitaRealAno=0;
    const s = await db.ref(`financeiro/dre_fechado/${ANO}`).once('value');
    let somaRec=0, somaCmp=0;
    if (s.exists()){
      const v = s.val()||{};
      Object.keys(v).forEach(mm=>{
        const m = Number(mm); if (!(m>=1 && m<=12)) return;
        const n = v[mm]||{};
        const recMes = num(n?.grupos?.Receita?.mes || 0);
        const cmpMes = num(n?.grupos?.CMV?.mes || 0);
        receitaReal[m-1] = recMes; somaRec+=recMes; somaCmp+=cmpMes;
        const cats = n.categorias||{};
        Object.keys(cats).forEach(id=>{
          const val = num(cats[id]?.valorMes||0);
          const arr = realMensal.get(id)||Array(12).fill(0); arr[m-1]=val; realMensal.set(id,arr);
          realAnual.set(id, num(realAnual.get(id)||0) + val);
        });
      });
    }
    receitaRealAno = somaRec;
    cmvPctRef = somaRec>0 ? (somaCmp/somaRec) : 0;
  }

  async function loadSavedProjection(ANO){
    const s = await db.ref(`financeiro/planejamento_projecao/${ANO}`).once('value');
    if (!s.exists()) return null; return s.val();
  }

  function ultimoReal(id){ const arr = realMensal.get(id)||Array(12).fill(0); for (let i=11;i>=0;i--) if (arr[i]!==0) return arr[i]; return 0; }
  function mediaUltimosN(id,N){ if(!N||N<=0) return 0; const a = realMensal.get(id)||Array(12).fill(0); let soma=0,c=0; for(let i=11;i>=0&&c<N;i--){ soma+=a[i]; c++; } return c? (soma/c):0; }

  function defineMeses(ANO){ mesesExibidos = (ANO==2025)? [10,11,12] : [1,2,3,4,5,6,7,8,9,10,11,12]; }

  async function seedReceita(ANO){
    for (let i=0;i<12;i++) receitaProj[i]=0;
    const prev = await loadSavedProjection(ANO-1);
    const prevDez = num(prev?.receitaProj?.[11] || 0);
    if (ANO!==2025 && !receitaProj[0]) receitaProj[0] = prevDez || 0;
  }

  async function seedProjection(ANO){
    projMensal.clear(); pctDriver.clear();
    await seedReceita(ANO);
    const prev = await loadSavedProjection(ANO-1);
    const prevDezReceita = num(prev?.receitaProj?.[11] || 0);

    categorias.forEach((cat,id)=>{
      const regra = cat.dre_regra || 'caixa';
      const nome  = norm(cat.nome);
      const arr = Array(12).fill(0);

      if (nome==='compras') pctDriver.set(id, cmvPctRef);
      else pctDriver.set(id, (cat.dre_percentual_base!=null)?Number(cat.dre_percentual_base):0);

      if (ANO==2025){
        for (let m=1;m<=12;m++){
          if (m<=9) arr[m-1] = (realMensal.get(id)||[])[m-1]||0;
          else{
            if (regra==='competencia_driver' || nome==='compras'){
              arr[m-1] = (pctDriver.get(id)||0) * num(receitaProj[m-1]||0);
            } else if (regra==='especial'){
              arr[m-1] = num(cat.dre_valor||0);
            } else if (regra==='competencia_media'){
              const N = cat.dre_media_janela ? Number(cat.dre_media_janela) : 3;
              arr[m-1] = mediaUltimosN(id, N);
            } else { arr[m-1] = ultimoReal(id); }
          }
        }
      } else {
        if (!receitaProj[0]) receitaProj[0] = prevDezReceita || receitaProj[0] || 0;
        for (let m=1;m<=12;m++){
          if (regra==='competencia_driver' || nome==='compras'){
            arr[m-1] = (pctDriver.get(id)||0) * num(receitaProj[m-1]||0);
          } else if (regra==='especial'){
            arr[m-1] = num(cat.dre_valor||0);
          } else if (regra==='competencia_media'){
            const N = cat.dre_media_janela ? Number(cat.dre_media_janela) : 3;
            arr[m-1] = mediaUltimosN(id, N);
          } else { arr[m-1] = ultimoReal(id); }
        }
      }
      projMensal.set(id, arr);
    });
  }

  function applySaved(saved){
    if (!saved) return;
    if (Array.isArray(saved.receitaProj) && saved.receitaProj.length===12){
      for (let i=0;i<12;i++) receitaProj[i] = num(saved.receitaProj[i]);
    }
    const cats = saved.categorias||{};
    Object.keys(cats).forEach(id=>{
      const node = cats[id]||{};
      if (Array.isArray(node.projMensal)) projMensal.set(id, node.projMensal.map(num));
      if (node.pctDriver!=null) pctDriver.set(id, num(node.pctDriver));
    });
  }

  function buildHeader(ANO){
    const hdr = document.getElementById('hdr');
    hdr.innerHTML = `
      <th class="ind">Centro/Categoria</th>
      <th class="annual1">DRE Projetado (Anual)</th>
      <th class="annual2">Consolidado DRE Real ${ANO}</th>
    `;
    mesesExibidos.forEach(m=>{
      const th = document.createElement('th'); th.className='month'; th.textContent = mesesPt[m-1]; hdr.appendChild(th);
    });
  }

  function somaProjGrupo(g){ let t=0; (grupos.get(g)||[]).forEach(id=>{ t += (projMensal.get(id)||[]).reduce((a,b)=>a+num(b),0); }); return t; }
  function somaRealGrupo(g){ let t=0; (grupos.get(g)||[]).forEach(id=>{ t += num(realAnual.get(id)||0); }); return t; }
  function somaProjMesGrupo(g,m){ let t=0; (grupos.get(g)||[]).forEach(id=> t += num((projMensal.get(id)||[])[m-1]||0) ); return t; }

  function montarTabela(ANO){
    const tbody = document.getElementById('tbody'); tbody.innerHTML = '';

    projReceitaAnual = somaProjGrupo("Receita");
    const receitaProjMes = mesesExibidos.map(m=> somaProjMesGrupo("Receita", m));

    const ORDEM = ["Receita","CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"];
    const centros = Array.from(grupos.keys());
    const ordenados = [...ORDEM, ...centros.filter(c=>!ORDEM.includes(c))];

    const headers = {};
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const key = norm(g).replace(/\s+/g,'-');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ind"><span class="toggle" data-grp="${key}" data-open="1"><span class="caret">▼</span> ${g}</span></td>
        <td class="annual1 num grp-total">—</td>
        <td class="annual2 num grp-total">—</td>
        ${mesesExibidos.map(()=>`<td class="month num grp-total">—</td>`).join('')}
      `;
      tr.dataset.grpkey = key;
      tbody.appendChild(tr);
      headers[g]=tr;

      (grupos.get(g)||[]).forEach(id=>{
        const cat = categorias.get(id); const regra = cat.dre_regra||'caixa'; const nome = norm(cat.nome);
        const arr = projMensal.get(id)||Array(12).fill(0);
        const projAnual = arr.reduce((a,b)=>a+num(b),0);
        const real = num(realAnual.get(id)||0);

        const percReal = receitaRealAno>0 ? (100*real/receitaRealAno) : 0;      // % Real sobre Receita real
        const percProj = projReceitaAnual>0 ? (100*projAnual/projReceitaAnual) : 0; // % Projetado sobre Receita projetada

        const trc = document.createElement('tr'); trc.className='cat-row'; trc.dataset.grp = key;

        const c0 = document.createElement('td'); c0.className='ind';
        c0.innerHTML = `${cat.nome}<div class="muted">${regra}</div>`;
        const c1 = document.createElement('td'); c1.className='annual1 num';
        c1.innerHTML = `${cur(projAnual)}<span class="pct">${projReceitaAnual?percProj.toFixed(1)+'%':'—'}</span>`;
        const c2 = document.createElement('td'); c2.className='annual2 num';
        c2.innerHTML = `${cur(real)}<span class="pct">${receitaRealAno?percReal.toFixed(1)+'%':'—'}</span>`;
        trc.appendChild(c0); trc.appendChild(c1); trc.appendChild(c2);

        mesesExibidos.forEach(m=>{
          const td = document.createElement('td'); td.className='month';
          const v = num(arr[m-1]||0);
          if (regra==='competencia_driver' || nome==='compras'){
            const p = pctDriver.get(id)||0;
            td.innerHTML = `
              <div class="inline">
                <input type="number" step="0.0001" class="in-pct" data-kind="pct" data-id="${id}" data-m="${m}" value="${p}">
                <input type="text" class="money" data-kind="val" data-id="${id}" data-m="${m}" value="${fmtMoneyStr(v)}">
              </div>`;
          } else {
            td.innerHTML = `<input type="text" class="money" data-kind="val" data-id="${id}" data-m="${m}" value="${fmtMoneyStr(v)}">`;
          }
          trc.appendChild(td);
        });

        tbody.appendChild(trc);
      });
    });

    // Totais por grupo (anual e meses, % sobre Receita projetada do mês)
    ordenados.forEach(g=>{
      if(!grupos.has(g)) return;
      const head = headers[g];
      const projAnualGrp = somaProjGrupo(g);
      const realAnualGrp = somaRealGrupo(g);
      const percProjGrp = projReceitaAnual>0 ? (100*projAnualGrp/projReceitaAnual).toFixed(1)+'%' : '—';
      const percRealGrp = receitaRealAno>0 ? (100*realAnualGrp/receitaRealAno).toFixed(1)+'%' : '—';
      head.children[1].innerHTML = `${cur(projAnualGrp)}<span class="pct">${percProjGrp}</span>`;
      head.children[2].innerHTML = `${cur(realAnualGrp)}<span class="pct">${percRealGrp}</span>`;
      mesesExibidos.forEach((m,idx)=>{
        const soma = somaProjMesGrupo(g, m);
        const base = receitaProjMes[idx]||0;
        head.children[3+idx].innerHTML = `${cur(soma)}<span class="pct">${base? (soma/base*100).toFixed(1)+'%' : '—'}</span>`;
      });
    });

    // ===== Linha Resultado (sticky bottom)
    const trRes = document.createElement('tr'); trRes.className='resultado';
    const projReceita = somaProjGrupo("Receita");
    const projOutros  = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
                          .map(g=>somaProjGrupo(g)).reduce((a,b)=>a+b,0));
    const projResAnual= projReceita - projOutros;

    const realReceita = somaRealGrupo("Receita");
    const realOutros  = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
                          .map(g=>somaRealGrupo(g)).reduce((a,b)=>a+b,0));
    const realResAnual = realReceita - realOutros;

    trRes.innerHTML = `
      <td class="ind">Resultado</td>
      <td class="annual1 num">${cur(projResAnual)}</td>
      <td class="annual2 num">${cur(realResAnual)}</td>
      ${mesesExibidos.map(m=>{
        const pr = somaProjMesGrupo("Receita",m);
        const po = (["CMV","Despesas Operacionais","Despesa Variável","Despesa Fixa","Investimento","Retirada"]
                    .map(g=>somaProjMesGrupo(g,m)).reduce((a,b)=>a+b,0));
        return `<td class="month num">${cur(pr - po)}</td>`;
      }).join('')}
    `;
    tbody.appendChild(trRes);

    // zebra & toggles
    let i=0; tbody.querySelectorAll('tr').forEach(tr=>{ tr.classList.add( (i%2===0)?'row-odd':'row-even' ); i++; });
    tbody.querySelectorAll('.toggle').forEach(tg=>{
      tg.addEventListener('click', ()=>{
        const grp = tg.dataset.grp; const open = tg.dataset.open==='1';
        tg.dataset.open = open ? '0':'1';
        tg.querySelector('.caret').textContent = open ? '►' : '▼';
        tbody.querySelectorAll(`tr.cat-row[data-grp="${grp}"]`).forEach(r=> r.classList.toggle('hidden', open));
      });
    });

    bindInputs(ANO);
  }

  function recalcDriverCell(id, m){ const p = pctDriver.get(id)||0; const arr = projMensal.get(id)||Array(12).fill(0); arr[m-1] = p * num(receitaProj[m-1]||0); projMensal.set(id, arr); }
  function propagateForward(ANO, id, fromM, kind){
    if (ANO==2025 && fromM<10) return;
    for (let m of mesesExibidos){ if (m<=fromM) continue;
      if (kind==='pct'){ recalcDriverCell(id, m); }
      if (kind==='val'){ const arr = projMensal.get(id)||Array(12).fill(0); arr[m-1] = (projMensal.get(id)||[])[fromM-1]; projMensal.set(id,arr); }
    }
  }
  function moneyOnFocus(e){ const v = parseMoney(e.target.value); e.target.value = (v||0).toString().replace('.',','); e.target.select(); }
  function moneyOnBlur(e, ANO){
    const id = e.target.dataset.id; const m = Number(e.target.dataset.m);
    const v = parseMoney(e.target.value);
    const arr = projMensal.get(id)||Array(12).fill(0); arr[m-1]=v; projMensal.set(id,arr);
    e.target.value = fmtMoneyStr(v);
    propagateForward(ANO, id, m, 'val');
    montarTabela(ANO);
  }

  function bindInputs(ANO){
    document.querySelectorAll('input.in-pct[data-kind="pct"]').forEach(inp=>{
      inp.addEventListener('blur', ()=>{
        const id = inp.dataset.id; const m = Number(inp.dataset.m);
        pctDriver.set(id, num(inp.value));
        recalcDriverCell(id, m);
        propagateForward(ANO, id, m, 'pct');
        montarTabela(ANO);
      });
    });
    document.querySelectorAll('input.money[data-kind="val"]').forEach(inp=>{
      inp.addEventListener('focus', moneyOnFocus);
      inp.addEventListener('blur',  (ev)=> moneyOnBlur(ev, ANO));
    });
  }

  async function salvar(ANO){
    const payload = {};
    categorias.forEach((_,id)=>{ payload[id] = { projMensal: projMensal.get(id)||Array(12).fill(0), pctDriver: pctDriver.get(id) ?? null }; });
    await db.ref(`financeiro/planejamento_projecao/${ANO}`).set({ meta:{ salvoEm:new Date().toISOString(), cmvPctRef }, receitaProj, categorias: payload });
    alert('Projeção salva!');
  }

  async function rebuild(ANO){
    document.getElementById('ctx').textContent = `Ano: ${ANO} • Meses: ${ANO==2025?'Out/Nov/Dez':'Jan–Dez'}`;
    defineMeses(ANO);
    await loadCategorias();
    await loadDREReal(ANO);
    await seedProjection(ANO);
    const saved = await loadSavedProjection(ANO);
    applySaved(saved);
    buildHeader(ANO);
    montarTabela(ANO);
  }

  const selAno = document.getElementById('anoSelect');
  selAno.onchange = ()=> rebuild(Number(selAno.value));
  document.getElementById('btnSalvar').onclick = ()=> salvar(Number(selAno.value));

  rebuild(2025);
})();
</script>
</body>
</html>
