<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compra - Produtos por Evento</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    table {
      border-collapse: collapse;
      width: auto;
      margin-top: 20px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 4px 6px;
      white-space: nowrap;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .totais-table {
      margin-top: 20px;
      width: auto;
      font-size: 12px;
    }
    .btn-export {
      background-color: #ff7f00;
      color: white;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 12px;
    }
    .btn-export:hover {
      background-color: #e96f00;
    }
    h1, h3 {
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="layout">
  <aside class="sidebar" id="menuLateral">
    <h4>LePanApp</h4>
    <a href="produtos.html">Produtos</a>
    <a href="equipe.html">Equipe</a>
    <a href="clientes.html">Clientes</a>
    <a href="eventos.html">Eventos</a>
    <a href="compra_evento.html">Compra</a>
  </aside>

  <main class="main-content">
    <h1>Produtos por Evento</h1>

    <button class="btn-export" onclick="exportarXLSX()">Exportar para XLSX</button>

    <div id="totaisEventos"></div>

    <table id="tabelaProdutos">
      <thead>
        <tr id="headerRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp",
    storageBucket: "lepanapp.appspot.com",
    messagingSenderId: "542989944344",
    appId: "1:542989944344:web:576e28199960fd5440a56d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let eventos = [];
  let produtosDB = {};
  let dadosTabela = {};

  async function carregarDados() {
    const produtosSnap = await db.ref('produtos').once('value');
    produtosDB = produtosSnap.val();

    const eventosSnap = await db.ref('eventos').once('value');
    eventos = [];

    eventosSnap.forEach(child => {
      const evento = child.val();
      evento.id = child.key;
      eventos.push(evento);
    });

    processarDados();
  }

  function processarDados() {
    dadosTabela = {};

    eventos.forEach(evento => {
      const nomeEvento = evento.nomeEvento || evento.id;

      if (!evento.produtos) return;

      evento.produtos.forEach((produto) => {
        const prodId = produto.produtoId;
        const prodNome = produtosDB[prodId] ? produtosDB[prodId].nome : prodId;

        if (!dadosTabela[prodNome]) {
          dadosTabela[prodNome] = {};
        }

        dadosTabela[prodNome][nomeEvento] = produto.quantidade || 0;
      });
    });

    renderTabela();
    renderTotaisEventos();
  }

  function renderTabela() {
    const eventosNomes = eventos.map(e => e.nomeEvento || e.id);

    const headerRow = document.getElementBy
