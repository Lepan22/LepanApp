<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compra - Produtos por Evento</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="layout">
  <aside class="sidebar" id="menuLateral">
    <h4>LePanApp</h4>
    <a href="produtos.html">Produtos</a>
    <a href="equipe.html">Equipe</a>
    <a href="clientes.html">Clientes</a>
    <a href="eventos.html">Eventos</a>
    <a href="compra_evento.html">Compra</a>
  </aside>

  <main class="main-content">
    <h1>Produtos por Evento</h1>

    <button onclick="exportarXLSX()">Exportar para XLSX</button>

    <table class="table table-bordered" style="margin-top:20px;">
      <thead>
        <tr id="headerRow">
          <th>Produto</th>
          <!-- Eventos serão inseridos aqui -->
        </tr>
      </thead>
      <tbody id="tabelaProdutos">
        <!-- Linhas de produtos -->
      </tbody>
    </table>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp",
    storageBucket: "lepanapp.appspot.com",
    messagingSenderId: "542989944344",
    appId: "1:542989944344:web:576e28199960fd5440a56d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let eventos = [];
  let produtos = {};

  function carregarEventos() {
    db.ref('eventos').once('value').then(snapshot => {
      eventos = [];

      snapshot.forEach(child => {
        const evento = child.val();
        evento.id = child.key;
        eventos.push(evento);
      });

      processarProdutos();
    });
  }

  function processarProdutos() {
    produtos = {};

    eventos.forEach(evento => {
      const nomeEvento = evento.nome || evento.id;

      if (!evento.itens) return;

      evento.itens.forEach(item => {
        const nomeProduto = item.nomeItem || 'Produto Sem Nome';

        if (!produtos[nomeProduto]) {
          produtos[nomeProduto] = {};
        }

        produtos[nomeProduto][nomeEvento] = item.quantidade || 0;
      });
    });

    renderTabela();
  }

  function renderTabela() {
    const headerRow = document.getElementById('headerRow');
    const tabela = document.getElementById('tabelaProdutos');

    // Limpa cabeçalho e corpo
    headerRow.innerHTML = '<th>Produto</th>';
    tabela.innerHTML = '';

    const eventosNomes = eventos.map(e => e.nome || e.id);

    eventosNomes.forEach(nome => {
      headerRow.innerHTML += `<th>${nome}</th>`;
    });

    Object.keys(produtos).forEach(produto => {
      const tr = document.createElement('tr');
      let row = `<td>${produto}</td>`;

      eventosNomes.forEach(nome => {
        const quantidade = produtos[produto][nome] || 0;
        row += `<td>${quantidade}</td>`;
      });

      tr.innerHTML = row;
      tabela.appendChild(tr);
    });
  }

  function exportarXLSX() {
    const ws_data = [];
    const header = ["Produto", ...eventos.map(e => e.nome || e.id)];
    ws_data.push(header);

    Object.keys(produtos).forEach(produto => {
      const row = [produto];
      eventos.forEach(evento => {
        const nomeEvento = evento.nome || evento.id;
        row.push(produtos[produto][nomeEvento] || 0);
      });
      ws_data.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Produtos por Evento");
    XLSX.writeFile(wb, "produtos_por_evento.xlsx");
  }

  document.addEventListener("DOMContentLoaded", () => {
    carregarEventos();
  });
</script>

</body>
</html>
