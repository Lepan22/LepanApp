<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compras Evento</title>
  <link rel="stylesheet" href="../assets/base.css" />
  <link rel="stylesheet" href="../assets/menu-styles.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="../assets/menu.js" defer></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="menuLateral"></aside>
    <main class="main-content">
      <div class="page-header">
        <h1>Compras por Evento</h1>
      </div>

      <div class="card-dashboard">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 10px;">
          <label for="filtroStatus">Status:</label>
          <select id="filtroStatus">
            <option value="aberto" selected>Aberto</option>
            <option value="finalizado">Finalizado</option>
            <option value="fechado">Fechado</option>
          </select>

          <label for="filtroDataInicio">Data In√≠cio:</label>
          <input type="date" id="filtroDataInicio">
          <label for="filtroDataFim">Data Fim:</label>
          <input type="date" id="filtroDataFim">

          <button onclick="exportarXLSX()">Exportar XLSX</button>
        </div>

        <div id="comprasTabela"></div>
      </div>
    </main>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
      authDomain: "lepanapp.firebaseapp.com",
      databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
      projectId: "lepanapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let eventos = [];

    function carregarDados() {
      db.ref('eventos').once('value').then(snapshot => {
        eventos = [];
        snapshot.forEach(child => {
          const evento = child.val();
          evento.id = child.key;
          eventos.push(evento);
        });
        processarDados();
      });
    }

    function formatarData(dataISO) {
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}`;
    }

    function processarDados() {
      const filtroStatus = document.getElementById('filtroStatus').value;
      const dataInicio = document.getElementById('filtroDataInicio').value;
      const dataFim = document.getElementById('filtroDataFim').value;

      const produtos = {};
      const colunas = [];

      const eventosFiltrados = eventos.filter(e => {
        const statusOk = (e.status || '').toLowerCase() === filtroStatus;
        const dataOk = (!dataInicio || e.data >= dataInicio) && (!dataFim || e.data <= dataFim);
        return statusOk && dataOk;
      });

      eventosFiltrados.forEach(e => {
        const nomeColuna = `${e.nomeEvento || ''}<br>${formatarData(e.data)}`;
        if (!colunas.includes(nomeColuna)) colunas.push(nomeColuna);

        if (e.produtos) {
          e.produtos.forEach(p => {
            const nome = p.nome || p.produtoNome || '';
            if (!produtos[nome]) produtos[nome] = {};
            produtos[nome][nomeColuna] = (produtos[nome][nomeColuna] || 0) + Number(p.quantidade || 0);
          });
        }
      });

      colunas.sort();

      let html = '<table><thead><tr><th>Produto</th>';
      colunas.forEach(c => html += `<th>${c}</th>`);
      html += '<th>Total</th></tr></thead><tbody>';

      for (const nome in produtos) {
        let total = 0;
        html += `<tr><td>${nome}</td>`;
        colunas.forEach(col => {
          const val = produtos[nome][col] || 0;
          html += `<td>${val}</td>`;
          total += val;
        });
        html += `<td><strong>${total}</strong></td></tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('comprasTabela').innerHTML = html;
    }

    function exportarXLSX() {
      const tabela = document.querySelector("#comprasTabela table");
      if (!tabela) return alert("Nenhuma tabela para exportar.");
      let csv = "";
      tabela.querySelectorAll("tr").forEach(row => {
        const cols = Array.from(row.querySelectorAll("th,td")).map(td => td.innerText.replace(/\n/g, " "));
        csv += cols.join(";") + "\n";
      });
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "compras_evento.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function setarDataFimPadrao() {
      const hoje = new Date();
      const diaSemana = hoje.getDay();
      const diff = (8 - diaSemana) % 7 || 7;
      hoje.setDate(hoje.getDate() + diff);
      document.getElementById('filtroDataFim').value = hoje.toISOString().split('T')[0];
    }

    document.addEventListener("DOMContentLoaded", () => {
      carregarMenu('../');
      setarDataFimPadrao();
      carregarDados();
    });
  </script>
</body>
</html>
