<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compra - Produtos por Evento</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    table th, table td {
      text-align: center;
      padding: 4px;
    }
  </style>
</head>
<body>

<div class="layout">
  <aside class="sidebar" id="menuLateral">
    <h4>LePanApp</h4>
    <a href="produtos.html">Produtos</a>
    <a href="equipe.html">Equipe</a>
    <a href="clientes.html">Clientes</a>
    <a href="eventos.html">Eventos</a>
    <a href="compra_evento.html">Compra</a>
  </aside>

  <main class="main-content">
    <h1>Produtos por Evento - Com Média e Totais</h1>

    <button onclick="exportarXLSX()">Exportar para XLSX</button>

    <div id="totaisEventos"></div>

    <table class="table table-bordered" style="margin-top:20px;">
      <thead>
        <tr>
          <th rowspan="2">Produto</th>
          <th id="eventosHeader" colspan="0"></th>
          <th rowspan="2">Total Enviado</th>
        </tr>
        <tr id="subHeaderRow">
          <!-- Sub-colunas Env e Méd -->
        </tr>
      </thead>
      <tbody id="tabelaProdutos">
        <!-- Linhas aqui -->
      </tbody>
    </table>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBClDBA7f9-jfF6Nz6Ia-YlZ6G-hx3oerY",
    authDomain: "lepanapp.firebaseapp.com",
    databaseURL: "https://lepanapp-default-rtdb.firebaseio.com",
    projectId: "lepanapp",
    storageBucket: "lepanapp.appspot.com",
    messagingSenderId: "542989944344",
    appId: "1:542989944344:web:576e28199960fd5440a56d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let eventos = [];
  let produtosDB = {};
  let dadosTabela = {};

  async function carregarDados() {
    const produtosSnap = await db.ref('produtos').once('value');
    produtosDB = produtosSnap.val();

    const eventosSnap = await db.ref('eventos').once('value');
    eventos = [];

    eventosSnap.forEach(child => {
      const evento = child.val();
      evento.id = child.key;
      eventos.push(evento);
    });

    processarDados();
  }

  function processarDados() {
    dadosTabela = {};

    eventos.forEach(evento => {
      const nomeEvento = evento.nomeEvento || evento.id;

      if (!evento.produtos) return;

      evento.produtos.forEach(produto => {
        const prodId = produto.produtoId;
        const prodNome = produtosDB[prodId] ? produtosDB[prodId].nome : prodId;

        if (!dadosTabela[prodNome]) {
          dadosTabela[prodNome] = {};
        }

        if (!dadosTabela[prodNome][nomeEvento]) {
          dadosTabela[prodNome][nomeEvento] = { enviada: 0, count: 0 };
        }

        dadosTabela[prodNome][nomeEvento].enviada += produto.quantidade || 0;
        dadosTabela[prodNome][nomeEvento].count += 1;
      });
    });

    for (let prodNome in dadosTabela) {
      for (let nomeEvento in dadosTabela[prodNome]) {
        const d = dadosTabela[prodNome][nomeEvento];
        d.media = d.count ? (d.enviada / d.count).toFixed(2) : '0';
      }
    }

    renderTabela();
    renderTotaisEventos();
  }

  function renderTabela() {
    const eventosNomes = [...new Set(eventos.map(e => e.nomeEvento || e.id))];

    const eventosHeader = document.getElementById('eventosHeader');
    eventosHeader.setAttribute('colspan', eventosNomes.length * 2);

    const subHeaderRow = document.getElementById('subHeaderRow');
    subHeaderRow.innerHTML = '';

    eventosNomes.forEach(() => {
      subHeaderRow.innerHTML += `<th>Env</th><th>Méd</th>`;
    });

    const tabela = document.getElementById('tabelaProdutos');
    tabela.innerHTML = '';

    Object.keys(dadosTabela).forEach(produto => {
      const tr = document.createElement('tr');
      let row = `<td>${produto}</td>`;
      let totalEnviado = 0;

      eventosNomes.forEach(nome => {
        const dados = dadosTabela[produto][nome];
        const enviada = dados ? dados.enviada : 0;
        const media = dados ? dados.media : 0;
        totalEnviado += Number(enviada);
        row += `<td>${enviada}</td><td>${media}</td>`;
      });

      row += `<td>${totalEnviado}</td>`;
      tr.innerHTML = row;
      tabela.appendChild(tr);
    });
  }

  function renderTotaisEventos() {
    const div = document.getElementById('totaisEventos');
    div.innerHTML = '<h3>Totais por Evento</h3>';

    const eventosUnicos = [...new Set(eventos.map(e => e.nomeEvento || e.id))];

    eventosUnicos.forEach(nomeEvento => {
      let estimativa = 0;
      let potencial = 0;

      eventos.filter(e => e.nomeEvento === nomeEvento).forEach(evento => {
        estimativa += Number(evento.estimativaVenda) || 0;

        if (evento.produtos) {
          evento.produtos.forEach(prod => {
            const valorVenda = produtosDB[prod.produtoId]?.valorVenda || 0;
            potencial += (prod.quantidade || 0) * valorVenda;
          });
        }
      });

      div.innerHTML += `
        <p><strong>${nomeEvento}</strong> - Estimativa Venda: R$ ${estimativa}, Potencial Venda: R$ ${potencial.toFixed(2)}</p>
      `;
    });
  }

  function exportarXLSX() {
    const ws_data = [];
    const header = ["Produto"];
    const eventosNomes = [...new Set(eventos.map(e => e.nomeEvento || e.id))];

    eventosNomes.forEach(() => {
      header.push("Env", "Méd");
    });
    header.push("Total Enviado");
    ws_data.push(header);

    Object.keys(dadosTabela).forEach(produto => {
      const row = [produto];
      let totalEnviado = 0;

      eventosNomes.forEach(nome => {
        const dados = dadosTabela[produto][nome];
        const enviada = dados ? dados.enviada : 0;
        const media = dados ? dados.media : 0;
        totalEnviado += Number(enviada);
        row.push(enviada, media);
      });

      row.push(totalEnviado);
      ws_data.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Produtos por Evento");
    XLSX.writeFile(wb, "produtos_por_evento_formatado.xlsx");
  }

  document.addEventListener("DOMContentLoaded", carregarDados);
</script>

</body>
</html>
