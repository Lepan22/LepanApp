<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Importar DRE</title>
  <link rel="stylesheet" href="assets/base.css" />
  <link rel="stylesheet" href="assets/menu-styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module" src="assets/firebase-config.js"></script>
  <script defer src="assets/menu.js"></script>
  <style>
    .form-filtro { margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    table { margin-top: 20px; font-size: 12px; }
    td.valor { text-align: right; }
    .grupo { background: #f0f0f0; font-weight: bold; }
    button { margin-top: 15px; }
  </style>
</head>
<body>
  <div id="menuLateral" class="sidebar"></div>

  <div class="main-content">
    <h2>Importar Planilha DRE</h2>

    <div class="form-filtro">
      <label>Mês:
        <select id="filtroMes">
          <option value="1">Janeiro</option>
          <option value="2">Fevereiro</option>
          <option value="3">Março</option>
          <option value="4">Abril</option>
          <option value="5">Maio</option>
          <option value="6" selected>Junho</option>
          <option value="7">Julho</option>
          <option value="8">Agosto</option>
          <option value="9">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </label>

      <label>Ano:
        <select id="filtroAno">
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
        </select>
      </label>
    </div>

    <input type="file" id="arquivoExcel" accept=".xls,.xlsx" />
    <div id="resultadoDRE"></div>
    <button id="salvarBtn" style="display:none;">Salvar Consolidação no Firebase</button>
  </div>

  <script type="module">
    import { db } from './assets/firebase-config.js';
    import { ref, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    let dadosImportados = [], consolidado = {};

    document.getElementById('arquivoExcel').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        dadosImportados = XLSX.utils.sheet_to_json(sheet);
        processarDRE();
      };
      reader.readAsArrayBuffer(file);
    });

    function processarDRE() {
      const mes = parseInt(document.getElementById('filtroMes').value);
      const ano = parseInt(document.getElementById('filtroAno').value);
      const entrada = {}, saida = {};
      let totalEntrada = 0, totalSaida = 0;

      dadosImportados.forEach(linha => {
        const data = new Date(linha.Data || linha.data || '');
        if (!data.getTime()) return;
        if (data.getMonth() + 1 !== mes || data.getFullYear() !== ano) return;

        const tipo = (linha.Tipo || linha.tipo || '').toLowerCase();
        const categoria = linha.Categoria || linha.categoria || 'Outros';
        const valor = parseFloat(linha.Valor || linha.valor || 0);

        if (tipo === 'entrada') {
          entrada[categoria] = (entrada[categoria] || 0) + valor;
          totalEntrada += valor;
        } else if (tipo === 'saída' || tipo === 'saida') {
          saida[categoria] = (saida[categoria] || 0) + valor;
          totalSaida += valor;
        }
      });

      const lucro = totalEntrada - totalSaida;
      consolidado = {
        ano, mes,
        entradas: entrada,
        saidas: saida,
        lucroLiquido: parseFloat(lucro.toFixed(2))
      };

      renderizarDRE(entrada, saida, lucro);
    }

    function renderizarDRE(entrada, saida, lucro) {
      const div = document.getElementById('resultadoDRE');
      let html = '<table><thead><tr><th>Categoria</th><th>Valor (R$)</th></tr></thead><tbody>';
      html += '<tr class="grupo"><td>Entradas</td><td></td></tr>';
      for (let cat in entrada) {
        html += `<tr><td>${cat}</td><td class="valor">${entrada[cat].toFixed(2)}</td></tr>`;
      }
      html += '<tr class="grupo"><td>Saídas</td><td></td></tr>';
      for (let cat in saida) {
        html += `<tr><td>${cat}</td><td class="valor">-${saida[cat].toFixed(2)}</td></tr>`;
      }
      html += `<tr class="grupo"><td>Lucro Líquido</td><td class="valor">${lucro.toFixed(2)}</td></tr>`;
      html += '</tbody></table>';
      div.innerHTML = html;
      document.getElementById('salvarBtn').style.display = 'inline-block';
    }

    document.getElementById('salvarBtn').addEventListener('click', () => {
      const caminho = `financeiro/consolidado/${consolidado.ano}_${String(consolidado.mes).padStart(2, '0')}`;
      set(ref(db, caminho), consolidado)
        .then(() => alert('Consolidação salva com sucesso!'))
        .catch(() => alert('Erro ao salvar no Firebase.'));
    });
  </script>
</body>
</html>
